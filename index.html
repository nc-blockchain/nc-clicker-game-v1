<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Encourage revalidation on refresh so players get updates after deploy -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- Bump this on every deploy so devices get updates (script below reloads if server version is newer) -->
  <meta name="app-version" content="4">
  <!-- Fix GitHub Pages: base URL so scripts/assets load from repo root (e.g. /nc-clicker-game-v1/) -->
  <script>
    (function(){
      var origin = location.origin;
      if (!origin || origin === 'null' || location.protocol === 'file:') return;
      var path = location.pathname.replace(/\/?$/, '');
      var basePath = (path === '' ? '/' : path + '/');
      document.write('<base href="' + origin + basePath + '" />');
    })();
  </script>
  <title>1N Blockchain Token Clicker ‚Äì Tap to earn $CARD</title>
  <!-- Share preview: opens nicely on mobile when link is shared -->
  <meta property="og:title" content="1N Blockchain Token Clicker" />
  <meta property="og:description" content="Tap the Cardinal to earn tokens. Play on your phone ‚Äì connect wallet, claim $CARD, challenge friends in PVP." />
  <meta property="og:image" content="https://biggleem.github.io/nc-clicker-game-v1/assets/cardinal.png" />
  <meta property="og:url" content="https://biggleem.github.io/nc-clicker-game-v1/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="1N Blockchain Token Clicker" />
  <meta name="twitter:description" content="Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends." />
  <link rel="icon" href="assets/cardinal.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/cardinal.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#0a0a0a',
            neon: {
              cyan: '#00fff7',
              pink: '#ff00aa',
              green: '#00ff88',
              yellow: '#ffff00',
              purple: '#b366ff',
            },
            pixel: { border: '#333', panel: '#1a1a1a' }
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'monospace'],
          },
          boxShadow: {
            neon: '0 0 10px currentColor, 0 0 20px currentColor',
            'neon-sm': '0 0 5px currentColor',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    html, body { -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }
    ::selection { background: transparent; color: inherit; }
    ::-moz-selection { background: transparent; color: inherit; }
    /* Bottom nav: hide scrollbar but keep scroll on small devices */
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    /* Bottom nav: left-aligned, scroll on small screens */
    .bottom-nav-inner { display: flex; flex-wrap: nowrap; justify-content: flex-start; align-items: center; gap: 2px; padding: 6px 8px; min-height: 44px; overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
    .bottom-nav-inner::-webkit-scrollbar { display: none; }
    @media (min-width: 400px) { .bottom-nav-inner { gap: 4px; padding: 8px 10px; } }
    .bottom-nav-link { flex-shrink: 0; padding: 6px 8px; font-size: 8px; border-radius: 6px; white-space: nowrap; }
    @media (min-width: 360px) { .bottom-nav-link { padding: 6px 10px; font-size: 9px; } }
    @media (min-width: 400px) { .bottom-nav-link { padding: 8px 12px; font-size: 10px; } }
    /* Home center: smaller font on small screens */
    .home-center-text { font-size: 8px; }
    @media (min-width: 360px) { .home-center-text { font-size: 9px; } }
    @media (min-width: 400px) { .home-center-text { font-size: 10px; } }
    .home-center-value { font-size: 12px; }
    @media (min-width: 360px) { .home-center-value { font-size: 14px; } }
    @media (min-width: 400px) { .home-center-value { font-size: 16px; } }
    .pixel-border { border: 3px solid #333; image-rendering: pixelated; }
    .neon-text-cyan { color: #00fff7; text-shadow: 0 0 10px #00fff7; }
    .neon-text-pink { color: #ff00aa; text-shadow: 0 0 10px #ff00aa; }
    .neon-text-green { color: #00ff88; text-shadow: 0 0 10px #00ff88; }
    .page { display: none; min-height: calc(100vh - 120px); }
    .page.active { display: block; }
    .nft-clicker { transition: transform 0.05s; box-shadow: 0 0 20px rgba(0,255,247,0.2), 0 0 40px rgba(255,0,170,0.1); }
    .nft-clicker:hover:not(.cooldown) { box-shadow: 0 0 25px rgba(0,255,247,0.35), 0 0 50px rgba(255,0,170,0.2); }
    .pvp-duel-tap-pulse { animation: pvpTapPulse 0.12s ease-out; }
    @keyframes pvpTapPulse { 0% { transform: scale(1); } 40% { transform: scale(0.9); } 100% { transform: scale(1); } }
    .pvp-go-glow { text-shadow: 0 0 12px rgba(0,255,247,0.9), 0 0 24px rgba(0,255,247,0.6); animation: pvpGoGlow 0.5s ease-out; }
    @keyframes pvpGoGlow { 0% { transform: scale(1.2); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
    .nft-clicker:active { transform: scale(0.97); }
    .nft-clicker.cooldown { opacity: 0.7; pointer-events: none; }
    .nft-clicker.bird-dead { opacity: 0.5; filter: grayscale(0.8); }
    .image-pixel { image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
    /* Bounties: square colored cards + bird card */
    .bounty-row { position: relative; border-radius: 8px; border: 2px solid; }
    .bounty-row.bounty-card-green { border-color: #00ff88; background: rgba(0,255,136,0.12); }
    .bounty-row.bounty-card-yellow { border-color: #ffff00; background: rgba(255,255,0,0.12); }
    .bounty-row.bounty-card-cyan { border-color: #00fff7; background: rgba(0,255,247,0.12); }
    .bounty-row.bounty-card-pink { border-color: #ff00aa; background: rgba(255,0,170,0.12); }
    .bounty-bird-card {
      flex-shrink: 0;
      width: 44px; height: 44px; border: 2px solid; border-radius: 6px;
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); box-shadow: 0 0 8px currentColor;
    }
    .bounty-bird-card img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    .bounty-bird-card.bird-green { border-color: #00ff88; color: #00ff88; }
    .bounty-bird-card.bird-yellow { border-color: #ffff00; color: #ffff00; }
    .bounty-bird-card.bird-cyan { border-color: #00fff7; color: #00fff7; }
    .bounty-bird-card.bird-pink { border-color: #ff00aa; color: #ff00aa; }
    .bounty-collection-card {
      border: 2px solid; border-radius: 8px;
      padding: 0.5rem; text-align: center; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .bounty-collection-card .bird-thumb { width: 36px; height: 36px; object-fit: contain; image-rendering: pixelated; margin-bottom: 4px; }
    .bounty-collection-card .bird-name { font-size: 9px; line-height: 1.2; color: #e5e5e5; }
    .bounty-collection-card .bird-reward { font-size: 8px; color: currentColor; }
    .bounty-collection-card .bounty-card-claim { color: inherit; background: transparent; }
    .bounty-collection-card.bird-green { border-color: #00ff88; color: #00ff88; background: rgba(0,255,136,0.2); }
    .bounty-collection-card.bird-yellow { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.2); }
    .bounty-collection-card.bird-cyan { border-color: #00fff7; color: #00fff7; background: rgba(0,255,247,0.2); }
    .bounty-collection-card.bird-pink { border-color: #ff00aa; color: #ff00aa; background: rgba(255,0,170,0.2); }
    /* TO CLAIM list: same design as Boosts (gray panels) */
    #bounties-list.bounty-toclaim-list .bounty-row { border-color: #374151; background: #1a1a1a; }
    #bounties-list.bounty-toclaim-list .bounty-bird-card { display: none; }
    .bounty-category { margin-bottom: 1.25rem; }
    .bounty-category-panel.hidden { display: none !important; }
    .bounty-category-title { font-size: 11px; font-weight: bold; color: #9ca3af; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    /* Loading / intro screen */
    .splash-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: #0a0a0a;
      background-image: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.3) 0%, rgba(120,20,40,0.12) 40%, transparent 70%);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .splash-card {
      background: #0a0a0a;
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      position: relative;
      border: 2px solid rgba(255,200,50,0.6);
      box-shadow: 0 0 30px rgba(255,180,0,0.4), 0 0 60px rgba(255,140,0,0.2), inset 0 0 0 1px rgba(255,220,100,0.2);
    }
    .splash-card::before {
      content: '';
      position: absolute;
      top: -2px; left: -2px; right: -2px; bottom: -2px;
      border-radius: 26px;
      background: linear-gradient(135deg, #FFD700, #FF8C00, #FFD700);
      z-index: -1;
      opacity: 0.4;
      filter: blur(8px);
    }
    .splash-title { color: #FFD700; font-size: 10px; margin-bottom: 16px; text-shadow: 0 0 12px rgba(255,215,0,0.8); line-height: 1.5; }
    .splash-cardinal { width: 160px; height: auto; margin: 16px auto; border-radius: 12px; image-rendering: pixelated; display: block; }
    .splash-text { color: rgba(255,255,255,0.9); font-size: 9px; line-height: 1.6; margin-bottom: 20px; }
    .splash-btn {
      background: linear-gradient(135deg, #FF8C00, #FFD700);
      color: #000;
      border: none;
      padding: 16px 32px;
      font-size: 10px;
      font-weight: 900;
      border-radius: 50px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      box-shadow: 0 8px 24px rgba(255,180,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .splash-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255,200,0,0.6); }
    .splash-btn:active { transform: translateY(0); }
    #app.hidden { display: none !important; }

    /* Red radial gradient background */
    body { position: relative; min-height: 100vh; }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.35) 0%, rgba(120,20,40,0.15) 40%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    #app { position: relative; z-index: 1; }

    /* Rising tiny stars */
    .stars-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .star {
      position: absolute;
      width: 2px; height: 2px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      animation: starRise linear infinite;
      box-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    @keyframes starRise {
      0% { transform: translateY(100vh) translateX(0) scale(1); opacity: 0; }
      8% { opacity: 0.8; }
      92% { opacity: 0.6; }
      100% { transform: translateY(-20px) translateX(0) scale(0.5); opacity: 0; }
    }

    /* Click effect: feather with falling physics */
    .feather-fall {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      width: 52px;
      height: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      transform-origin: center center;
      animation: featherFall 1.4s ease-in forwards;
    }
    .feather-fall.feather-sway1 { animation: featherFall1 1.4s ease-in forwards; }
    .feather-fall.feather-sway2 { animation: featherFall2 1.4s ease-in forwards; }
    .feather-fall.feather-sway3 { animation: featherFall3 1.4s ease-in forwards; }
    .reduced-motion .feather-fall { animation-duration: 0.4s !important; }
    @keyframes featherFall {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(120px) translateX(0) rotate(180deg) scale(0.9); }
    }
    @keyframes featherFall1 {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(130px) translateX(18px) rotate(220deg) scale(0.9); }
    }
    @keyframes featherFall2 {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(125px) translateX(-15px) rotate(-160deg) scale(0.9); }
    }
    @keyframes featherFall3 {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(115px) translateX(8px) rotate(90deg) scale(0.9); }
    }

    /* Click effect: +N token text */
    .tap-value-float {
      position: fixed;
      pointer-events: none;
      z-index: 101;
      font-size: 14px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 1px 2px rgba(0,0,0,0.8);
      animation: valueFloat 1s ease-out forwards;
      transform: translate(-50%, -50%);
    }
    @keyframes valueFloat {
      0% { opacity: 1; transform: translate(-50%, -50%) translateY(0) scale(1.2); }
      70% { opacity: 1; transform: translate(-50%, -50%) translateY(-50px) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) translateY(-70px) scale(0.9); }
    }
  </style>
</head>
<body class="bg-dark text-white font-pixel text-xs md:text-sm antialiased" style="background:#0a0a0a; color:#fff; margin:0; min-height:100vh;">
  <!-- Check for app update: fetch live index (no cache); if server version &gt; this page, reload to get update -->
  <script>
    (function(){
      if (location.protocol === 'file:' || !document.querySelector) return;
      if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(function(regs){ regs.forEach(function(r){ r.unregister(); }); }); }
      var meta = document.querySelector('meta[name="app-version"]');
      var myVer = meta ? meta.getAttribute('content') : '';
      if (!myVer) return;
      var path = location.pathname.replace(/\/?$/, '') || '/';
      var url = (path === '/' ? '/' : path + (path.indexOf('.html') !== -1 ? '' : '/')) + '?t=' + Date.now();
      fetch(url, { cache: 'no-store', credentials: 'same-origin' }).then(function(r){ return r.text(); }).then(function(html){
        var m = html.match(/<meta\s+name="app-version"\s+content="([^"]+)"/);
        var serverVer = m ? m[1] : '';
        if (serverVer && serverVer !== myVer) { location.reload(true); }
      }).catch(function(){});
    })();
  </script>
  <!-- Rising stars layer (behind app) -->
  <div class="stars-layer" id="stars-layer" aria-hidden="true"></div>

  <!-- Onboarding: multi-step intro for new users (first visit only) -->
  <div id="onboarding-overlay" class="hidden" style="position:fixed;inset:0;z-index:9999;background:#0a0a0a;display:none;align-items:center;justify-content:center;padding:20px;">
    <button type="button" id="onboarding-skip" class="absolute top-4 right-4 text-gray-500 text-[8px] hover:text-gray-300 py-1 px-2 z-10">Skip intro</button>
    <div class="onboarding-card bg-black border-2 border-neon-cyan rounded-xl p-6 max-w-sm w-full text-center relative" style="box-shadow:0 0 40px rgba(0,255,247,0.3);">
      <div id="onboarding-step" class="step">
        <!-- Step content injected by JS -->
      </div>
      <div class="flex justify-between items-center mt-6 gap-3">
        <button type="button" id="onboarding-back" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700 hidden">BACK</button>
        <div class="flex-1"></div>
        <button type="button" id="onboarding-next" class="py-2 px-5 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10 font-bold">NEXT</button>
      </div>
      <div class="flex justify-center gap-1.5 mt-3">
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="0"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="1"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="2"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="3"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="4"></span>
      </div>
    </div>
  </div>

  <!-- First-time only: set name when you first get the app (no name in storage) -->
  <div id="welcome-name-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Set your name" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">WELCOME TO 1N TOKEN CLICKER</p>
      <p class="text-gray-300 text-[9px] mb-4">Enter your display name once. You can change it later in Wallet ‚Üí Settings.</p>
      <input type="text" id="welcome-name-input" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <button type="button" id="welcome-name-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE</button>
    </div>
  </div>
  <!-- Profile: change name (opened from Wallet ‚Üí Settings) -->
  <div id="profile-name-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Change name" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">CHANGE DISPLAY NAME</p>
      <input type="text" id="profile-name-input" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <div class="flex gap-2 justify-center">
        <button type="button" id="profile-name-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE</button>
        <button type="button" id="profile-name-cancel" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CANCEL</button>
      </div>
    </div>
  </div>
  <!-- Toast: reusable in-game toast notification -->
  <div id="game-toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[10002] px-4 py-2 rounded-lg border-2 border-neon-green bg-black/95 text-neon-green text-[10px] font-bold shadow-lg transition-opacity" style="max-width:90vw;" role="status" aria-live="polite"></div>
  <!-- Notifications center -->
  <div id="notifications-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Notifications" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-yellow rounded-lg p-4 max-w-sm w-full max-h-[80vh] flex flex-col">
      <p class="text-neon-yellow text-[10px] font-bold mb-3">NOTIFICATIONS</p>
      <div class="mb-3">
        <p class="text-gray-400 text-[9px] mb-1">Browser notifications: <span id="notifications-permission">‚Äî</span></p>
        <button type="button" id="notifications-request-btn" class="py-1 px-2 border-2 border-neon-yellow text-neon-yellow rounded text-[9px] hover:bg-neon-yellow/10">ENABLE</button>
      </div>
      <div class="text-gray-500 text-[9px] mb-1">Recent activity</div>
      <ul id="notifications-list" class="space-y-1 text-[9px] text-gray-300 overflow-y-auto flex-1 min-h-0 max-h-48"></ul>
      <button type="button" id="notifications-close" class="mt-3 py-2 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CLOSE</button>
    </div>
  </div>
  <!-- Wallet Settings modal (opened by SETTINGS button in Wallet) -->
  <div id="wallet-settings-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Settings" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full max-h-[90vh] overflow-y-auto relative">
      <div class="flex items-center justify-between mb-3">
        <p class="text-neon-cyan text-[10px] font-bold">SETTINGS</p>
        <button type="button" id="wallet-settings-modal-close-x" aria-label="Close settings" class="p-1.5 rounded border-2 border-gray-500 text-gray-400 hover:border-neon-cyan hover:text-neon-cyan hover:bg-neon-cyan/10 text-sm leading-none">√ó</button>
      </div>
      <!-- Settings tab buttons -->
      <div class="flex flex-wrap gap-1 mb-3 border-b-2 border-gray-700 pb-2">
        <button type="button" class="settings-tab-btn py-1.5 px-2.5 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] font-bold bg-neon-cyan/10" data-settings-tab="general">‚öôÔ∏è Settings</button>
        <button type="button" class="settings-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-settings-tab="friends">üë• Friends</button>
        <button type="button" class="settings-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50 hover:text-neon-green" data-settings-tab="wallet">üí∞ Wallet</button>
        <button type="button" class="settings-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-yellow/50 hover:text-neon-yellow" data-settings-tab="info">‚ÑπÔ∏è Info</button>
      </div>
      <!-- Panel: General Settings (default visible) -->
      <div class="settings-panel" data-settings-panel="general">
        <div class="space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <span class="text-[10px] text-gray-400">Player ¬∑ Profile name:</span>
            <span id="wallet-settings-name" class="neon-text-cyan text-[10px]">‚Äî</span>
            <button type="button" id="wallet-settings-btn" class="py-1 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10">CHANGE NAME</button>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2">
            <span class="text-[10px] text-gray-400">Game ¬∑ Feather effects:</span>
            <label class="inline-flex items-center gap-1.5 cursor-pointer">
              <input type="checkbox" id="wallet-setting-feather-effects" class="rounded border-2 border-gray-500 bg-black text-neon-cyan focus:ring-neon-cyan" checked />
              <span id="wallet-setting-feather-label" class="text-[9px] text-gray-300">On</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2">
            <span class="text-[10px] text-gray-400">Sound:</span>
            <label class="inline-flex items-center gap-1.5 cursor-pointer">
              <input type="checkbox" id="wallet-setting-sound" class="rounded border-2 border-gray-500 bg-black text-neon-cyan focus:ring-neon-cyan" checked />
              <span id="wallet-setting-sound-label" class="text-[9px] text-gray-300">On</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2">
            <span class="text-[10px] text-gray-400">Haptics (vibration):</span>
            <label class="inline-flex items-center gap-1.5 cursor-pointer">
              <input type="checkbox" id="wallet-setting-haptics" class="rounded border-2 border-gray-500 bg-black text-neon-cyan focus:ring-neon-cyan" checked />
              <span id="wallet-setting-haptics-label" class="text-[9px] text-gray-300">On</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2">
            <span class="text-[10px] text-gray-400">Reduced motion:</span>
            <label class="inline-flex items-center gap-1.5 cursor-pointer">
              <input type="checkbox" id="wallet-setting-reduced-motion" class="rounded border-2 border-gray-500 bg-black text-neon-cyan focus:ring-neon-cyan" />
              <span id="wallet-setting-reduced-motion-label" class="text-[9px] text-gray-300">Off</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2 pt-2">
            <span class="text-[10px] text-gray-400">Get latest version:</span>
            <button type="button" id="wallet-settings-reload-app" class="py-1.5 px-3 border-2 border-neon-yellow text-neon-yellow rounded text-[9px] hover:bg-neon-yellow/10">RELOAD APP</button>
          </div>
        </div>
      </div>
      <!-- Panel: Friends (hidden by default) -->
      <div class="settings-panel hidden" data-settings-panel="friends">
        <p class="text-gray-500 text-[9px] mb-2">Your code: <span id="referral-code" class="neon-text-cyan">------</span></p>
        <div class="mb-2 flex flex-col items-center">
          <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1">Scan to join with my code</div>
          <div id="friends-invite-qrcode" class="inline-block p-2 bg-white rounded border-2 border-gray-600 shrink-0 mb-2" aria-hidden="true"></div>
          <button type="button" id="friends-scan-qr-btn" class="py-1.5 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10 shrink-0" title="Scan a friend's invite QR">üì∑ Scan QR</button>
        </div>
        <button type="button" id="invite-btn" class="w-full py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 text-[10px] mb-2">COPY INVITE LINK</button>
        <p id="invite-feedback" class="text-neon-green text-[9px] mb-2 hidden">Link copied! Send to friends‚Äîwhen they open it, your code is applied.</p>
        <button type="button" id="share-game-btn" class="w-full py-2 px-4 border-2 border-neon-pink text-neon-pink rounded text-[10px] font-bold hover:bg-neon-pink/10 mb-2">COPY GAME LINK</button>
        <p id="share-game-feedback" class="text-neon-green text-[9px] mb-3 hidden">Link copied!</p>
        <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1">Your friends</div>
        <p class="text-gray-500 text-[8px] mb-1">People who used your link or you added by code. Tap DUEL to challenge. Star (‚òÜ/‚òÖ) to add favorite players‚Äîthey appear at the top.</p>
        <ol id="friends-invited-list" class="space-y-1 text-[10px] min-h-[24px] mb-2"><li class="text-gray-500">Loading‚Ä¶</li></ol>
        <ol id="friends-added-list" class="space-y-1 text-[10px] min-h-[24px] mb-3"><li class="text-gray-500">Loading‚Ä¶</li></ol>
        <div id="friend-requests-section" class="hidden mt-2 pt-2 border-t border-gray-800/60 mb-3">
          <div class="text-[9px] text-gray-500 uppercase tracking-wider">Pending requests</div>
          <p id="friend-request-feedback" class="text-[10px] mt-1 mb-1 min-h-[14px] px-2 py-1 rounded hidden"></p>
          <ol id="friend-requests-list" class="space-y-2 text-[10px] min-h-[24px]"></ol>
        </div>
        <div class="mb-3">
          <button type="button" id="friends-play-vs-computer-btn" class="w-full py-2 px-4 border-2 border-neon-yellow text-neon-yellow rounded text-[10px] hover:bg-neon-yellow/10">ENTER TRAINING</button>
        </div>
        <div class="pt-2 border-t border-gray-800/60">
          <div class="text-[9px] text-gray-500 mb-1">Add friend by invite code</div>
          <div class="flex gap-2 flex-wrap items-center">
            <input type="text" id="friend-code-input" placeholder="E.G. REFABC12" maxlength="20" class="flex-1 min-w-[100px] bg-black border-2 border-gray-600 rounded px-2 py-1.5 text-neon-cyan text-[10px] uppercase" />
            <button type="button" id="friend-code-add-btn" class="py-1.5 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10">ADD FRIEND</button>
          </div>
          <p id="friend-code-feedback" class="text-[9px] min-h-[14px] hidden"></p>
        </div>
      </div>
      <!-- Panel: Wallet (hidden by default) -->
      <div class="settings-panel hidden" data-settings-panel="wallet">
        <div class="mb-3">
          <p class="text-neon-cyan text-[10px] font-bold mb-2">WALLET STATUS</p>
          <p id="wallet-settings-connection" class="text-[9px] text-gray-400 mb-2">‚Äî</p>
        </div>
        <div class="pt-3 border-t border-gray-700">
          <p class="text-neon-cyan text-[10px] font-bold mb-2">WALLET HELP</p>
          <div class="p-2 rounded border-2 border-neon-green/50 bg-neon-green/5 mb-2">
            <p class="text-neon-green text-[9px] font-bold">üì± On phone</p>
            <p class="text-gray-300 text-[9px] mt-1">Open <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="text-neon-cyan underline">biggleem.github.io/nc-clicker-game-v1</a> in your browser. Tap CONNECT WALLET ‚Üí Tonkeeper opens ‚Üí Approve. No desktop needed.</p>
          </div>
          <p class="text-gray-400 text-[9px] mb-1">1) Tap CONNECT WALLET on the Wallet tab ‚Üí 2) Approve in Tonkeeper (green button) ‚Üí 3) Return here. If it didn't detect, tap below:</p>
          <button type="button" id="ton-check-connection-btn" class="w-full mt-2 py-2 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 font-bold">I APPROVED ‚Äì CHECK CONNECTION</button>
          <p class="text-neon-yellow text-[8px] mt-2">On desktop localhost: run the backend or use the <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="underline">live site</a>.</p>
        </div>
      </div>
      <!-- Panel: Info (hidden by default) -->
      <div class="settings-panel hidden" data-settings-panel="info">
        <div class="mb-3">
          <p class="text-neon-yellow text-[10px] font-bold mb-2">LEVELS & DEATH RULES</p>
          <p class="text-gray-400 text-[9px] mb-1">Levels (by total taps):</p>
          <ul class="text-gray-500 text-[8px] mb-2 space-y-0.5 list-none">
            <li>ü•ö Egg: 0</li>
            <li>üê£ Chick Lv.1‚Äì10: 1‚Äì99, 100‚Äì199, ‚Ä¶ 900‚Äì999</li>
            <li>üê¶ Adult Lv.1‚Äì10: 1,000‚Äì1,099, ‚Ä¶ 1,900‚Äì1,999</li>
            <li>üèÖ Elite Lv.1‚Äì10: 2,000‚Äì2,099, ‚Ä¶ 2,900‚Äì2,999</li>
            <li>üèÜ Legend Lv.1‚Äì10: 3,000+</li>
          </ul>
          <p class="text-gray-400 text-[9px] mb-1 mt-2">Click Trophies (badge above bird):</p>
          <ul class="text-gray-500 text-[8px] mb-2 space-y-0.5 list-none">
            <li>üß¢ Rookie: 0+ taps</li>
            <li>üé© Regular: 1,000+ taps</li>
            <li>üéì Graduate: 5,000+ taps</li>
            <li>ü™ñ Veteran: 15,000+ taps</li>
            <li>üëë Legend: 25,000+ taps</li>
          </ul>
          <p class="text-gray-400 text-[9px] mb-1">Death: If away &gt; 48 hours, your bird dies üïäÔ∏è</p>
          <p class="text-gray-400 text-[9px] mb-1">Revive: 10 tokens or 10% of balance (whichever is higher). A friend can send you tokens if you have none. Or wait 48 hours for the egg to hatch (free revive).</p>
        </div>
        <button type="button" id="wallet-settings-replay-intro" class="w-full py-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:bg-gray-700">REPLAY INTRO</button>
      </div>
      <!-- Close button (always visible) -->
      <button type="button" id="wallet-settings-modal-close" class="mt-4 w-full py-2 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CLOSE</button>
    </div>
  </div>
  <!-- Wallet: no wallet / connect help ‚Äì Back to game or open install in new tab -->
  <div id="wallet-connect-help-modal" class="hidden" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-2">CONNECT WALLET</p>
      <p class="text-gray-300 text-[9px] mb-3">Don't have Tonkeeper? Install or sign in opens in a new tab so you can keep playing here.</p>
      <div class="flex flex-col gap-2">
        <a id="wallet-help-download-link" href="https://tonkeeper.com" target="_blank" rel="noopener noreferrer" class="py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10">DOWNLOAD TONKEEPER (NEW TAB)</a>
        <button type="button" id="wallet-help-back-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">BACK TO GAME</button>
      </div>
    </div>
  </div>
  <!-- Death modal: bird died from inactivity, revive with tokens or wait 48h for egg hatch -->
  <div id="death-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Bird has died" style="position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-gray-600 rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-4xl mb-2">üïäÔ∏è</p>
      <p class="text-neon-yellow text-[10px] font-bold mb-2">YOUR BIRD DIED</p>
      <p class="text-gray-500 text-[8px] mb-1">Deaths: <span id="death-count">0</span></p>
      <p class="text-gray-300 text-[9px] mb-3">You were away too long. Revive with 10 tokens or 10% of balance ‚Äî or a friend can send you tokens. Or wait 48 hours for the egg to hatch (free).</p>
      <p id="death-revive-cost" class="text-neon-cyan text-[10px] mb-2">Revive cost: 10 tokens</p>
      <p id="death-balance" class="text-gray-500 text-[9px] mb-2">Your balance: 0 tokens</p>
      <p id="death-hatch-countdown" class="text-gray-500 text-[8px] mb-2 hidden"></p>
      <div class="flex gap-2 justify-center flex-wrap">
        <button type="button" id="death-revive-btn" class="py-2 px-5 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 font-bold disabled:opacity-50 disabled:cursor-not-allowed">REVIVE</button>
        <button type="button" id="death-hatch-btn" class="hidden py-2 px-5 border-2 border-neon-yellow text-neon-yellow rounded text-[10px] hover:bg-neon-yellow/10 font-bold">EGG HATCH</button>
        <a href="#bounties" id="death-earn-tokens" class="py-2 px-5 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">EARN TOKENS</a>
      </div>
      <p class="text-gray-600 text-[8px] mt-2">Rules in Wallet ‚Üí Settings</p>
    </div>
  </div>
  <!-- Share confirmation: proof user shared on platform -->
  <div id="share-confirm-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Share confirmation" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-2">SHARE CONFIRMATION</p>
      <p id="share-confirm-msg" class="text-gray-300 text-[9px] mb-4">Did you share the game?</p>
      <div class="flex gap-2 justify-center flex-wrap">
        <button type="button" id="share-confirm-yes" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">Yes, I shared</button>
        <button type="button" id="share-confirm-no" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">Not yet</button>
      </div>
    </div>
  </div>
  <!-- PVP Onboarding: name + enough in-game tokens for wager -->
  <div id="pvp-full-list-modal" class="hidden" role="dialog" aria-modal="true" aria-label="PVP leaderboard" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-pink rounded-lg p-4 max-w-sm w-full max-h-[80vh] flex flex-col">
      <p class="text-neon-pink text-[10px] font-bold mb-3">PVP DUEL WINS (TOP 100)</p>
      <ol id="pvp-full-list-content" class="space-y-1 text-[10px] list-decimal list-inside text-gray-300 overflow-y-auto flex-1 min-h-[120px]">
        <li class="text-gray-500">Loading‚Ä¶</li>
      </ol>
      <button type="button" id="pvp-full-list-modal-close" class="mt-3 py-2 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CLOSE</button>
    </div>
  </div>
  <!-- Friends modal: invite & requests (opened by FRIENDS button in header) -->
  <!-- Friends: scan QR to add friend by their invite code -->
  <div id="friends-scan-qr-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Scan QR code" style="position:fixed;inset:0;z-index:10004;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full">
      <div class="flex items-center justify-between gap-2 mb-2">
        <p class="text-neon-cyan text-[10px] font-bold">Scan friend's invite QR</p>
        <button type="button" id="friends-scan-qr-close" class="p-1.5 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" aria-label="Close">&#215;</button>
      </div>
      <p class="text-[9px] text-gray-400 mb-2">Point your camera at a friend's &quot;Scan to join with my code&quot; QR. Allow camera when prompted.</p>
      <div class="relative rounded overflow-hidden border-2 border-gray-600 bg-black mb-2" style="min-height:200px;">
        <video id="friends-scan-qr-video" class="w-full h-auto object-cover" playsinline muted autoplay></video>
        <canvas id="friends-scan-qr-canvas" class="hidden" width="320" height="240"></canvas>
        <p id="friends-scan-qr-status" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500 bg-black/70 p-2">Starting camera‚Ä¶</p>
      </div>
      <p id="friends-scan-qr-result" class="text-[9px] text-neon-green mb-2 hidden"></p>
      <div class="flex gap-2">
        <button type="button" id="friends-scan-qr-use-btn" class="flex-1 py-2 border-2 border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10 hidden">Use this code</button>
        <button type="button" id="friends-scan-qr-cancel" class="flex-1 py-2 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700">Cancel</button>
      </div>
    </div>
  </div>
  <!-- Create new room dialog: opened when clicking Duel or Create room (for both players) -->
  <div id="pvp-create-room-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Create room" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
    <div class="bg-pixel-panel border-2 border-neon-green/60 rounded-lg p-4 max-w-sm w-full my-4">
      <div class="flex items-center justify-between gap-2 mb-3 border-b border-gray-700 pb-2">
        <p id="pvp-create-modal-title" class="text-neon-green text-[10px] font-bold">‚ûï CREATE NEW ROOM</p>
        <button type="button" id="pvp-create-room-modal-close" class="p-1.5 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" aria-label="Close">‚úï</button>
      </div>
      <p id="pvp-create-modal-subtitle" class="text-gray-400 text-[9px] mb-2 hidden"></p>
      <p class="text-neon-yellow text-[9px] mb-2 font-medium">You must choose a wager to duel. Your opponent must agree to this amount to start.</p>
      <p class="text-gray-400 text-[9px] mb-2">You have <span id="pvp-create-balance" class="text-neon-cyan font-bold">0</span> tokens.</p>
      <p class="text-gray-500 text-[8px] mb-1 uppercase tracking-wider">Your wager (required)</p>
      <div class="flex flex-wrap gap-2 mb-2">
        <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-neon-green text-neon-green rounded text-[9px] bg-neon-green/10" data-stake="5">5</button>
        <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50" data-stake="2">2</button>
        <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50" data-stake="7">7</button>
        <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50" data-stake="10">10</button>
      </div>
      <p class="text-gray-500 text-[8px] mb-1">Or custom (tokens):</p>
      <div class="flex flex-wrap gap-2 items-center mb-3">
        <input type="number" id="pvp-custom-stake" min="1" max="999" placeholder="e.g. 20" class="w-16 bg-black border-2 border-gray-600 rounded px-2 py-1 text-[10px] text-white" aria-label="Custom wager" />
      </div>
      <p id="pvp-create-modal-error" class="text-neon-pink text-[9px] mt-2 hidden"></p>
      <div class="flex gap-2 mt-2">
        <button type="button" id="pvp-create-room-btn" class="flex-1 py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 min-h-[44px] disabled:opacity-50 disabled:pointer-events-none" aria-label="Create room with chosen wager">CREATE ROOM</button>
        <button type="button" id="pvp-create-room-modal-cancel" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CANCEL</button>
      </div>
    </div>
  </div>
  <!-- Customize quick buffs: reorder and add buffs to main clicker strip -->
  <div id="customize-buffs-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Customize buffs" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
    <div class="bg-pixel-panel border-2 border-neon-cyan/50 rounded-lg p-4 max-w-sm w-full my-4">
      <div class="flex items-center justify-between gap-2 mb-3 border-b border-gray-700 pb-2">
        <p class="text-neon-cyan text-[10px] font-bold">Customize quick buffs</p>
        <button type="button" id="customize-buffs-modal-close" class="p-1.5 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" aria-label="Close">‚úï</button>
      </div>
      <p class="text-gray-500 text-[9px] mb-2">Reorder or add buffs to the main page. Max 3 slots.</p>
      <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">In your strip (drag order)</div>
      <ul id="customize-buffs-list" class="space-y-1 mb-3 min-h-[60px]"></ul>
      <div class="text-[9px] text-gray-400 uppercase tracking-wider mb-1">Add a buff</div>
      <select id="customize-buffs-add-select" class="w-full bg-black border-2 border-gray-600 rounded px-2 py-1.5 text-[10px] text-white mb-2">
        <option value="">‚Äî Choose ‚Äî</option>
      </select>
      <p id="customize-buffs-msg" class="text-[9px] mb-2 min-h-[14px]" aria-live="polite"></p>
      <button type="button" id="customize-buffs-add-btn" class="w-full py-2 border-2 border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10 mb-3 disabled:opacity-50 disabled:pointer-events-none">ADD TO STRIP</button>
      <button type="button" id="customize-buffs-done" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10">DONE</button>
    </div>
  </div>
  <!-- Room settings: change room name, copy link (opened by cog on room card) -->
  <div id="room-settings-modal" class="hidden" role="dialog" aria-modal="true" aria-label="Room settings" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full">
      <div class="flex items-center justify-between gap-2 mb-3">
        <p class="text-neon-cyan text-[10px] font-bold">ROOM SETTINGS</p>
        <button type="button" id="room-settings-modal-close" class="p-1.5 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" aria-label="Close">&#215;</button>
      </div>
      <div class="space-y-3">
        <div>
          <label for="room-settings-name" class="block text-[9px] text-gray-400 uppercase tracking-wider mb-1">Room name</label>
          <input type="text" id="room-settings-name" maxlength="32" placeholder="e.g. Friday duel" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px]" />
          <p id="room-settings-name-hint" class="text-[8px] text-gray-500 mt-1">Shown on the room card. Leave blank to use room ID.</p>
        </div>
        <div class="flex gap-2 items-center">
          <button type="button" id="room-settings-save-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10">SAVE NAME</button>
          <span id="room-settings-save-status" class="text-[9px] text-neon-green min-h-[14px]"></span>
        </div>
        <div>
          <label class="block text-[9px] text-gray-400 uppercase tracking-wider mb-1">Invite link</label>
          <div class="flex items-center gap-2 flex-wrap">
            <input type="text" id="room-settings-link" readonly class="flex-1 min-w-0 bg-gray-900 border-2 border-gray-600 rounded px-2 py-1.5 text-[9px] text-gray-300" />
            <button type="button" id="room-settings-copy-btn" class="py-1.5 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10 shrink-0">COPY LINK</button>
          </div>
        </div>
        <div class="pt-2 border-t border-gray-700">
          <label class="block text-[9px] text-gray-400 uppercase tracking-wider mb-1">Boosts</label>
          <button type="button" id="room-settings-customize-boosts-btn" class="w-full py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10">CUSTOMIZE BOOSTS</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Scan QR modal: camera stream to fill Send recipient -->
  <div id="send-scan-qr-modal" class="hidden" style="position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full">
      <div class="flex items-center justify-between gap-2 mb-2">
        <p class="text-neon-cyan text-[10px] font-bold">Scan recipient QR code</p>
        <button type="button" id="send-scan-qr-close" class="p-1.5 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" aria-label="Close">&#215;</button>
      </div>
      <p class="text-[9px] text-gray-400 mb-2">Point your camera at a player's "Scan to send me tokens" QR. Allow camera access when prompted.</p>
      <div class="relative rounded overflow-hidden border-2 border-gray-600 bg-black mb-2" style="min-height:200px;">
        <video id="send-scan-qr-video" class="w-full h-auto object-cover" playsinline muted autoplay></video>
        <canvas id="send-scan-qr-canvas" class="hidden" width="320" height="240"></canvas>
        <p id="send-scan-qr-status" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500 bg-black/70 p-2">Starting camera‚Ä¶</p>
      </div>
      <p id="send-scan-qr-result" class="text-[9px] text-neon-green mb-2 hidden"></p>
      <div class="flex gap-2">
        <button type="button" id="send-scan-qr-approve-btn" class="flex-1 py-2 border-2 border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10 hidden">Use as recipient</button>
        <button type="button" id="send-scan-qr-cancel" class="flex-1 py-2 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700">Cancel</button>
      </div>
    </div>
  </div>
  <div id="pvp-onboarding-modal" class="hidden" role="dialog" aria-modal="true" aria-label="PVP setup" style="position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-pink rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-pink text-[10px] font-bold mb-3">JOIN PVP DUEL</p>
      <p id="pvp-onboarding-msg" class="text-gray-300 text-[9px] mb-4">Enter your name to play. You need enough in-game tokens for the room's wager.</p>
      <input type="text" id="pvp-onboarding-name" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <div id="pvp-onboarding-step-connect" class="hidden mb-3">
        <p class="text-neon-yellow text-[9px] mb-2">You need enough in-game tokens for the room's wager. Earn tokens by tapping or claiming bounties.</p>
        <a href="#wallet" class="inline-block py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px]">GO TO WALLET</a>
      </div>
      <div id="pvp-onboarding-step-card" class="hidden mb-3">
        <p class="text-neon-yellow text-[9px]">You need at least the room's wager in in-game tokens. Loser pays winner.</p>
      </div>
      <div class="flex gap-2 justify-center flex-wrap">
        <button type="button" id="pvp-onboarding-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE & CONTINUE</button>
        <button type="button" id="pvp-onboarding-skip" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">SKIP (lobby only)</button>
      </div>
    </div>
  </div>

  <div id="app" style="display:block;">
  <!-- Top Bar: logo, tokens, notifications, settings (nav is bottom bar only) -->
  <header class="sticky top-0 z-50 bg-black/90 border-b-2 border-pixel-border backdrop-blur-sm">
    <div class="max-w-lg mx-auto px-4 py-2 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <a href="#home" class="flex-shrink-0" aria-label="Home"><img src="assets/cardinal.png" alt="1N BLOCKCHAIN" class="h-8 md:h-9 object-contain object-left" /></a>
        <span class="text-gray-400 shrink-0">TOKENS</span>
        <span id="top-tokens" class="neon-text-cyan font-bold shrink-0" aria-live="polite" role="status">0</span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <a href="#multiplayer" class="p-2 rounded border-2 border-neon-pink text-neon-pink hover:shadow-neon-sm text-[10px]">PVP</a>
        <button type="button" id="notifications-btn" aria-label="Notifications" class="p-2 rounded border-2 border-gray-500 text-gray-400 hover:border-neon-yellow hover:text-neon-yellow">üîî</button>
        <button type="button" id="header-settings-btn" aria-label="Settings" class="p-2 rounded border-2 border-gray-500 text-gray-400 hover:border-neon-cyan hover:text-neon-cyan">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto pb-20">
    <!-- Home -->
    <section id="page-home" class="page active p-4">
      <!-- Metric windows above NFT -->
      <div class="grid grid-cols-3 gap-2 mb-4">
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 home-center-text">CLICK RATE</div>
          <div class="flex items-baseline justify-center gap-0.5">
            <span id="clicks-per-sec" class="neon-text-green home-center-value" title="Taps per second">0</span>
            <span class="text-[9px] text-gray-600">/s</span>
          </div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 home-center-text">TOTAL TAPS</div>
          <div id="total-clicks" class="neon-text-cyan home-center-value">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 home-center-text">PEAK</div>
          <div class="flex items-baseline justify-center gap-0.5">
            <span id="peak-click-rate" class="neon-text-pink home-center-value" title="Best taps in 1 sec">0</span>
            <span class="text-[9px] text-gray-600">/s</span>
          </div>
        </div>
      </div>
      <!-- Power bar: tap multiplier (Power 1x) left, bar right -->
      <div class="flex justify-center items-center gap-2 mb-3">
        <div class="bg-pixel-panel border-2 border-neon-yellow/40 rounded-lg px-3 py-2 flex items-center gap-2 shrink-0">
          <span class="text-[9px] text-gray-400 uppercase tracking-wider">Power</span>
          <span id="home-power" class="text-neon-yellow font-bold text-sm">1</span>
          <span class="text-gray-500 text-[10px]">x</span>
        </div>
        <div class="w-full max-w-sm md:max-w-md min-w-0">
          <p class="text-gray-500 text-[9px] mb-1 flex justify-between"><span>POWER</span><span id="power-numeric" class="text-neon-cyan/90">150 / 150</span></p>
          <div class="w-full h-3 bg-black border-2 border-gray-700 rounded overflow-hidden">
            <div id="power-bar-fill" class="h-full bg-gradient-to-r from-neon-cyan to-neon-green transition-all duration-75 ease-linear" style="width: 100%"></div>
          </div>
        </div>
      </div>
      <!-- NFT Clicker -->
      <div class="flex justify-center">
        <div class="relative inline-block">
          <div class="absolute top-1 left-1 z-10">
            <div class="badge-circle w-9 h-9 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel shadow-lg pointer-events-auto cursor-default" id="badge-1" title="Rookie" role="img" aria-label="Click trophy">üß¢</div>
          </div>
          <button
            type="button"
            id="nft-clicker"
            class="nft-clicker w-40 h-40 md:w-52 md:h-52 pixel-border rounded-lg bg-black/80 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden relative"
            aria-label="Click to earn tokens"
          >
            <img src="assets/cardinal.png" alt="NFT Cardinal" class="w-full h-full object-contain image-pixel" />
            <span id="bird-level-badge" class="absolute bottom-1 right-1 flex items-center gap-0.5 bg-black/80 rounded px-1 border border-gray-600" title="Level"><span class="text-base">ü•ö</span><span class="text-[8px] text-gray-400">Egg</span></span>
          </button>
        </div>
      </div>
      <!-- Stats bar: Rate and Auto in one line -->
      <div class="mt-4 flex flex-wrap justify-center items-center gap-2 home-center-text">
        <div class="bg-pixel-panel border-2 border-neon-cyan/40 rounded-lg px-3 py-2 flex items-center gap-2">
          <span class="text-[9px] text-gray-400 uppercase tracking-wider">Rate</span>
          <span class="text-[10px] text-gray-300">1 token /</span>
          <span id="home-token-rate" class="text-neon-cyan font-bold text-sm">10</span>
          <span class="text-gray-500 text-[10px]">taps</span>
        </div>
        <div class="bg-pixel-panel border-2 border-neon-green/40 rounded-lg px-3 py-2 flex items-center gap-2">
          <span class="text-[9px] text-gray-400 uppercase tracking-wider">Auto</span>
          <span id="home-regen" class="text-neon-green font-bold text-sm">0</span>
          <span class="text-gray-500 text-[10px]">/s</span>
        </div>
      </div>
      <div id="home-next-milestone" class="mt-1 text-[9px] text-gray-500 text-center min-h-[12px]"></div>
      <!-- Active buff: stays on main clicker page until buff(s) are over -->
      <div id="active-buff-panel" class="mt-3 p-3 rounded-lg border-2 border-neon-yellow/50 bg-neon-yellow/5 hidden">
        <p class="text-neon-yellow text-[10px] font-bold mb-1.5 text-center">üî• ACTIVE BUFF</p>
        <p id="buff-countdown" class="text-[9px] text-neon-yellow/90 text-center min-h-[14px]"></p>
      </div>
      <!-- Quick buffs: order and selection saved in localStorage. Customize to reorder or add. -->
      <div id="home-strip-cards" class="mt-4 grid grid-cols-3 gap-2"></div>
      <p class="mt-2 text-center">
        <button type="button" id="home-customize-buffs-btn" class="text-[9px] text-neon-cyan hover:underline">Customize</button>
        <span class="text-gray-500"> ¬∑ </span>
        <a href="#boosts" class="text-[9px] text-neon-cyan hover:underline">Get More Boosts ‚Üí</a>
      </p>
    </section>

    <!-- Boosts -->
    <section id="page-boosts" class="page p-4">
      <div class="pvp-invite-banner-inline hidden mb-4">
        <div class="bg-neon-cyan/20 border-2 border-neon-cyan rounded-lg p-3 flex items-center justify-between gap-3 shadow-lg">
          <div class="flex-1 min-w-0">
            <p class="text-neon-cyan text-[10px] font-bold">GAME ABOUT TO START</p>
            <p class="text-gray-300 text-[9px]">You're invited! Tap to join the duel.</p>
          </div>
          <button type="button" class="pvp-invite-banner-join-btn shrink-0 py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/20 bg-neon-green/10">JOIN NOW</button>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-2 mb-4 border-b-2 border-gray-700 pb-2">
        <h2 class="text-neon-cyan m-0">BOOSTS</h2>
        <button type="button" class="boost-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-yellow/50 hover:text-neon-yellow" data-boost-tab="active">üî• ACTIVE</button>
      </div>
      <p class="text-gray-400 mb-4">Spend tokens on click buffs, autoclickers, and cooldown reductions.</p>
      <!-- Tabs -->
      <div class="flex flex-wrap gap-1 mb-3 border-b-2 border-gray-700 pb-2">
        <button type="button" class="boost-tab-btn py-1.5 px-2.5 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] font-bold bg-neon-cyan/10" data-boost-tab="tappower">‚ö° TAP</button>
        <button type="button" class="boost-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50 hover:text-neon-green" data-boost-tab="autoclicker">üîã AUTO</button>
        <button type="button" class="boost-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-boost-tab="cooldown">‚ùÑÔ∏è COOL</button>
        <button type="button" class="boost-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-pink/50 hover:text-neon-pink" data-boost-tab="power">‚ö° POWER</button>
      </div>
      <p class="text-gray-500 text-[9px] mb-2">All boosts last 60s. Rebuy to extend. Max 2 active buffs.</p>
      <div class="space-y-4">
        <div id="boost-panel-tappower" class="boost-panel" data-boost-panel="tappower">
        <div class="boost-category">
          <div class="text-neon-yellow text-[10px] font-bold mb-2 uppercase tracking-wider">‚ö° Tap Power</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+1 token per 10 clicks (2x)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">50 tokens</div></div>
              <button type="button" id="buy-tappower" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="50" data-boost="tapPower">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+1 token per 10 clicks (3x)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">150 tokens</div></div>
              <button type="button" id="buy-tappower3" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="150" data-boost="tapPower3">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+1 token per 10 clicks (4x)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">350 tokens</div></div>
              <button type="button" id="buy-tappower4" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="350" data-boost="tapPower4">BUY</button>
            </div>
          </div>
        </div>
        </div>
        <div id="boost-panel-autoclicker" class="boost-panel hidden" data-boost-panel="autoclicker">
        <div class="boost-category">
          <div class="text-neon-green text-[10px] font-bold mb-2 uppercase tracking-wider">üîã Autoclickers</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Autoclicker (1/s)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">100 tokens</div></div>
              <button type="button" id="buy-autoclicker" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="100" data-boost="autoclicker">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Turbo Autoclicker (2/s)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">250 tokens</div></div>
              <button type="button" id="buy-turbo-autoclicker" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="250" data-boost="turboAutoclicker">BUY</button>
            </div>
          </div>
        </div>
        </div>
        <div id="boost-panel-cooldown" class="boost-panel hidden" data-boost-panel="cooldown">
        <div class="boost-category">
          <div class="text-neon-cyan text-[10px] font-bold mb-2 uppercase tracking-wider">‚ôªÔ∏è Cooldowns</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Shorter cooldown (200ms)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">75 tokens</div></div>
              <button type="button" id="buy-cooldown" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="75" data-boost="cooldown">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Super cooldown (150ms)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">150 tokens</div></div>
              <button type="button" id="buy-super-cooldown" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="150" data-boost="superCooldown">BUY</button>
            </div>
          </div>
        </div>
        </div>
        <div id="boost-panel-power" class="boost-panel hidden" data-boost-panel="power">
        <div class="boost-category">
          <div class="text-neon-pink text-[10px] font-bold mb-2 uppercase tracking-wider">‚ö° Power Bar</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+50 power capacity</span><div class="text-neon-yellow text-[10px] font-bold mt-1">100 tokens</div></div>
              <button type="button" id="buy-power-capacity" class="boost-btn border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="100" data-boost="powerCapacity">BUY</button>
            </div>
          </div>
        </div>
        </div>
        <div id="boost-panel-active" class="boost-panel hidden" data-boost-panel="active">
        <div class="boost-category">
          <div class="text-neon-yellow text-[10px] font-bold mb-2 uppercase tracking-wider">üî• Active buffs (max 2)</div>
          <p class="text-gray-500 text-[9px] mb-2">Cooldown starts when buff ends. Combo &amp; Crit are passive.</p>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-neon-yellow/50 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>‚ö° Frenzy (tap x3, auto x2) 10s</span><div class="text-neon-yellow text-[10px] font-bold mt-1">80 tokens</div></div>
              <button type="button" class="boost-btn border-2 border-neon-yellow text-neon-yellow px-3 py-1 rounded text-[10px] hover:bg-neon-yellow/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="80" data-boost="frenzy">USE</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>üí• Overcharge (overcap power, 20%/s drain) 15s</span><div class="text-neon-yellow text-[10px] font-bold mt-1">60 tokens</div></div>
              <button type="button" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="60" data-boost="overcharge">USE</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>üßø Token Magnet +35% drops 2m</span><div class="text-neon-yellow text-[10px] font-bold mt-1">100 tokens</div></div>
              <button type="button" class="boost-btn border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="100" data-boost="tokenMagnet">USE</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>üõ° Shield (no combo loss) 60s</span><div class="text-neon-yellow text-[10px] font-bold mt-1">90 tokens</div></div>
              <button type="button" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="90" data-boost="shield">USE</button>
            </div>
            <div class="bg-pixel-panel border-2 border-neon-pink/50 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>üß® Burn (tap x5, power drains 3x) 12s</span><div class="text-neon-yellow text-[10px] font-bold mt-1">70 tokens</div></div>
              <button type="button" class="boost-btn border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="70" data-boost="burn">USE</button>
            </div>
          </div>
        </div>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Your balance: <span id="boosts-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Bounties -->
    <section id="page-bounties" class="page p-4">
      <div class="pvp-invite-banner-inline hidden mb-4">
        <div class="bg-neon-cyan/20 border-2 border-neon-cyan rounded-lg p-3 flex items-center justify-between gap-3 shadow-lg">
          <div class="flex-1 min-w-0">
            <p class="text-neon-cyan text-[10px] font-bold">GAME ABOUT TO START</p>
            <p class="text-gray-300 text-[9px]">You're invited! Tap to join the duel.</p>
          </div>
          <button type="button" class="pvp-invite-banner-join-btn shrink-0 py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/20 bg-neon-green/10">JOIN NOW</button>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-2 mb-4 border-b-2 border-gray-700 pb-2">
        <h2 class="text-neon-green m-0">BOUNTIES</h2>
        <div class="flex gap-2">
          <button type="button" id="bounty-tab-toclaim" class="bounty-tab border-2 border-neon-green text-neon-green px-3 py-1.5 rounded text-[10px] hover:bg-neon-green/10 bg-neon-green/10">Available</button>
          <button type="button" id="bounty-tab-claimed" class="bounty-tab border-2 border-gray-500 text-gray-400 px-3 py-1.5 rounded text-[10px] hover:bg-gray-700">Claimed</button>
        </div>
      </div>
      <p class="text-gray-400 mb-4">Daily rewards, weekly challenges, click milestones. Collect the bird cards!</p>
      <div id="graduating-bounty-bar" class="mb-3 p-3 bg-black border-2 border-neon-green/50 rounded text-[9px]">
        <div class="text-neon-green font-bold mb-1">ACTIVE & NEXT BOUNTY</div>
        <div id="grad-current" class="text-gray-300">Active: 500 taps ‚Äî 0/500 ¬∑ 15 tokens</div>
        <div id="grad-next" class="text-gray-500">Next: 1,000 taps ‚Äî 0/1,000 ¬∑ 25 tokens</div>
      </div>
      <div id="bounty-category-tabs" class="flex flex-wrap gap-2 mb-3">
        <button type="button" class="bounty-category-tab py-1.5 px-2.5 border-2 border-neon-green text-neon-green rounded text-[9px] font-bold bg-neon-green/10" data-bounty-category="daily">üìÖ Daily</button>
        <button type="button" class="bounty-category-tab py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-bounty-category="graduating">üìà Graduating</button>
        <button type="button" class="bounty-category-tab py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-yellow/50 hover:text-neon-yellow" data-bounty-category="fun">üéØ Fun</button>
        <button type="button" class="bounty-category-tab py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-pink/50 hover:text-neon-pink" data-bounty-category="highroller">üí∞ High Roller</button>
      </div>
      <div class="space-y-3 hidden" id="bounties-list">
        <!-- Daily Bounties -->
        <div class="bounty-category bounty-category-panel" data-bounty-category="daily">
          <div class="bounty-category-title">Daily Bounties</div>
          <div class="space-y-3">
        <div id="bounty-daily" class="bounty-row bounty-card-yellow p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="daily" data-bounty-name="Daily login" data-bounty-reward="5">
          <div class="flex-1 min-w-0"><div>Daily login</div><div class="text-[10px] text-gray-400">Claim once per day</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 5 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-yellow"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-daily" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="daily" data-reward="5">CLAIM</button>
          </div>
        </div>
        <div id="bounty-50today" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="50today" data-bounty-name="50 taps today" data-bounty-reward="5">
          <div class="flex-1 min-w-0"><div>50 taps today</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-50-progress">0</span>/50</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 5 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-50" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="50today" data-reward="5">CLAIM</button>
          </div>
        </div>
        <div id="bounty-100" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="100today" data-bounty-name="100 clicks today" data-bounty-reward="10">
          <div class="flex-1 min-w-0"><div>100 clicks today</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-100-progress">0</span>/100</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 10 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-100" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="100today" data-reward="10">CLAIM</button>
          </div>
        </div>
        <div id="bounty-weekly" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="weekly" data-bounty-name="Weekly 500" data-bounty-reward="50">
          <div class="flex-1 min-w-0"><div>Weekly: 500 clicks</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-weekly-progress">0</span>/500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 50 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-weekly" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="weekly" data-reward="50">CLAIM</button>
          </div>
        </div>
        <div id="bounty-share" class="bounty-row bounty-card-cyan p-3 flex flex-col gap-2" data-bounty-id="share" data-bounty-name="Share the game" data-bounty-reward="15">
          <div class="flex flex-wrap justify-between items-center gap-2">
            <div class="flex-1 min-w-0"><div>Share the game</div><div class="text-[10px] text-gray-400">Share via X, Telegram, Facebook, email, or SMS once per day</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 15 tokens</div></div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <div class="bounty-bird-card bird-cyan"><img src="assets/cardinal.png" alt="" /></div>
              <button type="button" id="claim-share" class="bounty-claim border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50" data-id="share" data-reward="15">CLAIM</button>
            </div>
          </div>
          <div class="flex flex-wrap gap-1.5 pt-1 border-t border-gray-700/50">
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="x" title="Share on X">ùïè</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="telegram" title="Share on Telegram">Telegram</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="facebook" title="Share on Facebook">Facebook</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="email" title="Share via Email">Email</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="sms" title="Share via SMS">SMS</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="copy" title="Copy link">Copy</button>
          </div>
        </div>
          </div>
        </div>
        <!-- Graduating Bounties -->
        <div class="bounty-category bounty-category-panel hidden" data-bounty-category="graduating">
          <div class="bounty-category-title">Graduating Bounties</div>
          <div class="space-y-3">
        <div id="bounty-500" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="500total" data-bounty-name="500 taps" data-bounty-reward="15">
          <div class="flex-1 min-w-0"><div>500 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-500-progress">0</span>/500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 15 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-500" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="500total" data-reward="15">CLAIM</button>
          </div>
        </div>
        <div id="bounty-1000" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="1000total" data-bounty-name="1,000 taps" data-bounty-reward="25">
          <div class="flex-1 min-w-0"><div>1,000 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-1000-progress">0</span>/1,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 25 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-1000" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="1000total" data-reward="25">CLAIM</button>
          </div>
        </div>
        <div id="bounty-2500" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="2500total" data-bounty-name="2,500 taps" data-bounty-reward="50">
          <div class="flex-1 min-w-0"><div>2,500 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-2500-progress">0</span>/2,500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 50 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-2500" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="2500total" data-reward="50">CLAIM</button>
          </div>
        </div>
        <div id="bounty-5000" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="5000total" data-bounty-name="5,000 taps" data-bounty-reward="100">
          <div class="flex-1 min-w-0"><div>5,000 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-5000-progress">0</span>/5,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 100 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-5000" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="5000total" data-reward="100">CLAIM</button>
          </div>
        </div>
        <div id="bounty-10000" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="10000total" data-bounty-name="10,000 taps" data-bounty-reward="200">
          <div class="flex-1 min-w-0"><div>10,000 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-10000-progress">0</span>/10,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 200 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-10000" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="10000total" data-reward="200">CLAIM</button>
          </div>
        </div>
          </div>
        </div>
        <!-- Fun Bounties -->
        <div class="bounty-category bounty-category-panel hidden" data-bounty-category="fun">
          <div class="bounty-category-title">Fun Bounties</div>
          <div class="space-y-3">
        <div id="bounty-firstfriend" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="firstfriend" data-bounty-name="First friend" data-bounty-reward="10">
          <div class="flex-1 min-w-0"><div>Add your first friend</div><div class="text-[10px] text-gray-400">Paste a friend's code or link</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 10 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-firstfriend" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="firstfriend" data-reward="10">CLAIM</button>
          </div>
        </div>
        <div id="bounty-lucky7" class="bounty-row bounty-card-yellow p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="lucky777" data-bounty-name="Lucky 777" data-bounty-reward="17">
          <div class="flex-1 min-w-0"><div>Lucky 777</div><div class="text-[10px] text-gray-400">Reach 777 total taps</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 17 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-yellow"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-lucky7" class="bounty-claim border-2 border-neon-yellow text-neon-yellow px-3 py-1 rounded text-[10px] hover:bg-neon-yellow/10 disabled:opacity-50" data-id="lucky777" data-reward="17">CLAIM</button>
          </div>
        </div>
        <div id="bounty-clickmaster" class="bounty-row bounty-card-yellow p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="clickmaster" data-bounty-name="Click master" data-bounty-reward="12">
          <div class="flex-1 min-w-0"><div>Click master</div><div class="text-[10px] text-gray-400">Hit 5+ taps in one second. Best: <span id="bounty-clickmaster-peak">0</span>/s</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 12 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-yellow"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-clickmaster" class="bounty-claim border-2 border-neon-yellow text-neon-yellow px-3 py-1 rounded text-[10px] hover:bg-neon-yellow/10 disabled:opacity-50" data-id="clickmaster" data-reward="12">CLAIM</button>
          </div>
        </div>
        <div id="bounty-speed" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="speeddemon" data-bounty-name="Speed demon" data-bounty-reward="20">
          <div class="flex-1 min-w-0"><div>Speed demon</div><div class="text-[10px] text-gray-400">Hit 8+ taps in one second</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 20 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-speed" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="speeddemon" data-reward="20">CLAIM</button>
          </div>
        </div>
        <div id="bounty-hoarder" class="bounty-row bounty-card-cyan p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="hoarder" data-bounty-name="Token hoarder" data-bounty-reward="25">
          <div class="flex-1 min-w-0"><div>Token hoarder</div><div class="text-[10px] text-gray-400">Reach 100 tokens balance</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 25 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-cyan"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-hoarder" class="bounty-claim border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50" data-id="hoarder" data-reward="25">CLAIM</button>
          </div>
        </div>
          </div>
        </div>
        <!-- High Roller Bounties -->
        <div class="bounty-category bounty-category-panel hidden" data-bounty-category="highroller">
          <div class="bounty-category-title">High Roller</div>
          <div class="space-y-3">
        <div id="bounty-500balance" class="bounty-row bounty-card-cyan p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="500balance" data-bounty-name="500 tokens" data-bounty-reward="20">
          <div class="flex-1 min-w-0"><div>500 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-500balance-progress">0</span>/500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 20 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-cyan"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-500balance" class="bounty-claim border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50" data-id="500balance" data-reward="20">CLAIM</button>
          </div>
        </div>
        <div id="bounty-1000balance" class="bounty-row bounty-card-cyan p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="1000balance" data-bounty-name="1,000 tokens" data-bounty-reward="35">
          <div class="flex-1 min-w-0"><div>1,000 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-1000balance-progress">0</span>/1,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 35 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-cyan"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-1000balance" class="bounty-claim border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50" data-id="1000balance" data-reward="35">CLAIM</button>
          </div>
        </div>
        <div id="bounty-2500balance" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="2500balance" data-bounty-name="2,500 tokens" data-bounty-reward="75">
          <div class="flex-1 min-w-0"><div>2,500 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-2500balance-progress">0</span>/2,500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 75 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-2500balance" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="2500balance" data-reward="75">CLAIM</button>
          </div>
        </div>
        <div id="bounty-5000balance" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="5000balance" data-bounty-name="5,000 tokens" data-bounty-reward="150">
          <div class="flex-1 min-w-0"><div>5,000 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-5000balance-progress">0</span>/5,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 150 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-5000balance" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="5000balance" data-reward="150">CLAIM</button>
          </div>
        </div>
        <div id="bounty-10000balance" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="10000balance" data-bounty-name="10,000 tokens" data-bounty-reward="300">
          <div class="flex-1 min-w-0"><div>10,000 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-10000balance-progress">0</span>/10,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 300 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-10000balance" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="10000balance" data-reward="300">CLAIM</button>
          </div>
        </div>
        <div id="bounty-25000balance" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="25000balance" data-bounty-name="25,000 tokens" data-bounty-reward="500">
          <div class="flex-1 min-w-0"><div>25,000 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-25000balance-progress">0</span>/25,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 500 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-25000balance" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="25000balance" data-reward="500">CLAIM</button>
          </div>
        </div>
        <div id="bounty-50000balance" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="50000balance" data-bounty-name="50,000 tokens" data-bounty-reward="1000">
          <div class="flex-1 min-w-0"><div>50,000 tokens balance</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-50000balance-progress">0</span>/50,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 1,000 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-50000balance" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="50000balance" data-reward="1000">CLAIM</button>
          </div>
        </div>
          </div>
        </div>
      </div>
      <div id="bounties-toclaim-cards" class="hidden grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
      <p id="bounties-toclaim-empty" class="hidden text-gray-500 text-[10px] py-4">All bounties claimed! Check Claimed for your collection.</p>
      <div id="bounties-claimed-cards" class="hidden grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
      <p id="bounties-claimed-category-empty" class="hidden text-gray-500 text-[10px] py-4">No claimed bounties in this category.</p>
      <p id="bounties-claimed-empty" class="hidden text-gray-500 text-[10px] py-4">No claimed bounties yet. Claim bounties from the Available tab!</p>
      <p class="text-gray-500 mt-4 text-[10px]">Balance: <span id="bounties-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Wallet -->
    <section id="page-wallet" class="page p-4">
      <div class="pvp-invite-banner-inline hidden mb-4">
        <div class="bg-neon-cyan/20 border-2 border-neon-cyan rounded-lg p-3 flex items-center justify-between gap-3 shadow-lg">
          <div class="flex-1 min-w-0">
            <p class="text-neon-cyan text-[10px] font-bold">GAME ABOUT TO START</p>
            <p class="text-gray-300 text-[9px]">You're invited! Tap to join the duel.</p>
          </div>
          <button type="button" class="pvp-invite-banner-join-btn shrink-0 py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/20 bg-neon-green/10">JOIN NOW</button>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-2 mb-4 border-b-2 border-gray-700 pb-2">
        <h2 class="text-neon-yellow m-0">WALLET</h2>
        <button type="button" id="wallet-header-connect-btn" class="wallet-header-connect-btn py-1.5 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] font-medium hover:bg-neon-cyan/10 shrink-0">üîó Connect</button>
      </div>
      <p class="text-gray-400 text-[10px] mb-3">Connect your wallet to buy more tokens and boosts with $CARD.</p>
      <!-- Wallet tabs -->
      <div class="flex flex-wrap gap-1 mb-3 border-b-2 border-gray-700 pb-2">
        <button type="button" class="wallet-tab-btn py-1.5 px-2.5 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] font-bold bg-neon-cyan/10" data-wallet-tab="balance">üí∞ Balance</button>
        <button type="button" class="wallet-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50 hover:text-neon-green" data-wallet-tab="swap">‚Üî SWAP</button>
        <button type="button" class="wallet-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-pink/50 hover:text-neon-pink" data-wallet-tab="withdraw">‚Üë Withdraw</button>
        <button type="button" class="wallet-tab-btn py-1.5 px-2.5 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-yellow/50 hover:text-neon-yellow" data-wallet-tab="send">‚ûú Send</button>
      </div>
      <!-- Balance -->
      <div id="wallet-panel-balance" class="wallet-panel" data-wallet-panel="balance">
        <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
          <div class="grid grid-cols-2 gap-4 text-center">
            <div>
              <div class="text-gray-500 text-[10px]">IN-GAME WALLET</div>
              <div id="wallet-balance" class="text-xl neon-text-cyan">0</div>
              <div class="text-gray-500 text-[9px]">tokens</div>
              <div class="text-gray-600 text-[8px] mt-0.5">Earn by tapping & bounties. Use for Boosts & PVP.</div>
            </div>
            <div>
              <div class="text-gray-500 text-[10px]">$CARD (on-chain)</div>
              <div id="card-balance" class="text-xl neon-text-cyan">‚Äî</div>
              <div class="text-gray-500 text-[9px]" id="wallet-config-hint">connect wallet</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Connect -->
      <div id="wallet-panel-connect" class="wallet-panel hidden" data-wallet-panel="connect">
        <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
          <div class="text-gray-500 text-[10px] mb-2">TON WALLET</div>
          <p id="wallet-file-warning" class="hidden text-neon-yellow text-[9px] mb-2 p-2 bg-black/50 rounded">Wallet needs the game opened from a URL. Run in project folder: <code class="text-[8px]">npx serve -p 3001</code> then open <code class="text-[8px]">http://localhost:3001</code></p>
          <div id="wallet-connect-area">
            <p id="wallet-connection-status" class="text-[9px] min-h-[14px] mb-2 text-gray-400"></p>
            <p class="text-gray-500 text-[8px] mb-1">Opens in a new tab so you can stay in the game. Return here after approving.</p>
            <button type="button" id="ton-connect-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 text-[10px]">CONNECT WALLET (Tonkeeper / Telegram)</button>
            <p class="text-gray-500 text-[9px] mt-2">Need help? <button type="button" id="wallet-need-help-btn" class="text-neon-cyan underline hover:no-underline">Open SETTINGS</button> for instructions and I approved ‚Äì check connection.</p>
            <p class="text-neon-yellow text-[9px] mt-1 hidden" id="wallet-localhost-hint">On desktop localhost: run the backend so the wallet can connect. Or use the <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="underline">live site</a>.</p>
          </div>
          <div id="wallet-connected-area" class="hidden">
            <div class="text-[10px] text-gray-400 mb-1">Address</div>
            <div id="ton-address" class="text-neon-green text-[10px] break-all mb-2">‚Äî</div>
            <button type="button" id="ton-disconnect-btn" class="py-1 px-2 border border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-800">DISCONNECT</button>
          </div>
        </div>
      </div>
      <!-- Swap -->
      <div id="wallet-panel-swap" class="wallet-panel hidden" data-wallet-panel="swap">
        <div class="bg-pixel-panel border-2 border-neon-green/30 p-4 rounded mb-4" id="swap-area">
          <div class="flex items-center justify-between gap-2 mb-2">
            <span class="text-gray-500 text-[10px]">SWAP $CARD ‚Üí TOKENS</span>
            <span id="ton-price-display" class="text-[9px] text-gray-400">TON: ‚Äî</span>
          </div>
          <p class="text-[10px] text-gray-400 mb-2">Exchange on-chain $CARD for in-game tokens to buy boosts and play.</p>
          <div class="flex gap-2 items-center flex-wrap">
            <input type="number" id="swap-amount" min="1" step="1" placeholder="$CARD amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-28 text-[10px]" />
            <button type="button" id="swap-btn" class="border-2 border-neon-green text-neon-green px-3 py-2 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50">SWAP</button>
          </div>
          <p class="text-gray-500 text-[9px] mt-1">Rate: 1 $CARD = 10 in-game tokens</p>
          <p id="swap-preview" class="text-neon-yellow text-[9px] mt-0.5 hidden">You get ~<span id="swap-preview-value">0</span> tokens</p>
          <p id="swap-feedback" class="text-[10px] mt-2 hidden"></p>
        </div>
      </div>
      <!-- Withdraw -->
      <div id="wallet-panel-withdraw" class="wallet-panel hidden" data-wallet-panel="withdraw">
        <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4" id="withdraw-area">
          <div class="text-gray-500 text-[10px] mb-2">WITHDRAW TOKENS ‚Üí $CARD</div>
          <p id="withdraw-area-hint" class="text-[10px] text-gray-400 mb-2">Convert in-game tokens to on-chain $CARD (sent to your connected wallet).</p>
          <div class="flex gap-2 items-center flex-wrap">
            <input type="number" id="withdraw-amount" min="1" placeholder="Amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-24 text-[10px]" />
            <button type="button" id="withdraw-max-btn" class="border-2 border-gray-500 text-gray-400 px-2 py-2 rounded text-[9px] hover:bg-gray-700 hover:border-gray-400">MAX</button>
            <button type="button" id="withdraw-btn" class="border-2 border-neon-green text-neon-green px-3 py-2 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50">WITHDRAW</button>
          </div>
          <p id="withdraw-feedback" class="text-[10px] mt-2 hidden"></p>
        </div>
      </div>
      <!-- Send: in-game tokens to another player's wallet -->
      <div id="wallet-panel-send" class="wallet-panel hidden" data-wallet-panel="send">
        <div class="bg-pixel-panel border-2 border-neon-yellow/30 p-4 rounded mb-4" id="send-area">
          <div class="text-gray-500 text-[10px] mb-2">SEND TOKENS TO PLAYER</div>
          <p class="text-[10px] text-gray-400 mb-2">Send in-game tokens to another player. Enter their TON wallet address or their internal wallet code (e.g. REFABC123). They must have opened the game at least once.</p>
          <div class="mb-3 p-2 rounded border-2 border-neon-cyan/40 bg-black/40">
            <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1">Your internal wallet code</div>
            <p class="text-[9px] text-gray-400 mb-1">Share this code so others can send you tokens. They enter it in the recipient field below.</p>
            <div class="flex items-center gap-2 flex-wrap">
              <code id="send-my-wallet-code" class="flex-1 min-w-0 text-neon-cyan text-[11px] font-mono break-all">‚Äî</code>
              <button type="button" id="send-copy-my-code-btn" class="shrink-0 py-1.5 px-2 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10">COPY</button>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-700">
              <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1 text-center">Scan to send me tokens</div>
              <div class="flex items-center justify-center gap-3 flex-wrap">
                <div id="send-qrcode-container" class="inline-block p-2 bg-white rounded border-2 border-gray-600 shrink-0" aria-hidden="true"></div>
                <div class="flex flex-col justify-center items-center min-w-0">
                  <span class="text-[9px] text-gray-500 uppercase tracking-wider">Your balance</span>
                  <span id="send-qr-balance" class="text-neon-cyan text-2xl font-bold font-mono">0</span>
                  <span class="text-[9px] text-gray-500">tokens</span>
                </div>
              </div>
            </div>
            <div class="mt-2 flex justify-end">
              <button type="button" id="send-scan-qr-btn" class="shrink-0 py-2 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10" title="Scan QR code to fill recipient">üì∑ Scan QR</button>
            </div>
          </div>
          <div class="mb-3">
            <div class="flex items-center justify-between gap-2 mb-1">
              <span class="text-[9px] text-gray-500 uppercase tracking-wider">Players you can send to</span>
              <button type="button" id="send-refresh-players-btn" class="py-1 px-2 border border-gray-500 text-gray-400 rounded text-[8px] hover:bg-gray-700">REFRESH</button>
            </div>
            <div id="send-players-list" class="flex flex-col gap-1.5 min-h-[32px] max-h-48 overflow-y-auto p-1 rounded border border-gray-700 bg-black/40">
              <span class="text-[9px] text-gray-500">Tap a player to fill recipient.</span>
            </div>
          </div>
          <div class="flex gap-2 items-center flex-wrap">
            <input type="number" id="send-amount" min="1" placeholder="Amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-24 text-[10px]" />
            <button type="button" id="send-max-btn" class="border-2 border-gray-500 text-gray-400 px-2 py-2 rounded text-[9px] hover:bg-gray-700 hover:border-gray-400">MAX</button>
          </div>
          <div class="space-y-2 mt-2 mb-2">
            <label class="text-[9px] text-gray-500 uppercase tracking-wider block">Recipient: wallet address or internal wallet code</label>
            <div class="flex gap-2 items-center">
              <input type="text" id="send-to-address" placeholder="UQBH... or REFABC123" class="flex-1 min-w-0 bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan text-[10px] font-mono" spellcheck="false" />
              <button type="button" id="send-tokens-btn" class="shrink-0 border-2 border-neon-yellow text-neon-yellow px-3 py-2 rounded text-[10px] hover:bg-neon-yellow/10 disabled:opacity-50">SEND</button>
            </div>
          </div>
          <p id="send-feedback" class="text-[10px] mt-2 hidden"></p>
          <div class="mt-4 pt-3 border-t border-gray-700">
            <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-2">Recent sends (wallet transactions)</div>
            <div id="send-transactions-list" class="min-h-[24px] max-h-40 overflow-y-auto p-2 rounded border border-gray-700 bg-black/40 text-[10px] text-gray-400">
              <span class="text-gray-500">Loading‚Ä¶</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Backend / Admin (black square); shown when backendUrl is set -->
      <div id="wallet-backend-square" class="bg-black border-2 border-gray-700 p-4 rounded mb-4 hidden">
        <p class="text-gray-500 text-[9px] mb-2">BACKEND</p>
        <div class="flex flex-wrap gap-2">
          <a id="wallet-backend-link" href="#" target="_blank" rel="noopener noreferrer" class="py-2 px-3 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-800 hover:text-white">OPEN BACKEND</a>
          <a id="wallet-admin-setup-link" href="#" target="_blank" rel="noopener noreferrer" class="py-2 px-3 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-800 hover:text-white">ADMIN SETUP</a>
        </div>
      </div>
    </section>

    <!-- Multiplayer -->
    <section id="page-multiplayer" class="page p-4">
      <div class="flex items-center justify-between gap-2 mb-4 border-b-2 border-gray-700 pb-2">
        <h2 class="text-neon-pink">MULTIPLAYER</h2>
      </div>
      <p class="text-gray-400 mb-4">Share the game. When friends open the link on their phone, they can play and challenge you.</p>
      <!-- PVP leaderboard: wins and tokens won from duels -->
      <div class="bg-pixel-panel border-2 border-neon-pink/30 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-1">PVP DUEL WINS (TOP 5)</div>
        <p class="text-[9px] text-gray-500 mb-2">Wins and total tokens won from wagers.</p>
        <div id="leaderboard-pvp-list-wrapper" class="min-h-[24px] overflow-x-auto">
          <table id="leaderboard-pvp-list" class="w-full text-[10px] text-gray-300 border-collapse" aria-label="PVP duel wins top 5">
            <thead>
              <tr class="text-left border-b border-gray-600">
                <th class="py-1.5 px-2 text-gray-500 font-medium">Rank</th>
                <th class="py-1.5 px-2 text-gray-500 font-medium">Username</th>
                <th class="py-1.5 px-2 text-gray-500 font-medium">Wins</th>
                <th class="py-1.5 px-2 text-gray-500 font-medium">Tokens won</th>
              </tr>
            </thead>
            <tbody id="leaderboard-pvp-tbody">
              <tr><td colspan="4" class="py-2 px-2 text-gray-500">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <button type="button" id="pvp-full-list-btn" class="mt-2 py-1.5 px-3 border-2 border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10">VIEW FULL LIST</button>
      </div>
      <!-- Player row above Create room: first friend (favorites first) for quick duel -->
      <div id="pvp-player-row-above-create" class="bg-pixel-panel border-2 border-gray-700 rounded-lg mb-3 overflow-hidden hidden" data-friend-ref="" data-friend-name="">
        <div class="flex flex-wrap items-center gap-2 p-3 border-b border-gray-700/50">
          <span class="flex-1 min-w-0">
            <span class="text-white text-[10px] font-bold">1.</span>
            <span id="pvp-player-row-name" class="text-white text-[10px] font-bold ml-1">‚Äî</span>
            <span id="pvp-player-row-tokens" class="block mt-0.5 text-neon-yellow text-[10px] font-bold">0 tokens</span>
          </span>
          <span class="flex gap-1 shrink-0 items-center">
            <button type="button" id="pvp-player-row-favorite-btn" class="pvp-player-row-star py-1 px-1.5 border border-neon-yellow rounded text-[10px] text-gray-500 hover:text-neon-yellow hover:bg-neon-yellow/10" title="Add to favorites" aria-label="Add to favorites">‚òÜ</button>
            <button type="button" id="pvp-player-row-duel-btn" class="py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10">DUEL</button>
            <button type="button" id="pvp-player-row-remove-btn" class="py-1 px-2 border border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10">REMOVE</button>
          </span>
        </div>
      </div>
      <!-- Create room (primary action) -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded-lg mb-4">
        <p class="text-[9px] text-gray-500 mb-2">Set a wager and create a room. Share the link ‚Äî the game starts when your opponent joins.</p>
        <button type="button" id="pvp-open-create-room-btn" class="w-full py-3 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/10 min-h-[48px]">CREATE ROOM</button>
      </div>
      <!-- Open rooms: tap to join -->
      <div class="mb-4">
        <div class="flex items-center justify-between gap-2 mb-2">
          <p class="text-[10px] text-gray-500">OPEN ROOMS ‚Äî tap to join</p>
          <button type="button" id="pvp-refresh-btn" class="py-1.5 px-3 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700">REFRESH</button>
        </div>
        <p id="pvp-status" class="text-[9px] text-gray-500 mb-1 min-h-[14px]"></p>
        <div id="pvp-rooms-list" class="grid grid-cols-1 gap-2">
          <!-- Rooms loaded from Supabase -->
        </div>
        <p id="pvp-error" class="text-neon-pink text-[9px] mt-2 hidden"></p>
      </div>
      <!-- Invited to duel: shown when URL has ?room= (open room link). Whole card is clickable to join. -->
      <div id="pvp-invited-card" class="hidden mb-4 p-4 rounded-lg border-2 border-neon-cyan bg-neon-cyan/5 cursor-pointer hover:bg-neon-cyan/10 transition-colors select-none" role="button" tabindex="0" aria-label="Join duel invitation">
        <p class="text-neon-cyan text-[10px] font-bold mb-1">YOU‚ÄôRE INVITED TO A DUEL</p>
        <p class="text-gray-300 text-[9px] mb-3">Open this link to join the room and play. Enter your name and have enough in-game tokens for the wager, then join.</p>
        <button type="button" id="pvp-invited-join-btn" class="w-full py-3 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/10 min-h-[48px]">JOIN & PLAY</button>
        <p id="pvp-invited-room-id" class="text-gray-500 text-[8px] mt-2 truncate"></p>
      </div>
      <div id="pvp-lobby-wrap">
      <!-- Play vs Computer: no friends / no stake needed -->
      <div class="bg-pixel-panel border-2 border-neon-yellow/60 p-4 rounded mb-4">
        <p class="text-neon-yellow text-[10px] font-bold mb-2">üñ•Ô∏è TRAINING ROOM</p>
        <p class="text-gray-400 text-[9px] mb-3">No friends online? Tap against the computer. No wallet or stake required. Practice only.</p>
        <button type="button" id="pvp-vs-computer-btn" class="py-2 px-4 border-2 border-neon-yellow text-neon-yellow rounded text-[10px] hover:bg-neon-yellow/10 min-h-[44px]">ENTER TRAINING</button>
      </div>
      </div>

      <!-- Duel view: side-by-side clicker (shown when in active game), all in one card -->
      <div id="pvp-duel-view" class="hidden mt-4">
        <div class="bg-pixel-panel border-2 border-neon-pink/50 rounded-lg p-4 shadow-lg">
          <p class="text-neon-pink text-[10px] font-bold mb-2 text-center">CLICK RACE ‚Äî 30 SEC</p>
          <p id="pvp-duel-timer" class="text-center text-neon-yellow text-sm mb-3">0:30</p>
          <div class="grid grid-cols-2 gap-3">
            <div id="pvp-duel-you" class="bg-black/40 border-2 border-neon-cyan rounded-lg p-3 text-center">
              <p id="pvp-duel-you-name" class="text-neon-cyan text-[10px] font-bold truncate">You</p>
              <p id="pvp-duel-you-clicks" class="text-2xl neon-text-cyan">0</p>
              <button type="button" id="pvp-duel-click-btn" class="nft-clicker w-24 h-24 pixel-border rounded-lg bg-black/80 mt-2 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden disabled:opacity-50 disabled:pointer-events-none" aria-label="Click to score">
                <img src="assets/cardinal.png" alt="Tap" class="w-full h-full object-contain image-pixel" />
              </button>
            </div>
            <div id="pvp-duel-opponent" class="bg-black/40 border-2 border-gray-600 rounded-lg p-3 text-center">
              <p id="pvp-duel-opp-name" class="text-gray-400 text-[10px] font-bold truncate">Opponent</p>
              <p id="pvp-duel-opp-clicks" class="text-2xl text-gray-300">0</p>
              <div class="w-24 h-24 pixel-border rounded-lg bg-black/80 mt-2 mx-auto flex items-center justify-center text-3xl text-gray-600">?</div>
            </div>
          </div>
          <div id="pvp-duel-waiting" class="text-center text-gray-500 text-[9px] mt-2 hidden">
            <p class="font-bold text-neon-cyan mb-1">Waiting for opponent‚Ä¶</p>
            <p>Share the room link with a friend. They join to start the race. Customize your boosts below before the race starts.</p>
            <div class="flex items-center justify-center gap-2 mt-2 flex-wrap">
              <p id="pvp-duel-room-link" class="text-[8px] text-gray-600 break-all flex-1 min-w-0"></p>
              <button type="button" id="pvp-duel-copy-link-btn" class="py-1 px-2 border-2 border-neon-cyan text-neon-cyan rounded text-[8px] hover:bg-neon-cyan/10 shrink-0">COPY</button>
              <button type="button" id="pvp-duel-customize-boosts-btn" class="py-1 px-2 border-2 border-neon-cyan text-neon-cyan rounded text-[8px] hover:bg-neon-cyan/10 shrink-0">CUSTOMIZE BOOSTS</button>
            </div>
          </div>
          <div id="pvp-duel-ready-wrap" class="text-center mt-3 hidden">
            <p id="pvp-duel-ready-status" class="text-[9px] text-gray-400 mb-2">Both players must click READY. Then 5‚Ä¶ 4‚Ä¶ 3‚Ä¶ 2‚Ä¶ 1‚Ä¶ GO!</p>
            <button type="button" id="pvp-duel-ready-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/10">READY</button>
          </div>
          <div class="mt-3 text-center">
            <button type="button" id="pvp-duel-end-game-btn" class="py-2 px-4 border-2 border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10">END GAME</button>
          </div>
        </div>
      </div>

      <!-- Duel result: winner / loser + 60s rematch window -->
      <div id="pvp-duel-result" class="hidden mt-4 p-4 rounded-lg border-2 text-center">
        <p id="pvp-duel-result-title" class="text-lg font-bold mb-2">‚Äî</p>
        <p id="pvp-duel-result-detail" class="text-[10px] text-gray-400 mb-2">‚Äî</p>
        <p id="pvp-duel-rematch-countdown" class="text-[9px] text-neon-cyan mb-2 hidden">Rematch ‚Äî 60s</p>
        <p id="pvp-duel-rematch-hint" class="text-[8px] text-gray-500 mb-2">If no rematch in 60s, this room will close.</p>
        <div class="flex gap-2 justify-center flex-wrap">
          <button type="button" id="pvp-duel-rematch-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">REMATCH</button>
          <button type="button" id="pvp-duel-lobby-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">BACK TO LOBBY</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav: left-aligned, responsive so full menu fits on screen -->
  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-black/95 border-t-2 border-pixel-border max-w-lg mx-auto">
    <div class="bottom-nav-inner">
      <a href="#home" class="nav-link bottom-nav-link" data-page="home">HOME</a>
      <a href="#boosts" class="nav-link bottom-nav-link" data-page="boosts">BOOSTS</a>
      <a href="#bounties" class="nav-link bottom-nav-link" data-page="bounties">BOUNTIES</a>
      <a href="#multiplayer" class="nav-link bottom-nav-link" data-page="multiplayer">PVP</a>
      <a href="#wallet" class="nav-link bottom-nav-link" data-page="wallet">WALLET</a>
    </div>
  </nav>
  </div>

  <script src="ton-config.js"></script>
  <script src="supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.anonKey && typeof window.supabase !== 'undefined') {
      window.supabaseClient = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);
    }
  </script>
  <script src="dist/wallet.js" onerror="console.warn('Wallet script failed to load')"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
    // --- Constants ---
    const CLICKS_PER_TOKEN = 10;
    const COOLDOWN_BASE_MS = 280;
    const COOLDOWN_REDUCED_MS = 200;
    const COOLDOWN_SUPER_MS = 150;
    const BUFF_DURATION_MS = 60 * 1000;
    // New buff system (timed active + passive)
    const BUFF_FRENZY_DURATION_MS = 10 * 1000;
    const BUFF_FRENZY_COOLDOWN_MS = 45 * 1000;
    const BUFF_OVERCHARGE_DURATION_MS = 15 * 1000;
    const BUFF_OVERCHARGE_COOLDOWN_MS = 30 * 1000;
    const BUFF_TOKEN_MAGNET_DURATION_MS = 2 * 60 * 1000;
    const BUFF_TOKEN_MAGNET_COOLDOWN_MS = 2 * 60 * 1000;
    const BUFF_SHIELD_DURATION_MS = 60 * 1000;
    const BUFF_SHIELD_COOLDOWN_MS = 2 * 60 * 1000;
    const BUFF_BURN_DURATION_MS = 12 * 1000;
    const BUFF_BURN_COOLDOWN_MS = 60 * 1000;
    const COMBO_IDLE_RESET_MS = 1500;
    const COMBO_SOFT_CAP_MS = 20 * 1000;
    const CRIT_PROC_DURATION_MS = 3 * 1000;
    const CRIT_ICD_MS = 4 * 1000;
    const MAX_ACTIVE_BUFFS = 2;
    const DEATH_IDLE_HOURS = 48;
    const REVIVE_PERCENT = 0.1;
    const REVIVE_MIN = 10;
    const EGG_HATCH_HOURS = 48;
    // Graduating click trophies ‚Äî shown on the badge above the bird
    const CLICK_TROPHIES = [
      { taps: 0,     emoji: 'üß¢', name: 'Rookie',     color: 'gray-400' },
      { taps: 1000,  emoji: 'üé©', name: 'Regular',    color: 'neon-cyan' },
      { taps: 5000,  emoji: 'üéì', name: 'Graduate',   color: 'neon-green' },
      { taps: 15000, emoji: 'ü™ñ', name: 'Veteran',    color: 'neon-yellow' },
      { taps: 25000, emoji: 'üëë', name: 'Legend',      color: 'neon-pink' }
    ];
    function getClickTrophy(taps) {
      var trophy = CLICK_TROPHIES[0];
      for (var i = CLICK_TROPHIES.length - 1; i >= 0; i--) {
        if (taps >= CLICK_TROPHIES[i].taps) { trophy = CLICK_TROPHIES[i]; break; }
      }
      return trophy;
    }

    const BIRD_LEVELS = [
      { taps: 0, emoji: 'ü•ö', name: 'Egg' },
      { taps: 1, emoji: 'üê£', name: 'Chick Lv.1' },
      { taps: 100, emoji: 'üê£', name: 'Chick Lv.2' },
      { taps: 200, emoji: 'üê£', name: 'Chick Lv.3' },
      { taps: 300, emoji: 'üê£', name: 'Chick Lv.4' },
      { taps: 400, emoji: 'üê§', name: 'Chick Lv.5' },
      { taps: 500, emoji: 'üê§', name: 'Chick Lv.6' },
      { taps: 600, emoji: 'üê§', name: 'Chick Lv.7' },
      { taps: 700, emoji: 'üê§', name: 'Chick Lv.8' },
      { taps: 800, emoji: 'üê§', name: 'Chick Lv.9' },
      { taps: 900, emoji: 'üê§', name: 'Chick Lv.10' },
      { taps: 1000, emoji: 'üê¶', name: 'Adult Lv.1' },
      { taps: 1100, emoji: 'üê¶', name: 'Adult Lv.2' },
      { taps: 1200, emoji: 'üê¶', name: 'Adult Lv.3' },
      { taps: 1300, emoji: 'üê¶', name: 'Adult Lv.4' },
      { taps: 1400, emoji: 'üê¶', name: 'Adult Lv.5' },
      { taps: 1500, emoji: 'üê¶', name: 'Adult Lv.6' },
      { taps: 1600, emoji: 'üê¶', name: 'Adult Lv.7' },
      { taps: 1700, emoji: 'üê¶', name: 'Adult Lv.8' },
      { taps: 1800, emoji: 'üê¶', name: 'Adult Lv.9' },
      { taps: 1900, emoji: 'üê¶', name: 'Adult Lv.10' },
      { taps: 2000, emoji: 'üèÖ', name: 'Elite Lv.1' },
      { taps: 2100, emoji: 'üèÖ', name: 'Elite Lv.2' },
      { taps: 2200, emoji: 'üèÖ', name: 'Elite Lv.3' },
      { taps: 2300, emoji: 'üèÖ', name: 'Elite Lv.4' },
      { taps: 2400, emoji: 'üèÖ', name: 'Elite Lv.5' },
      { taps: 2500, emoji: 'üèÖ', name: 'Elite Lv.6' },
      { taps: 2600, emoji: 'üèÖ', name: 'Elite Lv.7' },
      { taps: 2700, emoji: 'üèÖ', name: 'Elite Lv.8' },
      { taps: 2800, emoji: 'üèÖ', name: 'Elite Lv.9' },
      { taps: 2900, emoji: 'üèÖ', name: 'Elite Lv.10' },
      { taps: 3000, emoji: 'üèÜ', name: 'Legend Lv.1' },
      { taps: 3100, emoji: 'üèÜ', name: 'Legend Lv.2' },
      { taps: 3200, emoji: 'üèÜ', name: 'Legend Lv.3' },
      { taps: 3300, emoji: 'üèÜ', name: 'Legend Lv.4' },
      { taps: 3400, emoji: 'üèÜ', name: 'Legend Lv.5' },
      { taps: 3500, emoji: 'üèÜ', name: 'Legend Lv.6' },
      { taps: 3600, emoji: 'üèÜ', name: 'Legend Lv.7' },
      { taps: 3700, emoji: 'üèÜ', name: 'Legend Lv.8' },
      { taps: 3800, emoji: 'üèÜ', name: 'Legend Lv.9' },
      { taps: 3900, emoji: 'üèÜ', name: 'Legend Lv.10' }
    ];

    // --- State (load from localStorage) ---
    let totalClicks = parseInt(localStorage.getItem('tokenClicker_totalClicks') || '0', 10);
    let tokens = parseInt(localStorage.getItem('tokenClicker_tokens') || '0', 10);
    if (isNaN(tokens) || tokens < 0) tokens = Math.floor(totalClicks / CLICKS_PER_TOKEN);
    let baseTapPower = 1;
    let buffAutoclickerUntil = parseInt(localStorage.getItem('tokenClicker_buffAcUntil') || '0', 10);
    let buffTurboUntil = parseInt(localStorage.getItem('tokenClicker_buffTurboUntil') || '0', 10);
    let buffTapPowerUntil = parseInt(localStorage.getItem('tokenClicker_buffTapUntil') || '0', 10);
    let buffTapPowerLevel = parseInt(localStorage.getItem('tokenClicker_buffTapLevel') || '1', 10);
    let buffCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffCdUntil') || '0', 10);
    let buffSuperCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffSuperCdUntil') || '0', 10);
    let buffPowerCapacityUntil = parseInt(localStorage.getItem('tokenClicker_buffPowerUntil') || '0', 10);
    let hasAutoclicker = false;
    let hasTurboAutoclicker = false;
    let hasCooldownBoost = false;
    let hasSuperCooldownBoost = false;
    let hasPowerCapacityBoost = false;
    let tapPower = 1;
    // New buff state
    let buffFrenzyUntil = parseInt(localStorage.getItem('tokenClicker_buffFrenzyUntil') || '0', 10);
    let buffFrenzyCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffFrenzyCdUntil') || '0', 10);
    let buffOverchargeUntil = parseInt(localStorage.getItem('tokenClicker_buffOverchargeUntil') || '0', 10);
    let buffOverchargeCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffOverchargeCdUntil') || '0', 10);
    let buffTokenMagnetUntil = parseInt(localStorage.getItem('tokenClicker_buffTokenMagnetUntil') || '0', 10);
    let buffTokenMagnetCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffTokenMagnetCdUntil') || '0', 10);
    let buffShieldUntil = parseInt(localStorage.getItem('tokenClicker_buffShieldUntil') || '0', 10);
    let buffShieldCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffShieldCdUntil') || '0', 10);
    let buffBurnUntil = parseInt(localStorage.getItem('tokenClicker_buffBurnUntil') || '0', 10);
    let buffBurnCooldownUntil = parseInt(localStorage.getItem('tokenClicker_buffBurnCdUntil') || '0', 10);
    let comboStartedAt = 0;
    let comboLastClickAt = 0;
    let critProcUntil = 0;
    let critLastProcAt = 0;
    let baseCritChance = 0.1;
    function updateBuffState() {
      var now = Date.now();
      hasAutoclicker = buffAutoclickerUntil > now;
      hasTurboAutoclicker = hasAutoclicker && (buffTurboUntil > now);
      hasCooldownBoost = buffCooldownUntil > now;
      hasSuperCooldownBoost = buffSuperCooldownUntil > now;
      hasPowerCapacityBoost = buffPowerCapacityUntil > now;
      tapPower = (buffTapPowerUntil > now) ? buffTapPowerLevel : baseTapPower;
      if (!hasAutoclicker && autoclickerInterval) { clearInterval(autoclickerInterval); autoclickerInterval = null; }
      if (hasAutoclicker && !autoclickerInterval) startAutoclicker();
    }
    function hasFrenzy() { return buffFrenzyUntil > Date.now(); }
    function hasOvercharge() { return buffOverchargeUntil > Date.now(); }
    function hasTokenMagnet() { return buffTokenMagnetUntil > Date.now(); }
    function hasShield() { return buffShieldUntil > Date.now(); }
    function hasBurn() { return buffBurnUntil > Date.now(); }
    function countActiveNewBuffs() {
      var n = 0;
      if (hasFrenzy()) n++;
      if (hasOvercharge()) n++;
      if (hasTokenMagnet()) n++;
      if (hasShield()) n++;
      if (hasBurn()) n++;
      return n;
    }
    function getComboMultiplier() {
      var now = Date.now();
      if (comboLastClickAt && now - comboLastClickAt > COMBO_IDLE_RESET_MS) return 1;
      if (!comboStartedAt) return 1;
      var elapsed = Math.min(COMBO_SOFT_CAP_MS, now - comboStartedAt);
      if (elapsed <= 0) return 1;
      return 1 + (elapsed / COMBO_SOFT_CAP_MS) * 0.5;
    }
    function getEffectiveTapPower() {
      var base = tapPower;
      if (hasFrenzy()) base *= 3;
      if (hasBurn()) base *= 5;
      return Math.max(1, Math.floor(base));
    }
    function isCritActive() { return critProcUntil > Date.now(); }
    function rollCrit() {
      var now = Date.now();
      if (now - critLastProcAt < CRIT_ICD_MS) return false;
      var chance = baseCritChance * (isCritActive() ? 2 : 1);
      if (Math.random() < chance) {
        critLastProcAt = now;
        critProcUntil = now + CRIT_PROC_DURATION_MS;
        return true;
      }
      return false;
    }
    let lastDailyClaim = localStorage.getItem('tokenClicker_lastDailyClaim') || '';
    let lastShareClaim = localStorage.getItem('tokenClicker_lastShareClaim') || '';
    let claimed100Today = localStorage.getItem('tokenClicker_claimed100Today') === '1';
    let claimedWeekly = localStorage.getItem('tokenClicker_claimedWeekly') === '1';
    let claimed50Today = localStorage.getItem('tokenClicker_claimed50Today') === '1';
    let claimedFirstFriend = localStorage.getItem('tokenClicker_claimedFirstFriend') === '1';
    let claimed500total = localStorage.getItem('tokenClicker_claimed500total') === '1';
    let claimed1000total = localStorage.getItem('tokenClicker_claimed1000total') === '1';
    let claimed2500total = localStorage.getItem('tokenClicker_claimed2500total') === '1';
    let claimed5000total = localStorage.getItem('tokenClicker_claimed5000total') === '1';
    let claimed10000total = localStorage.getItem('tokenClicker_claimed10000total') === '1';
    let claimedLucky777 = localStorage.getItem('tokenClicker_claimedLucky777') === '1';
    let claimedSpeedDemon = localStorage.getItem('tokenClicker_speedDemonClaimed') === '1';
    let claimedClickMaster = localStorage.getItem('tokenClicker_claimedClickMaster') === '1';
    let claimedHoarder = localStorage.getItem('tokenClicker_claimedHoarder') === '1';
    let claimed500balance = localStorage.getItem('tokenClicker_claimed500balance') === '1';
    let claimed1000balance = localStorage.getItem('tokenClicker_claimed1000balance') === '1';
    let claimed2500balance = localStorage.getItem('tokenClicker_claimed2500balance') === '1';
    let claimed5000balance = localStorage.getItem('tokenClicker_claimed5000balance') === '1';
    let claimed10000balance = localStorage.getItem('tokenClicker_claimed10000balance') === '1';
    let claimed25000balance = localStorage.getItem('tokenClicker_claimed25000balance') === '1';
    let claimed50000balance = localStorage.getItem('tokenClicker_claimed50000balance') === '1';
    let currentBountyTab = localStorage.getItem('tokenClicker_bountyTab') || 'toclaim';
    let currentBountyCategory = localStorage.getItem('tokenClicker_bountyCategoryTab') || 'daily';
    let lastDate = localStorage.getItem('tokenClicker_lastDate') || '';
    let streakDays = parseInt(localStorage.getItem('tokenClicker_streakDays') || '0', 10);
    let lastStreakDate = localStorage.getItem('tokenClicker_lastStreakDate') || '';
    let clicksToday = parseInt(localStorage.getItem('tokenClicker_clicksToday') || '0', 10);
    let weekStartKey = localStorage.getItem('tokenClicker_weekStart') || '';
    let weeklyClicks = parseInt(localStorage.getItem('tokenClicker_weeklyClicks') || '0', 10);
    let lastActivityAt = parseInt(localStorage.getItem('tokenClicker_lastActivityAt') || String(Date.now()), 10);
    let isDead = localStorage.getItem('tokenClicker_isDead') === '1';
    let deathCount = parseInt(localStorage.getItem('tokenClicker_deathCount') || '0', 10);
    let deathTime = parseInt(localStorage.getItem('tokenClicker_deathTime') || '0', 10);
    if (isDead && !deathTime && lastActivityAt) deathTime = lastActivityAt;

    let lastClickTime = 0;
    let clicksInLastSecond = 0;
    let lastSecondTime = Date.now();
    let power = 150;
    let lastPowerUpdateAt = Date.now();
    let peakClicksPerSecond = 0;
    const POWER_BASE_MAX = 150;
    const POWER_REGEN_BASE = 5;
    const POWER_COST_PER_CLICK = 3;

    function getPowerMax() {
      var idx = 0;
      for (var i = BIRD_LEVELS.length - 1; i >= 0; i--) {
        if (totalClicks >= BIRD_LEVELS[i].taps) { idx = i; break; }
      }
      var fromLevel = POWER_BASE_MAX + idx * 10;
      var fromTapPower = (tapPower - 1) * 25;
      var fromCapacityBoost = hasPowerCapacityBoost ? 50 : 0;
      return fromLevel + fromTapPower + fromCapacityBoost;
    }
    function getPowerRegenPerSec() {
      if (hasSuperCooldownBoost) return POWER_REGEN_BASE + 2;
      if (hasCooldownBoost) return POWER_REGEN_BASE + 1;
      return POWER_REGEN_BASE;
    }
    let autoclickerInterval = null;

    function todayKey() { return new Date().toISOString().slice(0, 10); }
    function weekKey() {
      const d = new Date();
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().slice(0, 10);
    }

    // --- DOM ---
    const nftClicker = document.getElementById('nft-clicker');
    const topTokens = document.getElementById('top-tokens');
    const walletBalance = document.getElementById('wallet-balance');
    const totalClicksEl = document.getElementById('total-clicks');
    const clicksPerSecEl = document.getElementById('clicks-per-sec');
    const clickCountLabel = document.getElementById('click-count-label');

    function cooldownMs() { return hasSuperCooldownBoost ? COOLDOWN_SUPER_MS : (hasCooldownBoost ? COOLDOWN_REDUCED_MS : COOLDOWN_BASE_MS); }
    function powerRegenPerMs() { return getPowerRegenPerSec() / 1000; }
    function updatePowerBar() {
      var max = getPowerMax();
      var pct = max > 0 ? Math.min(100, Math.max(0, (power / max) * 100)) : 0;
      var fill = document.getElementById('power-bar-fill');
      if (fill) fill.style.width = pct + '%';
      var num = document.getElementById('power-numeric');
      if (num) num.textContent = Math.floor(power) + ' / ' + max;
      if (nftClicker) {
        if (power >= POWER_COST_PER_CLICK) nftClicker.classList.remove('cooldown');
        else nftClicker.classList.add('cooldown');
      }
    }

    var lastTokensSyncAt = 0;
    var TOKENS_SYNC_INTERVAL_MS = 5000;
    function syncTokensToLeaderboard() {
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!me) return;
      var supabase = window.supabaseClient;
      if (!supabase || Date.now() - lastTokensSyncAt < TOKENS_SYNC_INTERVAL_MS) return;
      lastTokensSyncAt = Date.now();
      var isGuest = me.indexOf('guest_') === 0;
      var query = isGuest ? supabase.from('leaderboard').select('id').eq('player_id', me).maybeSingle() : supabase.from('leaderboard').select('id').eq('wallet_address', me).maybeSingle();
      query.then(function(r) {
        var row = r.data;
        if (row) {
          supabase.from('leaderboard').update({ tokens: Math.max(0, tokens), updated_at: new Date().toISOString() }).eq('id', row.id).then(function() {});
        }
      });
    }
    function ensureLeaderboardRow(cb) {
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!me) { if (cb) cb(null); return; }
      var supabase = window.supabaseClient;
      if (!supabase) { if (cb) cb(null); return; }
      var isGuest = me.indexOf('guest_') === 0;
      var q = isGuest
        ? supabase.from('leaderboard').select('id, tokens').eq('player_id', me).maybeSingle()
        : supabase.from('leaderboard').select('id, tokens').ilike('wallet_address', me).limit(1);
      q.then(function(r) {
        var row = isGuest ? r.data : (r.data && r.data[0] ? r.data[0] : null);
        if (row) {
          var serverTokens = row.tokens != null ? Number(row.tokens) : 0;
          if (serverTokens > tokens) { tokens = Math.max(0, serverTokens); save(); if (typeof updateUI === 'function') updateUI(); }
          var refCode = (localStorage && localStorage.getItem('tokenClicker_refCode')) || '';
          refCode = (refCode && refCode.trim()) ? refCode.trim().toUpperCase() : null;
          if (refCode) {
            supabase.from('leaderboard').update({ ref_code: refCode, updated_at: new Date().toISOString() }).eq('id', row.id).then(function() {});
          }
          if (typeof subscribeTokenReceivedRealtime === 'function') subscribeTokenReceivedRealtime();
          if (typeof subscribeFriendRequestAcceptedRealtime === 'function') subscribeFriendRequestAcceptedRealtime();
          if (cb) cb(row);
          return;
        }
        row = null;
        if (!isGuest) {
          var byPlayer = supabase.from('leaderboard').select('id, tokens').eq('player_id', me).maybeSingle();
          byPlayer.then(function(r2) {
            if (r2.data) { row = r2.data; if (cb) cb(row); return; }
            doInsert();
          });
        } else doInsert();
        function doInsert() {
          var name = (typeof getPlayerName === 'function' ? getPlayerName() : null) || 'Player';
          var refCode = (localStorage && localStorage.getItem('tokenClicker_refCode')) || null;
          if (refCode && refCode.trim()) refCode = refCode.trim().toUpperCase();
          var payload = { name: name.slice(0, 100), tokens: Math.max(0, tokens), updated_at: new Date().toISOString(), ref_code: refCode };
          if (isGuest) payload.player_id = me;
          else { payload.wallet_address = me; payload.player_id = me; }
          supabase.from('leaderboard').insert(payload).then(function(ir) {
            if (ir.error) { if (cb) cb(null); return; }
            if (typeof subscribeTokenReceivedRealtime === 'function') subscribeTokenReceivedRealtime();
            if (typeof subscribeFriendRequestAcceptedRealtime === 'function') subscribeFriendRequestAcceptedRealtime();
            if (cb) cb(ir.data && ir.data[0] ? { id: ir.data[0].id, tokens: ir.data[0].tokens != null ? ir.data[0].tokens : 0 } : null);
          });
        }
      });
    }
    function save() {
      localStorage.setItem('tokenClicker_totalClicks', String(totalClicks));
      localStorage.setItem('tokenClicker_tokens', String(tokens));
      localStorage.setItem('tokenClicker_tapPower', String(tapPower));
      localStorage.setItem('tokenClicker_buffAcUntil', String(buffAutoclickerUntil));
      localStorage.setItem('tokenClicker_buffTurboUntil', String(buffTurboUntil));
      localStorage.setItem('tokenClicker_buffTapUntil', String(buffTapPowerUntil));
      localStorage.setItem('tokenClicker_buffTapLevel', String(buffTapPowerLevel));
      localStorage.setItem('tokenClicker_buffCdUntil', String(buffCooldownUntil));
      localStorage.setItem('tokenClicker_buffSuperCdUntil', String(buffSuperCooldownUntil));
      localStorage.setItem('tokenClicker_buffPowerUntil', String(buffPowerCapacityUntil));
      try {
        localStorage.setItem('tokenClicker_buffFrenzyUntil', String(buffFrenzyUntil));
        localStorage.setItem('tokenClicker_buffFrenzyCdUntil', String(buffFrenzyCooldownUntil));
        localStorage.setItem('tokenClicker_buffOverchargeUntil', String(buffOverchargeUntil));
        localStorage.setItem('tokenClicker_buffOverchargeCdUntil', String(buffOverchargeCooldownUntil));
        localStorage.setItem('tokenClicker_buffTokenMagnetUntil', String(buffTokenMagnetUntil));
        localStorage.setItem('tokenClicker_buffTokenMagnetCdUntil', String(buffTokenMagnetCooldownUntil));
        localStorage.setItem('tokenClicker_buffShieldUntil', String(buffShieldUntil));
        localStorage.setItem('tokenClicker_buffShieldCdUntil', String(buffShieldCooldownUntil));
        localStorage.setItem('tokenClicker_buffBurnUntil', String(buffBurnUntil));
        localStorage.setItem('tokenClicker_buffBurnCdUntil', String(buffBurnCooldownUntil));
      } catch (e) {}
      localStorage.setItem('tokenClicker_lastDailyClaim', lastDailyClaim);
      localStorage.setItem('tokenClicker_lastShareClaim', lastShareClaim);
      localStorage.setItem('tokenClicker_claimed100Today', claimed100Today ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedWeekly', claimedWeekly ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed50Today', claimed50Today ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedFirstFriend', claimedFirstFriend ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed500total', claimed500total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed1000total', claimed1000total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed2500total', claimed2500total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed5000total', claimed5000total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed10000total', claimed10000total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedLucky777', claimedLucky777 ? '1' : '0');
      localStorage.setItem('tokenClicker_speedDemonClaimed', claimedSpeedDemon ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedClickMaster', claimedClickMaster ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedHoarder', claimedHoarder ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed500balance', claimed500balance ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed1000balance', claimed1000balance ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed2500balance', claimed2500balance ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed5000balance', claimed5000balance ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed10000balance', claimed10000balance ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed25000balance', claimed25000balance ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed50000balance', claimed50000balance ? '1' : '0');
      localStorage.setItem('tokenClicker_bountyTab', currentBountyTab);
      try { localStorage.setItem('tokenClicker_bountyCategoryTab', currentBountyCategory); } catch (e) {}
      localStorage.setItem('tokenClicker_lastDate', lastDate);
      localStorage.setItem('tokenClicker_streakDays', String(streakDays));
      localStorage.setItem('tokenClicker_lastStreakDate', lastStreakDate);
      localStorage.setItem('tokenClicker_clicksToday', String(clicksToday));
      localStorage.setItem('tokenClicker_weekStart', weekStartKey);
      localStorage.setItem('tokenClicker_weeklyClicks', String(weeklyClicks));
      localStorage.setItem('tokenClicker_lastActivityAt', String(lastActivityAt));
      localStorage.setItem('tokenClicker_isDead', isDead ? '1' : '0');
      localStorage.setItem('tokenClicker_deathCount', String(deathCount));
      if (isDead && deathTime) localStorage.setItem('tokenClicker_deathTime', String(deathTime));
      else try { localStorage.removeItem('tokenClicker_deathTime'); } catch (e) {}
      if (typeof syncTokensToLeaderboard === 'function') syncTokensToLeaderboard();
    }

    function getBirdLevel(taps) {
      let level = BIRD_LEVELS[0];
      for (let i = BIRD_LEVELS.length - 1; i >= 0; i--) {
        if (taps >= BIRD_LEVELS[i].taps) { level = BIRD_LEVELS[i]; break; }
      }
      return level;
    }
    function getReviveCost() {
      const percentCost = Math.ceil(tokens * REVIVE_PERCENT);
      return Math.max(REVIVE_MIN, percentCost);
    }
    function canReviveByHatch() {
      if (!isDead || !deathTime) return false;
      const elapsedMs = Date.now() - deathTime;
      return elapsedMs >= EGG_HATCH_HOURS * 60 * 60 * 1000;
    }
    function reviveBird() {
      const cost = getReviveCost();
      if (tokens < cost) return;
      tokens -= cost;
      isDead = false;
      deathTime = 0;
      lastActivityAt = Date.now();
      save();
      updateUI();
    }
    function reviveByHatch() {
      if (!canReviveByHatch()) return;
      isDead = false;
      deathTime = 0;
      lastActivityAt = Date.now();
      save();
      updateUI();
    }
    function checkDeath() {
      const idleMs = Date.now() - lastActivityAt;
      const idleHours = idleMs / (1000 * 60 * 60);
      if (idleHours >= DEATH_IDLE_HOURS && !isDead) {
        isDead = true;
        deathTime = Date.now();
        deathCount++;
        save();
      }
    }

    function getBountyClaimed(id) {
      switch (id) {
        case 'daily': return lastDailyClaim === todayKey();
        case '50today': return claimed50Today;
        case '100today': return claimed100Today;
        case 'weekly': return claimedWeekly;
        case 'share': return lastShareClaim === todayKey();
        case 'firstfriend': return claimedFirstFriend;
        case '500total': return claimed500total;
        case '1000total': return claimed1000total;
        case '2500total': return claimed2500total;
        case '5000total': return claimed5000total;
        case '10000total': return claimed10000total;
        case 'lucky777': return claimedLucky777;
        case 'speeddemon': return claimedSpeedDemon;
        case 'clickmaster': return claimedClickMaster;
        case 'hoarder': return claimedHoarder;
        case '500balance': return claimed500balance;
        case '1000balance': return claimed1000balance;
        case '2500balance': return claimed2500balance;
        case '5000balance': return claimed5000balance;
        case '10000balance': return claimed10000balance;
        case '25000balance': return claimed25000balance;
        case '50000balance': return claimed50000balance;
        default: return false;
      }
    }
    function showBountyCategory(cat) {
      currentBountyCategory = cat || currentBountyCategory;
      try { localStorage.setItem('tokenClicker_bountyCategoryTab', currentBountyCategory); } catch (e) {}
      document.querySelectorAll('.bounty-category-panel').forEach(function(panel) {
        panel.classList.toggle('hidden', panel.getAttribute('data-bounty-category') !== currentBountyCategory);
      });
      document.querySelectorAll('.bounty-category-tab').forEach(function(btn) {
        var t = btn.getAttribute('data-bounty-category');
        var active = t === currentBountyCategory;
        btn.className = 'bounty-category-tab py-1.5 px-2.5 border-2 rounded text-[9px] ' + (active ? 'border-neon-green text-neon-green font-bold bg-neon-green/10' : 'border-gray-600 text-gray-400 hover:border-neon-cyan/50 hover:text-neon-cyan');
      });
    }
    function switchBountyTab(tab) {
      currentBountyTab = tab;
      var isClaimed = tab === 'claimed';
      var list = document.getElementById('bounties-list');
      var toclaimCardsEl = document.getElementById('bounties-toclaim-cards');
      var claimedCardsEl = document.getElementById('bounties-claimed-cards');
      var claimedCount = 0;
      var claimedRows = [];
      var toclaimCount = 0;
      var bountyCategoryOrder = ['daily', 'graduating', 'fun', 'highroller'];
      if (list) {
        list.querySelectorAll('.bounty-row').forEach(function(el) {
          var id = el.getAttribute('data-bounty-id');
          var claimed = getBountyClaimed(id);
          var category = (el.closest && el.closest('.bounty-category')) ? (el.closest('.bounty-category').getAttribute('data-bounty-category') || 'daily') : 'daily';
          if (claimed) {
            claimedCount++;
            var cardEl = el.querySelector('.bounty-bird-card');
            var birdClass = cardEl ? (cardEl.className.match(/\bbird-\w+/) || ['bird-green'])[0] : 'bird-green';
            claimedRows.push({ id: id, name: el.getAttribute('data-bounty-name') || id, reward: el.getAttribute('data-bounty-reward') || '', birdClass: birdClass, category: category });
            el.classList.add('hidden');
          } else {
            toclaimCount++;
            el.classList.remove('hidden');
          }
        });
        claimedRows.sort(function(a, b) {
          var ai = bountyCategoryOrder.indexOf(a.category);
          var bi = bountyCategoryOrder.indexOf(b.category);
          if (ai !== bi) return ai - bi;
          return (a.name || '').localeCompare(b.name || '');
        });
        if (isClaimed) {
          list.classList.add('hidden');
          list.classList.remove('bounty-toclaim-list');
        } else {
          list.classList.toggle('hidden', toclaimCount === 0);
          list.classList.add('bounty-toclaim-list');
        }
        list.querySelectorAll('.bounty-category').forEach(function(cat) {
          var rows = cat.querySelectorAll('.bounty-row');
          var allClaimed = rows.length > 0 && Array.from(rows).every(function(r) { return getBountyClaimed(r.getAttribute('data-bounty-id')); });
          cat.classList.toggle('hidden', allClaimed);
        });
      }
      if (toclaimCardsEl) toclaimCardsEl.classList.add('hidden');
      if (claimedCardsEl) {
        claimedCardsEl.classList.toggle('hidden', !isClaimed || claimedCount === 0);
        claimedCardsEl.innerHTML = '';
        if (isClaimed && claimedCount > 0) {
          var filtered = claimedRows.filter(function(r) { return r.category === currentBountyCategory; });
          var countInCategory = filtered.length;
          claimedCardsEl.classList.toggle('hidden', countInCategory === 0);
          if (countInCategory > 0) {
            filtered.forEach(function(r) {
              var card = document.createElement('div');
              card.className = 'bounty-collection-card ' + r.birdClass;
              card.innerHTML = '<img src="assets/cardinal.png" alt="" class="bird-thumb image-pixel" /><span class="bird-name">' + (r.name || r.id) + '</span><span class="bird-reward">+' + r.reward + ' tokens</span>';
              claimedCardsEl.appendChild(card);
            });
          }
          var categoryEmptyEl = document.getElementById('bounties-claimed-category-empty');
          if (categoryEmptyEl) categoryEmptyEl.classList.toggle('hidden', countInCategory > 0);
        }
      }
      var toclaimEmptyEl = document.getElementById('bounties-toclaim-empty');
      if (toclaimEmptyEl) toclaimEmptyEl.classList.toggle('hidden', isClaimed || toclaimCount > 0);
      var claimedEmptyEl = document.getElementById('bounties-claimed-empty');
      if (claimedEmptyEl) claimedEmptyEl.classList.toggle('hidden', !isClaimed || claimedCount > 0);
      var categoryEmptyEl = document.getElementById('bounties-claimed-category-empty');
      if (categoryEmptyEl) categoryEmptyEl.classList.toggle('hidden', !isClaimed || claimedCount === 0);
      var toclaimTabBtn = document.getElementById('bounty-tab-toclaim');
      var claimedTabBtn = document.getElementById('bounty-tab-claimed');
      if (toclaimTabBtn) toclaimTabBtn.className = 'bounty-tab border-2 px-3 py-1.5 rounded text-[10px] ' + (isClaimed ? 'border-gray-500 text-gray-400 hover:bg-gray-700' : 'border-neon-green text-neon-green hover:bg-neon-green/10 bg-neon-green/10');
      if (claimedTabBtn) claimedTabBtn.className = 'bounty-tab border-2 px-3 py-1.5 rounded text-[10px] ' + (isClaimed ? 'border-neon-green text-neon-green hover:bg-neon-green/10 bg-neon-green/10' : 'border-gray-500 text-gray-400 hover:bg-gray-700');
      if (!isClaimed && list) showBountyCategory(currentBountyCategory);
    }
    function updateBountyProgress() {
      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) {
        clicksToday = 0;
        claimed100Today = false;
        claimed50Today = false;
        lastDate = today;
      }
      if (week !== weekStartKey) {
        weeklyClicks = 0;
        claimedWeekly = false;
        weekStartKey = week;
      }
    }
    function updateStreak() {
      const today = todayKey();
      if (lastStreakDate === today) return;
      if (!lastStreakDate) {
        streakDays = 1;
      } else {
        const prev = new Date(lastStreakDate + 'T12:00:00');
        prev.setDate(prev.getDate() + 1);
        const nextDay = prev.toISOString().slice(0, 10);
        if (nextDay === today) streakDays += 1;
        else streakDays = 1;
      }
      lastStreakDate = today;
      save();
    }

    function updateUI() {
      if (topTokens) topTokens.textContent = tokens;
      if (walletBalance) walletBalance.textContent = tokens;
      const boostsBal = document.getElementById('boosts-balance');
      const bountiesBal = document.getElementById('bounties-balance');
      if (boostsBal) boostsBal.textContent = tokens;
      if (bountiesBal) bountiesBal.textContent = tokens;
      var sendQrBal = document.getElementById('send-qr-balance');
      if (sendQrBal) sendQrBal.textContent = tokens;
      if (totalClicksEl) totalClicksEl.textContent = totalClicks;
      if (clickCountLabel) clickCountLabel.textContent = totalClicks;
      var tapsPerToken = Math.max(1, Math.ceil(10 / tapPower));
      const homePower = document.getElementById('home-power');
      const homeTokenRate = document.getElementById('home-token-rate');
      const homeRegen = document.getElementById('home-regen');
      if (homePower) homePower.textContent = tapPower;
      if (homeTokenRate) homeTokenRate.textContent = tapsPerToken;
      if (homeRegen) homeRegen.textContent = hasTurboAutoclicker ? '2' : (hasAutoclicker ? '1' : '0');
      var peakEl = document.getElementById('peak-click-rate');
      if (peakEl) peakEl.textContent = peakClicksPerSecond;
      var buffEl = document.getElementById('buff-countdown');
      var activeBuffPanel = document.getElementById('active-buff-panel');
      if (buffEl) {
        var parts = [];
        var now = Date.now();
        if (buffTapPowerUntil > now) parts.push('Tap ' + buffTapPowerLevel + 'x: ' + getBuffCountdown(buffTapPowerUntil) + 's');
        if (buffAutoclickerUntil > now) parts.push('Auto: ' + getBuffCountdown(buffAutoclickerUntil) + 's');
        if (buffTurboUntil > now) parts.push('Turbo: ' + getBuffCountdown(buffTurboUntil) + 's');
        if (buffCooldownUntil > now || buffSuperCooldownUntil > now) parts.push('CD: ' + getBuffCountdown(Math.max(buffCooldownUntil, buffSuperCooldownUntil)) + 's');
        if (buffPowerCapacityUntil > now) parts.push('Power+: ' + getBuffCountdown(buffPowerCapacityUntil) + 's');
        if (buffFrenzyUntil > now) parts.push('Frenzy: ' + getBuffCountdown(buffFrenzyUntil) + 's');
        if (buffOverchargeUntil > now) parts.push('Overcharge: ' + getBuffCountdown(buffOverchargeUntil) + 's');
        if (buffTokenMagnetUntil > now) parts.push('Magnet: ' + getBuffCountdown(buffTokenMagnetUntil) + 's');
        if (buffShieldUntil > now) parts.push('Shield: ' + getBuffCountdown(buffShieldUntil) + 's');
        if (buffBurnUntil > now) parts.push('Burn: ' + getBuffCountdown(buffBurnUntil) + 's');
        buffEl.textContent = parts.length ? parts.join(' ¬∑ ') : '';
        if (activeBuffPanel) activeBuffPanel.classList.toggle('hidden', !parts.length);
      }
      var nextMilestoneEl = document.getElementById('home-next-milestone');
      if (nextMilestoneEl) {
        var earnedFromTaps = Math.floor(totalClicks * tapPower / 10);
        var nextTotalAt = Math.ceil((earnedFromTaps + 1) * 10 / tapPower);
        var tapsNeeded = Math.max(1, nextTotalAt - totalClicks);
        nextMilestoneEl.textContent = 'Next token in ' + tapsNeeded + ' tap' + (tapsNeeded === 1 ? '' : 's');
      }
      updateBadges();
      var pvpBal = document.getElementById('pvp-create-balance');
      if (pvpBal && typeof getInGameTokenBalance === 'function') pvpBal.textContent = getInGameTokenBalance();
      if (typeof updatePowerBar === 'function') updatePowerBar();
      updateBoostsUI();
      if (typeof renderHomeStripCards === 'function') renderHomeStripCards();
      updateHomeStrip();
      updateBountiesUI();
      updateGraduatingBountyBar();
      updateLeaderboard();
      updateLevelBadge();
      var dm = document.getElementById('death-modal');
      var onHome = document.getElementById('page-home') && document.getElementById('page-home').classList.contains('active');
      if (isDead && onHome) {
        var costEl = document.getElementById('death-revive-cost');
        var balEl = document.getElementById('death-balance');
        var revBtn = document.getElementById('death-revive-btn');
        if (dm) { dm.classList.remove('hidden'); dm.style.display = 'flex'; }
        if (costEl) costEl.textContent = 'Revive cost: ' + getReviveCost() + ' tokens';
        if (balEl) balEl.textContent = 'Your balance: ' + tokens + ' tokens';
        if (revBtn) revBtn.disabled = tokens < getReviveCost();
        var dcEl = document.getElementById('death-count');
        if (dcEl) dcEl.textContent = deathCount;
        var hatchBtn = document.getElementById('death-hatch-btn');
        var hatchCountdownEl = document.getElementById('death-hatch-countdown');
        var hatchOk = typeof canReviveByHatch === 'function' && canReviveByHatch();
        if (hatchBtn) { hatchBtn.classList.toggle('hidden', !hatchOk); hatchBtn.style.display = hatchOk ? '' : 'none'; }
        if (hatchCountdownEl) {
          if (hatchOk) { hatchCountdownEl.classList.add('hidden'); hatchCountdownEl.textContent = ''; }
          else if (deathTime && typeof EGG_HATCH_HOURS !== 'undefined') {
            var remainingMs = (EGG_HATCH_HOURS * 60 * 60 * 1000) - (Date.now() - deathTime);
            if (remainingMs > 0) {
              var h = Math.floor(remainingMs / (60 * 60 * 1000));
              var m = Math.floor((remainingMs % (60 * 60 * 1000)) / (60 * 1000));
              hatchCountdownEl.textContent = 'Egg hatches in ' + h + 'h ' + m + 'm';
              hatchCountdownEl.classList.remove('hidden');
            } else { hatchCountdownEl.classList.add('hidden'); hatchCountdownEl.textContent = ''; }
          } else { hatchCountdownEl.classList.add('hidden'); }
        }
      } else {
        if (dm) { dm.classList.add('hidden'); dm.style.display = 'none'; }
      }
    }
    function updateLevelBadge() {
      var badge = document.getElementById('bird-level-badge');
      var clicker = document.getElementById('nft-clicker');
      if (badge) {
        if (isDead) {
          badge.innerHTML = '<span class="text-base">üïäÔ∏è</span><span class="text-[8px] text-gray-400">Dead</span>';
          badge.title = 'Dead ‚Äì revive with tokens';
        } else {
          var level = getBirdLevel(totalClicks);
          badge.innerHTML = '<span class="text-base">' + level.emoji + '</span><span class="text-[8px] text-gray-400">' + level.name + '</span>';
          badge.title = level.name + ' (' + totalClicks + ' taps)';
        }
      }
      if (clicker) clicker.classList.toggle('bird-dead', isDead);
    }

    function updateGraduatingBountyBar() {
      const GRADUATING = [
        { id: '500total', target: 500, reward: 15, name: '500 taps' },
        { id: '1000total', target: 1000, reward: 25, name: '1,000 taps' },
        { id: '2500total', target: 2500, reward: 50, name: '2,500 taps' },
        { id: '5000total', target: 5000, reward: 100, name: '5,000 taps' },
        { id: '10000total', target: 10000, reward: 200, name: '10,000 taps' }
      ];
      const getClaimed = (id) => {
        if (id === '500total') return claimed500total;
        if (id === '1000total') return claimed1000total;
        if (id === '2500total') return claimed2500total;
        if (id === '5000total') return claimed5000total;
        if (id === '10000total') return claimed10000total;
        return false;
      };
      let current = null, next = null;
      for (let i = 0; i < GRADUATING.length; i++) {
        const g = GRADUATING[i];
        if (!getClaimed(g.id)) {
          if (!current) { current = g; next = GRADUATING[i + 1] || null; break; }
        }
      }
      const curEl = document.getElementById('grad-current');
      const nextEl = document.getElementById('grad-next');
      if (curEl) {
        if (current) {
          const prog = Math.min(totalClicks, current.target);
          curEl.textContent = 'Active: ' + current.name + ' ‚Äî ' + prog + '/' + current.target.toLocaleString() + ' ¬∑ ' + current.reward + ' tokens';
          curEl.classList.remove('text-gray-500');
          curEl.classList.add('text-gray-300');
        } else {
          curEl.textContent = 'All graduating bounties claimed!';
          curEl.classList.add('text-neon-green');
        }
      }
      if (nextEl) {
        if (next) {
          const prog = Math.min(totalClicks, next.target);
          nextEl.textContent = 'Next: ' + next.name + ' ‚Äî ' + prog + '/' + next.target.toLocaleString() + ' ¬∑ ' + next.reward + ' tokens';
          nextEl.classList.remove('hidden');
        } else {
          nextEl.textContent = '';
          nextEl.classList.add('hidden');
        }
      }
    }

    function updateBadges() {
      const firstPvpWin = localStorage.getItem('tokenClicker_firstPvpWin') === '1';
      const firstFriend = !!localStorage.getItem('tokenClicker_invitedBy');
      // Update graduating click trophy (badge-1)
      var trophy = getClickTrophy(totalClicks);
      var badge1El = document.getElementById('badge-1');
      if (badge1El) {
        badge1El.textContent = trophy.emoji;
        badge1El.title = trophy.name + ' (' + totalClicks.toLocaleString() + ' taps)';
        badge1El.setAttribute('aria-label', trophy.name);
        // Update border color to match trophy tier
        badge1El.className = badge1El.className.replace(/border-(?:gray-600|neon-cyan|neon-green|neon-yellow|neon-pink)/g, '');
        badge1El.classList.add('border-' + trophy.color);
      }
      var badge1Boost = document.getElementById('badge-boost-1');
      if (badge1Boost) {
        badge1Boost.textContent = trophy.emoji;
        badge1Boost.title = trophy.name;
      }
      // Other badges: unlock based on milestones
      const pairs = [
        [['badge-2', 'badge-boost-2'], totalClicks >= 100],
        [['badge-3', 'badge-boost-3'], totalClicks >= 500],
        [['badge-4', 'badge-boost-4'], totalClicks >= 1000],
        [['badge-5', 'badge-boost-5'], totalClicks >= 5000],
        [['badge-6', 'badge-boost-6'], totalClicks >= 10000],
        [['badge-7', 'badge-boost-7'], totalClicks >= 25000],
        [['badge-8', 'badge-boost-8'], streakDays >= 7],
        [['badge-9', 'badge-boost-9'], firstPvpWin],
        [['badge-10', 'badge-boost-10'], firstFriend],
        [['badge-11', 'badge-boost-11'], streakDays >= 30]
      ];
      pairs.forEach(([ids, unlocked]) => {
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.classList.toggle('opacity-50', !unlocked);
          el.classList.toggle('border-neon-yellow', !!unlocked);
          el.classList.toggle('border-gray-600', !unlocked);
        });
      });
    }

    function getBuffCountdown(until) {
      var left = Math.max(0, Math.ceil((until - Date.now()) / 1000));
      return left;
    }
    function updateBoostButtons() {
      var now = Date.now();
      var activeCount = countActiveNewBuffs();
      document.querySelectorAll('.boost-btn').forEach(btn => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        var active = false;
        var until = 0;
        var blocked = false;
        if (boost === 'tapPower') { active = buffTapPowerUntil > now; until = buffTapPowerUntil; }
        else if (boost === 'tapPower3') { active = buffTapPowerUntil > now && buffTapPowerLevel >= 3; until = buffTapPowerUntil; blocked = buffTapPowerLevel < 2; }
        else if (boost === 'tapPower4') { active = buffTapPowerUntil > now && buffTapPowerLevel >= 4; until = buffTapPowerUntil; blocked = buffTapPowerLevel < 3; }
        else if (boost === 'autoclicker') { active = buffAutoclickerUntil > now; until = buffAutoclickerUntil; }
        else if (boost === 'turboAutoclicker') { active = buffTurboUntil > now; until = buffTurboUntil; blocked = buffAutoclickerUntil <= now; }
        else if (boost === 'cooldown') { active = buffCooldownUntil > now; until = buffCooldownUntil; }
        else if (boost === 'superCooldown') { active = buffSuperCooldownUntil > now; until = buffSuperCooldownUntil; }
        else if (boost === 'powerCapacity') { active = buffPowerCapacityUntil > now; until = buffPowerCapacityUntil; }
        else if (boost === 'frenzy') { active = buffFrenzyUntil > now; until = buffFrenzyUntil; blocked = activeCount >= MAX_ACTIVE_BUFFS && !active || now < buffFrenzyCooldownUntil; }
        else if (boost === 'overcharge') { active = buffOverchargeUntil > now; until = buffOverchargeUntil; blocked = activeCount >= MAX_ACTIVE_BUFFS && !active || now < buffOverchargeCooldownUntil; }
        else if (boost === 'tokenMagnet') { active = buffTokenMagnetUntil > now; until = buffTokenMagnetUntil; blocked = activeCount >= MAX_ACTIVE_BUFFS && !active || now < buffTokenMagnetCooldownUntil; }
        else if (boost === 'shield') { active = buffShieldUntil > now; until = buffShieldUntil; blocked = activeCount >= MAX_ACTIVE_BUFFS && !active || now < buffShieldCooldownUntil; }
        else if (boost === 'burn') { active = buffBurnUntil > now; until = buffBurnUntil; blocked = activeCount >= MAX_ACTIVE_BUFFS && !active || now < buffBurnCooldownUntil; }
        var onCd = (boost === 'frenzy' && now < buffFrenzyCooldownUntil) || (boost === 'overcharge' && now < buffOverchargeCooldownUntil) || (boost === 'tokenMagnet' && now < buffTokenMagnetCooldownUntil) || (boost === 'shield' && now < buffShieldCooldownUntil) || (boost === 'burn' && now < buffBurnCooldownUntil);
        btn.disabled = blocked || tokens < cost || (onCd && !active);
        btn.textContent = active ? getBuffCountdown(until) + 's' : (onCd ? 'CD' : (blocked ? '‚Äî' : 'USE'));
      });
    }
    function updateBoostsUI() {
      updateBoostButtons();
    }
    var HOME_STRIP_BUFF_CATALOG = [
      { id: 'tapPower', label: 'Tap Power', cost: 50, icon: '‚ö°', accent: 'cyan' },
      { id: 'tapPower3', label: 'Tap 3x', cost: 150, icon: '‚ö°', accent: 'cyan' },
      { id: 'tapPower4', label: 'Tap 4x', cost: 350, icon: '‚ö°', accent: 'cyan' },
      { id: 'autoclicker', label: 'Auto', cost: 100, icon: 'üîã', accent: 'cyan' },
      { id: 'turboAutoclicker', label: 'Turbo', cost: 250, icon: 'üîã', accent: 'cyan' },
      { id: 'cooldown', label: 'Regen', cost: 75, icon: '‚ôªÔ∏è', accent: 'cyan' },
      { id: 'superCooldown', label: 'Super CD', cost: 150, icon: '‚ôªÔ∏è', accent: 'cyan' },
      { id: 'powerCapacity', label: 'Power+', cost: 100, icon: '‚ö°', accent: 'pink' },
      { id: 'frenzy', label: 'Frenzy', cost: 80, icon: 'üî•', accent: 'yellow' },
      { id: 'overcharge', label: 'Overcharge', cost: 60, icon: 'üí•', accent: 'cyan' },
      { id: 'tokenMagnet', label: 'Magnet', cost: 100, icon: 'üßø', accent: 'green' },
      { id: 'shield', label: 'Shield', cost: 90, icon: 'üõ°', accent: 'cyan' },
      { id: 'burn', label: 'Burn', cost: 70, icon: 'üß®', accent: 'pink' }
    ];
    var HOME_STRIP_MAX = 3;
    function getHomeStripBuffs() {
      try {
        var raw = localStorage.getItem('tokenClicker_homeBuffs');
        if (raw) {
          var arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length > 0) return arr.slice(0, HOME_STRIP_MAX);
        }
      } catch (e) {}
      return ['tapPower', 'frenzy', 'autoclicker'];
    }
    function saveHomeStripBuffs(arr) {
      try { localStorage.setItem('tokenClicker_homeBuffs', JSON.stringify(arr.slice(0, HOME_STRIP_MAX))); } catch (e) {}
    }
    function getBuffInfo(boostId) {
      for (var i = 0; i < HOME_STRIP_BUFF_CATALOG.length; i++) {
        if (HOME_STRIP_BUFF_CATALOG[i].id === boostId) return HOME_STRIP_BUFF_CATALOG[i];
      }
      return null;
    }
    function getBuffState(boost) {
      var now = Date.now();
      var active = false, until = 0, blocked = false;
      if (boost === 'tapPower') { active = buffTapPowerUntil > now; until = buffTapPowerUntil; }
      else if (boost === 'tapPower3') { active = buffTapPowerUntil > now && buffTapPowerLevel >= 3; until = buffTapPowerUntil; blocked = buffTapPowerLevel < 2; }
      else if (boost === 'tapPower4') { active = buffTapPowerUntil > now && buffTapPowerLevel >= 4; until = buffTapPowerUntil; blocked = buffTapPowerLevel < 3; }
      else if (boost === 'autoclicker') { active = buffAutoclickerUntil > now; until = buffAutoclickerUntil; }
      else if (boost === 'turboAutoclicker') { active = buffTurboUntil > now; until = buffTurboUntil; blocked = buffAutoclickerUntil <= now; }
      else if (boost === 'cooldown') { active = buffCooldownUntil > now; until = buffCooldownUntil; }
      else if (boost === 'superCooldown') { active = buffSuperCooldownUntil > now; until = buffSuperCooldownUntil; }
      else if (boost === 'powerCapacity') { active = buffPowerCapacityUntil > now; until = buffPowerCapacityUntil; }
      else if (boost === 'frenzy') { active = buffFrenzyUntil > now; until = buffFrenzyUntil; blocked = (typeof countActiveNewBuffs === 'function' && countActiveNewBuffs() >= 2 && !active) || now < buffFrenzyCooldownUntil; }
      else if (boost === 'overcharge') { active = buffOverchargeUntil > now; until = buffOverchargeUntil; blocked = (typeof countActiveNewBuffs === 'function' && countActiveNewBuffs() >= 2 && !active) || now < buffOverchargeCooldownUntil; }
      else if (boost === 'tokenMagnet') { active = buffTokenMagnetUntil > now; until = buffTokenMagnetUntil; blocked = (typeof countActiveNewBuffs === 'function' && countActiveNewBuffs() >= 2 && !active) || now < buffTokenMagnetCooldownUntil; }
      else if (boost === 'shield') { active = buffShieldUntil > now; until = buffShieldUntil; blocked = (typeof countActiveNewBuffs === 'function' && countActiveNewBuffs() >= 2 && !active) || now < buffShieldCooldownUntil; }
      else if (boost === 'burn') { active = buffBurnUntil > now; until = buffBurnUntil; blocked = (typeof countActiveNewBuffs === 'function' && countActiveNewBuffs() >= 2 && !active) || now < buffBurnCooldownUntil; }
      return { active: active, until: until, blocked: blocked };
    }
    function renderHomeStripCards() {
      var container = document.getElementById('home-strip-cards');
      if (!container) return;
      var ids = getHomeStripBuffs();
      var html = '';
      for (var i = 0; i < ids.length; i++) {
        var info = getBuffInfo(ids[i]);
        if (!info) continue;
        var borderCl = info.accent === 'yellow' ? 'border-neon-yellow/40' : info.accent === 'pink' ? 'border-neon-pink/40' : 'border-gray-700';
        var btnCl = info.accent === 'yellow' ? 'border-neon-yellow text-neon-yellow hover:bg-neon-yellow/10' : info.accent === 'pink' ? 'border-neon-pink text-neon-pink hover:bg-neon-pink/10' : 'border-neon-cyan text-neon-cyan hover:bg-neon-cyan/10';
        html += '<div class="home-strip-card bg-pixel-panel border-2 ' + borderCl + ' p-3 rounded text-center transition-colors" data-boost="' + info.id + '" data-cost="' + info.cost + '">';
        html += '<div class="text-base mb-1">' + info.icon + '</div>';
        html += '<div class="home-center-text text-[10px]">' + info.label + '</div>';
        html += '<div class="text-gray-500 home-center-text text-[9px]">' + info.cost + '</div>';
        html += '<button type="button" class="home-strip-btn boost-btn mt-2 border-2 ' + btnCl + ' px-2 py-1 rounded text-[9px] disabled:opacity-50 disabled:cursor-not-allowed" data-cost="' + info.cost + '" data-boost="' + info.id + '">USE</button>';
        html += '</div>';
      }
      container.innerHTML = html;
    }
    function updateHomeStrip() {
      var now = Date.now();
      var cards = document.querySelectorAll('#home-strip-cards .home-strip-card');
      function setCard(card, cost, boost) {
        if (!card) return;
        var btn = card.querySelector('.home-strip-btn');
        var st = getBuffState(boost);
        var canAfford = tokens >= cost && !st.blocked;
        card.classList.toggle('opacity-50', !canAfford);
        card.classList.toggle('pointer-events-none', !canAfford);
        if (btn) {
          btn.style.display = canAfford ? '' : 'none';
          if (canAfford) {
            btn.textContent = st.active ? getBuffCountdown(st.until) + 's' : 'USE';
            btn.disabled = tokens < cost || st.blocked;
          }
        }
      }
      for (var i = 0; i < cards.length; i++) {
        var c = cards[i];
        setCard(c, parseInt(c.getAttribute('data-cost'), 10), c.getAttribute('data-boost'));
      }
    }

    function updateBountiesUI() {
      updateBountyProgress();
      const today = todayKey();
      const dailyClaimBtn = document.getElementById('claim-daily');
      if (dailyClaimBtn) {
        dailyClaimBtn.disabled = lastDailyClaim === today;
        dailyClaimBtn.textContent = lastDailyClaim === today ? 'CLAIMED' : 'CLAIM';
      }
      const p50 = document.getElementById('bounty-50-progress');
      if (p50) p50.textContent = clicksToday;
      const claim50Btn = document.getElementById('claim-50');
      if (claim50Btn) {
        claim50Btn.disabled = clicksToday < 50 || claimed50Today;
        claim50Btn.textContent = claimed50Today ? 'CLAIMED' : 'CLAIM';
      }
      const p100 = document.getElementById('bounty-100-progress');
      if (p100) p100.textContent = clicksToday;
      const claim100Btn = document.getElementById('claim-100');
      if (claim100Btn) {
        claim100Btn.disabled = clicksToday < 100 || claimed100Today;
        claim100Btn.textContent = claimed100Today ? 'CLAIMED' : 'CLAIM';
      }
      const pWeek = document.getElementById('bounty-weekly-progress');
      if (pWeek) pWeek.textContent = weeklyClicks;
      const claimWeekBtn = document.getElementById('claim-weekly');
      if (claimWeekBtn) {
        claimWeekBtn.disabled = weeklyClicks < 500 || claimedWeekly;
        claimWeekBtn.textContent = claimedWeekly ? 'CLAIMED' : 'CLAIM';
      }
      var shareDate = localStorage.getItem('tokenClicker_shareDate') || '';
      var hasSharedToday = shareDate === todayKey();
      var claimedShareToday = lastShareClaim === todayKey();
      var claimShareBtn = document.getElementById('claim-share');
      if (claimShareBtn) {
        claimShareBtn.disabled = !hasSharedToday || claimedShareToday;
        claimShareBtn.textContent = claimedShareToday ? 'CLAIMED' : 'CLAIM';
      }
      var hasFriend = !!localStorage.getItem('tokenClicker_invitedBy');
      var claimFirstFriendBtn = document.getElementById('claim-firstfriend');
      if (claimFirstFriendBtn) {
        claimFirstFriendBtn.disabled = !hasFriend || claimedFirstFriend;
        claimFirstFriendBtn.textContent = claimedFirstFriend ? 'CLAIMED' : 'CLAIM';
      }
      [500, 1000, 2500, 5000, 10000].forEach(function(goal) {
        var p = document.getElementById('bounty-' + goal + '-progress');
        if (p) p.textContent = totalClicks;
        var btn = document.getElementById('claim-' + goal);
        if (!btn) return;
        var claimed = goal === 500 ? claimed500total : goal === 1000 ? claimed1000total : goal === 2500 ? claimed2500total : goal === 5000 ? claimed5000total : claimed10000total;
        btn.disabled = totalClicks < goal || claimed;
        btn.textContent = claimed ? 'CLAIMED' : 'CLAIM';
      });
      var claimLuckyBtn = document.getElementById('claim-lucky7');
      if (claimLuckyBtn) {
        claimLuckyBtn.disabled = totalClicks < 777 || claimedLucky777;
        claimLuckyBtn.textContent = claimedLucky777 ? 'CLAIMED' : 'CLAIM';
      }
      var clickMasterUnlocked = localStorage.getItem('tokenClicker_clickMaster') === '1' || peakClicksPerSecond >= 5;
      var claimClickMasterBtn = document.getElementById('claim-clickmaster');
      if (claimClickMasterBtn) {
        claimClickMasterBtn.disabled = !clickMasterUnlocked || claimedClickMaster;
        claimClickMasterBtn.textContent = claimedClickMaster ? 'CLAIMED' : 'CLAIM';
      }
      var peakEl = document.getElementById('bounty-clickmaster-peak');
      if (peakEl) peakEl.textContent = peakClicksPerSecond;
      var speedUnlocked = localStorage.getItem('tokenClicker_speedDemon') === '1';
      var claimSpeedBtn = document.getElementById('claim-speed');
      if (claimSpeedBtn) {
        claimSpeedBtn.disabled = !speedUnlocked || claimedSpeedDemon;
        claimSpeedBtn.textContent = claimedSpeedDemon ? 'CLAIMED' : 'CLAIM';
      }
      var claimHoarderBtn = document.getElementById('claim-hoarder');
      if (claimHoarderBtn) {
        claimHoarderBtn.disabled = tokens < 100 || claimedHoarder;
        claimHoarderBtn.textContent = claimedHoarder ? 'CLAIMED' : 'CLAIM';
      }
      [500, 1000, 2500, 5000, 10000, 25000, 50000].forEach(function(goal) {
        var suf = goal + 'balance';
        var p = document.getElementById('bounty-' + suf + '-progress');
        if (p) p.textContent = Math.min(tokens, goal);
        var btn = document.getElementById('claim-' + suf);
        if (!btn) return;
        var claimed = goal === 500 ? claimed500balance : goal === 1000 ? claimed1000balance : goal === 2500 ? claimed2500balance : goal === 5000 ? claimed5000balance : goal === 10000 ? claimed10000balance : goal === 25000 ? claimed25000balance : claimed50000balance;
        btn.disabled = tokens < goal || claimed;
        btn.textContent = claimed ? 'CLAIMED' : 'CLAIM';
      });
      switchBountyTab(currentBountyTab);
      save();
    }

    function updateLeaderboard() {
      let leaderboard = [];
      try {
        leaderboard = JSON.parse(localStorage.getItem('tokenClicker_leaderboard') || '[]');
      } catch (_) {}
      if (!Array.isArray(leaderboard) || leaderboard.length === 0) {
        leaderboard = [ { name: 'Alpha', tokens: 500 }, { name: 'Beta', tokens: 300 } ];
      }
      const me = leaderboard.find(e => e.name === 'You');
      if (me) me.tokens = tokens; else leaderboard.push({ name: 'You', tokens });
      leaderboard.sort((a, b) => b.tokens - a.tokens);
      try { localStorage.setItem('tokenClicker_leaderboard', JSON.stringify(leaderboard)); } catch (_) {}
      const list = document.getElementById('leaderboard-list');
      if (list) {
        var name = function(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); };
        var newHtml = leaderboard.slice(0, 10).map(function(e) {
          return '<li>' + name(e.name) + ' ‚Äî ' + e.tokens + ' tokens</li>';
        }).join('');
        if (list.innerHTML !== newHtml) list.innerHTML = newHtml;
      }
      let refCode = localStorage.getItem('tokenClicker_refCode');
      if (!refCode) {
        refCode = 'REF' + Math.random().toString(36).slice(2, 8).toUpperCase();
        localStorage.setItem('tokenClicker_refCode', refCode);
      }
      const refEl = document.getElementById('referral-code');
      if (refEl) refEl.textContent = refCode;
      if (typeof subscribeReferralsRealtime === 'function') subscribeReferralsRealtime();
      if (typeof subscribeFriendRequestsRealtime === 'function') subscribeFriendRequestsRealtime();
      if (typeof subscribeFriendRequestAcceptedRealtime === 'function') subscribeFriendRequestAcceptedRealtime();
      if (typeof subscribeTokenReceivedRealtime === 'function') subscribeTokenReceivedRealtime();
    }
    function aggregatePvpLeaderboard(data, limit) {
      var byName = {};
      data.forEach(function(e) {
        var name = (e.name || 'Player').trim() || 'Player';
        var w = e.pvp_wins != null ? Number(e.pvp_wins) : 0;
        var tok = e.pvp_tokens_won != null ? Number(e.pvp_tokens_won) : 0;
        if (!byName[name]) byName[name] = { wins: 0, tokensWon: 0 };
        byName[name].wins += w;
        byName[name].tokensWon += tok;
      });
      return Object.keys(byName).map(function(name) {
        return { name: name, wins: byName[name].wins, tokensWon: byName[name].tokensWon };
      }).sort(function(a, b) { return b.wins - a.wins; }).slice(0, limit);
    }
    function loadLeaderboardPvp() {
      var supabase = window.supabaseClient;
      var tbody = document.getElementById('leaderboard-pvp-tbody');
      if (!tbody) return;
      function setAll(html) { tbody.innerHTML = html; }
      if (!supabase) {
        setAll('<tr><td colspan="4" class="py-2 px-2 text-gray-500">Leaderboard unavailable.</td></tr>');
        return;
      }
      var hadContent = tbody.innerHTML && tbody.innerHTML.indexOf('Loading') < 0 && tbody.innerHTML.indexOf('No duel wins') < 0 && tbody.innerHTML.indexOf('unavailable') < 0;
      if (!hadContent) setAll('<tr><td colspan="4" class="py-2 px-2 text-gray-500">Loading‚Ä¶</td></tr>');
      function renderRows(data) {
        if (!data || data.length === 0) {
          setAll('<tr><td colspan="4" class="py-2 px-2 text-gray-500">No duel wins yet.</td></tr>');
          return;
        }
        var sorted = aggregatePvpLeaderboard(data, 5);
        setAll(sorted.map(function(e, i) {
          var name = (e.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return '<tr class="border-b border-gray-700/50"><td class="py-1.5 px-2">' + (i + 1) + '</td><td class="py-1.5 px-2">' + name + '</td><td class="py-1.5 px-2">' + e.wins + '</td><td class="py-1.5 px-2">' + e.tokensWon + '</td></tr>';
        }).join(''));
      }
      supabase.from('leaderboard').select('name, pvp_wins, pvp_tokens_won').gt('pvp_wins', 0).then(function(r) {
        if (r.error) {
          supabase.from('leaderboard').select('name, pvp_wins, pvp_tokens_won').gt('pvp_wins', 0).then(function(r2) {
            if (r2.error || !r2.data) { setAll('<tr><td colspan="4" class="py-2 px-2 text-gray-500">No duel wins yet.</td></tr>'); return; }
            renderRows(r2.data);
          });
          return;
        }
        renderRows(r.data);
      });
    }
    function loadPvpFullList() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('pvp-full-list-content');
      if (!list) return;
      if (!supabase) { list.innerHTML = '<li class="text-gray-500">Leaderboard unavailable.</li>'; return; }
      list.innerHTML = '<li class="text-gray-500">Loading‚Ä¶</li>';
      function renderList(data) {
        if (!data || data.length === 0) {
          list.innerHTML = '<li class="text-gray-500">No duel wins yet.</li>';
          return;
        }
        var sorted = aggregatePvpLeaderboard(data, 100);
        list.innerHTML = sorted.map(function(e) {
          var tok = e.tokensWon;
          return '<li>' + e.name + ' ‚Äî ' + e.wins + ' win' + (e.wins !== 1 ? 's' : '') + ', ' + tok + ' token' + (tok !== 1 ? 's' : '') + ' won</li>';
        }).join('');
      }
      supabase.from('leaderboard').select('name, pvp_wins, pvp_tokens_won').gt('pvp_wins', 0).then(function(r) {
        if (r.error) {
          supabase.from('leaderboard').select('name, pvp_wins, pvp_tokens_won').gt('pvp_wins', 0).then(function(r2) {
            if (r2.error || !r2.data) { list.innerHTML = '<li class="text-gray-500">No duel wins yet.</li>'; return; }
            renderList(r2.data);
          });
          return;
        }
        renderList(r.data);
      });
    }

    function updateClicksPerSecond() {
      const now = Date.now();
      if (now - lastSecondTime >= 1000) {
        clicksInLastSecond = 0;
        lastSecondTime = now;
      }
      if (clicksPerSecEl) clicksPerSecEl.textContent = clicksInLastSecond;
    }

    function addTokens(amount) {
      tokens += amount;
      updateUI();
      save();
    }

    function onValidClick() {
      if (isDead) return -1;
      var cost = POWER_COST_PER_CLICK * (hasBurn() ? 3 : 1);
      if (power < cost) return -1;
      updateStreak();
      power = Math.max(0, power - cost);
      lastClickTime = Date.now();
      lastActivityAt = lastClickTime;
      if (comboLastClickAt && lastClickTime - comboLastClickAt > COMBO_IDLE_RESET_MS) comboStartedAt = 0;
      comboLastClickAt = lastClickTime;
      if (comboStartedAt === 0) comboStartedAt = lastClickTime;
      updatePowerBar();

      var eff = getEffectiveTapPower();
      totalClicks++;
      const prevEffective = (totalClicks - 1) * eff;
      const newEffective = totalClicks * eff;
      var earned = Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
      var combo = getComboMultiplier();
      earned = Math.max(0, Math.floor(earned * combo));
      if (rollCrit()) earned *= 2;
      if (hasTokenMagnet()) earned = Math.max(0, Math.floor(earned * 1.35));
      tokens += earned;

      const now = lastClickTime;
      const nowSec = now / 1000;
      if (Math.floor(nowSec) > Math.floor(lastSecondTime / 1000)) {
        lastSecondTime = now;
        clicksInLastSecond = 0;
      }
      clicksInLastSecond++;
      if (clicksInLastSecond > peakClicksPerSecond) peakClicksPerSecond = clicksInLastSecond;
      if (clicksInLastSecond >= 5) try { localStorage.setItem('tokenClicker_clickMaster', '1'); } catch (e) {}
      if (clicksInLastSecond >= 8) try { localStorage.setItem('tokenClicker_speedDemon', '1'); } catch (e) {}

      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) { clicksToday = 0; claimed100Today = false; claimed50Today = false; lastDate = today; }
      if (week !== weekStartKey) { weeklyClicks = 0; claimedWeekly = false; weekStartKey = week; }
      clicksToday++;
      weeklyClicks++;

      updateUI();
      save();
      updateClicksPerSecond();
      return earned;
    }

    function spawnFeathersAt(cx, cy) {
      for (var i = 0; i < 3; i++) {
        var el = document.createElement('div');
        el.className = 'feather-fall feather-sway' + (1 + (i % 3));
        el.style.left = (cx + (Math.random() - 0.5) * 20) + 'px';
        el.style.top = cy + 'px';
        el.style.marginLeft = '-26px';
        el.style.marginTop = '-16px';
        var img = document.createElement('img');
        img.src = 'assets/cardinal-feather.png';
        img.alt = '';
        img.className = 'image-pixel';
        img.style.width = '52px';
        img.style.height = 'auto';
        img.style.display = 'block';
        el.appendChild(img);
        document.body.appendChild(el);
        (function(featherEl) {
          var dur = localStorage.getItem('tokenClicker_reducedMotion') === '1' ? 500 : 1500;
          setTimeout(function() { if (featherEl.parentNode) featherEl.remove(); }, dur);
        })(el);
      }
    }
    function playTapSound() {
      if (localStorage.getItem('tokenClicker_sound') === '0') return;
      try {
        var ctx = window.tapSoundCtx || (window.tapSoundCtx = new (window.AudioContext || window.webkitAudioContext)());
        if (ctx.state === 'suspended') ctx.resume();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 800;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.08, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.05);
      } catch (e) {}
    }
    function triggerHaptics() {
      if (localStorage.getItem('tokenClicker_haptics') === '0') return;
      if (navigator.vibrate) navigator.vibrate(10);
    }
    function spawnClickEffects(earned, clickEvent) {
      var showFeathers = localStorage.getItem('tokenClicker_featherEffects') !== '0';
      var cx = clickEvent && typeof clickEvent.clientX === 'number' ? clickEvent.clientX : (nftClicker && nftClicker.getBoundingClientRect().left + nftClicker.getBoundingClientRect().width / 2);
      var cy = clickEvent && typeof clickEvent.clientY === 'number' ? clickEvent.clientY : (nftClicker && nftClicker.getBoundingClientRect().top + nftClicker.getBoundingClientRect().height / 2);

      if (showFeathers) spawnFeathersAt(cx, cy);
      playTapSound();
      triggerHaptics();

      var valueEl = document.createElement('div');
      valueEl.className = 'tap-value-float';
      valueEl.textContent = '+1';
      valueEl.style.left = cx + 'px';
      valueEl.style.top = cy + 'px';
      document.body.appendChild(valueEl);
      setTimeout(function() { if (valueEl.parentNode) valueEl.remove(); }, 1100);
    }

    if (nftClicker) nftClicker.addEventListener('click', function(e) {
      var earned = onValidClick();
      if (earned >= 0) {
        spawnClickEffects(earned, e);
        nftClicker.classList.remove('pvp-duel-tap-pulse');
        nftClicker.offsetHeight;
        nftClicker.classList.add('pvp-duel-tap-pulse');
        setTimeout(function() { if (nftClicker) nftClicker.classList.remove('pvp-duel-tap-pulse'); }, 120);
      }
    });
    var badge1 = document.getElementById('badge-1');
    if (badge1 && nftClicker) badge1.addEventListener('click', function(e) { e.preventDefault(); nftClicker.click(); });

    document.getElementById('death-revive-btn') && document.getElementById('death-revive-btn').addEventListener('click', function() { reviveBird(); });
    document.getElementById('death-hatch-btn') && document.getElementById('death-hatch-btn').addEventListener('click', function() { reviveByHatch(); });

    // Boosts: tab switching
    function showBoostTab(tabId) {
      tabId = tabId || 'tappower';
      document.querySelectorAll('.boost-tab-btn').forEach(function(btn) {
        var t = btn.getAttribute('data-boost-tab');
        if (t === tabId) {
          btn.classList.remove('border-gray-600', 'text-gray-400');
          btn.classList.add('border-neon-cyan', 'text-neon-cyan', 'bg-neon-cyan/10');
          btn.classList.remove('border-neon-green', 'text-neon-green', 'border-neon-pink', 'text-neon-pink', 'border-neon-yellow', 'text-neon-yellow');
        } else {
          btn.classList.add('border-gray-600', 'text-gray-400');
          btn.classList.remove('border-neon-cyan', 'text-neon-cyan', 'bg-neon-cyan/10', 'border-neon-green', 'text-neon-green', 'border-neon-pink', 'text-neon-pink', 'border-neon-yellow', 'text-neon-yellow');
        }
      });
      document.querySelectorAll('.boost-panel').forEach(function(panel) {
        var p = panel.getAttribute('data-boost-panel');
        if (p === tabId) { panel.classList.remove('hidden'); } else { panel.classList.add('hidden'); }
      });
      try { localStorage.setItem('tokenClicker_boostTab', tabId); } catch (e) {}
    }
    document.querySelectorAll('.boost-tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() { showBoostTab(btn.getAttribute('data-boost-tab')); });
    });
    var savedBoostTab = localStorage.getItem('tokenClicker_boostTab') || 'tappower';
    if (document.querySelector('.boost-tab-btn[data-boost-tab="' + savedBoostTab + '"]')) showBoostTab(savedBoostTab);

    // Wallet: tab switching + header Connect button
    function showWalletTab(tabId) {
      tabId = tabId || 'balance';
      var activeColors = { balance: 'border-neon-cyan text-neon-cyan bg-neon-cyan/10', connect: 'border-neon-cyan text-neon-cyan bg-neon-cyan/10', swap: 'border-neon-green text-neon-green bg-neon-green/10', withdraw: 'border-neon-pink text-neon-pink bg-neon-pink/10', send: 'border-neon-yellow text-neon-yellow bg-neon-yellow/10' };
      var allColorClasses = ['border-neon-cyan', 'text-neon-cyan', 'bg-neon-cyan/10', 'border-neon-green', 'text-neon-green', 'bg-neon-green/10', 'border-neon-pink', 'text-neon-pink', 'bg-neon-pink/10', 'border-neon-yellow', 'text-neon-yellow', 'bg-neon-yellow/10'];
      document.querySelectorAll('.wallet-tab-btn').forEach(function(btn) {
        var t = btn.getAttribute('data-wallet-tab');
        btn.classList.remove.apply(btn.classList, allColorClasses);
        btn.classList.remove('font-bold');
        if (t === tabId) {
          btn.classList.add('font-bold');
          (activeColors[tabId] || activeColors.balance).split(' ').forEach(function(c) { btn.classList.add(c); });
        } else {
          btn.classList.add('border-gray-600', 'text-gray-400');
        }
      });
      document.querySelectorAll('.wallet-panel').forEach(function(panel) {
        var p = panel.getAttribute('data-wallet-panel');
        if (p === tabId) { panel.classList.remove('hidden'); } else { panel.classList.add('hidden'); }
      });
      var headerConnectBtn = document.getElementById('wallet-header-connect-btn');
      if (headerConnectBtn) {
        if (tabId === 'connect') {
          headerConnectBtn.classList.add('ring-2', 'ring-offset-1', 'ring-offset-black', 'ring-neon-cyan');
          headerConnectBtn.classList.remove('ring-2', 'ring-offset-1', 'ring-offset-black', 'ring-neon-green');
        } else {
          headerConnectBtn.classList.remove('ring-2', 'ring-offset-1', 'ring-offset-black', 'ring-neon-cyan', 'ring-neon-green');
        }
      }
      try { localStorage.setItem('tokenClicker_walletTab', tabId); } catch (e) {}
      if (tabId === 'send') {
        if (typeof syncTokensFromLeaderboard === 'function') syncTokensFromLeaderboard(function() {});
        var code = localStorage.getItem('tokenClicker_refCode');
        if (!code) { code = 'REF' + Math.random().toString(36).slice(2, 8).toUpperCase(); try { localStorage.setItem('tokenClicker_refCode', code); } catch (e) {} }
        var codeEl = document.getElementById('send-my-wallet-code');
        if (codeEl) codeEl.textContent = code || '‚Äî';
        if (typeof loadSendPlayersList === 'function') loadSendPlayersList();
        if (typeof loadSendTransactions === 'function') loadSendTransactions();
        var qrContainer = document.getElementById('send-qrcode-container');
        if (qrContainer && code) {
          qrContainer.innerHTML = '';
          var base = (typeof getShareBaseUrl === 'function' ? getShareBaseUrl() : (window.location.origin + window.location.pathname)).replace(/\/?$/, '');
          var sendToUrl = base + '#wallet?sendTo=' + encodeURIComponent(code);
          if (typeof QRCode !== 'undefined') {
            try { new QRCode(qrContainer, { text: sendToUrl, width: 120, height: 120 }); } catch (e) {}
          }
        }
        var sendQrBalanceEl = document.getElementById('send-qr-balance');
        if (sendQrBalanceEl) {
          var tokens = Math.max(0, parseInt(localStorage.getItem('tokenClicker_tokens') || '0', 10));
          sendQrBalanceEl.textContent = String(tokens);
        }
      }
      if (typeof ensureLeaderboardRow === 'function') ensureLeaderboardRow();
    }
    document.getElementById('send-copy-my-code-btn') && document.getElementById('send-copy-my-code-btn').addEventListener('click', function() {
      var codeEl = document.getElementById('send-my-wallet-code');
      var code = codeEl ? codeEl.textContent.trim() : '';
      if (code && code !== '‚Äî') {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(code).then(function() {
            var btn = document.getElementById('send-copy-my-code-btn');
            if (btn) { btn.textContent = 'COPIED!'; setTimeout(function() { if (btn) btn.textContent = 'COPY'; }, 1500); }
          }).catch(function() {});
        }
      }
    });
    document.querySelectorAll('.wallet-tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() { showWalletTab(btn.getAttribute('data-wallet-tab')); });
    });
    var headerConnectBtn = document.getElementById('wallet-header-connect-btn');
    if (headerConnectBtn) headerConnectBtn.addEventListener('click', function() { showWalletTab('connect'); });
    var savedWalletTab = localStorage.getItem('tokenClicker_walletTab') || 'balance';
    if (document.querySelector('.wallet-tab-btn[data-wallet-tab="' + savedWalletTab + '"]')) showWalletTab(savedWalletTab);
    else if (savedWalletTab === 'connect') showWalletTab('connect');
    // Customize quick buffs modal
    var customizeBuffsEditing = [];
    function openCustomizeBuffsModal() {
      customizeBuffsEditing = getHomeStripBuffs().slice();
      var list = document.getElementById('customize-buffs-list');
      var addSelect = document.getElementById('customize-buffs-add-select');
      var msgEl = document.getElementById('customize-buffs-msg');
      if (list) list.innerHTML = '';
      if (msgEl) msgEl.textContent = '';
      if (!list || !addSelect) return;
      function renderList() {
        list.innerHTML = customizeBuffsEditing.map(function(id, idx) {
          var info = getBuffInfo(id);
          if (!info) return '';
          return '<li class="flex items-center gap-2 py-1.5 border-b border-gray-700/50 last:border-0">' +
            '<span class="flex-1 text-[10px]">' + info.icon + ' ' + info.label + ' (' + info.cost + ')</span>' +
            '<button type="button" class="customize-buff-up py-1 px-1.5 border border-gray-500 text-gray-400 rounded text-[8px] hover:bg-gray-700" data-idx="' + idx + '" aria-label="Move up">‚Üë</button>' +
            '<button type="button" class="customize-buff-down py-1 px-1.5 border border-gray-500 text-gray-400 rounded text-[8px] hover:bg-gray-700" data-idx="' + idx + '" aria-label="Move down">‚Üì</button>' +
            '<button type="button" class="customize-buff-remove py-1 px-1.5 border border-neon-pink text-neon-pink rounded text-[8px] hover:bg-neon-pink/10" data-idx="' + idx + '" aria-label="Remove ' + (info.label || id) + '">‚úï</button>' +
            '</li>';
        }).join('');
      }
      var opts = HOME_STRIP_BUFF_CATALOG.filter(function(b) { return customizeBuffsEditing.indexOf(b.id) < 0; }).map(function(b) { return '<option value="' + b.id + '">' + b.icon + ' ' + b.label + ' (' + b.cost + ')</option>'; });
      addSelect.innerHTML = '<option value="">‚Äî Choose ‚Äî</option>' + opts.join('');
      function updateAddState() {
        var msgEl = document.getElementById('customize-buffs-msg');
        var addBtn = document.getElementById('customize-buffs-add-btn');
        if (addBtn) addBtn.disabled = customizeBuffsEditing.length >= HOME_STRIP_MAX;
        if (msgEl) {
          if (customizeBuffsEditing.length >= HOME_STRIP_MAX) msgEl.textContent = 'Strip is full (max 3). Remove a buff first to add another.';
          else msgEl.textContent = '';
        }
      }
      renderList();
      updateAddState();
      list.onclick = function(ev) {
        var btn = ev.target && ev.target.closest && ev.target.closest('button');
        if (!btn || !btn.getAttribute) return;
        var idx = btn.getAttribute('data-idx');
        if (idx == null) return;
        idx = parseInt(idx, 10);
        if (btn.classList.contains('customize-buff-up') && idx > 0) {
          customizeBuffsEditing[idx] = customizeBuffsEditing.splice(idx - 1, 1, customizeBuffsEditing[idx])[0];
          renderList();
          updateAddState();
        } else if (btn.classList.contains('customize-buff-down') && idx < customizeBuffsEditing.length - 1) {
          customizeBuffsEditing[idx] = customizeBuffsEditing.splice(idx + 1, 1, customizeBuffsEditing[idx])[0];
          renderList();
          updateAddState();
        } else if (btn.classList.contains('customize-buff-remove')) {
          customizeBuffsEditing.splice(idx, 1);
          renderList();
          var opts2 = HOME_STRIP_BUFF_CATALOG.filter(function(b) { return customizeBuffsEditing.indexOf(b.id) < 0; }).map(function(b) { return '<option value="' + b.id + '">' + b.icon + ' ' + b.label + ' (' + b.cost + ')</option>'; });
          addSelect.innerHTML = '<option value="">‚Äî Choose ‚Äî</option>' + opts2.join('');
          updateAddState();
        }
      };
      document.getElementById('customize-buffs-modal').classList.remove('hidden');
      document.getElementById('customize-buffs-modal').style.display = 'flex';
    }
    function closeCustomizeBuffsModal() {
      document.getElementById('customize-buffs-modal').classList.add('hidden');
      document.getElementById('customize-buffs-modal').style.display = 'none';
    }
    document.getElementById('home-customize-buffs-btn') && document.getElementById('home-customize-buffs-btn').addEventListener('click', openCustomizeBuffsModal);
    document.getElementById('customize-buffs-modal-close') && document.getElementById('customize-buffs-modal-close').addEventListener('click', closeCustomizeBuffsModal);
    document.getElementById('customize-buffs-modal') && document.getElementById('customize-buffs-modal').addEventListener('click', function(e) { if (e.target && e.target.id === 'customize-buffs-modal') closeCustomizeBuffsModal(); });
    // Room settings modal (room name + copy link). LocalStorage fallback when DB column missing.
    var roomSettingsModalRoomId = null;
    function getLocalRoomName(roomId) { try { var v = localStorage.getItem('pvp_room_name_' + roomId); return (v && v.trim()) ? v.trim() : ''; } catch (e) { return ''; } }
    function setLocalRoomName(roomId, name) { try { if (roomId && name) localStorage.setItem('pvp_room_name_' + roomId, name); else if (roomId) localStorage.removeItem('pvp_room_name_' + roomId); } catch (e) {} }
    function openRoomSettingsModal(roomId) {
      if (!roomId) return;
      roomSettingsModalRoomId = roomId;
      var nameInput = document.getElementById('room-settings-name');
      var linkInput = document.getElementById('room-settings-link');
      var saveStatus = document.getElementById('room-settings-save-status');
      if (saveStatus) saveStatus.textContent = '';
      var base = (typeof getShareBaseUrl === 'function' ? getShareBaseUrl() : (window.location.origin + window.location.pathname)).replace(/\/?$/, '');
      var shareUrl = base + '/?room=' + roomId;
      if (linkInput) linkInput.value = shareUrl;
      var supabase = window.supabaseClient;
      if (nameInput) nameInput.value = getLocalRoomName(roomId);
      if (supabase) {
        supabase.from('rooms').select('room_name').eq('id', roomId).single().then(function(r) {
          if (nameInput && !r.error && r.data && r.data.room_name && (r.data.room_name || '').trim()) nameInput.value = (r.data.room_name || '').trim();
          else if (nameInput && !getLocalRoomName(roomId)) nameInput.value = '';
        }).catch(function() {});
      }
      document.getElementById('room-settings-modal').classList.remove('hidden');
      document.getElementById('room-settings-modal').style.display = 'flex';
    }
    function closeRoomSettingsModal() {
      roomSettingsModalRoomId = null;
      document.getElementById('room-settings-modal').classList.add('hidden');
      document.getElementById('room-settings-modal').style.display = 'none';
    }
    document.getElementById('room-settings-modal-close') && document.getElementById('room-settings-modal-close').addEventListener('click', closeRoomSettingsModal);
    document.getElementById('room-settings-modal') && document.getElementById('room-settings-modal').addEventListener('click', function(e) { if (e.target && e.target.id === 'room-settings-modal') closeRoomSettingsModal(); });
    document.getElementById('room-settings-save-btn') && document.getElementById('room-settings-save-btn').addEventListener('click', function() {
      if (!roomSettingsModalRoomId) return;
      var nameInput = document.getElementById('room-settings-name');
      var saveStatus = document.getElementById('room-settings-save-status');
      var name = nameInput ? (nameInput.value || '').trim() : '';
      setLocalRoomName(roomSettingsModalRoomId, name);
      if (!window.supabaseClient) {
        if (saveStatus) saveStatus.textContent = 'Saved (this device)';
        if (typeof loadPvpRooms === 'function') loadPvpRooms();
        if (saveStatus) setTimeout(function() { saveStatus.textContent = ''; }, 2000);
        return;
      }
      window.supabaseClient.from('rooms').update({ room_name: name || null, updated_at: new Date().toISOString() }).eq('id', roomSettingsModalRoomId).then(function(r) {
        if (saveStatus) saveStatus.textContent = r.error ? 'Saved (this device)' : 'Saved';
        if (typeof loadPvpRooms === 'function') loadPvpRooms();
        if (saveStatus) setTimeout(function() { saveStatus.textContent = ''; }, 2000);
      });
    });
    document.getElementById('room-settings-copy-btn') && document.getElementById('room-settings-copy-btn').addEventListener('click', function() {
      var linkInput = document.getElementById('room-settings-link');
      var url = linkInput ? linkInput.value.trim() : '';
      if (!url) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() {
          var btn = document.getElementById('room-settings-copy-btn');
          if (btn) { btn.textContent = 'COPIED!'; setTimeout(function() { if (btn) btn.textContent = 'COPY LINK'; }, 1500); }
        }).catch(function() {});
      }
    });
    document.getElementById('room-settings-customize-boosts-btn') && document.getElementById('room-settings-customize-boosts-btn').addEventListener('click', function() {
      if (typeof openCustomizeBuffsModal === 'function') openCustomizeBuffsModal();
    });
    window.openRoomSettingsModal = openRoomSettingsModal;
    document.getElementById('customize-buffs-done') && document.getElementById('customize-buffs-done').addEventListener('click', function() {
      saveHomeStripBuffs(customizeBuffsEditing);
      renderHomeStripCards();
      updateHomeStrip();
      closeCustomizeBuffsModal();
    });
    document.getElementById('customize-buffs-add-btn') && document.getElementById('customize-buffs-add-btn').addEventListener('click', function(ev) {
      if (ev) { ev.preventDefault(); ev.stopPropagation(); }
      var msgEl = document.getElementById('customize-buffs-msg');
      var addBtn = document.getElementById('customize-buffs-add-btn');
      var sel = document.getElementById('customize-buffs-add-select');
      if (!sel) return;
      var id = sel.value || (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].value) || '';
      id = (id && id.trim) ? id.trim() : id;
      if (msgEl) msgEl.textContent = '';
      if (!id) {
        if (msgEl) msgEl.textContent = 'Choose a buff from the list above.';
        return;
      }
      if (customizeBuffsEditing.length >= HOME_STRIP_MAX) {
        if (msgEl) msgEl.textContent = 'Strip is full (max 3). Remove a buff first.';
        return;
      }
      if (customizeBuffsEditing.indexOf(id) >= 0) {
        if (msgEl) msgEl.textContent = 'That buff is already in your strip.';
        return;
      }
      customizeBuffsEditing.push(id);
      var list = document.getElementById('customize-buffs-list');
      var addSelect = document.getElementById('customize-buffs-add-select');
      if (!list) return;
      list.innerHTML = customizeBuffsEditing.map(function(bid, idx) {
        var info = getBuffInfo(bid);
        if (!info) return '<li class="flex items-center gap-2 py-1.5 border-b border-gray-700/50"><span class="text-[10px] text-gray-500">' + bid + '</span><button type="button" class="customize-buff-remove" data-idx="' + idx + '">‚úï</button></li>';
        return '<li class="flex items-center gap-2 py-1.5 border-b border-gray-700/50 last:border-0">' +
          '<span class="flex-1 text-[10px]">' + info.icon + ' ' + info.label + ' (' + info.cost + ')</span>' +
          '<button type="button" class="customize-buff-up py-1 px-1.5 border border-gray-500 text-gray-400 rounded text-[8px] hover:bg-gray-700" data-idx="' + idx + '" aria-label="Move up">‚Üë</button>' +
          '<button type="button" class="customize-buff-down py-1 px-1.5 border border-gray-500 text-gray-400 rounded text-[8px] hover:bg-gray-700" data-idx="' + idx + '" aria-label="Move down">‚Üì</button>' +
          '<button type="button" class="customize-buff-remove py-1 px-1.5 border border-neon-pink text-neon-pink rounded text-[8px] hover:bg-neon-pink/10" data-idx="' + idx + '" aria-label="Remove ' + (info.label || bid) + '">‚úï</button>' +
          '</li>';
      }).join('');
      var opts = HOME_STRIP_BUFF_CATALOG.filter(function(b) { return customizeBuffsEditing.indexOf(b.id) < 0; }).map(function(b) { return '<option value="' + b.id + '">' + b.icon + ' ' + b.label + ' (' + b.cost + ')</option>'; });
      addSelect.innerHTML = '<option value="">‚Äî Choose ‚Äî</option>' + opts.join('');
      if (addBtn) addBtn.disabled = customizeBuffsEditing.length >= HOME_STRIP_MAX;
      if (msgEl) msgEl.textContent = 'Added. Click DONE to save.';
    });

    // Boosts: buy/use buffs (delegated so dynamic home-strip buttons work)
    document.addEventListener('click', function(e) {
      var btn = e.target && e.target.closest && e.target.closest('.boost-btn');
      if (!btn || !btn.dataset) return;
      const cost = parseInt(btn.dataset.cost, 10);
      const boost = btn.dataset.boost;
      if (!boost || isNaN(cost)) return;
      if (tokens < cost) return;
        updateBuffState();
        var now = Date.now();
        var end = now + BUFF_DURATION_MS;
        if (boost === 'tapPower') { tokens -= cost; buffTapPowerUntil = Math.max(buffTapPowerUntil, end); buffTapPowerLevel = Math.max(buffTapPowerLevel, 2); }
        if (boost === 'tapPower3') { tokens -= cost; buffTapPowerUntil = Math.max(buffTapPowerUntil, end); buffTapPowerLevel = Math.max(buffTapPowerLevel, 3); }
        if (boost === 'tapPower4') { tokens -= cost; buffTapPowerUntil = Math.max(buffTapPowerUntil, end); buffTapPowerLevel = Math.max(buffTapPowerLevel, 4); }
        if (boost === 'autoclicker') { tokens -= cost; buffAutoclickerUntil = Math.max(buffAutoclickerUntil, end); startAutoclicker(); }
        if (boost === 'turboAutoclicker' && buffAutoclickerUntil > now) { tokens -= cost; buffTurboUntil = Math.max(buffTurboUntil, end); restartAutoclicker(); }
        if (boost === 'cooldown') { tokens -= cost; buffCooldownUntil = Math.max(buffCooldownUntil, end); }
        if (boost === 'superCooldown') { tokens -= cost; buffSuperCooldownUntil = Math.max(buffSuperCooldownUntil, end); }
        if (boost === 'powerCapacity') { tokens -= cost; buffPowerCapacityUntil = Math.max(buffPowerCapacityUntil, end); }
        var nowMs = Date.now();
        if (boost === 'frenzy' && countActiveNewBuffs() < MAX_ACTIVE_BUFFS && !hasFrenzy() && nowMs >= buffFrenzyCooldownUntil) {
          tokens -= cost; buffFrenzyUntil = nowMs + BUFF_FRENZY_DURATION_MS;
          if (autoclickerInterval) restartAutoclicker();
        }
        if (boost === 'overcharge' && countActiveNewBuffs() < MAX_ACTIVE_BUFFS && !hasOvercharge() && nowMs >= buffOverchargeCooldownUntil) {
          tokens -= cost; buffOverchargeUntil = nowMs + BUFF_OVERCHARGE_DURATION_MS; buffOverchargeCooldownUntil = nowMs + BUFF_OVERCHARGE_DURATION_MS + BUFF_OVERCHARGE_COOLDOWN_MS;
        }
        if (boost === 'tokenMagnet' && countActiveNewBuffs() < MAX_ACTIVE_BUFFS && !hasTokenMagnet() && nowMs >= buffTokenMagnetCooldownUntil) {
          tokens -= cost; buffTokenMagnetUntil = nowMs + BUFF_TOKEN_MAGNET_DURATION_MS; buffTokenMagnetCooldownUntil = nowMs + BUFF_TOKEN_MAGNET_DURATION_MS + BUFF_TOKEN_MAGNET_COOLDOWN_MS;
        }
        if (boost === 'shield' && countActiveNewBuffs() < MAX_ACTIVE_BUFFS && !hasShield() && nowMs >= buffShieldCooldownUntil) {
          tokens -= cost; buffShieldUntil = nowMs + BUFF_SHIELD_DURATION_MS; buffShieldCooldownUntil = nowMs + BUFF_SHIELD_DURATION_MS + BUFF_SHIELD_COOLDOWN_MS;
        }
        if (boost === 'burn' && countActiveNewBuffs() < MAX_ACTIVE_BUFFS && !hasBurn() && nowMs >= buffBurnCooldownUntil) {
          tokens -= cost; buffBurnUntil = nowMs + BUFF_BURN_DURATION_MS; buffBurnCooldownUntil = nowMs + BUFF_BURN_DURATION_MS + BUFF_BURN_COOLDOWN_MS;
        }
      updateBuffState();
      updateUI();
      updateBoostButtons();
      save();
    });

    function getAutoclickerIntervalMs() {
      var base = (hasAutoclicker && hasTurboAutoclicker) ? 500 : 1000;
      if (hasFrenzy()) base = Math.floor(base / 2);
      return base;
    }
    function startAutoclicker() {
      if (autoclickerInterval) return;
      const ms = getAutoclickerIntervalMs();
      autoclickerInterval = setInterval(() => {
        totalClicks++;
        var eff = typeof getEffectiveTapPower === 'function' ? getEffectiveTapPower() : tapPower;
        const prevEffective = (totalClicks - 1) * eff;
        const newEffective = totalClicks * eff;
        tokens += Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
        const today = todayKey();
        const week = weekKey();
        if (today !== lastDate) { clicksToday = 0; lastDate = today; }
        if (week !== weekStartKey) { weeklyClicks = 0; weekStartKey = week; }
        clicksToday++;
        weeklyClicks++;
        updateUI();
        save();
      }, ms);
    }
    function restartAutoclicker() {
      if (autoclickerInterval) { clearInterval(autoclickerInterval); autoclickerInterval = null; }
      updateBuffState();
      if (hasAutoclicker) startAutoclicker();
    }

    // Bounties: claim
    document.querySelectorAll('.bounty-claim').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const reward = parseInt(btn.dataset.reward, 10);
        if (!id || btn.disabled) return;
        btn.disabled = true; // Prevent double-click
        let didClaim = false;
        if (id === 'daily' && lastDailyClaim !== todayKey()) { lastDailyClaim = todayKey(); addTokens(reward); didClaim = true; }
        if (id === '50today' && clicksToday >= 50 && !claimed50Today) { claimed50Today = true; addTokens(reward); didClaim = true; }
        if (id === '100today' && clicksToday >= 100 && !claimed100Today) { claimed100Today = true; addTokens(reward); didClaim = true; }
        if (id === 'weekly' && weeklyClicks >= 500 && !claimedWeekly) { claimedWeekly = true; addTokens(reward); didClaim = true; }
        if (id === 'share' && localStorage.getItem('tokenClicker_shareDate') === todayKey() && lastShareClaim !== todayKey()) { lastShareClaim = todayKey(); addTokens(reward); didClaim = true; }
        if (id === 'firstfriend' && !!localStorage.getItem('tokenClicker_invitedBy') && !claimedFirstFriend) { claimedFirstFriend = true; addTokens(reward); didClaim = true; }
        if (id === '500total' && totalClicks >= 500 && !claimed500total) { claimed500total = true; addTokens(reward); didClaim = true; }
        if (id === '1000total' && totalClicks >= 1000 && !claimed1000total) { claimed1000total = true; addTokens(reward); didClaim = true; }
        if (id === '2500total' && totalClicks >= 2500 && !claimed2500total) { claimed2500total = true; addTokens(reward); didClaim = true; }
        if (id === '5000total' && totalClicks >= 5000 && !claimed5000total) { claimed5000total = true; addTokens(reward); didClaim = true; }
        if (id === '10000total' && totalClicks >= 10000 && !claimed10000total) { claimed10000total = true; addTokens(reward); didClaim = true; }
        if (id === 'lucky777' && totalClicks >= 777 && !claimedLucky777) { claimedLucky777 = true; addTokens(reward); didClaim = true; }
        if (id === 'speeddemon' && localStorage.getItem('tokenClicker_speedDemon') === '1' && !claimedSpeedDemon) { claimedSpeedDemon = true; addTokens(reward); didClaim = true; }
        if (id === 'clickmaster' && (localStorage.getItem('tokenClicker_clickMaster') === '1' || peakClicksPerSecond >= 5) && !claimedClickMaster) { claimedClickMaster = true; addTokens(reward); didClaim = true; }
        if (id === 'hoarder' && tokens >= 100 && !claimedHoarder) { claimedHoarder = true; addTokens(reward); didClaim = true; }
        if (id === '500balance' && tokens >= 500 && !claimed500balance) { claimed500balance = true; addTokens(reward); didClaim = true; }
        if (id === '1000balance' && tokens >= 1000 && !claimed1000balance) { claimed1000balance = true; addTokens(reward); didClaim = true; }
        if (id === '2500balance' && tokens >= 2500 && !claimed2500balance) { claimed2500balance = true; addTokens(reward); didClaim = true; }
        if (id === '5000balance' && tokens >= 5000 && !claimed5000balance) { claimed5000balance = true; addTokens(reward); didClaim = true; }
        if (id === '10000balance' && tokens >= 10000 && !claimed10000balance) { claimed10000balance = true; addTokens(reward); didClaim = true; }
        if (id === '25000balance' && tokens >= 25000 && !claimed25000balance) { claimed25000balance = true; addTokens(reward); didClaim = true; }
        if (id === '50000balance' && tokens >= 50000 && !claimed50000balance) { claimed50000balance = true; addTokens(reward); didClaim = true; }
        if (didClaim) {
          updateStreak();
          save();
          try { pushNotification('Bounty claimed: +' + reward + ' tokens'); } catch (e) {}
          if (!localStorage.getItem('tokenClicker_firstBountyHintShown')) {
            try { pushNotification('Check the üîî for activity'); } catch (e) {}
            localStorage.setItem('tokenClicker_firstBountyHintShown', '1');
          }
        }
        updateBountiesUI();
      });
    });
    document.getElementById('bounty-tab-toclaim') && document.getElementById('bounty-tab-toclaim').addEventListener('click', function() { switchBountyTab('toclaim'); });
    document.getElementById('bounty-tab-claimed') && document.getElementById('bounty-tab-claimed').addEventListener('click', function() { switchBountyTab('claimed'); });
    document.querySelectorAll('.bounty-category-tab').forEach(function(btn) {
      btn.addEventListener('click', function() {
        showBountyCategory(btn.getAttribute('data-bounty-category'));
        if (currentBountyTab === 'claimed') switchBountyTab('claimed');
      });
    });
    if (currentBountyTab === 'toclaim') showBountyCategory(currentBountyCategory);

    // Share URL: use canonical game URL so shared links open on mobile (production site)
    function getShareBaseUrl() {
      var base = (window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl) || (window.location.origin + window.location.pathname).replace(/\/$/, '');
      return base;
    }
    function getInviteUrl() {
      var code = localStorage.getItem('tokenClicker_refCode') || 'REF0000';
      return getShareBaseUrl() + '/?ref=' + encodeURIComponent(code);
    }
    function getGameUrl() {
      return getShareBaseUrl() + '/';
    }
    function getShareText() { return 'Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends!'; }
    function markSharedGame() {
      try {
        localStorage.setItem('tokenClicker_hasSharedGame', '1');
        localStorage.setItem('tokenClicker_shareDate', todayKey());
      } catch (e) {}
      if (typeof updateBountiesUI === 'function') updateBountiesUI();
    }
    var platformNames = { x: 'X', telegram: 'Telegram', facebook: 'Facebook', email: 'Email', sms: 'SMS' };
    function showShareConfirmModal(platform, onConfirm) {
      var modal = document.getElementById('share-confirm-modal');
      var msg = document.getElementById('share-confirm-msg');
      var yesBtn = document.getElementById('share-confirm-yes');
      var noBtn = document.getElementById('share-confirm-no');
      if (!modal || !msg) return;
      msg.textContent = 'Did you share the game on ' + (platformNames[platform] || platform) + '?';
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      function closeModal() { modal.classList.add('hidden'); modal.style.display = 'none'; }
      yesBtn.onclick = function() { closeModal(); if (onConfirm) onConfirm(); yesBtn.onclick = null; noBtn.onclick = null; };
      noBtn.onclick = function() { closeModal(); yesBtn.onclick = null; noBtn.onclick = null; };
    }
    function doShareGame(channel) {
      var url = getGameUrl();
      var text = getShareText();
      var encodedUrl = encodeURIComponent(url);
      var encodedText = encodeURIComponent(text);
      var fullText = text + ' ' + url;
      if (channel === 'copy') {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() { markSharedGame(); }).catch(function() {});
        } else {
          var ta = document.createElement('textarea');
          ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = '0';
          document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); markSharedGame(); } catch (e) {}
          document.body.removeChild(ta);
        }
        return;
      }
      if (channel === 'x') { window.open('https://x.com/intent/tweet?text=' + encodedText + '&url=' + encodedUrl, '_blank', 'width=550,height=420'); showShareConfirmModal('x', markSharedGame); return; }
      if (channel === 'telegram') { window.open('https://t.me/share/url?url=' + encodedUrl + '&text=' + encodedText, '_blank', 'width=550,height=420'); showShareConfirmModal('telegram', markSharedGame); return; }
      if (channel === 'facebook') { window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodedUrl, '_blank', 'width=550,height=420'); showShareConfirmModal('facebook', markSharedGame); return; }
      if (channel === 'email') { window.location.href = 'mailto:?subject=' + encodeURIComponent('1N Blockchain Token Clicker') + '&body=' + encodeURIComponent(fullText); showShareConfirmModal('email', markSharedGame); return; }
      if (channel === 'sms') { window.location.href = 'sms:?body=' + encodeURIComponent(fullText); showShareConfirmModal('sms', markSharedGame); return; }
    }

    // Friends: copy invite link (canonical URL so it opens on mobile)
    const inviteBtn = document.getElementById('invite-btn');
    const inviteFeedback = document.getElementById('invite-feedback');
    if (inviteBtn) {
      inviteBtn.addEventListener('click', () => {
        var url = getInviteUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            if (inviteFeedback) { inviteFeedback.classList.remove('hidden'); setTimeout(() => inviteFeedback.classList.add('hidden'), 3000); }
          }).catch(function() { fallbackCopy(url, inviteFeedback); });
        } else { fallbackCopy(url, inviteFeedback); }
      });
    }
    var friendCodeAddBtn = document.getElementById('friend-code-add-btn');
    var friendCodeInput = document.getElementById('friend-code-input');
    if (friendCodeAddBtn) friendCodeAddBtn.addEventListener('click', function() { addFriendByCode(); });
    if (friendCodeInput) friendCodeInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); addFriendByCode(); } });

    (function() {
      var friendsScanStream = null;
      var friendsScanRafId = null;
      var friendsScanLastCode = null;
      function parseRefFromQrData(data) {
        if (!data || !data.trim()) return null;
        var s = data.trim();
        try {
          if (s.indexOf('ref=') >= 0) {
            var m = s.match(/[?&]ref=([^&]+)/i);
            if (m) return decodeURIComponent(m[1].replace(/\+/g, ' ')).trim().toUpperCase();
          }
          if (s.indexOf('http') === 0) {
            var url = new URL(s);
            var ref = url.searchParams.get('ref');
            if (ref) return ref.trim().toUpperCase();
          }
          if (/^REF[A-Z0-9]{4,}$/i.test(s)) return s.trim().toUpperCase();
        } catch (e) {}
        return null;
      }
      function closeFriendsScanModal() {
        if (friendsScanRafId) { cancelAnimationFrame(friendsScanRafId); friendsScanRafId = null; }
        if (friendsScanStream) { friendsScanStream.getTracks().forEach(function(t) { t.stop(); }); friendsScanStream = null; }
        var modal = document.getElementById('friends-scan-qr-modal');
        var video = document.getElementById('friends-scan-qr-video');
        if (video && video.srcObject) video.srcObject = null;
        if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
        document.getElementById('friends-scan-qr-use-btn').classList.add('hidden');
        document.getElementById('friends-scan-qr-result').classList.add('hidden');
        friendsScanLastCode = null;
      }
      function tick() {
        var video = document.getElementById('friends-scan-qr-video');
        var canvas = document.getElementById('friends-scan-qr-canvas');
        var statusEl = document.getElementById('friends-scan-qr-status');
        if (!video || !canvas || video.readyState < 2) { friendsScanRafId = requestAnimationFrame(tick); return; }
        var w = video.videoWidth, h = video.videoHeight;
        if (!w || !h) { friendsScanRafId = requestAnimationFrame(tick); return; }
        var ctx = canvas.getContext('2d');
        canvas.width = w; canvas.height = h;
        ctx.drawImage(video, 0, 0);
        var imageData = ctx.getImageData(0, 0, w, h);
        var code = null;
        if (typeof jsQR !== 'undefined') { try { code = jsQR(imageData.data, w, h, { inversionAttempts: 'dontInvert' }); } catch (e) {} }
        if (code && code.data) {
          var ref = parseRefFromQrData(code.data);
          if (ref) {
            friendsScanLastCode = ref;
            if (statusEl) statusEl.textContent = 'QR code found';
            var resultEl = document.getElementById('friends-scan-qr-result');
            var useBtn = document.getElementById('friends-scan-qr-use-btn');
            if (resultEl) { resultEl.textContent = 'Code: ' + ref; resultEl.classList.remove('hidden'); }
            if (useBtn) useBtn.classList.remove('hidden');
            friendsScanRafId = null;
            return;
          }
        }
        friendsScanRafId = requestAnimationFrame(tick);
      }
      document.getElementById('friends-scan-qr-btn') && document.getElementById('friends-scan-qr-btn').addEventListener('click', function() {
        var modal = document.getElementById('friends-scan-qr-modal');
        var video = document.getElementById('friends-scan-qr-video');
        var statusEl = document.getElementById('friends-scan-qr-status');
        if (!modal || !video) return;
        document.getElementById('friends-scan-qr-result').classList.add('hidden');
        document.getElementById('friends-scan-qr-use-btn').classList.add('hidden');
        statusEl.textContent = 'Starting camera‚Ä¶';
        modal.classList.remove('hidden'); modal.style.display = 'flex';
        if (friendsScanStream) friendsScanStream.getTracks().forEach(function(t) { t.stop(); });
        friendsScanStream = null; friendsScanLastCode = null;
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(function(stream) {
          friendsScanStream = stream;
          video.srcObject = stream;
          video.play();
          statusEl.textContent = 'Point at a friend\'s invite QR code';
          friendsScanRafId = requestAnimationFrame(tick);
        }).catch(function() { statusEl.textContent = 'Camera access denied or unavailable.'; });
      });
      document.getElementById('friends-scan-qr-close') && document.getElementById('friends-scan-qr-close').addEventListener('click', closeFriendsScanModal);
      document.getElementById('friends-scan-qr-cancel') && document.getElementById('friends-scan-qr-cancel').addEventListener('click', closeFriendsScanModal);
      document.getElementById('friends-scan-qr-use-btn') && document.getElementById('friends-scan-qr-use-btn').addEventListener('click', function() {
        if (friendsScanLastCode && friendCodeInput) { friendCodeInput.value = friendsScanLastCode; }
        closeFriendsScanModal();
      });
      document.getElementById('friends-scan-qr-modal') && document.getElementById('friends-scan-qr-modal').addEventListener('click', function(e) {
        if (e.target && e.target.id === 'friends-scan-qr-modal') closeFriendsScanModal();
      });
    })();

    // PVP: Share game ‚Äì copy link that opens on mobile
    const shareGameBtn = document.getElementById('share-game-btn');
    const shareGameFeedback = document.getElementById('share-game-feedback');
    function fallbackCopy(text, feedbackEl) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); if (feedbackEl) { feedbackEl.classList.remove('hidden'); setTimeout(function() { feedbackEl.classList.add('hidden'); }, 3000); } } catch (e) {}
      document.body.removeChild(ta);
    }
    if (shareGameBtn) {
      shareGameBtn.addEventListener('click', function() {
        var url = getGameUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            if (typeof markSharedGame === 'function') markSharedGame();
            if (shareGameFeedback) { shareGameFeedback.classList.remove('hidden'); setTimeout(function() { shareGameFeedback.classList.add('hidden'); }, 4000); }
          }).catch(function() { fallbackCopy(url, shareGameFeedback); if (typeof markSharedGame === 'function') markSharedGame(); });
        } else { fallbackCopy(url, shareGameFeedback); if (typeof markSharedGame === 'function') markSharedGame(); }
      });
    }
    document.querySelectorAll('.share-bounty-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var channel = btn.getAttribute('data-share') || 'copy';
        if (typeof doShareGame === 'function') doShareGame(channel);
      });
    });

    // TON Wallet: connector + optional TonConnect UI modal; we prefer direct connect + link for reliability
    var walletStatusEl = document.getElementById('wallet-connection-status');
    function setWalletStatus(msg, isError) {
      if (walletStatusEl) { walletStatusEl.textContent = msg || ''; walletStatusEl.className = 'text-[9px] min-h-[14px] mb-2 ' + (isError ? 'text-neon-pink' : 'text-gray-400'); }
    }
    let tonConnectUI = null;
    if (window.TonWallet && typeof TON_CONNECT_UI !== 'undefined') {
      try {
        tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ connector: window.TonWallet.getConnector() });
        window.tonConnectUI = tonConnectUI;
        if (tonConnectUI.onStatusChange) tonConnectUI.onStatusChange(function() { updateWalletUI(); setWalletStatus(''); });
      } catch (e) { console.warn('TonConnect UI init:', e); }
    }
    var lastCardBalanceFetch = 0;
    function fetchCardBalanceFromBackend() {
      const TW = window.TonWallet;
      const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
      if (!TW || !backendUrl) return;
      const addr = TW.getAddress();
      if (!addr) return;
      if (Date.now() - lastCardBalanceFetch < 15000) return;
      lastCardBalanceFetch = Date.now();
      fetch(backendUrl.replace(/\/$/, '') + '/api/wallet/card-balance?address=' + encodeURIComponent(addr))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data.balance != null && TW.setCardBalance) TW.setCardBalance(data.balance);
          updateWalletUI();
        })
        .catch(function() { updateWalletUI(); });
    }
    var lastTonPriceFetch = 0;
    function fetchTonPrice() {
      var el = document.getElementById('ton-price-display');
      if (!el) return;
      if (Date.now() - lastTonPriceFetch < 60000) return;
      lastTonPriceFetch = Date.now();
      fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data['the-open-network'] && data['the-open-network'].usd != null) {
            el.textContent = 'TON: $' + Number(data['the-open-network'].usd).toFixed(4);
          } else { el.textContent = 'TON: ‚Äî'; }
        })
        .catch(function() { el.textContent = 'TON: ‚Äî'; });
    }
    function updateWalletUI() {
      const TW = window.TonWallet;
      if (!TW) return;
      const addr = TW.getAddress();
      const connectArea = document.getElementById('wallet-connect-area');
      const connectedArea = document.getElementById('wallet-connected-area');
      const tonAddress = document.getElementById('ton-address');
      const cardBalanceEl = document.getElementById('card-balance');
      if (connectArea) connectArea.classList.toggle('hidden', !!addr);
      if (connectedArea) connectedArea.classList.toggle('hidden', !addr);
      if (tonAddress && addr) tonAddress.textContent = addr.slice(0, 8) + '‚Ä¶' + addr.slice(-8);
      if (cardBalanceEl) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardBalanceEl.textContent = String(TW.cardBalance);
        } else {
          cardBalanceEl.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      var cardTop = document.getElementById('wallet-card-balance-top');
      if (cardTop) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardTop.textContent = String(TW.cardBalance);
        } else {
          cardTop.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      if (addr) {
        fetchCardBalanceFromBackend();
        persistNameToLeaderboard();
        if (!getPlayerName() && window.supabaseClient) {
          window.supabaseClient.from('leaderboard').select('name').eq('wallet_address', addr).maybeSingle().then(function(r) {
            if (r.data && r.data.name) localStorage.setItem('tokenClicker_playerName', r.data.name.trim().slice(0, 20));
          });
        }
      }
      var headerConnectBtn = document.getElementById('wallet-header-connect-btn');
      if (headerConnectBtn) {
        if (addr) {
          headerConnectBtn.textContent = 'Connected';
          headerConnectBtn.classList.remove('border-neon-cyan', 'text-neon-cyan', 'hover:bg-neon-cyan/10');
          headerConnectBtn.classList.add('border-neon-green', 'text-neon-green', 'hover:bg-neon-green/10');
        } else {
          headerConnectBtn.textContent = 'üîó Connect';
          headerConnectBtn.classList.remove('border-neon-green', 'text-neon-green', 'hover:bg-neon-green/10');
          headerConnectBtn.classList.add('border-neon-cyan', 'text-neon-cyan', 'hover:bg-neon-cyan/10');
        }
      }
    }
    const tonConnectBtn = document.getElementById('ton-connect-btn');
    const tonDisconnectBtn = document.getElementById('ton-disconnect-btn');
    var connectionPollTimer = null;
    function startConnectionPolling() {
      if (connectionPollTimer) return;
      setWalletStatus('Waiting for approval‚Ä¶ Return to this tab after approving in Tonkeeper.');
      var attempts = 0;
      var maxAttempts = 40;
      function poll() {
        if (window.TonWallet && window.TonWallet.getAddress()) {
          connectionPollTimer = null;
          setWalletStatus('');
          updateWalletUI();
          return;
        }
        attempts++;
        if (attempts >= maxAttempts) {
          connectionPollTimer = null;
          setWalletStatus('No connection yet. Click "I approved ‚Äì check connection" or try again.');
          return;
        }
        var unPause = window.TonWallet && window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') unPause().catch(function() {});
        window.TonWallet.restoreConnection().then(function() {
          updateWalletUI();
          if (window.TonWallet.getAddress()) { connectionPollTimer = null; setWalletStatus(''); return; }
          connectionPollTimer = setTimeout(poll, 2000);
        }).catch(function() { connectionPollTimer = setTimeout(poll, 2000); });
      }
      if (window.TonWallet && window.TonWallet.unPauseConnection) {
        window.TonWallet.unPauseConnection().then(function() { poll(); }).catch(function() { poll(); });
      } else {
        poll();
      }
    }
    if (tonConnectBtn) {
      tonConnectBtn.addEventListener('click', function() {
        if (!window.TonWallet) { setWalletStatus('Wallet script not loaded.', true); return; }
        setWalletStatus('Opening in new tab‚Ä¶ Stay here; return after approving.');
        tonConnectBtn.disabled = true;
        window.TonWallet.connect()
          .then(function() {
            updateWalletUI();
            if (window.TonWallet.getAddress()) { setWalletStatus(''); tonConnectBtn.disabled = false; return; }
            startConnectionPolling();
            tonConnectBtn.disabled = false;
          })
          .catch(function(err) {
            var msg = (err && err.message) || 'Connect failed';
            if (msg.indexOf('POPUP_BLOCKED') !== -1) msg = 'Popup blocked. Allow popups for this site or use the link that opened.';
            setWalletStatus(msg, true);
            tonConnectBtn.disabled = false;
            var helpModal = document.getElementById('wallet-connect-help-modal');
            if (helpModal) {
              helpModal.classList.remove('hidden');
              helpModal.style.display = 'flex';
            }
          });
      });
    var walletHelpBackBtn = document.getElementById('wallet-help-back-btn');
    var walletConnectHelpModal = document.getElementById('wallet-connect-help-modal');
    if (walletHelpBackBtn && walletConnectHelpModal) {
      walletHelpBackBtn.addEventListener('click', function() {
        walletConnectHelpModal.classList.add('hidden');
        walletConnectHelpModal.style.display = 'none';
        setWalletStatus('');
      });
    }
    }
    const tonCheckBtn = document.getElementById('ton-check-connection-btn');
    if (tonCheckBtn && window.TonWallet) {
      tonCheckBtn.addEventListener('click', function() {
        if (connectionPollTimer) { clearTimeout(connectionPollTimer); connectionPollTimer = null; }
        const origText = tonCheckBtn.textContent;
        tonCheckBtn.disabled = true;
        tonCheckBtn.textContent = 'Checking‚Ä¶';
        setWalletStatus('Checking connection‚Ä¶');
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') Promise.resolve(unPause()).catch(function() {});
        function done() {
          updateWalletUI();
          tonCheckBtn.disabled = false;
          tonCheckBtn.textContent = origText;
          setWalletStatus('');
        }
        var attempts = 0;
        var maxAttempts = 12;
        function poll() {
          window.TonWallet.restoreConnection()
            .then(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setWalletStatus('Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')');
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Not yet. Try again or refresh.';
                tonCheckBtn.disabled = false;
                setWalletStatus('No connection yet. Approve in Tonkeeper and try again.');
              }
            })
            .catch(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Try again or refresh page.';
                tonCheckBtn.disabled = false;
                setWalletStatus('Try again or refresh.');
              }
            });
        }
        poll();
      });
    }
    if (tonDisconnectBtn && window.TonWallet) {
      tonDisconnectBtn.addEventListener('click', () => {
        window.TonWallet.disconnect();
        updateWalletUI();
      });
    }
    if (window.TonWallet) {
      const fileWarning = document.getElementById('wallet-file-warning');
      if (fileWarning && (typeof location !== 'undefined' && location.protocol === 'file:')) {
        fileWarning.classList.remove('hidden');
      }
      window.TonWallet.onStatusChange(updateWalletUI);
      window.TonWallet.restoreConnection().then(() => {
        updateWalletUI();
      }).catch(() => { updateWalletUI(); });
      // When user returns to this tab after approving in Tonkeeper, unpause bridge and sync
      window.addEventListener('focus', function() {
        if (!window.TonWallet) return;
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') {
          unPause().then(function() {
            window.TonWallet.restoreConnection().then(updateWalletUI).catch(updateWalletUI);
          }).catch(function() { updateWalletUI(); });
        }
      });
    }

    // Backend config: load minter address (and network) from backend
    const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
    if (backendUrl) {
      fetch(backendUrl.replace(/\/$/, '') + '/api/config')
        .then(r => r.json())
        .then(data => {
          if (data.cardMinterAddress && window.TonWallet) {
            window.TonWallet.setCardMinterAddress(data.cardMinterAddress);
          }
          const hint = document.getElementById('wallet-config-hint');
          if (hint) hint.textContent = data.cardMinterAddress ? 'Minter: ' + data.cardMinterAddress.slice(0, 8) + '‚Ä¶' : 'Set backendUrl in ton-config.js and add minter to backend .env';
        })
        .catch(() => {});
    }
    // Wallet: backend / admin links in black square (only for admins)
    var walletBackendSquare = document.getElementById('wallet-backend-square');
    var walletBackendLink = document.getElementById('wallet-backend-link');
    var walletAdminSetupLink = document.getElementById('wallet-admin-setup-link');
    var isAdmin = localStorage.getItem('tokenClicker_admin') === 'true';
    if (backendUrl && isAdmin) {
      if (walletBackendSquare) walletBackendSquare.classList.remove('hidden');
      if (walletBackendLink) walletBackendLink.href = backendUrl.replace(/\/$/, '');
      if (walletAdminSetupLink) walletAdminSetupLink.href = backendUrl.replace(/\/$/, '') + '/setup';
    }

    // Withdraw: send in-game tokens to backend, backend mints $CARD to user
    const withdrawAmount = document.getElementById('withdraw-amount');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const withdrawFeedback = document.getElementById('withdraw-feedback');
    if (withdrawBtn && backendUrl) {
      withdrawBtn.addEventListener('click', async () => {
        const amount = withdrawAmount ? parseInt(withdrawAmount.value, 10) : 0;
        if (!amount || amount < 1) { withdrawFeedback.textContent = 'Enter amount (1+).'; withdrawFeedback.classList.remove('hidden'); return; }
        const addr = window.TonWallet && window.TonWallet.getAddress();
        if (!addr) { withdrawFeedback.textContent = 'Connect wallet first.'; withdrawFeedback.classList.remove('hidden'); return; }
        if (tokens < amount) { withdrawFeedback.textContent = 'Not enough in-game balance.'; withdrawFeedback.classList.remove('hidden'); return; }
        withdrawBtn.disabled = true;
        withdrawFeedback.textContent = 'Sending‚Ä¶';
        withdrawFeedback.classList.remove('hidden');
        withdrawFeedback.classList.remove('text-neon-green', 'text-neon-pink');
        try {
          const res = await fetch(backendUrl.replace(/\/$/, '') + '/api/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, amount }),
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.success) {
            tokens -= amount;
            save();
            updateUI();
            withdrawFeedback.textContent = 'Withdraw sent! Check your wallet for $CARD.';
            withdrawFeedback.classList.add('text-neon-green');
            if (withdrawAmount) withdrawAmount.value = '';
          } else {
            withdrawFeedback.textContent = data.error || 'Withdraw failed.';
            withdrawFeedback.classList.add('text-neon-pink');
          }
        } catch (e) {
          withdrawFeedback.textContent = e.message || 'Network error.';
          withdrawFeedback.classList.add('text-neon-pink');
        }
        withdrawBtn.disabled = false;
      });
    } else {
      var withdrawHint = document.getElementById('withdraw-area-hint');
      if (withdrawHint) withdrawHint.textContent = 'Set backendUrl in ton-config.js to enable withdraw.';
    }
    var withdrawMaxBtn = document.getElementById('withdraw-max-btn');
    if (withdrawMaxBtn && withdrawAmount) {
      withdrawMaxBtn.addEventListener('click', function() {
        var bal = typeof getInGameTokenBalance === 'function' ? getInGameTokenBalance() : (typeof tokens !== 'undefined' ? tokens : 0);
        withdrawAmount.value = Math.max(0, Math.floor(bal));
      });
    }
    // Send: in-game tokens to another player (Supabase leaderboard)
    var sendToAddress = document.getElementById('send-to-address');
    var sendAmount = document.getElementById('send-amount');
    var sendTokensBtn = document.getElementById('send-tokens-btn');
    var sendFeedback = document.getElementById('send-feedback');
    var sendMaxBtn = document.getElementById('send-max-btn');
    if (sendMaxBtn && sendAmount) {
      sendMaxBtn.addEventListener('click', function() {
        var bal = typeof getInGameTokenBalance === 'function' ? getInGameTokenBalance() : (typeof tokens !== 'undefined' ? tokens : 0);
        sendAmount.value = Math.max(0, Math.floor(bal));
      });
    }
    if (sendTokensBtn && sendFeedback) {
      sendTokensBtn.addEventListener('click', async function() {
        var toInput = (sendToAddress && sendToAddress.value) ? sendToAddress.value.trim() : '';
        var amount = sendAmount ? parseInt(sendAmount.value, 10) : 0;
        if (!toInput) { sendFeedback.textContent = 'Enter recipient wallet address or ref code.'; sendFeedback.classList.remove('hidden'); sendFeedback.classList.remove('text-neon-green'); sendFeedback.classList.add('text-neon-pink'); return; }
        if (!amount || amount < 1) { sendFeedback.textContent = 'Enter amount (1+).'; sendFeedback.classList.remove('hidden'); sendFeedback.classList.remove('text-neon-green'); sendFeedback.classList.add('text-neon-pink'); return; }
        var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
        if (!me) { sendFeedback.textContent = 'Player id not set. Refresh and try again.'; sendFeedback.classList.remove('hidden'); sendFeedback.classList.add('text-neon-pink'); return; }
        var myRefCode = (localStorage.getItem('tokenClicker_refCode') || '').trim().toUpperCase();
        if (me.toLowerCase() === toInput.toLowerCase() || (myRefCode && myRefCode === toInput.trim().toUpperCase())) { sendFeedback.textContent = 'Cannot send to yourself.'; sendFeedback.classList.remove('hidden'); sendFeedback.classList.remove('text-neon-green'); sendFeedback.classList.add('text-neon-pink'); return; }
        if (tokens < amount) { sendFeedback.textContent = 'Not enough in-game balance.'; sendFeedback.classList.remove('hidden'); sendFeedback.classList.remove('text-neon-green'); sendFeedback.classList.add('text-neon-pink'); return; }
        var supabase = window.supabaseClient;
        if (!supabase) { sendFeedback.textContent = 'Leaderboard not available. Refresh and try again.'; sendFeedback.classList.remove('hidden'); sendFeedback.classList.add('text-neon-pink'); return; }
        sendTokensBtn.disabled = true;
        sendFeedback.textContent = 'Sending‚Ä¶';
        sendFeedback.classList.remove('hidden');
        sendFeedback.classList.remove('text-neon-green', 'text-neon-pink');
        try {
          if (typeof ensureLeaderboardRow === 'function') {
            await new Promise(function(resolve) { ensureLeaderboardRow(resolve); });
          }
          var isGuest = me.indexOf('guest_') === 0;
          function fetchFromRow() {
            return isGuest
              ? supabase.from('leaderboard').select('id, tokens').eq('player_id', me).maybeSingle()
              : supabase.from('leaderboard').select('id, tokens').ilike('wallet_address', me).limit(1);
          }
          var fromResult = await fetchFromRow();
          var fromRow = isGuest ? fromResult : { data: fromResult.data && fromResult.data[0] ? fromResult.data[0] : null, error: fromResult.error };
          if (!fromRow.data && !isGuest) {
            var byPlayer = await supabase.from('leaderboard').select('id, tokens').eq('player_id', me).maybeSingle();
            if (byPlayer.data) fromRow = byPlayer;
          }
          if (!fromRow.data) {
            await new Promise(function(r) { setTimeout(r, 450); });
            fromResult = await fetchFromRow();
            fromRow = isGuest ? fromResult : { data: fromResult.data && fromResult.data[0] ? fromResult.data[0] : null, error: fromResult.error };
            if (!fromRow.data && !isGuest) {
              byPlayer = await supabase.from('leaderboard').select('id, tokens').eq('player_id', me).maybeSingle();
              if (byPlayer.data) fromRow = byPlayer;
            }
          }
          if (fromRow.error || !fromRow.data) { sendFeedback.textContent = 'Your internal wallet not found. Connect wallet or open Wallet tab, then try again.'; sendFeedback.classList.add('text-neon-pink'); sendTokensBtn.disabled = false; return; }
          var looksLikeRef = /^REF[A-Z0-9]{4,}$/i.test(toInput);
          var toResult = looksLikeRef
            ? await supabase.from('leaderboard').select('id, tokens, name, ref_code, player_id, wallet_address').ilike('ref_code', toInput.trim().toUpperCase()).limit(1)
            : await supabase.from('leaderboard').select('id, tokens, player_id, wallet_address').ilike('wallet_address', toInput.trim()).limit(1);
          var toRow = { data: toResult.data && toResult.data[0] ? toResult.data[0] : null, error: toResult.error };
          if ((toRow.error || !toRow.data) && !looksLikeRef) {
            var byPlayer = await supabase.from('leaderboard').select('id, tokens, name, ref_code, player_id, wallet_address').eq('player_id', toInput.trim()).maybeSingle();
            if (byPlayer.data) toRow = { data: byPlayer.data, error: null };
          }
          if (toRow.error || !toRow.data || !toRow.data.id) { sendFeedback.textContent = 'Recipient not found. They need to open the game and have a leaderboard row.'; sendFeedback.classList.add('text-neon-pink'); sendTokensBtn.disabled = false; return; }
          var toCurrent = (toRow.data.tokens != null) ? Number(toRow.data.tokens) : 0;
          tokens -= amount;
          save();
          updateUI();
          var ourNewBalance = Math.max(0, tokens);
          var toNewBalance = toCurrent + amount;
          var updateSender = await supabase.from('leaderboard').update({ tokens: ourNewBalance, updated_at: new Date().toISOString() }).eq('id', fromRow.data.id);
          if (updateSender.error) {
            tokens += amount;
            save();
            updateUI();
            sendFeedback.textContent = 'Failed to update your balance. ' + (updateSender.error.message || 'Try again.');
            sendFeedback.classList.add('text-neon-pink');
            sendTokensBtn.disabled = false;
            return;
          }
          var updateRecipient = await supabase.from('leaderboard').update({ tokens: toNewBalance, updated_at: new Date().toISOString() }).eq('id', toRow.data.id);
          if (updateRecipient.error) {
            await supabase.from('leaderboard').update({ tokens: ourNewBalance + amount, updated_at: new Date().toISOString() }).eq('id', fromRow.data.id);
            tokens += amount;
            save();
            updateUI();
            sendFeedback.textContent = 'Failed to credit recipient. ' + (updateRecipient.error.message || 'Try again.');
            sendFeedback.classList.add('text-neon-pink');
            sendTokensBtn.disabled = false;
            return;
          }
          if (typeof syncTokensFromLeaderboard === 'function') syncTokensFromLeaderboard(function() {});
          var senderName = (typeof getPlayerName === 'function' ? getPlayerName() : null) || 'Someone';
          var pid = (toRow.data.player_id || '').toString().trim();
          var wid = (toRow.data.wallet_address || '').toString().trim();
          var recipientIds = [];
          if (pid) recipientIds.push(pid);
          if (wid && wid !== pid) recipientIds.push(wid);
          if (recipientIds.length === 0 && (pid || wid)) recipientIds.push(pid || wid);
          recipientIds.forEach(function(recipientId) {
            if (recipientId) supabase.from('token_received_notifications').insert({ recipient_player_id: recipientId, sender_name: senderName, amount: amount }).then(function() {});
          });
          var toLabel = looksLikeRef ? (toRow.data.name || toInput) : (toInput || '').slice(0, 8) + '‚Ä¶';
          var senderPid = (fromRow.data && fromRow.data.player_id ? fromRow.data.player_id : (typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null)) || '';
          if (senderPid) await supabase.from('token_sends').insert({ sender_player_id: senderPid, recipient_player_id: pid || null, recipient_label: (toRow.data.name || toInput || toLabel || '').toString().trim(), amount: amount });
          if (typeof loadSendTransactions === 'function') loadSendTransactions();
          sendFeedback.textContent = 'Sent ' + amount + ' tokens to ' + toLabel;
          sendFeedback.classList.add('text-neon-green');
          if (sendToAddress) sendToAddress.value = '';
          if (sendAmount) sendAmount.value = '';
        } catch (e) {
          tokens += amount;
          save();
          updateUI();
          sendFeedback.textContent = e.message || 'Send failed.';
          sendFeedback.classList.add('text-neon-pink');
        }
        sendTokensBtn.disabled = false;
      });
    }
    function loadSendPlayersList() {
      var listEl = document.getElementById('send-players-list');
      var sendToInput = document.getElementById('send-to-address');
      if (!listEl) return;
      listEl.innerHTML = '<span class="text-[9px] text-gray-500">Loading‚Ä¶</span>';
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      var supabase = window.supabaseClient;
      if (!supabase) { listEl.innerHTML = '<span class="text-[9px] text-gray-500">Leaderboard not available.</span>'; return; }
      supabase.from('leaderboard').select('id, name, ref_code, player_id, wallet_address').not('name', 'is', null).limit(200).then(function(r) {
        if (r.error || !r.data) { listEl.innerHTML = '<span class="text-[9px] text-gray-500">Could not load players.</span>'; return; }
        var meNorm = (me + '').trim().toLowerCase();
        var myRefCode = (localStorage.getItem('tokenClicker_refCode') || '').trim().toUpperCase();
        var filtered = (r.data || []).filter(function(row) {
          var pid = (row.player_id || '').toString().trim().toLowerCase();
          var w = (row.wallet_address || '').toString().trim().toLowerCase();
          var ref = (row.ref_code || '').trim().toUpperCase();
          if (meNorm && (pid === meNorm || w === meNorm)) return false;
          if (myRefCode && ref && ref === myRefCode) return false;
          return true;
        });
        var seen = {};
        var rows = filtered.filter(function(row) {
          var code = (row.ref_code || '').trim().toUpperCase();
          var key = code || (row.player_id || '').toString() || (row.wallet_address || '').toString();
          if (!key || seen[key]) return false;
          seen[key] = true;
          return true;
        });
        if (rows.length === 0) { listEl.innerHTML = '<span class="text-[9px] text-gray-500">No other players yet. Ask friends to open the game and set their name.</span>'; return; }
        listEl.innerHTML = rows.map(function(row) {
          var name = (row.name || 'Player').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          var sendTo = (row.ref_code || '').trim() || (row.wallet_address || '').toString() || (row.player_id || '').toString();
          var label = (row.ref_code || '').trim() || (row.wallet_address || '').slice(0, 8) + '‚Ä¶' || (row.player_id || '').slice(0, 12) + '‚Ä¶';
          var sendToEsc = (sendTo || '').replace(/"/g, '&quot;');
          return '<button type="button" class="send-player-chip w-full py-2 px-3 rounded border border-gray-600 text-gray-300 text-[9px] hover:border-neon-cyan hover:text-neon-cyan hover:bg-neon-cyan/10 text-left flex items-center justify-between gap-2" data-ref="' + sendToEsc + '">' + '<span class="min-w-0 truncate">' + name + '</span>' + ' <span class="text-gray-500 font-mono shrink-0">' + (label || '') + '</span></button>';
        }).join('');
        listEl.querySelectorAll('.send-player-chip').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var ref = btn.getAttribute('data-ref');
            if (ref && sendToInput) sendToInput.value = ref;
          });
        });
      });
    }
    function loadSendTransactions() {
      var listEl = document.getElementById('send-transactions-list');
      if (!listEl) return;
      var me = (typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null) || '';
      var supabase = window.supabaseClient;
      if (!supabase) { listEl.innerHTML = '<span class="text-gray-500">Not available.</span>'; return; }
      listEl.innerHTML = '<span class="text-gray-500">Loading‚Ä¶</span>';
      supabase.from('token_sends').select('amount, recipient_label, created_at').eq('sender_player_id', me).order('created_at', { ascending: false }).limit(20).then(function(r) {
        if (r.error || !r.data || r.data.length === 0) {
          listEl.innerHTML = '<span class="text-gray-500">No sends yet. Tokens you send appear here.</span>';
          return;
        }
        var now = Date.now();
        listEl.innerHTML = r.data.map(function(row) {
          var amt = row.amount != null ? row.amount : 0;
          var label = (row.recipient_label || 'Unknown').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          var created = row.created_at ? new Date(row.created_at).getTime() : now;
          var ago = now - created;
          var agoStr = ago < 60000 ? 'just now' : ago < 3600000 ? Math.floor(ago / 60000) + ' min ago' : ago < 86400000 ? Math.floor(ago / 3600000) + ' h ago' : Math.floor(ago / 86400000) + ' d ago';
          return '<div class="py-1 border-b border-gray-700/50 last:border-0">' + amt + ' tokens ‚Üí ' + label + ' <span class="text-gray-500">' + agoStr + '</span></div>';
        }).join('');
      });
    }
    document.getElementById('send-refresh-players-btn') && document.getElementById('send-refresh-players-btn').addEventListener('click', function() {
      if (typeof loadSendPlayersList === 'function') loadSendPlayersList();
    });
    (function() {
      var sendScanStream = null;
      var sendScanRafId = null;
      var sendScanLastResult = null;
      function closeSendScanModal() {
        if (sendScanRafId) { cancelAnimationFrame(sendScanRafId); sendScanRafId = null; }
        if (sendScanStream) { sendScanStream.getTracks().forEach(function(t) { t.stop(); }); sendScanStream = null; }
        var modal = document.getElementById('send-scan-qr-modal');
        var video = document.getElementById('send-scan-qr-video');
        if (video && video.srcObject) { video.srcObject = null; }
        if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
        document.getElementById('send-scan-qr-approve-btn').classList.add('hidden');
        document.getElementById('send-scan-qr-result').classList.add('hidden');
        sendScanLastResult = null;
      }
      function parseScannedValue(data) {
        if (!data || !data.trim()) return null;
        var s = data.trim();
        try {
          if (s.indexOf('sendTo=') >= 0) {
            var m = s.match(/sendTo=([^&]+)/i);
            if (m) return decodeURIComponent(m[1].replace(/\+/g, ' '));
          }
          if (s.indexOf('http') === 0) {
            var url = new URL(s);
            var sendTo = url.hash && url.hash.indexOf('sendTo=') >= 0 ? (url.hash.match(/sendTo=([^&]+)/i) || [])[1] : null;
            if (sendTo) return decodeURIComponent(sendTo.replace(/\+/g, ' '));
          }
        } catch (e) {}
        return s;
      }
      function tick() {
        var video = document.getElementById('send-scan-qr-video');
        var canvas = document.getElementById('send-scan-qr-canvas');
        var statusEl = document.getElementById('send-scan-qr-status');
        if (!video || !canvas || video.readyState < 2) { sendScanRafId = requestAnimationFrame(tick); return; }
        var w = video.videoWidth;
        var h = video.videoHeight;
        if (!w || !h) { sendScanRafId = requestAnimationFrame(tick); return; }
        var ctx = canvas.getContext('2d');
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(video, 0, 0);
        var imageData = ctx.getImageData(0, 0, w, h);
        var code = null;
        if (typeof jsQR !== 'undefined') {
          try { code = jsQR(imageData.data, w, h, { inversionAttempts: 'dontInvert' }); } catch (e) {}
        }
        if (code && code.data) {
          var value = parseScannedValue(code.data);
          if (value) {
            sendScanLastResult = value;
            if (statusEl) statusEl.textContent = 'QR code found';
            var resultEl = document.getElementById('send-scan-qr-result');
            var approveBtn = document.getElementById('send-scan-qr-approve-btn');
            if (resultEl) { resultEl.textContent = 'Recipient: ' + value; resultEl.classList.remove('hidden'); }
            if (approveBtn) { approveBtn.classList.remove('hidden'); }
            sendScanRafId = null;
            return;
          }
        }
        sendScanRafId = requestAnimationFrame(tick);
      }
      document.getElementById('send-scan-qr-btn') && document.getElementById('send-scan-qr-btn').addEventListener('click', function() {
        var modal = document.getElementById('send-scan-qr-modal');
        var video = document.getElementById('send-scan-qr-video');
        var statusEl = document.getElementById('send-scan-qr-status');
        if (!modal || !video) return;
        document.getElementById('send-scan-qr-result').classList.add('hidden');
        document.getElementById('send-scan-qr-approve-btn').classList.add('hidden');
        statusEl.textContent = 'Starting camera‚Ä¶';
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        if (sendScanStream) sendScanStream.getTracks().forEach(function(t) { t.stop(); });
        sendScanStream = null;
        sendScanLastResult = null;
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(function(stream) {
          sendScanStream = stream;
          video.srcObject = stream;
          video.play();
          statusEl.textContent = 'Point at a recipient QR code';
          sendScanRafId = requestAnimationFrame(tick);
        }).catch(function(err) {
          statusEl.textContent = 'Camera access denied or unavailable. You can enter the code manually.';
        });
      });
      document.getElementById('send-scan-qr-close') && document.getElementById('send-scan-qr-close').addEventListener('click', closeSendScanModal);
      document.getElementById('send-scan-qr-cancel') && document.getElementById('send-scan-qr-cancel').addEventListener('click', closeSendScanModal);
      document.getElementById('send-scan-qr-approve-btn') && document.getElementById('send-scan-qr-approve-btn').addEventListener('click', function() {
        if (sendScanLastResult) {
          var inp = document.getElementById('send-to-address');
          if (inp) inp.value = sendScanLastResult;
        }
        closeSendScanModal();
      });
      document.getElementById('send-scan-qr-modal') && document.getElementById('send-scan-qr-modal').addEventListener('click', function(e) {
        if (e.target && e.target.id === 'send-scan-qr-modal') closeSendScanModal();
      });
    })();
    // Swap: $CARD ‚Üí in-game tokens (backend verifies balance, frontend credits tokens)
    var swapAmountEl = document.getElementById('swap-amount');
    var swapBtn = document.getElementById('swap-btn');
    var swapFeedback = document.getElementById('swap-feedback');
    if (swapBtn && backendUrl) {
      swapBtn.addEventListener('click', async function() {
        var amount = swapAmountEl ? parseInt(swapAmountEl.value, 10) : 0;
        if (!amount || amount < 1) {
          if (swapFeedback) { swapFeedback.textContent = 'Enter $CARD amount (1+).'; swapFeedback.classList.remove('hidden'); }
          return;
        }
        var addr = window.TonWallet && window.TonWallet.getAddress();
        if (!addr) {
          if (swapFeedback) { swapFeedback.textContent = 'Connect wallet first.'; swapFeedback.classList.remove('hidden'); }
          return;
        }
        swapBtn.disabled = true;
        if (swapFeedback) { swapFeedback.textContent = 'Swapping‚Ä¶'; swapFeedback.classList.remove('hidden'); swapFeedback.classList.remove('text-neon-green', 'text-neon-pink'); }
        try {
          var res = await fetch(backendUrl.replace(/\/$/, '') + '/api/swap', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, amount: amount }),
          });
          var data = await res.json().catch(function() { return {}; });
          if (data.success && data.tokensToCredit) {
            tokens += data.tokensToCredit;
            save();
            updateUI();
            if (swapAmountEl) swapAmountEl.value = '';
            var swapPrev = document.getElementById('swap-preview');
            if (swapPrev) swapPrev.classList.add('hidden');
            if (swapFeedback) { swapFeedback.textContent = 'Swapped! +' + data.tokensToCredit + ' tokens.'; swapFeedback.classList.add('text-neon-green'); }
            if (window.TonWallet && window.TonWallet.setCardBalance && data.cardAmount != null) {
              var cur = window.TonWallet.cardBalance;
              if (cur != null) window.TonWallet.setCardBalance(Math.max(0, Number(cur) - data.cardAmount));
            }
            fetchCardBalanceFromBackend();
          } else {
            var errMsg = data.error || 'Swap failed.';
            if (swapFeedback) {
              if (/not enough|insufficient/i.test(errMsg) && window.TonWallet && window.TonWallet.cardBalance != null) {
                errMsg += ' Your $CARD balance: ' + Math.max(0, Number(window.TonWallet.cardBalance));
              }
              swapFeedback.textContent = errMsg;
              swapFeedback.classList.add('text-neon-pink');
              swapFeedback.classList.remove('hidden');
            }
          }
        } catch (e) {
          if (swapFeedback) { swapFeedback.textContent = e.message || 'Network error.'; swapFeedback.classList.add('text-neon-pink'); }
        }
        swapBtn.disabled = false;
      });
    } else {
      var swapArea = document.getElementById('swap-area');
      if (swapArea) {
        var desc = swapArea.querySelector('.text-gray-400');
        if (desc) desc.textContent = 'Set backendUrl in ton-config.js to enable swap.';
      }
    }
    if (swapAmountEl) {
      swapAmountEl.addEventListener('input', function() {
        var prev = document.getElementById('swap-preview');
        var val = document.getElementById('swap-preview-value');
        var amt = parseInt(swapAmountEl.value, 10);
        if (prev && val) {
          if (amt > 0) {
            val.textContent = String(amt * 10);
            prev.classList.remove('hidden');
          } else {
            prev.classList.add('hidden');
          }
        }
      });
      swapAmountEl.addEventListener('change', function() {
        var prev = document.getElementById('swap-preview');
        var val = document.getElementById('swap-preview-value');
        var amt = parseInt(swapAmountEl.value, 10);
        if (prev && val) {
          if (amt > 0) {
            val.textContent = String(amt * 10);
            prev.classList.remove('hidden');
          } else {
            prev.classList.add('hidden');
          }
        }
      });
    }

    // --- PVP: token stakes, countdown ---
    var PVP_DEFAULT_STAKE = 5;
    var PVP_GAME_DURATION_SEC = 30;
    var PVP_COUNTDOWN_SEC = 5;
    var PVP_CLICK_COOLDOWN_MS = 200;
    var PVP_PRESET_STAKES = [2, 5, 7, 10];

    function getPlayerName() {
      return (localStorage.getItem('tokenClicker_playerName') || '').trim().slice(0, 20) || null;
    }
    function setPlayerName(name) {
      name = (name || '').trim().slice(0, 20);
      if (name) {
        localStorage.setItem('tokenClicker_playerName', name);
        registerReferralIfNeeded(name);
        persistNameToLeaderboard();
      }
    }
    function registerReferralIfNeeded(invitedName) {
      var inviterCode = (localStorage.getItem('tokenClicker_invitedBy') || '').trim().toUpperCase();
      if (!inviterCode || !invitedName) return;
      var supabase = window.supabaseClient;
      if (!supabase) { localStorage.removeItem('tokenClicker_invitedBy'); return; }
      var wallet = getPvpPlayerId();
      if (wallet && wallet.indexOf('guest_') === 0) wallet = null;
      supabase.from('referrals').insert({ inviter_ref_code: inviterCode, invited_name: String(invitedName).trim(), invited_wallet: wallet }).then(function() {
        localStorage.removeItem('tokenClicker_invitedBy');
        if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      }).catch(function(err) { console.warn('Referral register failed:', err); });
    }
    function getFriendTokenCache() {
      try {
        var raw = localStorage.getItem('tokenClicker_friendTokens');
        if (!raw) return { byWallet: {}, byRefCode: {}, byPlayerId: {} };
        var parsed = JSON.parse(raw);
        return { byWallet: parsed.byWallet || {}, byRefCode: parsed.byRefCode || {}, byPlayerId: parsed.byPlayerId || {} };
      } catch (e) { return { byWallet: {}, byRefCode: {}, byPlayerId: {} }; }
    }
    function setFriendTokenCache(cache) {
      try { localStorage.setItem('tokenClicker_friendTokens', JSON.stringify(cache)); } catch (e) {}
    }
    function mergeFriendTokenCache(byWallet, byRefCode, byPlayerId) {
      var c = getFriendTokenCache();
      if (byWallet) Object.keys(byWallet).forEach(function(k) { c.byWallet[k] = byWallet[k]; });
      if (byRefCode) Object.keys(byRefCode).forEach(function(k) { c.byRefCode[k.toUpperCase()] = byRefCode[k]; });
      if (byPlayerId) Object.keys(byPlayerId).forEach(function(k) { var key = (k || '').toString().trim(); if (key) c.byPlayerId[key] = byPlayerId[k]; });
      setFriendTokenCache(c);
    }
    function removeFromFriendTokenCache(wallet, refCode) {
      var c = getFriendTokenCache();
      if (wallet) delete c.byWallet[wallet];
      if (refCode) delete c.byRefCode[(refCode || '').toUpperCase()];
      setFriendTokenCache(c);
    }
    // Reusable in-game toast notification
    var gameToastTimer = null;
    function showGameToast(message, color) {
      var toast = document.getElementById('game-toast');
      if (!toast) return;
      // Reset border/text color classes
      toast.className = toast.className.replace(/border-neon-\S+/g, '').replace(/text-neon-\S+/g, '').trim();
      var c = color || 'neon-green';
      toast.classList.add('border-' + c, 'text-' + c);
      toast.textContent = message;
      toast.classList.remove('hidden');
      if (gameToastTimer) clearTimeout(gameToastTimer);
      gameToastTimer = setTimeout(function() { toast.classList.add('hidden'); gameToastTimer = null; }, 4500);
    }
    var friendsReferralsChannel = null;
    var referralsRealtimeFailed = false;
    function subscribeReferralsRealtime() {
      var supabase = window.supabaseClient;
      var refCode = (localStorage.getItem('tokenClicker_refCode') || '').trim();
      if (!supabase || !refCode || friendsReferralsChannel || referralsRealtimeFailed) return;
      try {
        var ch = supabase.channel('referrals-inv-' + refCode).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'referrals', filter: 'inviter_ref_code=eq.' + refCode }, function(payload) {
          var row = payload.new;
          if (!row) return;
          var name = (row.invited_name || 'Someone').trim();
          if (typeof pushNotification === 'function') pushNotification(name + ' accepted your invite!');
          showGameToast(name + ' accepted your invite!', 'neon-green');
          if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
        });
        friendsReferralsChannel = ch;
        ch.subscribe(function(status) {
          if (status === 'CHANNEL_ERROR') { friendsReferralsChannel = null; referralsRealtimeFailed = true; }
        });
      } catch (e) {
        referralsRealtimeFailed = true;
      }
    }
    function unsubscribeReferralsRealtime() {
      if (window.supabaseClient && friendsReferralsChannel) {
        try { window.supabaseClient.removeChannel(friendsReferralsChannel); } catch (e) {}
        friendsReferralsChannel = null;
      }
    }
    var friendsLeaderboardChannel = null;
    function subscribeFriendsLeaderboardRealtime() {
      var supabase = window.supabaseClient;
      if (!supabase || friendsLeaderboardChannel) return;
      friendsLeaderboardChannel = supabase.channel('friends-leaderboard').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leaderboard' }, function(payload) {
        var row = payload.new;
        if (!row) return;
        var w = (row.wallet_address || '').trim();
        var r = (row.ref_code || '').trim().toUpperCase();
        var p = (row.player_id || '').toString().trim();
        var t = row.tokens != null ? row.tokens : 0;
        var cache = getFriendTokenCache();
        var changed = false;
        if (w && (w in cache.byWallet)) { mergeFriendTokenCache({ [w]: t }, null, null); changed = true; }
        if (r && (r in cache.byRefCode)) { mergeFriendTokenCache(null, { [r]: t }, null); changed = true; }
        if (p && (p in cache.byPlayerId)) { mergeFriendTokenCache(null, null, { [p]: t }); changed = true; }
        if (changed) {
          var settingsModal = document.getElementById('wallet-settings-modal');
          var friendsPanel = document.querySelector('.settings-panel[data-settings-panel="friends"]');
          if (settingsModal && !settingsModal.classList.contains('hidden') && friendsPanel && !friendsPanel.classList.contains('hidden')) {
            if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
            if (typeof loadFriendRequests === 'function') loadFriendRequests();
            if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
          }
          var rowWrap = document.getElementById('pvp-player-row-above-create');
          if (rowWrap && !rowWrap.classList.contains('hidden')) {
            var friendRef = (rowWrap.getAttribute('data-friend-ref') || '').trim().toUpperCase();
            if (friendRef && r === friendRef) {
              var tokensEl = document.getElementById('pvp-player-row-tokens');
              if (tokensEl) tokensEl.textContent = t + ' tokens';
            }
          }
        }
      }).subscribe();
    }
    function unsubscribeFriendsLeaderboardRealtime() {
      if (window.supabaseClient && friendsLeaderboardChannel) {
        try { window.supabaseClient.removeChannel(friendsLeaderboardChannel); } catch (e) {}
        friendsLeaderboardChannel = null;
      }
    }
    var friendRequestsChannel = null;
    var friendRequestsRealtimeFailed = false;
    function subscribeFriendRequestsRealtime() {
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me || friendRequestsChannel || friendRequestsRealtimeFailed) return;
      try {
        var ch = supabase.channel('friend-requests-' + (me + '').replace(/[^a-zA-Z0-9_-]/g, '_')).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'friend_requests', filter: 'to_wallet=eq.' + me }, function(payload) {
          var row = payload.new;
          if (!row || (row.to_wallet || '').trim() !== (me + '').trim()) return;
          if (typeof loadFriendRequests === 'function') loadFriendRequests();
          var fromName = (row.from_name || 'Someone').trim();
          try { if (typeof pushNotification === 'function') pushNotification('Friend request from ' + fromName); } catch (e) {}
        });
        friendRequestsChannel = ch;
        ch.subscribe(function(status) {
          if (status === 'CHANNEL_ERROR') { friendRequestsChannel = null; friendRequestsRealtimeFailed = true; }
        });
      } catch (e) {
        friendRequestsRealtimeFailed = true;
      }
    }
    function unsubscribeFriendRequestsRealtime() {
      if (window.supabaseClient && friendRequestsChannel) {
        try { window.supabaseClient.removeChannel(friendRequestsChannel); } catch (e) {}
        friendRequestsChannel = null;
      }
    }
    var friendRequestAcceptedChannel = null;
    var friendRequestAcceptedRealtimeFailed = false;
    function subscribeFriendRequestAcceptedRealtime() {
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me || (me + '').trim() === '' || friendRequestAcceptedChannel || friendRequestAcceptedRealtimeFailed) return;
      try {
        var meId = (me + '').trim();
        var filterVal = /^[a-zA-Z0-9_-]+$/.test(meId) ? meId : ('"' + meId.replace(/"/g, '""') + '"');
        var ch = supabase.channel('friend-request-accepted-' + meId.replace(/[^a-zA-Z0-9_-]/g, '_').slice(0, 64)).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'friend_requests', filter: 'from_wallet=eq.' + filterVal }, function(payload) {
          var row = payload.new;
          if (!row || (row.from_wallet || '').trim() !== meId) return;
          if ((row.status || '').toLowerCase() !== 'accepted') return;
          var accepterName = (row.to_name || 'Someone').trim();
          try { if (typeof pushNotification === 'function') pushNotification(accepterName + ' accepted your invite!'); } catch (e) {}
          showGameToast(accepterName + ' accepted your invite!', 'neon-green');
          if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
        });
        friendRequestAcceptedChannel = ch;
        ch.subscribe(function(status) {
          if (status === 'CHANNEL_ERROR') { friendRequestAcceptedChannel = null; friendRequestAcceptedRealtimeFailed = true; }
        });
      } catch (e) {
        friendRequestAcceptedRealtimeFailed = true;
      }
    }
    function unsubscribeFriendRequestAcceptedRealtime() {
      if (window.supabaseClient && friendRequestAcceptedChannel) {
        try { window.supabaseClient.removeChannel(friendRequestAcceptedChannel); } catch (e) {}
        friendRequestAcceptedChannel = null;
      }
    }
    var tokenReceivedChannel = null;
    var tokenReceivedRealtimeFailed = false;
    function subscribeTokenReceivedRealtime() {
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me || (me + '').trim() === '' || tokenReceivedChannel || tokenReceivedRealtimeFailed) return;
      try {
        var meId = (me + '').trim();
        var filterVal = /^[a-zA-Z0-9_-]+$/.test(meId) ? meId : ('"' + meId.replace(/"/g, '""') + '"');
        var ch = supabase.channel('token-received-' + meId.replace(/[^a-zA-Z0-9_-]/g, '_').slice(0, 64)).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'token_received_notifications', filter: 'recipient_player_id=eq.' + filterVal }, function(payload) {
          var row = payload.new;
          if (!row || (row.recipient_player_id || '').trim() !== meId) return;
          var senderName = (row.sender_name || 'Someone').trim();
          var amt = row.amount != null ? parseInt(row.amount, 10) : 0;
          var msg = (amt > 0 ? '+' + amt + ' tokens from ' + senderName + '!' : 'Tokens received from ' + senderName + '!');
          showGameToast(msg, 'neon-yellow');
          if (typeof syncTokensFromLeaderboard === 'function') syncTokensFromLeaderboard(function() {
            try { if (typeof pushNotification === 'function') pushNotification(msg); } catch (e) {}
          });
        });
        tokenReceivedChannel = ch;
        ch.subscribe(function(status) {
          if (status === 'CHANNEL_ERROR') { tokenReceivedChannel = null; tokenReceivedRealtimeFailed = true; }
        });
      } catch (e) {
        tokenReceivedRealtimeFailed = true;
      }
    }
    function syncTokensFromLeaderboard(cb) {
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      var supabase = window.supabaseClient;
      if (!me || !supabase) { if (cb) cb(); return; }
      var isGuest = (me + '').indexOf('guest_') === 0;
      var q = isGuest
        ? supabase.from('leaderboard').select('tokens').eq('player_id', me).limit(1)
        : supabase.from('leaderboard').select('tokens').ilike('wallet_address', me).limit(1);
      q.then(function(r) {
        var row = (r.data && r.data[0]) ? r.data[0] : null;
        if (row && row.tokens != null) {
          var serverTokens = Math.max(0, Number(row.tokens));
          tokens = serverTokens;
          if (typeof save === 'function') save();
          if (typeof updateUI === 'function') updateUI();
        }
        if (cb) cb();
      }).catch(function() { if (cb) cb(); });
    }
    function unsubscribeTokenReceivedRealtime() {
      if (window.supabaseClient && tokenReceivedChannel) {
        try { window.supabaseClient.removeChannel(tokenReceivedChannel); } catch (e) {}
        tokenReceivedChannel = null;
      }
    }
    var friendsPollInterval = null;
    function startFriendsTokenPolling() {
      if (friendsPollInterval) return;
      friendsPollInterval = setInterval(function() {
        var settingsModal = document.getElementById('wallet-settings-modal');
        var friendsPanel = document.querySelector('.settings-panel[data-settings-panel="friends"]');
        var onFriends = settingsModal && !settingsModal.classList.contains('hidden') && friendsPanel && !friendsPanel.classList.contains('hidden');
        if (onFriends) {
          if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
          if (typeof loadFriendRequests === 'function') loadFriendRequests();
          if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
        }
      }, 5000);
    }
    function stopFriendsTokenPolling() {
      if (friendsPollInterval) { clearInterval(friendsPollInterval); friendsPollInterval = null; }
    }
    function loadFriendsInvited() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('friends-invited-list');
      if (!list) return;
      if (!supabase) {
        list.innerHTML = '<li class="text-gray-500">Friends unavailable.</li>';
        return;
      }
      var refCode = localStorage.getItem('tokenClicker_refCode') || '';
      if (!refCode) { list.innerHTML = '<li class="text-gray-500">Your code not set yet.</li>'; return; }
      supabase.from('referrals').select('invited_name, invited_wallet, created_at').eq('inviter_ref_code', refCode).order('created_at', { ascending: false }).limit(50)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No one has used your invite link yet.</li>';
            return;
          }
          var wallets = r.data.map(function(e) { return (e.invited_wallet || '').trim(); }).filter(Boolean);
          var cache = getFriendTokenCache();
          var tokensByWallet = {};
          wallets.forEach(function(w) { tokensByWallet[w] = cache.byWallet[w] != null ? cache.byWallet[w] : null; });
          renderInvitedList(r.data, tokensByWallet);
          if (wallets.length > 0) {
            supabase.from('leaderboard').select('wallet_address, tokens, player_id').in('wallet_address', wallets).then(function(lr) {
              if (lr.data) {
                var byPlayerId = {};
                lr.data.forEach(function(row) {
                  tokensByWallet[row.wallet_address] = row.tokens != null ? row.tokens : 0;
                  var pid = (row.player_id || '').toString().trim();
                  if (pid) byPlayerId[pid] = row.tokens != null ? row.tokens : 0;
                });
                mergeFriendTokenCache(tokensByWallet, null, byPlayerId);
              }
              renderInvitedList(r.data, tokensByWallet);
              subscribeFriendsLeaderboardRealtime();
              if (typeof subscribeFriendRequestsRealtime === 'function') subscribeFriendRequestsRealtime();
              if (typeof subscribeFriendRequestAcceptedRealtime === 'function') subscribeFriendRequestAcceptedRealtime();
              if (typeof subscribeTokenReceivedRealtime === 'function') subscribeTokenReceivedRealtime();
            });
          }
          function renderInvitedList(data, tokensByWallet) {
            list.innerHTML = data.map(function(e, i) {
            var name = e.invited_name || 'Player';
            var wallet = (e.invited_wallet || '').trim();
            var walletShort = wallet ? (wallet.slice(0, 6) + '‚Ä¶') : '';
            var tokens = tokensByWallet[wallet] != null ? tokensByWallet[wallet] : null;
            var tokenStr = tokens != null ? '<span class="text-neon-yellow text-[10px] font-bold">' + tokens + ' tokens</span>' : '';
            var nameEsc = (name || '').replace(/"/g, '&quot;');
            var walletEsc = (wallet || '').replace(/"/g, '&quot;');
            return '<li class="flex flex-wrap items-center gap-2 py-1 border-b border-gray-700/50 last:border-0">' +
              '<span class="flex-1 min-w-0">' + (i + 1) + '. ' + name + (walletShort ? ' (' + walletShort + ')' : '') + (tokenStr ? '<span class="block mt-0.5">' + tokenStr + '</span>' : '') + '</span>' +
              '<span class="flex gap-1 shrink-0">' +
              '<button type="button" class="invited-duel-btn py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-name="' + nameEsc + '" data-wallet="' + walletEsc + '">DUEL</button>' +
              '<button type="button" class="invited-remove-btn py-1 px-2 border border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10" data-name="' + nameEsc + '" data-wallet="' + walletEsc + '">REMOVE</button>' +
              '</span></li>';
          }).join('');
            var refCode = localStorage.getItem('tokenClicker_refCode') || '';
            list.querySelectorAll('.invited-remove-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var name = btn.getAttribute('data-name') || 'this friend';
              if (!confirm('Do you want to remove ' + name + '?')) return;
              var wallet = btn.getAttribute('data-wallet') || '';
              var q = supabase.from('referrals').delete().eq('inviter_ref_code', refCode);
              if (wallet) q = q.eq('invited_wallet', wallet); else q = q.is('invited_wallet', null);
              q.then(function(res) {
                if (res.error) { console.error('Remove invited friend failed:', res.error); if (typeof loadFriendsInvited === 'function') loadFriendsInvited(); return; }
                if (typeof removeFromFriendTokenCache === 'function') removeFromFriendTokenCache(wallet, null);
                if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
              });
            });
          });
            list.querySelectorAll('.invited-duel-btn').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var name = btn.getAttribute('data-name') || 'Friend';
                startDuelWithFriend(name);
              });
            });
          }
        })
        .catch(function() { list.innerHTML = '<li class="text-gray-500">Could not load.</li>'; });
    }
    function startDuelWithFriend(friendName) {
      var name = getPlayerName();
      if (!name) { window.location.hash = 'wallet'; showPage('wallet'); return; }
      window.location.hash = 'multiplayer';
      showPage('multiplayer');
      if (typeof openPvpCreateRoomModal === 'function') openPvpCreateRoomModal(friendName || null);
    }
    function getFavoriteFriendRefs() {
      try {
        var raw = localStorage.getItem('tokenClicker_favoriteFriendRefs');
        var arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(function(r) { return (r || '').toString().trim().toUpperCase(); }).filter(Boolean) : [];
      } catch (e) { return []; }
    }
    function toggleFavoriteFriendRef(refCode) {
      var ref = (refCode || '').trim().toUpperCase();
      if (!ref) return false;
      var favs = getFavoriteFriendRefs();
      var idx = favs.indexOf(ref);
      if (idx >= 0) {
        favs.splice(idx, 1);
      } else {
        favs.push(ref);
      }
      try { localStorage.setItem('tokenClicker_favoriteFriendRefs', JSON.stringify(favs)); } catch (e) {}
      return favs.indexOf(ref) >= 0;
    }
    function isFavoriteFriendRef(refCode) {
      return getFavoriteFriendRefs().indexOf((refCode || '').trim().toUpperCase()) >= 0;
    }
    function loadFriendRequests() {
      var supabase = window.supabaseClient;
      var sect = document.getElementById('friend-requests-section');
      var list = document.getElementById('friend-requests-list');
      if (!sect || !list) return;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me) {
        sect.classList.add('hidden');
        return;
      }
      list.innerHTML = '<li class="text-gray-500">Loading‚Ä¶</li>';
      supabase.from('friend_requests').select('id, from_wallet, from_name, created_at').eq('to_wallet', me).eq('status', 'pending').order('created_at', { ascending: false }).limit(20)
        .then(function(r) {
          if (r.error) {
            sect.classList.add('hidden');
            return;
          }
          if (!r.data || r.data.length === 0) {
            sect.classList.add('hidden');
            return;
          }
          sect.classList.remove('hidden');
          // Delay clear so accept/reject feedback stays visible briefly after action
          setTimeout(function() { setFriendRequestFeedback(''); }, 4000);
          var pushedIds = JSON.parse(localStorage.getItem('tokenClicker_pushedRequestIds') || '[]');
          r.data.forEach(function(req) {
            if (pushedIds.indexOf(req.id) < 0) {
              try { pushNotification('Friend request from ' + (req.from_name || 'Someone')); } catch (e) {}
              pushedIds.push(req.id);
              if (pushedIds.length > 100) pushedIds = pushedIds.slice(-50);
            }
          });
          try { localStorage.setItem('tokenClicker_pushedRequestIds', JSON.stringify(pushedIds)); } catch (e) {}
          list.innerHTML = r.data.map(function(req) {
            var name = (req.from_name || 'Someone').replace(/"/g, '&quot;');
            return '<li class="flex flex-wrap items-center gap-2 py-1.5 border-b border-gray-700/50 last:border-0">' +
              '<span class="flex-1 min-w-0">' + (req.from_name || 'Someone') + '</span>' +
              '<span class="flex gap-1 shrink-0">' +
              '<button type="button" class="friend-request-accept py-1 px-2 border-2 border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-id="' + req.id + '" data-from-wallet="' + (req.from_wallet || '').replace(/"/g, '&quot;') + '" data-from-name="' + name + '">ACCEPT</button>' +
              '<button type="button" class="friend-request-reject py-1 px-2 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" data-id="' + req.id + '">REJECT</button>' +
              '</span></li>';
          }).join('');
          list.querySelectorAll('.friend-request-accept').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var id = btn.getAttribute('data-id');
              var fromWallet = btn.getAttribute('data-from-wallet');
              var fromName = btn.getAttribute('data-from-name') || 'Friend';
              if (!id || !fromWallet) return;
              acceptFriendRequest(id, fromWallet, fromName);
            });
          });
          list.querySelectorAll('.friend-request-reject').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var id = btn.getAttribute('data-id');
              if (!id) return;
              rejectFriendRequest(id);
            });
          });
        })
        .catch(function() { sect.classList.add('hidden'); });
    }
    function setFriendRequestFeedback(msg, isError) {
      var el = document.getElementById('friend-request-feedback');
      if (!el) return;
      el.textContent = msg || '';
      el.classList.remove('hidden', 'text-neon-green', 'text-neon-yellow', 'bg-neon-yellow/10', 'bg-neon-green/10');
      if (msg) {
        el.classList.add(isError ? 'text-neon-yellow bg-neon-yellow/10' : 'text-neon-green bg-neon-green/10');
        el.classList.remove('hidden');
      } else {
        el.classList.add('hidden');
      }
    }
    function acceptFriendRequest(reqId, fromWallet, fromName) {
      setFriendRequestFeedback('');
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me) {
        var msg = 'Set your name in Wallet ‚Üí Settings first.';
        setFriendRequestFeedback(msg, true);
        try { pushNotification(msg); } catch (e) {}
        return;
      }
      supabase.from('friend_requests').select('from_wallet, to_wallet, from_name, to_name').eq('id', reqId).eq('to_wallet', me).eq('status', 'pending').single().then(function(r) {
        if (r.error || !r.data) {
          var msg = 'Request expired or already handled.';
          setFriendRequestFeedback(msg, true);
          try { pushNotification(msg); } catch (e) {}
          if (typeof loadFriendRequests === 'function') loadFriendRequests();
          return;
        }
        var req = r.data;
        var ids = [req.from_wallet, req.to_wallet].filter(Boolean);
        Promise.all([
          supabase.from('leaderboard').select('ref_code, wallet_address, player_id').in('wallet_address', ids),
          supabase.from('leaderboard').select('ref_code, wallet_address, player_id').in('player_id', ids)
        ]).then(function(results) {
          var refById = {};
          results.forEach(function(res) {
            if (res && res.data) res.data.forEach(function(row) {
              var ref = (row.ref_code || '').trim();
              if (row.wallet_address) refById[row.wallet_address] = ref;
              if (row.player_id) refById[row.player_id] = ref;
            });
          });
          var fromRef = (refById[req.from_wallet] || '').toUpperCase();
          var toRef = (refById[req.to_wallet] || '').toUpperCase();
          if (!toRef) toRef = (localStorage.getItem('tokenClicker_refCode') || '').trim().toUpperCase();
          if (!toRef) {
            var msg = 'Could not accept: save your name in Wallet ‚Üí Settings so your invite code is synced.';
            setFriendRequestFeedback(msg, true);
            try { pushNotification(msg); } catch (e) {}
            return;
          }
          function setFromRefMissing() {
            var msg = "Could not accept: " + (req.from_name || "Sender") + "'s invite code not synced. Ask them to save their name in Wallet ‚Üí Settings.";
            setFriendRequestFeedback(msg, true);
            try { pushNotification(msg); } catch (e) {}
          }
          if (!fromRef && (req.from_name || '').trim()) {
            var fromNameTrim = (req.from_name || '').trim();
            supabase.from('leaderboard').select('ref_code, wallet_address, player_id, name').ilike('name', fromNameTrim).limit(10).then(function(nameRow) {
              var found = nameRow.data && nameRow.data.find(function(row) {
                var match = (row.wallet_address === req.from_wallet || row.player_id === req.from_wallet);
                return match && (row.ref_code || '').trim();
              });
              if (found && (found.ref_code || '').trim()) {
                fromRef = (found.ref_code || '').trim().toUpperCase();
                doInsert();
              } else {
                setFromRefMissing();
              }
            }).catch(function() { setFromRefMissing(); });
            return;
          }
          if (!fromRef) {
            setFromRefMissing();
            return;
          }
          doInsert();
          function doInsert() {
          supabase.from('friends_by_code').insert([
            { user_wallet: req.from_wallet, friend_ref_code: toRef, friend_name: req.to_name || 'Friend' },
            { user_wallet: req.to_wallet, friend_ref_code: fromRef, friend_name: req.from_name || 'Friend' }
          ]).then(function(ins) {
            if (ins.error) {
              var msg = ins.error.message || 'Could not add friend.';
              if (ins.error.code === '23505') {
                msg = 'Already friends with ' + (req.from_name || 'them') + '.';
                supabase.from('friend_requests').update({ status: 'accepted', updated_at: new Date().toISOString() }).eq('id', reqId).then(function() {});
              } else if (msg.indexOf('friends_by_code') >= 0 || msg.indexOf('schema cache') >= 0) {
                msg = 'Database missing friends table. In Supabase: SQL Editor ‚Üí run supabase/migrations/003_friends_by_code.sql';
              }
              setFriendRequestFeedback(msg, true);
              try { pushNotification(msg); } catch (e) {}
            } else {
              supabase.from('friend_requests').update({ status: 'accepted', updated_at: new Date().toISOString() }).eq('id', reqId).then(function() {});
              setFriendRequestFeedback('You are now friends with ' + (req.from_name || 'Someone') + '.', false);
              try { pushNotification('You are now friends with ' + (req.from_name || 'Someone')); } catch (e) {}
            }
            if (typeof loadFriendRequests === 'function') loadFriendRequests();
            if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
          });
          }
        }).catch(function(err) {
          var msg = (err && err.message) ? err.message : 'Could not accept request.';
          setFriendRequestFeedback(msg, true);
          try { pushNotification(msg); } catch (e) {}
          if (typeof loadFriendRequests === 'function') loadFriendRequests();
        });
      }).catch(function(err) {
        var msg = (err && err.message) ? err.message : 'Could not accept request.';
        setFriendRequestFeedback(msg, true);
        try { pushNotification(msg); } catch (e) {}
        if (typeof loadFriendRequests === 'function') loadFriendRequests();
      });
    }
    function rejectFriendRequest(reqId) {
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me) return;
      supabase.from('friend_requests').update({ status: 'rejected', updated_at: new Date().toISOString() }).eq('id', reqId).eq('to_wallet', me).then(function() {
        if (typeof loadFriendRequests === 'function') loadFriendRequests();
      });
    }
    function loadFriendsAddedByCode() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('friends-added-list');
      if (!list) return;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase) {
        list.innerHTML = '<li class="text-gray-500">Friends unavailable.</li>';
        return;
      }
      if (!me) {
        list.innerHTML = '<li class="text-gray-500">Set your name in Wallet ‚Üí Settings to add friends by code.</li>';
        return;
      }
      list.innerHTML = '<li class="text-gray-500">Loading‚Ä¶</li>';
      supabase.from('friends_by_code').select('friend_ref_code, friend_name, created_at').eq('user_wallet', me).order('created_at', { ascending: false }).limit(50)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No friends added by code yet. Enter a code above.</li>';
            return;
          }
          var seen = {};
          var uniqueFriends = r.data.filter(function(e) {
            var code = (e.friend_ref_code || '').trim().toUpperCase();
            if (!code || seen[code]) return false;
            seen[code] = true;
            return true;
          });
          var favRefs = getFavoriteFriendRefs();
          uniqueFriends.sort(function(a, b) {
            var ac = (a.friend_ref_code || '').trim().toUpperCase();
            var bc = (b.friend_ref_code || '').trim().toUpperCase();
            var aFav = favRefs.indexOf(ac) >= 0 ? 1 : 0;
            var bFav = favRefs.indexOf(bc) >= 0 ? 1 : 0;
            if (bFav !== aFav) return bFav - aFav;
            return 0;
          });
          var codes = uniqueFriends.map(function(e) { return (e.friend_ref_code || '').trim(); }).filter(Boolean);
          var cache = getFriendTokenCache();
          var tokensByCode = {};
          codes.forEach(function(c) { var u = c.toUpperCase(); tokensByCode[u] = cache.byRefCode[u] != null ? cache.byRefCode[u] : null; });
          renderAddedList(uniqueFriends, tokensByCode);
          if (codes.length > 0) {
            supabase.from('leaderboard').select('ref_code, tokens, player_id').in('ref_code', codes).then(function(lr) {
              if (lr.data) {
                var byPlayerId = {};
                lr.data.forEach(function(row) {
                  var u = (row.ref_code || '').toUpperCase();
                  tokensByCode[u] = row.tokens != null ? row.tokens : 0;
                  var pid = (row.player_id || '').toString().trim();
                  if (pid) byPlayerId[pid] = row.tokens != null ? row.tokens : 0;
                });
                var byRef = {};
                Object.keys(tokensByCode).forEach(function(k) { byRef[k] = tokensByCode[k]; });
                mergeFriendTokenCache(null, byRef, byPlayerId);
              }
              renderAddedList(uniqueFriends, tokensByCode);
              subscribeFriendsLeaderboardRealtime();
              if (typeof subscribeFriendRequestsRealtime === 'function') subscribeFriendRequestsRealtime();
              if (typeof subscribeFriendRequestAcceptedRealtime === 'function') subscribeFriendRequestAcceptedRealtime();
              if (typeof subscribeTokenReceivedRealtime === 'function') subscribeTokenReceivedRealtime();
            });
          }
          function renderAddedList(data, tokensByCode) {
            list.innerHTML = data.map(function(e, i) {
            var name = (e.friend_name || e.friend_ref_code || 'Friend').replace(/"/g, '&quot;');
            var code = (e.friend_ref_code || '').replace(/"/g, '&quot;');
            var codeUpper = (e.friend_ref_code || '').trim().toUpperCase();
            var tokens = tokensByCode[codeUpper] != null ? tokensByCode[codeUpper] : null;
            var tokenStr = tokens != null ? '<span class="text-neon-yellow text-[10px] font-bold">' + tokens + ' tokens</span>' : '';
            var isFav = isFavoriteFriendRef(codeUpper);
            var starLabel = isFav ? '‚òÖ' : '‚òÜ';
            var starTitle = isFav ? 'Remove from favorites' : 'Add to favorites';
            return '<li class="flex flex-wrap items-center gap-2 py-1 border-b border-gray-700/50 last:border-0">' +
              '<span class="flex-1 min-w-0">' + (i + 1) + '. ' + (e.friend_name || e.friend_ref_code || 'Friend') + (tokenStr ? '<span class="block mt-0.5">' + tokenStr + '</span>' : '') + '</span>' +
              '<span class="flex gap-1 shrink-0 items-center">' +
              '<button type="button" class="friend-favorite-btn py-1 px-1.5 border border-neon-yellow rounded text-[10px] ' + (isFav ? 'text-neon-yellow bg-neon-yellow/20' : 'text-gray-500 hover:text-neon-yellow hover:bg-neon-yellow/10') + '" data-ref="' + code + '" title="' + starTitle + '" aria-label="' + starTitle + '">' + starLabel + '</button>' +
              '<button type="button" class="friend-duel-btn py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-name="' + name + '" data-ref="' + code + '">DUEL</button>' +
              '<button type="button" class="friend-remove-btn py-1 px-2 border border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10" data-name="' + name + '" data-ref="' + code + '">REMOVE</button>' +
              '</span></li>';
          }).join('');
          list.querySelectorAll('.friend-favorite-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var ref = btn.getAttribute('data-ref') || '';
              if (!ref) return;
              toggleFavoriteFriendRef(ref);
              var favRefs = getFavoriteFriendRefs();
              uniqueFriends.sort(function(a, b) {
                var ac = (a.friend_ref_code || '').trim().toUpperCase();
                var bc = (b.friend_ref_code || '').trim().toUpperCase();
                var aFav = favRefs.indexOf(ac) >= 0 ? 1 : 0;
                var bFav = favRefs.indexOf(bc) >= 0 ? 1 : 0;
                if (bFav !== aFav) return bFav - aFav;
                return 0;
              });
              renderAddedList(uniqueFriends, tokensByCode);
            });
          });
          list.querySelectorAll('.friend-remove-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var name = btn.getAttribute('data-name') || 'this friend';
              if (!confirm('Do you want to remove ' + name + '?')) return;
              var ref = btn.getAttribute('data-ref') || '';
              if (!ref) return;
              supabase.from('friends_by_code').delete().eq('user_wallet', me).eq('friend_ref_code', ref).then(function(res) {
                if (res.error) { console.error('Remove friend failed:', res.error); if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode(); return; }
                if (typeof removeFromFriendTokenCache === 'function') removeFromFriendTokenCache(null, ref);
                if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
              });
            });
          });
          list.querySelectorAll('.friend-duel-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var name = btn.getAttribute('data-name') || 'Friend';
              startDuelWithFriend(name);
            });
          });
          }
        })
        .catch(function() { list.innerHTML = '<li class="text-gray-500">Could not load.</li>'; });
    }
    function addFriendByCode() {
      var input = document.getElementById('friend-code-input');
      var feedback = document.getElementById('friend-code-feedback');
      var code = (input && input.value ? input.value.trim() : '').toUpperCase();
      if (!code) {
        if (feedback) { feedback.textContent = 'Enter an invite code.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
        return;
      }
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me) {
        if (feedback) { feedback.textContent = 'Set your name in Wallet ‚Üí Settings first.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
        return;
      }
      var myRef = localStorage.getItem('tokenClicker_refCode') || '';
      if (myRef && code === myRef.toUpperCase()) {
        if (feedback) { feedback.textContent = "You can't add yourself."; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
        return;
      }
      if (feedback) feedback.classList.add('hidden');
      var ilikeCode = (code + '').replace(/%/g, '\\%').replace(/_/g, '\\_');
      supabase.from('leaderboard').select('name, wallet_address, player_id, ref_code').ilike('ref_code', ilikeCode).limit(1).then(function(r) {
        if (r.error) {
          if (feedback) { feedback.textContent = (r.error.message && r.error.message.indexOf('schema') >= 0 ? 'Database schema outdated. Run migration 010 in Supabase.' : (r.error.message || 'Could not look up code.')); feedback.classList.remove('hidden'); feedback.classList.add('text-neon-yellow'); }
          return;
        }
        var row = r.data && r.data[0];
        if (!row || !row.name) {
          if (feedback) { feedback.textContent = 'Unknown invite code. Your friend should open the app, go to Wallet ‚Üí Settings, and SAVE their name so their code is synced.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
          return;
        }
        var toWallet = (row.wallet_address || row.player_id || '').trim();
        if (!toWallet || toWallet === me) {
          if (feedback) { feedback.textContent = 'Invalid or your own code.'; feedback.classList.remove('hidden'); feedback.classList.add('text-neon-yellow'); }
          return;
        }
        var friendName = (row.name || '').trim() || code;
        var fromName = (typeof getPlayerName === 'function' ? getPlayerName() : '') || 'Player';
        supabase.from('friend_requests').insert({ from_wallet: me, to_wallet: toWallet, from_name: fromName, to_name: friendName, status: 'pending' }).then(function(ins) {
          if (ins.error) {
            var msg = ins.error.message || '';
            if (ins.error.code === '23505') msg = 'Request already sent.';
            else if (msg.indexOf('friend_requests') >= 0 || msg.indexOf('schema cache') >= 0) msg = 'Database missing friend_requests table. In Supabase: SQL Editor ‚Üí New query ‚Üí paste and run supabase/migrations/011_friend_requests.sql';
            if (feedback) { feedback.textContent = msg; feedback.classList.remove('hidden'); feedback.classList.add('text-neon-yellow'); }
            if (ins.error.code !== '23505' && typeof loadFriendRequests === 'function') loadFriendRequests();
            return;
          }
          if (input) input.value = '';
          if (feedback) { feedback.textContent = 'Request sent to ' + friendName + '.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-yellow'); feedback.classList.add('text-neon-green'); }
          if (typeof loadFriendRequests === 'function') loadFriendRequests();
        });
      });
    }
    function persistNameToLeaderboard() {
      var name = getPlayerName();
      var wallet = getPvpPlayerId();
      if (!name || !wallet) return;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      function revertNameFromServer() {
        var isGuest = (wallet + '').indexOf('guest_') === 0;
        var q = isGuest ? supabase.from('leaderboard').select('name').eq('player_id', wallet).maybeSingle() : supabase.from('leaderboard').select('name').eq('wallet_address', wallet).maybeSingle();
        q.then(function(rr) {
          var serverName = rr.data && rr.data.name ? rr.data.name : '';
          if (typeof setPlayerName === 'function') setPlayerName(serverName);
          if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
          if (typeof updateUI === 'function') updateUI();
          try { if (typeof pushNotification === 'function') pushNotification('That name is already taken. Choose another.'); } catch (e) {}
        });
      }
      supabase.from('leaderboard').select('id').eq('wallet_address', wallet).maybeSingle().then(function(r) {
        var row = r.data;
        if (!row) {
          supabase.from('leaderboard').select('id').eq('player_id', wallet).maybeSingle().then(function(r2) { row = r2.data; doPersist(row); });
        } else {
          doPersist(row);
        }
      });
      function doPersist(row) {
        if (row) {
          supabase.from('leaderboard').update({ name: name, updated_at: new Date().toISOString(), ref_code: localStorage.getItem('tokenClicker_refCode') || null, player_id: wallet }).eq('id', row.id).then(function(ur) {
            if (ur.error && ur.error.code === '23505') revertNameFromServer();
            else if (!ur.error && localStorage.getItem('tokenClicker_invitedBy') && typeof registerReferralIfNeeded === 'function') registerReferralIfNeeded(name);
          });
        } else {
          supabase.from('leaderboard').insert({ name: name, wallet_address: wallet, player_id: wallet, tokens: 0, ref_code: localStorage.getItem('tokenClicker_refCode') || null }).then(function(ir) {
            if (ir.error && ir.error.code === '23505') revertNameFromServer();
            else if (!ir.error && localStorage.getItem('tokenClicker_invitedBy') && typeof registerReferralIfNeeded === 'function') registerReferralIfNeeded(name);
          });
        }
      }
    }
    function getInGameTokenBalance() {
      if (typeof tokens !== 'undefined') return Math.max(0, parseInt(tokens, 10));
      return Math.max(0, parseInt(localStorage.getItem('tokenClicker_tokens') || '0', 10));
    }
    function hasEnoughTokens(stake) {
      var s = parseInt(stake, 10);
      if (isNaN(s) || s < 1) return false;
      return getInGameTokenBalance() >= s;
    }
    function showPvpOnboarding(reason, roomId) {
      return;
    }
    function hidePvpOnboarding() {
      var modal = document.getElementById('pvp-onboarding-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }
      window._pvpOnboardingRoomId = null;
    }
    document.getElementById('pvp-onboarding-save') && document.getElementById('pvp-onboarding-save').addEventListener('click', function() {
      var nameInput = document.getElementById('pvp-onboarding-name');
      var name = nameInput && nameInput.value.trim().slice(0, 20);
      if (name) setPlayerName(name);
      var roomId = window._pvpOnboardingRoomId || window._pvpInvitedRoomId || (new URLSearchParams(window.location.search).get('room'));
      hidePvpOnboarding();
      window.location.hash = 'multiplayer';
      showPage('multiplayer');
      if (roomId && typeof joinPvpRoom === 'function') {
        joinPvpRoom(roomId);
      } else if (typeof window.loadPvpRooms === 'function') {
        window.loadPvpRooms();
      }
    });
    document.getElementById('pvp-onboarding-skip') && document.getElementById('pvp-onboarding-skip').addEventListener('click', function() {
      hidePvpOnboarding();
      if (window._pvpOnboardingRoomId && typeof window.loadPvpRooms === 'function') window.loadPvpRooms();
    });
    function hideWelcomeNameModal() {
      var m = document.getElementById('welcome-name-modal');
      if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    function hideProfileNameModal() {
      var m = document.getElementById('profile-name-modal');
      if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    document.getElementById('welcome-name-save') && document.getElementById('welcome-name-save').addEventListener('click', function() {
      var input = document.getElementById('welcome-name-input');
      var name = input && input.value.trim().slice(0, 20);
      if (name) {
        setPlayerName(name);
        hideWelcomeNameModal();
        if (typeof registerReferralIfNeeded === 'function') registerReferralIfNeeded(name);
        if (typeof persistNameToLeaderboard === 'function') persistNameToLeaderboard();
        updateUI();
      }
    });
    // Settings modal tab switching (same pattern as boosts tabs)
    function showSettingsTab(tabId) {
      tabId = tabId || 'general';
      document.querySelectorAll('.settings-tab-btn').forEach(function(btn) {
        var t = btn.getAttribute('data-settings-tab');
        if (t === tabId) {
          btn.classList.remove('border-gray-600', 'text-gray-400');
          btn.classList.add('border-neon-cyan', 'text-neon-cyan', 'bg-neon-cyan/10', 'font-bold');
        } else {
          btn.classList.add('border-gray-600', 'text-gray-400');
          btn.classList.remove('border-neon-cyan', 'text-neon-cyan', 'bg-neon-cyan/10', 'font-bold',
            'border-neon-green', 'text-neon-green', 'bg-neon-green/10',
            'border-neon-yellow', 'text-neon-yellow', 'bg-neon-yellow/10');
        }
      });
      document.querySelectorAll('.settings-panel').forEach(function(panel) {
        var p = panel.getAttribute('data-settings-panel');
        if (p === tabId) { panel.classList.remove('hidden'); } else { panel.classList.add('hidden'); }
      });
      if (tabId === 'friends') { initFriendsPanel(); }
      if (tabId !== 'friends') { stopFriendsTokenPolling(); }
      try { localStorage.setItem('tokenClicker_settingsTab', tabId); } catch (e) {}
    }
    function initFriendsPanel() {
      var refCode = localStorage.getItem('tokenClicker_refCode');
      if (!refCode || !refCode.trim()) {
        refCode = 'REF' + Math.random().toString(36).slice(2, 8).toUpperCase();
        try { localStorage.setItem('tokenClicker_refCode', refCode); } catch (e) {}
      }
      refCode = (refCode || '').trim().toUpperCase();
      var refEl = document.getElementById('referral-code');
      if (refEl) refEl.textContent = refCode || '------';
      var qrContainer = document.getElementById('friends-invite-qrcode');
      if (qrContainer && refCode && typeof QRCode !== 'undefined') {
        qrContainer.innerHTML = '';
        var inviteUrl = (typeof getInviteUrl === 'function' ? getInviteUrl() : ((window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl) || (window.location.origin + window.location.pathname).replace(/\/$/, '')) + '/?ref=' + encodeURIComponent(refCode));
        try { new QRCode(qrContainer, { text: inviteUrl, width: 120, height: 120 }); } catch (e) {}
      }
      if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      if (typeof loadFriendRequests === 'function') loadFriendRequests();
      if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
      startFriendsTokenPolling();
      if (typeof subscribeFriendRequestsRealtime === 'function') subscribeFriendRequestsRealtime();
      if (typeof subscribeFriendRequestAcceptedRealtime === 'function') subscribeFriendRequestAcceptedRealtime();
      if (typeof subscribeTokenReceivedRealtime === 'function') subscribeTokenReceivedRealtime();
    }
    document.querySelectorAll('.settings-tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() { showSettingsTab(btn.getAttribute('data-settings-tab')); });
    });
    function openWalletSettingsModal(initialTab) {
      if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
      var connEl = document.getElementById('wallet-settings-connection');
      if (connEl) {
        var addr = window.TonWallet && typeof window.TonWallet.getAddress === 'function' ? window.TonWallet.getAddress() : null;
        if (addr) {
          var short = addr.length > 12 ? addr.slice(0, 6) + '‚Ä¶' + addr.slice(-4) : addr;
          connEl.textContent = 'Connected: ' + short;
          connEl.classList.remove('text-neon-pink');
          connEl.classList.add('text-neon-green');
        } else {
          connEl.textContent = 'Not connected';
          connEl.classList.remove('text-neon-green');
          connEl.classList.add('text-gray-400');
        }
      }
      // Close notifications modal if open
      var notifModal = document.getElementById('notifications-modal');
      if (notifModal) { notifModal.classList.add('hidden'); notifModal.style.display = 'none'; }
      var modal = document.getElementById('wallet-settings-modal');
      if (modal) { modal.classList.remove('hidden'); modal.style.display = 'flex'; }
      // Set tab: use provided initialTab, else last saved tab, else 'general'
      var tab = initialTab || localStorage.getItem('tokenClicker_settingsTab') || 'general';
      showSettingsTab(tab);
    }
    document.getElementById('header-settings-btn') && document.getElementById('header-settings-btn').addEventListener('click', function() { openWalletSettingsModal(); });
    document.getElementById('wallet-need-help-btn') && document.getElementById('wallet-need-help-btn').addEventListener('click', function() { openWalletSettingsModal('wallet'); });
    function closeWalletSettingsModal() {
      var modal = document.getElementById('wallet-settings-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
      stopFriendsTokenPolling();
    }
    document.getElementById('wallet-settings-modal-close') && document.getElementById('wallet-settings-modal-close').addEventListener('click', closeWalletSettingsModal);
    document.getElementById('wallet-settings-modal-close-x') && document.getElementById('wallet-settings-modal-close-x').addEventListener('click', closeWalletSettingsModal);
    // Click outside settings modal to close
    document.getElementById('wallet-settings-modal') && document.getElementById('wallet-settings-modal').addEventListener('click', function (e) {
      if (e.target === this) closeWalletSettingsModal();
    });
    // Friends modal wrappers (for backward compatibility with other code that calls openFriendsModal)
    function openFriendsModal() { openWalletSettingsModal('friends'); }
    function closeFriendsModal() { closeWalletSettingsModal(); }
    document.getElementById('wallet-settings-replay-intro') && document.getElementById('wallet-settings-replay-intro').addEventListener('click', function() {
      var modal = document.getElementById('wallet-settings-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
      try { localStorage.removeItem('tokenClicker_onboardingCompleted'); } catch (e) {}
      var overlay = document.getElementById('onboarding-overlay');
      if (overlay) { overlay.classList.remove('hidden'); overlay.style.display = 'flex'; }
      if (app) app.classList.add('hidden');
      showOnboardingStep(0);
    });
    document.getElementById('wallet-settings-reload-app') && document.getElementById('wallet-settings-reload-app').addEventListener('click', function() { location.reload(); });
    document.getElementById('wallet-settings-btn') && document.getElementById('wallet-settings-btn').addEventListener('click', function() {
      var modal = document.getElementById('profile-name-modal');
      var input = document.getElementById('profile-name-input');
      if (input) input.value = getPlayerName() || '';
      if (modal) { modal.classList.remove('hidden'); modal.style.display = 'flex'; }
    });
    document.getElementById('profile-name-save') && document.getElementById('profile-name-save').addEventListener('click', function() {
      var input = document.getElementById('profile-name-input');
      var name = input && input.value.trim().slice(0, 20);
      if (name) { setPlayerName(name); hideProfileNameModal(); updateProfileDisplayName(); updateUI(); }
    });
    document.getElementById('profile-name-cancel') && document.getElementById('profile-name-cancel').addEventListener('click', hideProfileNameModal);
    function updateProfileDisplayName() {
      var el = document.getElementById('profile-display-name');
      if (el) el.textContent = getPlayerName() || '‚Äî';
      var walletName = document.getElementById('wallet-settings-name');
      if (walletName) walletName.textContent = getPlayerName() || '‚Äî';
    }
    var featherCb = document.getElementById('wallet-setting-feather-effects');
    var featherLabel = document.getElementById('wallet-setting-feather-label');
    if (featherCb) {
      featherCb.checked = localStorage.getItem('tokenClicker_featherEffects') !== '0';
      if (featherLabel) featherLabel.textContent = featherCb.checked ? 'On' : 'Off';
      featherCb.addEventListener('change', function() {
        localStorage.setItem('tokenClicker_featherEffects', featherCb.checked ? '1' : '0');
        if (featherLabel) featherLabel.textContent = featherCb.checked ? 'On' : 'Off';
      });
    }
    var soundCb = document.getElementById('wallet-setting-sound');
    var soundLabel = document.getElementById('wallet-setting-sound-label');
    if (soundCb) {
      soundCb.checked = localStorage.getItem('tokenClicker_sound') !== '0';
      if (soundLabel) soundLabel.textContent = soundCb.checked ? 'On' : 'Off';
      soundCb.addEventListener('change', function() {
        localStorage.setItem('tokenClicker_sound', soundCb.checked ? '1' : '0');
        if (soundLabel) soundLabel.textContent = soundCb.checked ? 'On' : 'Off';
      });
    }
    var hapticsCb = document.getElementById('wallet-setting-haptics');
    var hapticsLabel = document.getElementById('wallet-setting-haptics-label');
    if (hapticsCb) {
      hapticsCb.checked = localStorage.getItem('tokenClicker_haptics') !== '0';
      if (hapticsLabel) hapticsLabel.textContent = hapticsCb.checked ? 'On' : 'Off';
      hapticsCb.addEventListener('change', function() {
        localStorage.setItem('tokenClicker_haptics', hapticsCb.checked ? '1' : '0');
        if (hapticsLabel) hapticsLabel.textContent = hapticsCb.checked ? 'On' : 'Off';
      });
    }
    var reducedMotionCb = document.getElementById('wallet-setting-reduced-motion');
    var reducedMotionLabel = document.getElementById('wallet-setting-reduced-motion-label');
    if (reducedMotionCb) {
      reducedMotionCb.checked = localStorage.getItem('tokenClicker_reducedMotion') === '1';
      if (reducedMotionLabel) reducedMotionLabel.textContent = reducedMotionCb.checked ? 'On' : 'Off';
      reducedMotionCb.addEventListener('change', function() {
        localStorage.setItem('tokenClicker_reducedMotion', reducedMotionCb.checked ? '1' : '0');
        if (reducedMotionLabel) reducedMotionLabel.textContent = reducedMotionCb.checked ? 'On' : 'Off';
        document.documentElement.classList.toggle('reduced-motion', reducedMotionCb.checked);
      });
    }
    document.documentElement.classList.toggle('reduced-motion', localStorage.getItem('tokenClicker_reducedMotion') === '1');
    // PVP full list modal removed; TOP 5 only on Friends page.

    // --- Notifications ---
    var NOTIFICATIONS_MAX = 50;
    function pushNotification(msg) {
      try {
        var list = JSON.parse(localStorage.getItem('tokenClicker_notifications') || '[]');
        list.unshift({ t: Date.now(), msg: msg });
        if (list.length > NOTIFICATIONS_MAX) list.length = NOTIFICATIONS_MAX;
        localStorage.setItem('tokenClicker_notifications', JSON.stringify(list));
      } catch (e) {}
    }
    function renderNotificationsList() {
      var el = document.getElementById('notifications-list');
      if (!el) return;
      try {
        var list = JSON.parse(localStorage.getItem('tokenClicker_notifications') || '[]');
        if (list.length === 0) { el.innerHTML = '<li class="text-gray-500">No activity yet. Claim bounties and tap to see updates here.</li>'; return; }
        el.innerHTML = list.slice(0, 20).map(function (n) {
          var d = new Date(n.t);
          var when = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          return '<li class="border-b border-gray-700 pb-1">' + (n.msg || '') + ' <span class="text-gray-500">' + when + '</span></li>';
        }).join('');
      } catch (e) { el.innerHTML = '<li class="text-gray-500">No activity yet.</li>'; }
    }
    function updateNotificationsPermissionLabel() {
      var el = document.getElementById('notifications-permission');
      var btn = document.getElementById('notifications-request-btn');
      if (!el) return;
      if (typeof Notification === 'undefined') { el.textContent = 'not supported'; if (btn) btn.disabled = true; return; }
      var p = Notification.permission;
      el.textContent = p === 'granted' ? 'enabled' : p === 'denied' ? 'denied' : 'ask';
      if (btn) { btn.style.display = (p === 'granted' ? 'none' : 'inline-block'); btn.disabled = (p === 'denied'); }
    }
    document.getElementById('notifications-btn') && document.getElementById('notifications-btn').addEventListener('click', function () {
      var modal = document.getElementById('notifications-modal');
      if (!modal) return;
      // Close settings modal if open
      var settingsModal = document.getElementById('wallet-settings-modal');
      if (settingsModal) { settingsModal.classList.add('hidden'); settingsModal.style.display = 'none'; }
      updateNotificationsPermissionLabel();
      renderNotificationsList();
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    });
    document.getElementById('notifications-close') && document.getElementById('notifications-close').addEventListener('click', function (e) {
      e.stopPropagation();
      var modal = document.getElementById('notifications-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
    });
    // Click outside notifications modal to close
    document.getElementById('notifications-modal') && document.getElementById('notifications-modal').addEventListener('click', function (e) {
      if (e.target === this) { this.classList.add('hidden'); this.style.display = 'none'; }
    });
    document.getElementById('pvp-full-list-btn') && document.getElementById('pvp-full-list-btn').addEventListener('click', function () {
      var modal = document.getElementById('pvp-full-list-modal');
      if (!modal) return;
      if (typeof loadPvpFullList === 'function') loadPvpFullList();
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    });
    document.getElementById('pvp-full-list-modal-close') && document.getElementById('pvp-full-list-modal-close').addEventListener('click', function () {
      var modal = document.getElementById('pvp-full-list-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
    });
    document.getElementById('notifications-request-btn') && document.getElementById('notifications-request-btn').addEventListener('click', function () {
      if (typeof Notification === 'undefined') return;
      Notification.requestPermission().then(function () { updateNotificationsPermissionLabel(); });
    });
    updateNotificationsPermissionLabel();

    // --- PVP: rooms from Supabase ---
    function getPvpPlayerId() {
      if (window.TonWallet && typeof window.TonWallet.getAddress === 'function') {
        var addr = window.TonWallet.getAddress();
        if (addr) return addr;
      }
      var guest = localStorage.getItem('tokenClicker_pvp_guest_id');
      if (!guest) {
        guest = 'guest_' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('tokenClicker_pvp_guest_id', guest);
      }
      return guest;
    }
    var creatorRoomPollId = null;
    var creatorRoomChannel = null;
    function subscribeCreatorRoomAutoEnter(roomId) {
      if (!roomId) return;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      function doEnter() {
        if (creatorRoomPollId) { clearInterval(creatorRoomPollId); creatorRoomPollId = null; }
        if (creatorRoomChannel) { creatorRoomChannel.unsubscribe(); creatorRoomChannel = null; }
        if (typeof enterDuel === 'function') enterDuel(roomId);
      }
      try {
        creatorRoomChannel = supabase.channel('creator-room-' + roomId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, function(payload) {
          var room = payload.new;
          if (room && room.status === 'in_progress') doEnter();
        }).subscribe();
      } catch (e) {}
      creatorRoomPollId = setInterval(function() {
        supabase.from('rooms').select('status').eq('id', roomId).single().then(function(r) {
          if (r.data && r.data.status === 'in_progress') doEnter();
        });
      }, 2500);
    }
    function loadPvpRooms() {
      var list = document.getElementById('pvp-rooms-list');
      var status = document.getElementById('pvp-status');
      var errEl = document.getElementById('pvp-error');
      if (!list) return;
      if (errEl) errEl.classList.add('hidden');
      var supabase = window.supabaseClient;
      if (!supabase) {
        if (status) status.textContent = 'Rooms unavailable.';
        list.innerHTML = '<p class="text-gray-500 text-[10px] p-3">Leaderboard &amp; rooms need Supabase. Add URL and anon key in supabase-config.js and run migrations.</p>';
        return;
      }
      if (status) status.textContent = 'Loading rooms‚Ä¶';
      var nowIso = new Date().toISOString();
      var fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      supabase.from('rooms').update({ status: 'finished', updated_at: nowIso }).eq('status', 'open').lt('created_at', fiveMinAgo).then(function() {});
      supabase.from('rooms').update({ status: 'finished', updated_at: nowIso }).eq('status', 'in_progress').lt('game_ends_at', nowIso).then(function() {});
      function loadRoomsWithCols(cols) {
        return supabase.from('rooms').select(cols).order('created_at', { ascending: false }).limit(50);
      }
      loadRoomsWithCols('id, status, player1_wallet, player2_wallet, player1_name, player2_name, player1_wager_agreed, player2_wager_agreed, player1_ready, player2_ready, player1_clicks, player2_clicks, game_started_at, game_ends_at, winner_wallet, stake_amount, rematch_until, room_name, created_at')
        .then(function(r) {
          var msg = r.error && r.error.message ? r.error.message : '';
          if (r.error && (msg.indexOf('rematch') >= 0 || msg.indexOf('does not exist') >= 0 || msg.indexOf('schema cache') >= 0 || msg.indexOf('player1_wager_agreed') >= 0 || msg.indexOf('player2_wager_agreed') >= 0 || msg.indexOf('room_name') >= 0 || msg.indexOf('player1_ready') >= 0 || msg.indexOf('player2_ready') >= 0)) {
            return loadRoomsWithCols('id, status, player1_wallet, player2_wallet, player1_name, player2_name, player1_clicks, player2_clicks, game_started_at, game_ends_at, winner_wallet, stake_amount, created_at').then(function(r2) {
              if (r2.data) r2.data.forEach(function(room) { room.rematch_until = null; room.player1_wager_agreed = true; room.player2_wager_agreed = room.player2_wallet ? true : false; room.room_name = room.room_name || null; room.player1_ready = false; room.player2_ready = false; });
              return r2;
            });
          }
          return r;
        })
        .then(function(r) {
          if (status) status.textContent = '';
          if (r.error) {
            if (status) status.textContent = 'Could not load rooms.';
            if (errEl) { errEl.textContent = r.error.message || 'Error'; errEl.classList.remove('hidden'); }
            list.innerHTML = '';
            return;
          }
          var rooms = (r.data || []).filter(function(room) {
            if (room.status === 'open' || room.status === 'in_progress') return true;
            if (room.status === 'finished' && room.rematch_until && new Date(room.rematch_until).getTime() > Date.now()) return true;
            return false;
          });
          var order = { open: 0, in_progress: 1, finished: 2 };
          rooms.sort(function(a, b) {
            var oa = order[a.status] !== undefined ? order[a.status] : 3;
            var ob = order[b.status] !== undefined ? order[b.status] : 3;
            if (oa !== ob) return oa - ob;
            return new Date(b.created_at) - new Date(a.created_at);
          });
          var me = getPvpPlayerId();
          function escHtml(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
          list.innerHTML = rooms.map(function(room) {
            var p1 = room.player1_wallet || '‚Äî';
            var p2 = room.player2_wallet || '‚Äî';
            var count = (p1 && p1 !== '‚Äî' ? 1 : 0) + (p2 && p2 !== '‚Äî' ? 1 : 0);
            var isOpen = room.status === 'open' && count < 2;
            var isWagerPending = room.status === 'open' && count === 2;
            var isMine = p1 === me || p2 === me;
            var myAgreed = (p1 === me && room.player1_wager_agreed) || (p2 === me && room.player2_wager_agreed);
            var shortId = room.id.slice(0, 8);
            var joinBtn = isOpen && p1 !== me ? '<button type="button" class="pvp-join-btn mt-2 py-1 px-2 border border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10" data-room-id="' + room.id + '">JOIN</button>' : '';
            var agreeBtn = isWagerPending && isMine && !myAgreed ? '<button type="button" class="pvp-agree-wager-btn mt-2 py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-room-id="' + room.id + '">AGREE TO START</button>' : '';
            var enterDuelBtn = room.status === 'in_progress' && isMine && pvpDuelRoomId !== room.id ? '<button type="button" class="pvp-enter-duel-btn mt-2 py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-room-id="' + room.id + '">ENTER DUEL</button>' : '';
            var showClose = room.status === 'open' && p1 === me && count < 2;
            var settingsBtn = isMine ? '<button type="button" class="pvp-game-settings-btn w-6 h-6 flex items-center justify-center p-0 border border-gray-500 text-gray-400 rounded hover:bg-gray-700 hover:text-neon-cyan hover:border-neon-cyan text-[12px] leading-none shrink-0" data-room-id="' + room.id + '" title="Game settings" aria-label="Game settings">&#9881;</button>' : '';
            var closeXBtn = showClose ? '<button type="button" class="pvp-close-room-btn w-6 h-6 flex items-center justify-center p-0 border border-neon-pink text-neon-pink rounded text-[12px] hover:bg-neon-pink/10 shrink-0" data-room-id="' + room.id + '" title="Close room" aria-label="Close room">&#215;</button>' : '';
            var customizeBoostsBtn = room.status === 'open' && isMine ? '<button type="button" class="pvp-customize-boosts-btn mt-2 py-1 px-2 border border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10" data-room-id="' + room.id + '">CUSTOMIZE BOOSTS</button>' : '';
            var base = (window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl ? window.TON_CONFIG.gameBaseUrl : (window.location.origin + window.location.pathname)).replace(/\/?$/, '');
            var shareLink = base + '/?room=' + room.id;
            var stake = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 5;
            if (isNaN(stake) || stake < 1) stake = 5;
            var alreadyInDuel = pvpDuelRoomId === room.id;
            var cardAction = isOpen && p1 !== me ? 'join' : (isWagerPending && isMine ? 'agree-wager' : ((room.status === 'in_progress' || (isOpen && isMine)) && !alreadyInDuel ? 'enter-duel' : ''));
            var statusText;
            if (isWagerPending) {
              statusText = myAgreed ? 'Waiting for other player‚Ä¶' : 'Agree to start';
            } else if (room.status === 'in_progress') {
              statusText = alreadyInDuel ? 'You are in this duel' : 'Race in progress ‚Äî tap ENTER DUEL';
            } else if (room.status === 'open' && count === 1) {
              var whoInRoom = (room.player1_name && room.player1_name.trim()) || (room.player2_name && room.player2_name.trim()) || null;
              statusText = whoInRoom ? escHtml(whoInRoom) + ' in room ‚Äî waiting for player to join' : 'Waiting for player to join';
            } else {
              statusText = count + '/2 ¬∑ ' + room.status;
            }
            var statusLine = room.status === 'open' && count === 1 ? statusText : (count + '/2 ¬∑ ' + statusText);
            return '<div class="pvp-room-card bg-pixel-panel border-2 border-gray-700 p-3 rounded text-left cursor-pointer hover:border-gray-500 relative" data-room-id="' + room.id + '" data-room-action="' + cardAction + '" data-room-stake="' + stake + '">' +
              '<div class="flex justify-between items-center gap-2">' +
              '<span class="text-[10px] text-neon-pink truncate">Room ' + escHtml(room.room_name && room.room_name.trim() ? room.room_name.trim() : (typeof getLocalRoomName === 'function' ? getLocalRoomName(room.id) : '') || shortId) + (isMine ? ' (you)' : '') + ' ¬∑ ' + stake + ' tokens</span>' + closeXBtn +
              '</div>' +
              '<div class="text-gray-500 text-[9px] mt-1">' + statusLine + '</div>' +
              '<div class="mt-2 flex flex-wrap gap-2 items-center justify-between">' +
              '<div class="flex flex-wrap gap-2 items-center">' + joinBtn + agreeBtn + enterDuelBtn + customizeBoostsBtn +
              '<button type="button" class="pvp-copy-link-btn py-1 px-2 border border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" data-room-id="' + room.id + '" data-room-url="' + shareLink + '">COPY LINK</button>' +
              '</div>' + settingsBtn +
              '</div></div>';
          }).join('');
          if (rooms.length === 0) list.innerHTML = '<p class="text-gray-500 text-[10px] p-3">No rooms yet. Create one above.</p>';
          // Use one delegated click on the list so all buttons and card clicks work
          list.onclick = function(ev) {
            var target = ev.target;
            if (target && target.nodeType !== 1) target = target.parentElement;
            if (!target) return;
            var roomId = target.getAttribute && target.getAttribute('data-room-id');
            if (!roomId) {
              var card = target.closest && target.closest('.pvp-room-card');
              if (card) {
                roomId = card.getAttribute('data-room-id');
                var action = card.getAttribute('data-room-action');
                if (action === 'join') { ev.preventDefault(); ev.stopPropagation(); if (typeof joinPvpRoom === 'function') joinPvpRoom(roomId); return; }
                if (action === 'agree-wager') { ev.preventDefault(); ev.stopPropagation(); if (typeof agreeWagerPvp === 'function') agreeWagerPvp(roomId); return; }
                if (action === 'enter-duel') { ev.preventDefault(); ev.stopPropagation(); enterDuel(roomId); return; }
              }
              return;
            }
            if (target.classList && target.classList.contains('pvp-join-btn')) { ev.preventDefault(); ev.stopPropagation(); if (typeof joinPvpRoom === 'function') joinPvpRoom(roomId); return; }
            if (target.classList && target.classList.contains('pvp-agree-wager-btn')) { ev.preventDefault(); if (typeof agreeWagerPvp === 'function') agreeWagerPvp(roomId); return; }
            if (target.classList && target.classList.contains('pvp-agree-wager-btn')) { ev.preventDefault(); if (typeof agreeWagerPvp === 'function') agreeWagerPvp(roomId); return; }
            if (target.classList && target.classList.contains('pvp-enter-duel-btn')) { ev.preventDefault(); enterDuel(roomId); return; }
            if (target.classList && target.classList.contains('pvp-close-room-btn')) { ev.preventDefault(); closePvpRoom(roomId); return; }
            if (target.classList && target.classList.contains('pvp-game-settings-btn')) { ev.preventDefault(); ev.stopPropagation(); if (roomId && typeof openRoomSettingsModal === 'function') openRoomSettingsModal(roomId); return; }
            if (target.classList && target.classList.contains('pvp-customize-boosts-btn')) { ev.preventDefault(); ev.stopPropagation(); if (typeof openCustomizeBuffsModal === 'function') openCustomizeBuffsModal(); return; }
            if (target.classList && target.classList.contains('pvp-copy-link-btn')) {
              ev.preventDefault();
              var url = target.getAttribute('data-room-url');
              if (url && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(function() {
                  var statusEl = document.getElementById('pvp-status');
                  if (statusEl) { statusEl.textContent = 'Room link copied!'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
                });
              }
              return;
            }
            var card = target.closest && target.closest('.pvp-room-card');
            if (card) {
              var action = card.getAttribute('data-room-action');
              if (action === 'join') { ev.preventDefault(); joinPvpRoom(roomId); return; }
              if (action === 'agree-wager') { ev.preventDefault(); if (typeof agreeWagerPvp === 'function') agreeWagerPvp(roomId); return; }
              if (action === 'enter-duel') { ev.preventDefault(); enterDuel(roomId); return; }
            }
          };
        })
        .catch(function(e) {
          if (status) status.textContent = '';
          if (errEl) { errEl.textContent = e.message || 'Network error'; errEl.classList.remove('hidden'); }
          list.innerHTML = '';
        });
    }
    function getPvpCreateStake() {
      var custom = document.getElementById('pvp-custom-stake');
      if (custom && custom.value.trim() !== '') {
        var n = parseInt(custom.value.trim(), 10);
        if (!isNaN(n) && n >= 1 && n <= 999) return n;
      }
      var sel = document.querySelector('.pvp-stake-btn.border-neon-green');
      if (sel && sel.getAttribute('data-stake')) return parseInt(sel.getAttribute('data-stake'), 10) || 5;
      return PVP_DEFAULT_STAKE;
    }
    function hasValidWagerSelection() {
      var custom = document.getElementById('pvp-custom-stake');
      if (custom && custom.value.trim() !== '') {
        var n = parseInt(custom.value.trim(), 10);
        if (!isNaN(n) && n >= 1 && n <= 999) return true;
        return false;
      }
      var sel = document.querySelector('.pvp-stake-btn.border-neon-green');
      return !!(sel && sel.getAttribute('data-stake'));
    }
    function updatePvpCreateRoomButtonState() {
      var btn = document.getElementById('pvp-create-room-btn');
      if (!btn) return;
      btn.disabled = !hasValidWagerSelection();
    }
    function updatePvpPlayerRowAboveCreate() {
      var rowWrap = document.getElementById('pvp-player-row-above-create');
      var nameEl = document.getElementById('pvp-player-row-name');
      var tokensEl = document.getElementById('pvp-player-row-tokens');
      var starBtn = document.getElementById('pvp-player-row-favorite-btn');
      var removeBtn = document.getElementById('pvp-player-row-remove-btn');
      if (!rowWrap) return;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      var supabase = window.supabaseClient;
      if (!me || !supabase) { rowWrap.classList.add('hidden'); rowWrap.setAttribute('data-friend-ref', ''); rowWrap.setAttribute('data-friend-name', ''); return; }
      supabase.from('friends_by_code').select('friend_ref_code, friend_name, created_at').eq('user_wallet', me).order('created_at', { ascending: false }).limit(50).then(function(r) {
        if (r.error || !r.data || r.data.length === 0) { rowWrap.classList.add('hidden'); rowWrap.setAttribute('data-friend-ref', ''); rowWrap.setAttribute('data-friend-name', ''); return; }
        var favRefs = typeof getFavoriteFriendRefs === 'function' ? getFavoriteFriendRefs() : [];
        var list = r.data.slice();
        list.sort(function(a, b) {
          var ac = (a.friend_ref_code || '').trim().toUpperCase();
          var bc = (b.friend_ref_code || '').trim().toUpperCase();
          var aFav = favRefs.indexOf(ac) >= 0 ? 1 : 0;
          var bFav = favRefs.indexOf(bc) >= 0 ? 1 : 0;
          if (bFav !== aFav) return bFav - aFav;
          return 0;
        });
        var first = list[0];
        var ref = (first.friend_ref_code || '').trim().toUpperCase();
        var name = (first.friend_name || first.friend_ref_code || 'Friend').trim();
        var cache = typeof getFriendTokenCache === 'function' ? getFriendTokenCache() : { byRefCode: {} };
        var tokenCount = cache.byRefCode && ref ? (cache.byRefCode[ref] != null ? cache.byRefCode[ref] : null) : null;
        rowWrap.setAttribute('data-friend-ref', ref);
        rowWrap.setAttribute('data-friend-name', name);
        if (nameEl) nameEl.textContent = name;
        if (tokensEl) tokensEl.textContent = (tokenCount != null ? tokenCount : '‚Äî') + (tokenCount != null ? ' tokens' : '');
        if (starBtn) {
          var isFav = typeof isFavoriteFriendRef === 'function' && isFavoriteFriendRef(ref);
          starBtn.textContent = isFav ? '‚òÖ' : '‚òÜ';
          starBtn.title = isFav ? 'Remove from favorites' : 'Add to favorites';
          starBtn.classList.toggle('text-neon-yellow', isFav);
          starBtn.classList.toggle('bg-neon-yellow/20', isFav);
          starBtn.classList.toggle('text-gray-500', !isFav);
        }
        if (removeBtn) removeBtn.classList.remove('hidden');
        rowWrap.classList.remove('hidden');
        if (ref && typeof subscribeFriendsLeaderboardRealtime === 'function') subscribeFriendsLeaderboardRealtime();
        if (ref && tokenCount == null && typeof mergeFriendTokenCache === 'function') {
          supabase.from('leaderboard').select('ref_code, tokens').ilike('ref_code', ref).limit(1).then(function(lr) {
            if (lr.data && lr.data[0] != null && tokensEl && rowWrap.getAttribute('data-friend-ref') === ref) {
              var t = lr.data[0].tokens != null ? lr.data[0].tokens : 0;
              tokensEl.textContent = t + ' tokens';
              mergeFriendTokenCache(null, { [ref]: t }, null);
            }
          });
        }
      });
    }
    window.updatePvpPlayerRowAboveCreate = updatePvpPlayerRowAboveCreate;
    function openPvpCreateRoomModal(friendName) {
      var modal = document.getElementById('pvp-create-room-modal');
      if (!modal) return;
      window._pvpCreateForFriend = friendName || null;
      var title = document.getElementById('pvp-create-modal-title');
      var subtitle = document.getElementById('pvp-create-modal-subtitle');
      if (title) title.textContent = friendName ? 'DUEL ‚Äî ' + (friendName.length > 12 ? friendName.slice(0, 12) + '‚Ä¶' : friendName) : '‚ûï CREATE NEW ROOM';
      if (subtitle) {
        if (friendName) { subtitle.textContent = 'Set wager and create room. Send the link to ' + friendName + ' to join.'; subtitle.classList.remove('hidden'); } else { subtitle.textContent = ''; subtitle.classList.add('hidden'); }
      }
      var errEl = document.getElementById('pvp-create-modal-error');
      if (errEl) { errEl.textContent = ''; errEl.classList.add('hidden'); }
      var custom = document.getElementById('pvp-custom-stake');
      if (custom) custom.value = '';
      document.querySelectorAll('.pvp-stake-btn').forEach(function(b) {
        b.classList.remove('border-neon-green', 'text-neon-green', 'bg-neon-green/10');
        b.classList.add('border-gray-600', 'text-gray-400');
        if (b.getAttribute('data-stake') === '5') {
          b.classList.add('border-neon-green', 'text-neon-green', 'bg-neon-green/10');
          b.classList.remove('border-gray-600', 'text-gray-400');
        }
      });
      if (typeof updateUI === 'function') updateUI();
      updatePvpCreateRoomButtonState();
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    }
    function closePvpCreateRoomModal() {
      var modal = document.getElementById('pvp-create-room-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
      window._pvpCreateForFriend = null;
    }
    window.openPvpCreateRoomModal = openPvpCreateRoomModal;
    window.closePvpCreateRoomModal = closePvpCreateRoomModal;
    function createPvpRoom() {
      var supabase = window.supabaseClient;
      var btn = document.getElementById('pvp-create-room-btn');
      var errEl = document.getElementById('pvp-create-modal-error') || document.getElementById('pvp-error');
      if (!supabase) { if (errEl) { errEl.textContent = 'Supabase not configured.'; errEl.classList.remove('hidden'); } return; }
      var name = getPlayerName();
      if (!name) { showPvpOnboarding('name'); return; }
      if (!hasValidWagerSelection()) {
        if (errEl) { errEl.textContent = 'Choose a wager to duel (tap an amount or enter custom).'; errEl.classList.remove('hidden'); }
        return;
      }
      var stake = getPvpCreateStake();
      if (!hasEnoughTokens(stake)) {
        if (errEl) { errEl.textContent = 'You need at least ' + stake + ' in-game tokens to create this room. Earn tokens by tapping or claiming bounties.'; errEl.classList.remove('hidden'); }
        return;
      }
      if (btn) btn.disabled = true;
      var me = getPvpPlayerId();
      var createForFriend = window._pvpCreateForFriend || null;
      supabase.from('rooms').insert({
        status: 'open',
        player1_wallet: me,
        player1_name: name,
        stake_amount: stake
      }).select('id').single()
        .then(function(r) {
          if (btn) btn.disabled = false;
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Failed to create room'; errEl.classList.remove('hidden'); } return; }
          var roomId = r.data.id;
          if (typeof closePvpCreateRoomModal === 'function') closePvpCreateRoomModal();
          var status = document.getElementById('pvp-status');
          if (status) { status.textContent = 'Room created! Share the link ‚Äî game starts when your opponent joins.'; status.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { status.textContent = ''; status.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 6000); }
          loadPvpRooms();
          if (errEl) errEl.classList.add('hidden');
          if (typeof subscribeCreatorRoomAutoEnter === 'function') subscribeCreatorRoomAutoEnter(roomId);
          var url = (typeof getShareBaseUrl === 'function' ? getShareBaseUrl() : (window.location.origin + window.location.pathname)) + '/?room=' + roomId;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(function() {
              if (typeof pushNotification === 'function') pushNotification(createForFriend ? 'Link copied. Send to ' + createForFriend + ' to join.' : 'Room link copied! Send it to your opponent to join.');
            }).catch(function() {});
          }
          if (createForFriend) window._pvpCreateForFriend = null;
        })
        .catch(function(e) {
          if (btn) btn.disabled = false;
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function closePvpRoom(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var me = getPvpPlayerId();
      supabase.from('rooms').update({ status: 'finished', updated_at: new Date().toISOString() }).eq('id', roomId).eq('status', 'open').eq('player1_wallet', me)
        .then(function(r) {
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Could not close room'; errEl.classList.remove('hidden'); } return; }
          if (errEl) errEl.classList.add('hidden');
          loadPvpRooms();
          var statusEl = document.getElementById('pvp-status');
          if (statusEl) { statusEl.textContent = 'Room closed.'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
        })
        .catch(function(e) {
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function joinPvpRoom(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var name = getPlayerName();
      if (!name) { showPvpOnboarding('name', roomId); return; }
      var me = getPvpPlayerId();
      supabase.from('rooms').select('status, player1_wallet, player2_wallet, stake_amount').eq('id', roomId).single().then(function(check) {
        if (check.error || !check.data) { if (errEl) { errEl.textContent = 'Room not found.'; errEl.classList.remove('hidden'); } return; }
        var room = check.data;
        var stake = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 5;
        if (isNaN(stake) || stake < 1) stake = 5;
        if (!hasEnoughTokens(stake)) {
          if (errEl) { errEl.textContent = 'You need at least ' + stake + ' in-game tokens to join this wager. Your balance: ' + getInGameTokenBalance() + '.'; errEl.classList.remove('hidden'); }
          return;
        }
        if (room.status !== 'open') { if (errEl) { errEl.textContent = 'Room is full or game already started.'; errEl.classList.remove('hidden'); } return; }
        if (room.player2_wallet) { if (errEl) { errEl.textContent = 'Room is full. Only 2 players per game.'; errEl.classList.remove('hidden'); } return; }
        if (room.player1_wallet === me) { if (errEl) { errEl.textContent = 'You already created this room. Wait for opponent or close it.'; errEl.classList.remove('hidden'); } return; }
        doJoinPvpRoom(roomId, me, name, errEl);
      });
    }
    function doJoinPvpRoom(roomId, me, name, errEl) {
      var supabase = window.supabaseClient;
      var now = new Date();
      supabase.from('rooms').update({
        player2_wallet: me,
        player2_name: name,
        status: 'in_progress',
        player1_ready: false,
        player2_ready: false,
        updated_at: now.toISOString()
      }).eq('id', roomId).eq('status', 'open')
        .then(function(r) {
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Could not join'; errEl.classList.remove('hidden'); } return; }
          loadPvpRooms();
          if (errEl) errEl.classList.add('hidden');
          if (typeof clearPvpInvitedRoom === 'function') clearPvpInvitedRoom();
          var statusEl = document.getElementById('pvp-status');
          if (statusEl) { statusEl.textContent = 'You joined! Entering duel‚Ä¶'; statusEl.className = 'text-[9px] text-neon-green mb-1 min-h-[14px]'; }
          if (typeof enterDuel === 'function') enterDuel(roomId);
        })
        .catch(function(e) {
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function agreeWagerPvp(roomId) {
      var supabase = window.supabaseClient;
      var me = getPvpPlayerId();
      if (!supabase || !roomId) return;
      supabase.from('rooms').select('player1_wallet, player2_wallet, player1_wager_agreed, player2_wager_agreed').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        var isP1 = room.player1_wallet === me;
        var isP2 = room.player2_wallet === me;
        if (!isP1 && !isP2) return;
        var now = new Date();
        var col = isP1 ? 'player1_wager_agreed' : 'player2_wager_agreed';
        var update = {};
        update[col] = true;
        update.updated_at = now.toISOString();
        supabase.from('rooms').update(update).eq('id', roomId).then(function() {
          supabase.from('rooms').select('player1_wager_agreed, player2_wager_agreed').eq('id', roomId).single().then(function(r2) {
            if (r2.error || !r2.data) return;
            var row = r2.data;
            if (row.player1_wager_agreed !== true || row.player2_wager_agreed !== true) return;
            supabase.from('rooms').update({
              status: 'in_progress',
              player1_ready: false,
              player2_ready: false,
              updated_at: new Date().toISOString()
            }).eq('id', roomId).then(function() {
              if (typeof enterDuel === 'function') enterDuel(roomId);
            });
          });
        });
      });
    }

    // --- PVP: duel view, realtime clicks, timer, winner, rematch ---
    var pvpDuelRoomId = null;
    var pvpDuelMyRole = 0; // 1 or 2
    var pvpDuelTimerId = null;
    var pvpDuelRealtimeUnsub = null;
    var pvpDuelPollId = null;
    var pvpDuelLastClickAt = 0;
    var pvpRematchCountdownId = null;
    var pvpRematchChannelUnsub = null;
    // Play vs Computer (no Supabase)
    var pvpVsBotMode = false;
    var pvpBotClicks = 0;
    var pvpMyClicksVsBot = 0;
    var pvpBotIntervalId = null;
    var pvpLastWasVsBot = false;

    function showDuelLobby() {
      document.getElementById('pvp-duel-view').classList.add('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = '';
      if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
      if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
      if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
      if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
      if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
      if (pvpBotIntervalId) { clearInterval(pvpBotIntervalId); pvpBotIntervalId = null; }
      pvpDuelRoomId = null;
      pvpDuelMyRole = 0;
      pvpVsBotMode = false;
    }
    function startVsComputer() {
      pvpVsBotMode = true;
      pvpDuelRoomId = null;
      pvpDuelMyRole = 1;
      pvpMyClicksVsBot = 0;
      pvpBotClicks = 0;
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = 'none';
      document.getElementById('pvp-duel-view').classList.remove('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-duel-waiting').classList.add('hidden');
      document.getElementById('pvp-duel-you-name').textContent = getPlayerName() || 'You';
      document.getElementById('pvp-duel-opp-name').textContent = 'Computer';
      document.getElementById('pvp-duel-you-clicks').textContent = '0';
      document.getElementById('pvp-duel-opp-clicks').textContent = '0';
      var endsAt = Date.now() + (PVP_COUNTDOWN_SEC + PVP_GAME_DURATION_SEC) * 1000;
      startDuelTimer(endsAt);
      if (pvpBotIntervalId) clearInterval(pvpBotIntervalId);
      if (window._pvpBotStartTimeout) clearTimeout(window._pvpBotStartTimeout);
      window._pvpBotStartTimeout = setTimeout(function() {
        window._pvpBotStartTimeout = null;
        if (!pvpVsBotMode) return;
        pvpBotIntervalId = setInterval(function() {
          if (!pvpVsBotMode) { clearInterval(pvpBotIntervalId); pvpBotIntervalId = null; return; }
          pvpBotClicks += 1;
          var el = document.getElementById('pvp-duel-opp-clicks');
          if (el) el.textContent = String(pvpBotClicks);
        }, 280 + Math.random() * 120);
      }, PVP_COUNTDOWN_SEC * 1000);
    }
    function endVsComputerGame() {
      if (!pvpVsBotMode) return;
      if (pvpBotIntervalId) { clearInterval(pvpBotIntervalId); pvpBotIntervalId = null; }
      pvpVsBotMode = false;
      var winner = pvpMyClicksVsBot > pvpBotClicks ? 'me' : (pvpBotClicks > pvpMyClicksVsBot ? 'bot' : null);
      document.getElementById('pvp-duel-view').classList.add('hidden');
      var resultEl = document.getElementById('pvp-duel-result');
      resultEl.classList.remove('hidden');
      pvpLastWasVsBot = true;
      if (winner === 'me') {
        if (typeof pushNotification === 'function') pushNotification('You beat the computer! Play vs a friend for real.');
        document.getElementById('pvp-duel-result-title').textContent = 'YOU WIN!';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-green';
        document.getElementById('pvp-duel-result-detail').textContent = 'You beat the computer! Practice wins don\'t count on the leaderboard. Play vs a friend for real.';
      } else if (winner === 'bot') {
        if (typeof pushNotification === 'function') pushNotification('You lost vs computer. Try again or duel a friend!');
        document.getElementById('pvp-duel-result-title').textContent = 'COMPUTER WINS';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-pink';
        document.getElementById('pvp-duel-result-detail').textContent = 'The computer had more taps. Try again or invite a friend to duel!';
      } else {
        document.getElementById('pvp-duel-result-title').textContent = 'DRAW';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 text-gray-400';
        document.getElementById('pvp-duel-result-detail').textContent = 'Tie! No winner.';
      }
    }
    function enterDuel(roomId) {
      pvpDuelRoomId = roomId;
      pvpVsBotMode = false;
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = 'none';
      document.getElementById('pvp-duel-view').classList.remove('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-duel-waiting').classList.add('hidden');
      var readyWrap = document.getElementById('pvp-duel-ready-wrap');
      if (readyWrap) readyWrap.classList.add('hidden');
      var me = getPvpPlayerId();
      var supabase = window.supabaseClient;
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status === 'finished') { showDuelResult(room); document.getElementById('pvp-duel-view').classList.add('hidden'); document.getElementById('pvp-duel-result').classList.remove('hidden'); var lobbyWrap = document.getElementById('pvp-lobby-wrap'); if (lobbyWrap) lobbyWrap.style.display = 'none'; return; }
        pvpDuelMyRole = room.player1_wallet === me ? 1 : (room.player2_wallet === me ? 2 : 0);
        var youName = pvpDuelMyRole === 1 ? (room.player1_name || 'You') : (room.player2_name || 'You');
        var oppName = pvpDuelMyRole === 1 ? (room.player2_name || 'Opponent') : (room.player1_name || 'Opponent');
        document.getElementById('pvp-duel-you-name').textContent = youName;
        document.getElementById('pvp-duel-opp-name').textContent = oppName;
        document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
        document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
        var endsAt = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
        var needReady = room.status === 'in_progress' && !endsAt && room.player2_wallet && (typeof room.player1_ready === 'boolean' || typeof room.player2_ready === 'boolean');
        if (needReady) {
          if (document.getElementById('pvp-duel-waiting')) document.getElementById('pvp-duel-waiting').classList.add('hidden');
          if (readyWrap) readyWrap.classList.remove('hidden');
          updatePvpReadyUI(room);
        } else if (room.status === 'open' || (!endsAt && room.status === 'in_progress')) {
          var waitEl = document.getElementById('pvp-duel-waiting');
          if (waitEl) waitEl.classList.remove('hidden');
          if (readyWrap) readyWrap.classList.add('hidden');
          var linkEl = document.getElementById('pvp-duel-room-link');
          if (linkEl) linkEl.textContent = (getShareBaseUrl ? getShareBaseUrl() : window.location.href.split('?')[0]) + '?room=' + roomId;
        } else if (readyWrap) readyWrap.classList.add('hidden');
        startDuelTimer(endsAt);
        subscribeDuelRoom(roomId);
        if (pvpDuelPollId) clearInterval(pvpDuelPollId);
        pvpDuelPollId = setInterval(function() {
          if (!pvpDuelRoomId) { if (pvpDuelPollId) clearInterval(pvpDuelPollId); pvpDuelPollId = null; return; }
          supabase.from('rooms').select('player1_clicks, player2_clicks, status, game_ends_at, player1_ready, player2_ready').eq('id', roomId).single().then(function(r) {
            if (r.error || !r.data) return;
            var room = r.data;
            document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
            document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
            if (room.status === 'finished') { if (pvpDuelPollId) clearInterval(pvpDuelPollId); pvpDuelPollId = null; if (pvpDuelTimerId) clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; endDuelGame(); return; }
            var endsAt2 = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
            if (room.player1_ready && room.player2_ready && !endsAt2 && typeof startDuelWhenBothReady === 'function') startDuelWhenBothReady(roomId);
            else if (typeof updatePvpReadyUI === 'function') updatePvpReadyUI(room);
          });
        }, 250);
      });
    }
    function updatePvpReadyUI(room) {
      var readyWrap = document.getElementById('pvp-duel-ready-wrap');
      if (!readyWrap || !room) return;
      if (room.game_ends_at) { readyWrap.classList.add('hidden'); return; }
      var myReady = (pvpDuelMyRole === 1 && room.player1_ready) || (pvpDuelMyRole === 2 && room.player2_ready);
      var otherReady = (pvpDuelMyRole === 1 && room.player2_ready) || (pvpDuelMyRole === 2 && room.player1_ready);
      var btn = document.getElementById('pvp-duel-ready-btn');
      var statusEl = document.getElementById('pvp-duel-ready-status');
      if (btn) { btn.textContent = myReady ? 'Ready!' : 'READY'; btn.disabled = myReady; }
      if (statusEl) statusEl.textContent = myReady ? (otherReady ? 'Both ready! Starting in 5‚Ä¶' : 'Waiting for opponent to be ready‚Ä¶') : 'Click READY. Then 5‚Ä¶ 4‚Ä¶ 3‚Ä¶ 2‚Ä¶ 1‚Ä¶ GO!';
    }
    function startDuelWhenBothReady(roomId) {
      var supabase = window.supabaseClient;
      if (!supabase) return;
      var now = new Date();
      var totalSec = PVP_COUNTDOWN_SEC + PVP_GAME_DURATION_SEC;
      var endsAt = new Date(now.getTime() + totalSec * 1000);
      supabase.from('rooms').update({
        game_started_at: now.toISOString(),
        game_ends_at: endsAt.toISOString(),
        player1_ready: false,
        player2_ready: false,
        updated_at: now.toISOString()
      }).eq('id', roomId).is('game_ends_at', null).then(function() {
        startDuelTimer(endsAt.getTime());
      });
    }
    function startDuelTimer(endsAtMs) {
      if (pvpDuelTimerId) clearInterval(pvpDuelTimerId);
      var countdownEndMs = endsAtMs - PVP_GAME_DURATION_SEC * 1000;
      var clickBtn = document.getElementById('pvp-duel-click-btn');
      if (clickBtn) clickBtn.disabled = true;
      function tick() {
        var now = Date.now();
        if (endsAtMs <= 0) return;
        if (now < countdownEndMs) {
          var countdownLeft = Math.ceil((countdownEndMs - now) / 1000);
          var el = document.getElementById('pvp-duel-timer');
          if (el) {
            if (countdownLeft >= 5) { el.textContent = '5'; el.classList.remove('pvp-go-glow'); }
            else if (countdownLeft === 4) { el.textContent = '4'; el.classList.remove('pvp-go-glow'); }
            else if (countdownLeft === 3) { el.textContent = '3'; el.classList.remove('pvp-go-glow'); }
            else if (countdownLeft === 2) { el.textContent = '2'; el.classList.remove('pvp-go-glow'); }
            else if (countdownLeft === 1) { el.textContent = '1'; el.classList.remove('pvp-go-glow'); }
            else if (countdownLeft === 0) { el.textContent = 'GO!'; el.classList.add('pvp-go-glow'); }
            else { el.textContent = 'GO!'; el.classList.add('pvp-go-glow'); }
          }
          return;
        }
        if (clickBtn && clickBtn.disabled) clickBtn.disabled = false;
        var left = Math.max(0, Math.ceil((endsAtMs - now) / 1000));
        var el = document.getElementById('pvp-duel-timer');
        if (el) { el.classList.remove('pvp-go-glow'); el.textContent = '0:' + (left < 10 ? '0' : '') + left; }
        if (left <= 0) {
          clearInterval(pvpDuelTimerId);
          pvpDuelTimerId = null;
          if (pvpVsBotMode) endVsComputerGame(); else endDuelGame();
        }
      }
      tick();
      pvpDuelTimerId = setInterval(tick, 200);
    }
    function subscribeDuelRoom(roomId) {
      var supabase = window.supabaseClient;
      if (!supabase) return;
      if (pvpDuelRealtimeUnsub) pvpDuelRealtimeUnsub();
      var me = getPvpPlayerId();
      var channel = supabase.channel('room-' + roomId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, function(payload) {
        var room = payload.new;
        if (!room || room.id !== roomId) return;
        document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
        document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
        var endsAt = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
        if (room.player1_ready && room.player2_ready && !endsAt && typeof startDuelWhenBothReady === 'function') startDuelWhenBothReady(roomId);
        if (endsAt && !pvpDuelTimerId) startDuelTimer(endsAt);
        if (typeof updatePvpReadyUI === 'function') updatePvpReadyUI(room);
        if (room.status === 'finished') {
          if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
          showDuelResult(room);
        }
      }).subscribe();
      pvpDuelRealtimeUnsub = function() { supabase.removeChannel(channel); };
    }
    function endDuelGame() {
      if (pvpVsBotMode) { endVsComputerGame(); return; }
      if (!pvpDuelRoomId) return;
      var supabase = window.supabaseClient;
      supabase.from('rooms').select('*').eq('id', pvpDuelRoomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status === 'finished') { showDuelResult(room); return; }
        var c1 = room.player1_clicks || 0, c2 = room.player2_clicks || 0;
        var winner = c1 > c2 ? room.player1_wallet : (c2 > c1 ? room.player2_wallet : null);
        var rematchUntil = new Date(Date.now() + 60 * 1000).toISOString();
        supabase.from('rooms').update({ status: 'finished', winner_wallet: winner, updated_at: new Date().toISOString(), rematch_until: rematchUntil }).eq('id', pvpDuelRoomId).then(function(u) {
          room.status = 'finished';
          room.winner_wallet = winner;
          room.rematch_until = (u.error && (u.error.message || '').toLowerCase().indexOf('rematch') >= 0) ? null : rematchUntil;
          showDuelResult(room);
          if (winner) { var st = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 0; upsertLeaderboardWin(winner, room.player1_wallet === winner ? room.player1_name : room.player2_name, isNaN(st) ? 0 : st); }
        }).catch(function() {
          room.status = 'finished';
          room.winner_wallet = winner;
          room.rematch_until = null;
          showDuelResult(room);
          if (winner) { var st = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 0; upsertLeaderboardWin(winner, room.player1_wallet === winner ? room.player1_name : room.player2_name, isNaN(st) ? 0 : st); }
        });
      });
    }
    function endDuelEarly() {
      if (pvpVsBotMode) { endVsComputerGame(); return; }
      if (!pvpDuelRoomId) return;
      if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
      if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
      endDuelGame();
    }
    function showDuelResult(room) {
      pvpLastWasVsBot = false;
      if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
      if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
      if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
      document.getElementById('pvp-duel-view').classList.add('hidden');
      var resultEl = document.getElementById('pvp-duel-result');
      resultEl.classList.remove('hidden');
      var me = getPvpPlayerId();
      var winnerWallet = room.winner_wallet;
      // Note: upsertLeaderboardWin is called in endDuelGame(), not here, to avoid double-counting wins
      var winName = room.player1_wallet === winnerWallet ? room.player1_name : (room.player2_name || 'Winner');
      var stake = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 5;
      if (isNaN(stake) || stake < 1) stake = 5;
      if (winnerWallet === me) {
        if (typeof addTokens === 'function') addTokens(stake);
        try { localStorage.setItem('tokenClicker_firstPvpWin', '1'); } catch (e) {}
        if (typeof updateBadges === 'function') updateBadges();
        if (typeof pushNotification === 'function') pushNotification('You won the duel! +' + stake + ' tokens.');
        document.getElementById('pvp-duel-result-title').textContent = 'YOU WIN!';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-green';
        document.getElementById('pvp-duel-result-detail').textContent = 'You won ' + stake + ' tokens. You\'re on the leaderboard.';
      } else if (winnerWallet) {
        if (typeof pushNotification === 'function') pushNotification('You lost the duel. ' + winName + ' won ' + stake + ' tokens.');
        if (typeof tokens !== 'undefined') {
          tokens = Math.max(0, (tokens || 0) - stake);
          if (typeof save === 'function') save();
          if (typeof updateUI === 'function') updateUI();
        }
        document.getElementById('pvp-duel-result-title').textContent = 'YOU LOSE';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-pink';
        document.getElementById('pvp-duel-result-detail').textContent = winName + ' won. You lost ' + stake + ' tokens.';
      } else {
        document.getElementById('pvp-duel-result-title').textContent = 'DRAW';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 text-gray-400';
        document.getElementById('pvp-duel-result-detail').textContent = 'Tie! No token transfer.';
      }
      var rematchCountEl = document.getElementById('pvp-duel-rematch-countdown');
      var rematchBtn = document.getElementById('pvp-duel-rematch-btn');
      var roomId = pvpDuelRoomId;
      var rematchUntil = room.rematch_until ? new Date(room.rematch_until).getTime() : 0;
      if (roomId && rematchUntil > Date.now() && window.supabaseClient) {
        rematchCountEl.classList.remove('hidden');
        function updateRematchCountdown() {
          var left = Math.max(0, Math.ceil((rematchUntil - Date.now()) / 1000));
          rematchCountEl.textContent = left > 0 ? 'Rematch ‚Äî ' + left + 's (same stake, no extra cost)' : 'Room closed. No rematch in time.';
          if (left <= 0) {
            if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
            if (rematchBtn) rematchBtn.disabled = true;
            if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
          }
        }
        updateRematchCountdown();
        pvpRematchCountdownId = setInterval(updateRematchCountdown, 1000);
        var channel = window.supabaseClient.channel('rematch-' + roomId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, function(payload) {
          var r = payload.new;
          if (r && r.status === 'in_progress' && r.game_ends_at && new Date(r.game_ends_at).getTime() > Date.now()) {
            if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
            if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
            enterDuel(roomId);
          }
        }).subscribe();
        pvpRematchChannelUnsub = function() { window.supabaseClient.removeChannel(channel); };
      } else {
        rematchCountEl.classList.add('hidden');
      }
      if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
    }
    function upsertLeaderboardWin(wallet, name, tokensWon) {
      var supabase = window.supabaseClient;
      if (!supabase || !wallet || String(wallet).trim() === '') return;
      var w = String(wallet).trim();
      var n = (name && String(name).trim()) || 'Player';
      // Strip hash suffixes from names (e.g. "T~Baby#29f7c2aa" -> "T~Baby")
      n = n.replace(/#[a-f0-9]{8}$/i, '');
      var addTokens = (tokensWon != null && !isNaN(tokensWon)) ? Math.max(0, parseInt(tokensWon, 10)) : 0;
      var isGuest = w.indexOf('guest_') === 0;
      // Look up by wallet_address OR player_id, use limit(1) to avoid maybeSingle failure on duplicates
      var query = isGuest
        ? supabase.from('leaderboard').select('id, pvp_wins, pvp_tokens_won, name').or('wallet_address.eq.' + w + ',player_id.eq.' + w).limit(1)
        : supabase.from('leaderboard').select('id, pvp_wins, pvp_tokens_won, name').eq('wallet_address', w).limit(1);
      query.then(function(r) {
        if (r.error) { console.warn('Leaderboard select for win failed:', r.error); return; }
        var row = r.data && r.data.length > 0 ? r.data[0] : null;
        var wins = (row && (row.pvp_wins != null ? Number(row.pvp_wins) : 0)) || 0;
        var newWins = Math.max(0, wins) + 1;
        var prevTokens = (row && row.pvp_tokens_won != null) ? Math.max(0, Number(row.pvp_tokens_won)) : 0;
        var newTokens = prevTokens + addTokens;
        if (row) {
          supabase.from('leaderboard').update({ pvp_wins: newWins, pvp_tokens_won: newTokens, name: n || row.name, updated_at: new Date().toISOString() }).eq('id', row.id).then(function(u) {
            if (u.error) console.warn('Leaderboard win update failed:', u.error);
            if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
          });
        } else {
          var insertData = { name: n, tokens: 0, pvp_wins: 1, pvp_tokens_won: addTokens, ref_code: localStorage.getItem('tokenClicker_refCode') || null };
          if (isGuest) { insertData.player_id = w; insertData.wallet_address = w; }
          else { insertData.wallet_address = w; }
          supabase.from('leaderboard').insert(insertData).then(function(u) {
            if (u.error) console.warn('Leaderboard win insert failed:', u.error);
            if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
          });
        }
      });
    }
    document.getElementById('pvp-duel-click-btn') && document.getElementById('pvp-duel-click-btn').addEventListener('click', function(e) {
      var clickBtn = document.getElementById('pvp-duel-click-btn');
      if (clickBtn) {
        clickBtn.classList.remove('pvp-duel-tap-pulse');
        clickBtn.offsetHeight;
        clickBtn.classList.add('pvp-duel-tap-pulse');
        setTimeout(function() { if (clickBtn) clickBtn.classList.remove('pvp-duel-tap-pulse'); }, 120);
        var rect = clickBtn.getBoundingClientRect();
        var cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
        if (localStorage.getItem('tokenClicker_featherEffects') !== '0') {
          spawnFeathersAt(cx, cy);
        }
        var floatEl = document.createElement('div');
        floatEl.className = 'tap-value-float';
        floatEl.textContent = '+1';
        floatEl.style.left = cx + 'px';
        floatEl.style.top = cy + 'px';
        document.body.appendChild(floatEl);
        setTimeout(function() { if (floatEl.parentNode) floatEl.remove(); }, 800);
      }
      if (pvpVsBotMode) {
        var now = Date.now();
        if (now - pvpDuelLastClickAt < PVP_CLICK_COOLDOWN_MS) return;
        pvpDuelLastClickAt = now;
        pvpMyClicksVsBot += 1;
        var el = document.getElementById('pvp-duel-you-clicks');
        if (el) el.textContent = String(pvpMyClicksVsBot);
        return;
      }
      if (!pvpDuelRoomId || !pvpDuelMyRole) return;
      var now = Date.now();
      if (now - pvpDuelLastClickAt < PVP_CLICK_COOLDOWN_MS) return;
      pvpDuelLastClickAt = now;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.rpc('increment_pvp_clicks', { room_id: pvpDuelRoomId, player_num: pvpDuelMyRole }).then(function(r) {
        if (r.data && r.data.clicks != null) document.getElementById('pvp-duel-you-clicks').textContent = String(r.data.clicks);
      });
    });
    document.getElementById('pvp-duel-ready-btn') && document.getElementById('pvp-duel-ready-btn').addEventListener('click', function() {
      if (pvpVsBotMode || !pvpDuelRoomId || !pvpDuelMyRole) return;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      var col = pvpDuelMyRole === 1 ? 'player1_ready' : 'player2_ready';
      supabase.from('rooms').update({ [col]: true, updated_at: new Date().toISOString() }).eq('id', pvpDuelRoomId).then(function() {
        if (typeof updatePvpReadyUI === 'function') {
          var r = { player1_ready: pvpDuelMyRole === 1, player2_ready: pvpDuelMyRole === 2 };
          updatePvpReadyUI(r);
        }
      });
    });
    document.getElementById('pvp-duel-end-game-btn') && document.getElementById('pvp-duel-end-game-btn').addEventListener('click', function() {
      endDuelEarly();
    });
    document.getElementById('pvp-duel-copy-link-btn') && document.getElementById('pvp-duel-copy-link-btn').addEventListener('click', function() {
      var linkEl = document.getElementById('pvp-duel-room-link');
      var url = linkEl ? linkEl.textContent.trim() : '';
      if (!url) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() {
          var btn = document.getElementById('pvp-duel-copy-link-btn');
          if (btn) { btn.textContent = 'COPIED!'; setTimeout(function() { btn.textContent = 'COPY'; }, 1500); }
        }).catch(function() {});
      } else {
        try { var ta = document.createElement('textarea'); ta.value = url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); } catch (e) {}
      }
    });
    document.getElementById('pvp-duel-customize-boosts-btn') && document.getElementById('pvp-duel-customize-boosts-btn').addEventListener('click', function() {
      if (typeof openCustomizeBuffsModal === 'function') openCustomizeBuffsModal();
    });
    document.getElementById('pvp-duel-rematch-btn') && document.getElementById('pvp-duel-rematch-btn').addEventListener('click', function() {
      if (pvpLastWasVsBot) {
        showDuelLobby();
        startVsComputer();
        return;
      }
      if (!pvpDuelRoomId || !pvpDuelMyRole) { showDuelLobby(); if (typeof loadPvpRooms === 'function') loadPvpRooms(); return; }
      var supabase = window.supabaseClient;
      if (!supabase) { showDuelLobby(); if (typeof loadPvpRooms === 'function') loadPvpRooms(); return; }
      var rematchBtn = document.getElementById('pvp-duel-rematch-btn');
      var rematchHint = document.getElementById('pvp-duel-rematch-hint');
      var errMsg = 'Rematch needs DB columns. In Supabase SQL Editor run: supabase/migrations/006_rooms_rematch.sql';
      var me = getPvpPlayerId();
      var col = pvpDuelMyRole === 1 ? 'player1_wants_rematch' : 'player2_wants_rematch';
      supabase.from('rooms').update({ [col]: true, updated_at: new Date().toISOString() }).eq('id', pvpDuelRoomId).then(function(u) {
        if (u.error) {
          var m = (u.error.message || '').toLowerCase();
          if (m.indexOf('wants_rematch') >= 0 || m.indexOf('rematch') >= 0 || m.indexOf('schema') >= 0) { if (rematchHint) { rematchHint.textContent = errMsg; rematchHint.classList.remove('hidden'); rematchHint.classList.add('text-neon-pink'); } }
          return;
        }
        supabase.from('rooms').select('player1_wants_rematch, player2_wants_rematch, rematch_until').eq('id', pvpDuelRoomId).single().then(function(r) {
          if (r.error) {
            var m = (r.error.message || '').toLowerCase();
            if (m.indexOf('wants_rematch') >= 0 || m.indexOf('rematch') >= 0 || m.indexOf('schema') >= 0) { if (rematchHint) { rematchHint.textContent = errMsg; rematchHint.classList.remove('hidden'); rematchHint.classList.add('text-neon-pink'); } }
            return;
          }
          var room = r.data;
          if (!room) return;
          var until = room.rematch_until ? new Date(room.rematch_until).getTime() : 0;
          if (until <= Date.now()) return;
          if (room.player1_wants_rematch && room.player2_wants_rematch) {
            var now = new Date();
            var totalSec = (typeof PVP_COUNTDOWN_SEC !== 'undefined' ? PVP_COUNTDOWN_SEC : 3) + (typeof PVP_GAME_DURATION_SEC !== 'undefined' ? PVP_GAME_DURATION_SEC : 30);
            var endsAt = new Date(now.getTime() + totalSec * 1000);
            supabase.from('rooms').update({
              status: 'in_progress',
              winner_wallet: null,
              player1_clicks: 0,
              player2_clicks: 0,
              player1_ready: false,
              player2_ready: false,
              game_started_at: now.toISOString(),
              game_ends_at: endsAt.toISOString(),
              player1_wants_rematch: false,
              player2_wants_rematch: false,
              rematch_until: null,
              updated_at: now.toISOString()
            }).eq('id', pvpDuelRoomId).then(function(u2) {
              if (u2.error) return;
              enterDuel(pvpDuelRoomId);
            });
          }
        });
      }).catch(function() { if (rematchHint) { rematchHint.textContent = 'Rematch failed. Try again or run migration 006.'; rematchHint.classList.remove('hidden'); rematchHint.classList.add('text-neon-pink'); } });
    });
    document.getElementById('pvp-duel-lobby-btn') && document.getElementById('pvp-duel-lobby-btn').addEventListener('click', function() {
      showDuelLobby();
      if (typeof loadPvpRooms === 'function') loadPvpRooms();
    });

    // Creator: when player2 joins, start game (set game_ends_at) and enter duel
    function checkMyRoomStarted(roomId) {
      var me = getPvpPlayerId();
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status !== 'in_progress' || room.player1_wallet !== me) return;
        if (!room.game_ends_at) {
          var now = new Date();
          var totalSec = PVP_COUNTDOWN_SEC + PVP_GAME_DURATION_SEC;
          var endsAt = new Date(now.getTime() + totalSec * 1000);
          supabase.from('rooms').update({ game_started_at: now.toISOString(), game_ends_at: endsAt.toISOString(), updated_at: now.toISOString() }).eq('id', roomId).then(function() { enterDuel(roomId); });
        } else {
          enterDuel(roomId);
        }
      });
    }
    window.enterDuel = enterDuel;
    window.checkMyRoomStarted = checkMyRoomStarted;
    window.startVsComputer = startVsComputer;
    var pvpCreateBtn = document.getElementById('pvp-create-room-btn');
    var pvpRefreshBtn = document.getElementById('pvp-refresh-btn');
    if (pvpCreateBtn) pvpCreateBtn.addEventListener('click', createPvpRoom);
    if (pvpRefreshBtn) pvpRefreshBtn.addEventListener('click', function() { loadPvpRooms(); });
    document.getElementById('pvp-open-create-room-btn') && document.getElementById('pvp-open-create-room-btn').addEventListener('click', function() { openPvpCreateRoomModal(null); });
    document.getElementById('pvp-player-row-duel-btn') && document.getElementById('pvp-player-row-duel-btn').addEventListener('click', function() {
      var row = document.getElementById('pvp-player-row-above-create');
      var friendName = row && row.getAttribute('data-friend-name');
      openPvpCreateRoomModal(friendName || null);
    });
    document.getElementById('pvp-player-row-favorite-btn') && document.getElementById('pvp-player-row-favorite-btn').addEventListener('click', function() {
      var row = document.getElementById('pvp-player-row-above-create');
      var ref = row && row.getAttribute('data-friend-ref');
      if (!ref || typeof toggleFavoriteFriendRef !== 'function') return;
      toggleFavoriteFriendRef(ref);
      if (typeof updatePvpPlayerRowAboveCreate === 'function') updatePvpPlayerRowAboveCreate();
    });
    document.getElementById('pvp-player-row-remove-btn') && document.getElementById('pvp-player-row-remove-btn').addEventListener('click', function() {
      var row = document.getElementById('pvp-player-row-above-create');
      var ref = row && row.getAttribute('data-friend-ref');
      var name = row && row.getAttribute('data-friend-name') || 'this friend';
      if (!ref || !confirm('Remove ' + name + ' from friends?')) return;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!me || !window.supabaseClient) return;
      window.supabaseClient.from('friends_by_code').delete().eq('user_wallet', me).eq('friend_ref_code', ref).then(function(res) {
        if (res.error) { console.error('Remove friend failed:', res.error); return; }
        if (typeof removeFromFriendTokenCache === 'function') removeFromFriendTokenCache(null, ref);
        if (typeof updatePvpPlayerRowAboveCreate === 'function') updatePvpPlayerRowAboveCreate();
      });
    });
    document.getElementById('pvp-create-room-modal-close') && document.getElementById('pvp-create-room-modal-close').addEventListener('click', closePvpCreateRoomModal);
    document.getElementById('pvp-create-room-modal-cancel') && document.getElementById('pvp-create-room-modal-cancel').addEventListener('click', closePvpCreateRoomModal);
    document.getElementById('pvp-create-room-modal') && document.getElementById('pvp-create-room-modal').addEventListener('click', function(e) { if (e.target && e.target.id === 'pvp-create-room-modal') closePvpCreateRoomModal(); });
    document.querySelectorAll('.pvp-stake-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.pvp-stake-btn').forEach(function(b) {
          b.classList.remove('border-neon-green', 'text-neon-green', 'bg-neon-green/10');
          b.classList.add('border-gray-600', 'text-gray-400');
        });
        this.classList.add('border-neon-green', 'text-neon-green', 'bg-neon-green/10');
        this.classList.remove('border-gray-600', 'text-gray-400');
        var custom = document.getElementById('pvp-custom-stake');
        if (custom) custom.value = '';
        if (typeof updatePvpCreateRoomButtonState === 'function') updatePvpCreateRoomButtonState();
      });
    });
    var pvpCustomStakeEl = document.getElementById('pvp-custom-stake');
    if (pvpCustomStakeEl) {
      pvpCustomStakeEl.addEventListener('input', function() { if (typeof updatePvpCreateRoomButtonState === 'function') updatePvpCreateRoomButtonState(); });
      pvpCustomStakeEl.addEventListener('change', function() { if (typeof updatePvpCreateRoomButtonState === 'function') updatePvpCreateRoomButtonState(); });
    }
    document.getElementById('pvp-vs-computer-btn') && document.getElementById('pvp-vs-computer-btn').addEventListener('click', function() {
      var name = getPlayerName();
      if (!name) {
        var n = prompt('Enter your name to play vs computer (practice):', 'Player');
        if (n && n.trim()) setPlayerName(n.trim().slice(0, 20));
      }
      startVsComputer();
    });
    document.getElementById('friends-play-vs-computer-btn') && document.getElementById('friends-play-vs-computer-btn').addEventListener('click', function() {
      var name = getPlayerName();
      if (!name) {
        var n = prompt('Enter your name to play vs computer (practice):', 'Player');
        if (n && n.trim()) setPlayerName(n.trim().slice(0, 20));
      }
      try { sessionStorage.setItem('tokenClicker_startVsComputer', '1'); } catch (e) {}
      window.location.hash = 'multiplayer';
      showPage('multiplayer');
      if (typeof window.startVsComputer === 'function') {
        try { sessionStorage.removeItem('tokenClicker_startVsComputer'); } catch (e) {}
        window.startVsComputer();
      }
    });
    function handleInvitedCardJoin() {
      var roomId = window._pvpInvitedRoomId || (typeof URLSearchParams !== 'undefined' && new URLSearchParams(window.location.search).get('room'));
      if (roomId && typeof joinPvpRoom === 'function') { joinPvpRoom(roomId); window.location.hash = 'multiplayer'; if (typeof showPage === 'function') showPage('multiplayer'); }
    }
    document.getElementById('pvp-invited-join-btn') && document.getElementById('pvp-invited-join-btn').addEventListener('click', function(ev) { ev.preventDefault(); ev.stopPropagation(); handleInvitedCardJoin(); });
    document.getElementById('pvp-invited-card') && document.getElementById('pvp-invited-card').addEventListener('click', function(ev) {
      if (ev.target && ev.target.closest && ev.target.closest('#pvp-invited-join-btn')) return;
      handleInvitedCardJoin();
    });
    document.getElementById('pvp-invited-card') && document.getElementById('pvp-invited-card').addEventListener('keydown', function(ev) {
      if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); handleInvitedCardJoin(); }
    });
    document.addEventListener('click', function(ev) {
      if (ev.target && ev.target.closest && ev.target.closest('.pvp-invite-banner-join-btn')) {
        var roomId = typeof getPvpInvitedRoomId === 'function' ? getPvpInvitedRoomId() : null;
        if (roomId) { window.location.hash = 'multiplayer'; showPage('multiplayer'); if (typeof joinPvpRoom === 'function') joinPvpRoom(roomId); }
      }
    });
    window.loadPvpRooms = loadPvpRooms;
    setTimeout(function() { if (typeof ensureLeaderboardRow === 'function') ensureLeaderboardRow(); }, 2000);

    document.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });
    setInterval(updateClicksPerSecond, 200);
    setInterval(function() { updateBuffState(); if (typeof updateUI === 'function') updateUI(); }, 1000);
    setInterval(function() {
      if (isDead) return;
      var now = Date.now();
      var elapsed = Math.min(500, now - lastPowerUpdateAt);
      lastPowerUpdateAt = now;
      var max = getPowerMax();
      var overcapMax = hasOvercharge() ? max + 100 : max;
      if (power < max) {
        power = Math.min(max, power + powerRegenPerMs() * elapsed);
      } else if (power > max && hasOvercharge()) {
        var over = power - max;
        power = Math.max(max, power - over * 0.2 * (elapsed / 1000));
      }
      if (power > overcapMax) power = overcapMax;
      updatePowerBar();
    }, 50);
    (function() {
      var lastFrenzy = false;
      setInterval(function() {
        var now = Date.now();
        var frenzyOn = buffFrenzyUntil > now;
        if (lastFrenzy && !frenzyOn && buffFrenzyUntil > 0) {
          buffFrenzyCooldownUntil = now + BUFF_FRENZY_COOLDOWN_MS;
          if (typeof restartAutoclicker === 'function') restartAutoclicker();
        }
        lastFrenzy = frenzyOn;
      }, 500);
    })();

    // Routing
    function getPageFromHash() {
      const raw = (window.location.hash || '#home').slice(1);
      const path = raw.split('?')[0].toLowerCase();
      return path === '' ? 'home' : path;
    }
    function getSendToFromHash() {
      var raw = (window.location.hash || '').slice(1);
      if (raw.indexOf('?') < 0) return null;
      var qs = raw.split('?')[1] || '';
      var m = qs.match(/sendTo=([^&]+)/i);
      return m ? decodeURIComponent(m[1].replace(/\+/g, ' ')) : null;
    }
    function getPvpInvitedRoomId() {
      return window._pvpInvitedRoomId || (typeof URLSearchParams !== 'undefined' && new URLSearchParams(window.location.search).get('room')) || (function() { try { return sessionStorage.getItem('tokenClicker_pvpInvitedRoom'); } catch (e) { return null; } })() || null;
    }
    function checkActiveDuelInvite(roomId) {
      var supabase = window.supabaseClient;
      if (!supabase || !roomId) return Promise.resolve(false);
      var testInvite = typeof URLSearchParams !== 'undefined' && new URLSearchParams(window.location.search).get('test_invite') === '1';
      return supabase.from('rooms').select('status, player1_wallet, player2_wallet').eq('id', roomId).single()
        .then(function(r) {
          if (r.error || !r.data) return false;
          var room = r.data;
          if (room.status !== 'open') return false;
          if (!testInvite) {
            var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : '';
            if (room.player1_wallet === me || room.player2_wallet === me) return false;
          }
          return true;
        })
        .catch(function() { return false; });
    }
    var pvpBannerRefreshId = null;
    function updatePvpInviteBanner() {
      var roomId = getPvpInvitedRoomId();
      var banners = document.querySelectorAll('.pvp-invite-banner-inline');
      var pageId = getPageFromHash();
      var invitedCard = document.getElementById('pvp-invited-card');
      function hideBanners() {
        banners.forEach(function(b) { b.classList.add('hidden'); });
      }
      if (!roomId) {
        if (pvpBannerRefreshId) { clearInterval(pvpBannerRefreshId); pvpBannerRefreshId = null; }
        window._pvpInvitedRoomId = null;
        try { sessionStorage.removeItem('tokenClicker_pvpInvitedRoom'); } catch (e) {}
        hideBanners();
        if (invitedCard) invitedCard.classList.add('hidden');
        return;
      }
      window._pvpInvitedRoomId = roomId;
      if (!pvpBannerRefreshId) {
        pvpBannerRefreshId = setInterval(function() { if (getPvpInvitedRoomId()) updatePvpInviteBanner(); }, 30000);
      }
      checkActiveDuelInvite(roomId).then(function(isActive) {
        if (!isActive) {
          if (pvpBannerRefreshId) { clearInterval(pvpBannerRefreshId); pvpBannerRefreshId = null; }
          if (typeof clearPvpInvitedRoom === 'function') clearPvpInvitedRoom();
          hideBanners();
          if (invitedCard) invitedCard.classList.add('hidden');
          return;
        }
        if (pageId === 'boosts' || pageId === 'bounties' || pageId === 'wallet') {
          banners.forEach(function(b) {
            var section = b.closest('section');
            var show = section && section.id === 'page-' + pageId;
            b.classList.toggle('hidden', !show);
          });
        } else {
          hideBanners();
        }
        if (invitedCard) {
          if (pageId === 'multiplayer') {
            invitedCard.classList.remove('hidden');
            var roomIdEl = document.getElementById('pvp-invited-room-id');
            if (roomIdEl) roomIdEl.textContent = 'Room: ' + roomId.slice(0, 8) + '‚Ä¶';
          } else {
            invitedCard.classList.add('hidden');
          }
        }
      }).catch(function() { hideBanners(); if (invitedCard) invitedCard.classList.add('hidden'); });
    }
    function clearPvpInvitedRoom() {
      window._pvpInvitedRoomId = null;
      try { sessionStorage.removeItem('tokenClicker_pvpInvitedRoom'); } catch (e) {}
      updatePvpInviteBanner();
      var invitedCard = document.getElementById('pvp-invited-card');
      if (invitedCard) invitedCard.classList.add('hidden');
    }
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById('page-' + pageId);
      if (el) el.classList.add('active');
      window.scrollTo(0, 0);
      updatePvpInviteBanner();
      if (pageId === 'home' && typeof updateUI === 'function') updateUI();
      if (pageId === 'multiplayer') {
        if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
      }
      document.querySelectorAll('.nav-link').forEach(a => {
        a.classList.toggle('text-neon-cyan', a.getAttribute('data-page') === pageId);
        a.classList.toggle('text-gray-400', a.getAttribute('data-page') !== pageId);
      });
      if (pageId === 'wallet') {
        if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
        if (typeof fetchTonPrice === 'function') fetchTonPrice();
        if (typeof ensureLeaderboardRow === 'function') ensureLeaderboardRow();
        var sendTo = getSendToFromHash();
        if (sendTo && typeof showWalletTab === 'function') {
          showWalletTab('send');
          var inp = document.getElementById('send-to-address');
          if (inp) inp.value = sendTo;
        }
      }
      if (pageId === 'multiplayer') {
        if (typeof updatePvpPlayerRowAboveCreate === 'function') updatePvpPlayerRowAboveCreate();
        var balEl = document.getElementById('pvp-create-balance');
        if (balEl && typeof getInGameTokenBalance === 'function') balEl.textContent = getInGameTokenBalance();
        if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
        if (typeof window.loadPvpRooms === 'function') window.loadPvpRooms();
        try {
          if (sessionStorage.getItem('tokenClicker_startVsComputer') === '1') {
            sessionStorage.removeItem('tokenClicker_startVsComputer');
            setTimeout(function() { if (typeof window.startVsComputer === 'function') window.startVsComputer(); }, 100);
          }
        } catch (e) {}
      }
    }
    window.addEventListener('hashchange', () => showPage(getPageFromHash()));

    // Visibility change: save state when hidden, refresh on return
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        if (typeof save === 'function') save();
      } else {
        checkDeath();
        if (typeof updateUI === 'function') updateUI();
        if (typeof updateBountiesUI === 'function') updateBountiesUI();
      }
    });

    // Onboarding: multi-step intro for new users
    const app = document.getElementById('app');
    const ONBOARDING_STEPS = [
      { icon: 'üê¶', title: 'WELCOME TO 1N TOKEN CLICKER', desc: 'Tap the Cardinal to earn tokens. Every 10 taps = 1 token. Build the community one tap at a time!' },
      { icon: '‚ö°', title: 'BOOSTS', desc: 'Spend tokens on Power (2x), Autoclicker, and faster cooldown. Earn more tokens faster!' },
      { icon: 'üéØ', title: 'BOUNTIES', desc: 'Claim daily rewards, weekly challenges, and tap milestones. Free tokens for completing goals!' },
      { icon: 'üèÜ', title: 'PVP DUELS', desc: 'Challenge friends in 30-second click races. Stake tokens ‚Äî winner takes all!' },
      { icon: 'üëõ', title: 'WALLET', desc: 'Connect Tonkeeper to swap $CARD for tokens or withdraw tokens to on-chain $CARD.' }
    ];
    let onboardingStep = 0;
    function showOnboardingStep(step) {
      onboardingStep = step;
      var container = document.getElementById('onboarding-step');
      var backBtn = document.getElementById('onboarding-back');
      var nextBtn = document.getElementById('onboarding-next');
      if (!container || !backBtn || !nextBtn) return;
      var s = ONBOARDING_STEPS[step];
      container.innerHTML = '<div class="text-4xl mb-4">' + s.icon + '</div><p class="text-neon-cyan text-[10px] font-bold mb-2">' + s.title + '</p><p class="text-gray-300 text-[9px] leading-relaxed">' + s.desc + '</p>';
      backBtn.classList.toggle('hidden', step === 0);
      nextBtn.textContent = step === 4 ? "LET'S PLAY!" : 'NEXT';
      document.querySelectorAll('.onboarding-dot').forEach(function(dot, i) {
        dot.classList.toggle('bg-neon-cyan', i === step);
        dot.classList.toggle('bg-gray-600', i !== step);
      });
    }
    function finishOnboarding() {
      try { localStorage.setItem('tokenClicker_onboardingCompleted', '1'); } catch (e) {}
      var overlay = document.getElementById('onboarding-overlay');
      if (overlay) { overlay.classList.add('hidden'); overlay.style.display = 'none'; }
      if (app) app.classList.remove('hidden');
      updateBountyProgress();
      save();
      showPage(getPageFromHash());
      updateUI();
      var playerName = typeof getPlayerName === 'function' ? getPlayerName() : null;
      if (!playerName) {
        var welcomeModal = document.getElementById('welcome-name-modal');
        var welcomeText = welcomeModal && welcomeModal.querySelector('.text-gray-300');
        var invitedBy = localStorage.getItem('tokenClicker_invitedBy');
        if (welcomeText) welcomeText.textContent = invitedBy ? 'You were invited! Enter your display name to accept and join. You can change it later in Wallet ‚Üí Settings.' : 'Enter your display name once. You can change it later in Wallet ‚Üí Settings.';
        if (welcomeModal) { welcomeModal.classList.remove('hidden'); welcomeModal.style.display = 'flex'; }
      } else if (localStorage.getItem('tokenClicker_invitedBy') && typeof registerReferralIfNeeded === 'function') {
        registerReferralIfNeeded(playerName);
      }
    }
    document.getElementById('onboarding-next') && document.getElementById('onboarding-next').addEventListener('click', function() {
      if (onboardingStep >= 4) finishOnboarding();
      else { showOnboardingStep(onboardingStep + 1); }
    });
    document.getElementById('onboarding-back') && document.getElementById('onboarding-back').addEventListener('click', function() {
      if (onboardingStep > 0) showOnboardingStep(onboardingStep - 1);
    });
    document.getElementById('onboarding-skip') && document.getElementById('onboarding-skip').addEventListener('click', finishOnboarding);

    function createStars() {
      const layer = document.getElementById('stars-layer');
      if (!layer) return;
      for (let i = 0; i < 45; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDuration = (4 + Math.random() * 6) + 's';
        star.style.animationDelay = Math.random() * 8 + 's';
        layer.appendChild(star);
      }
    }

    window.addEventListener('load', () => {
      createStars();
      checkDeath();
      setInterval(checkDeath, 300000); // Re-check death every 5 minutes
      updateBuffState();
      updateBountyProgress();
      save();
      var params = new URLSearchParams(window.location.search);
      var refParam = params.get('ref') || (window.location.hash ? new URLSearchParams(window.location.hash.slice(1)).get('ref') : null);
      if (!refParam && window.location.hash) {
        var m = window.location.hash.match(/[?&]ref=([^&]+)/);
        if (m) refParam = m[1];
      }
      if (!refParam && window.location.href) {
        var hrefMatch = window.location.href.match(/[?&]ref=([^&?#]+)/);
        if (hrefMatch) refParam = decodeURIComponent(hrefMatch[1]);
      }
      if (refParam) localStorage.setItem('tokenClicker_invitedBy', (refParam + '').trim().toUpperCase());
      if (params.get('room')) {
        window._pvpInvitedRoomId = params.get('room');
        try { sessionStorage.setItem('tokenClicker_pvpInvitedRoom', params.get('room')); } catch (e) {}
      }
      updatePvpInviteBanner();
      showPage(getPageFromHash());
      updateUI();
      if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      if (typeof loadFriendRequests === 'function') loadFriendRequests();
      if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
      if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
      var invitedBy = localStorage.getItem('tokenClicker_invitedBy');
      var playerName = typeof getPlayerName === 'function' ? getPlayerName() : null;
      var onboardingDone = localStorage.getItem('tokenClicker_onboardingCompleted') === '1';
      if (onboardingDone) {
        if (invitedBy && playerName) {
          if (typeof registerReferralIfNeeded === 'function') registerReferralIfNeeded(playerName);
        } else if (invitedBy && !playerName) {
          var welcomeModal = document.getElementById('welcome-name-modal');
          var welcomeText = welcomeModal && welcomeModal.querySelector('.text-gray-300');
          if (welcomeText) welcomeText.textContent = 'You were invited! Enter your display name to accept and join. You can change it later in Wallet ‚Üí Settings.';
          if (welcomeModal) { welcomeModal.classList.remove('hidden'); welcomeModal.style.display = 'flex'; }
        }
      } else {
        var overlay = document.getElementById('onboarding-overlay');
        if (overlay) {
          overlay.classList.remove('hidden');
          overlay.style.display = 'flex';
          if (app) app.classList.add('hidden');
          showOnboardingStep(0);
        }
      }
    });
  </script>
</body>
</html>
