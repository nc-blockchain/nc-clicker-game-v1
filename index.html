<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fix GitHub Pages: base URL so scripts/assets load from repo root (e.g. /nc-clicker-game-v1/) -->
  <script>
    (function(){
      var path = location.pathname.replace(/\/?$/, '');
      var basePath = (path === '' ? '/' : path + '/');
      document.write('<base href="' + location.origin + basePath + '" />');
    })();
  </script>
  <title>1N Blockchain Token Clicker ‚Äì Tap to earn $CARD</title>
  <!-- Share preview: opens nicely on mobile when link is shared -->
  <meta property="og:title" content="1N Blockchain Token Clicker" />
  <meta property="og:description" content="Tap the Cardinal to earn tokens. Play on your phone ‚Äì connect wallet, claim $CARD, challenge friends in PVP." />
  <meta property="og:image" content="https://biggleem.github.io/nc-clicker-game-v1/assets/cardinal.png" />
  <meta property="og:url" content="https://biggleem.github.io/nc-clicker-game-v1/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="1N Blockchain Token Clicker" />
  <meta name="twitter:description" content="Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends." />
  <link rel="icon" href="assets/cardinal.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/cardinal.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#0a0a0a',
            neon: {
              cyan: '#00fff7',
              pink: '#ff00aa',
              green: '#00ff88',
              yellow: '#ffff00',
              purple: '#b366ff',
            },
            pixel: { border: '#333', panel: '#1a1a1a' }
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'monospace'],
          },
          boxShadow: {
            neon: '0 0 10px currentColor, 0 0 20px currentColor',
            'neon-sm': '0 0 5px currentColor',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    /* Bottom nav: hide scrollbar but keep scroll on small devices */
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .pixel-border { border: 3px solid #333; image-rendering: pixelated; }
    .neon-text-cyan { color: #00fff7; text-shadow: 0 0 10px #00fff7; }
    .neon-text-pink { color: #ff00aa; text-shadow: 0 0 10px #ff00aa; }
    .neon-text-green { color: #00ff88; text-shadow: 0 0 10px #00ff88; }
    .page { display: none; min-height: calc(100vh - 120px); }
    .page.active { display: block; }
    .nft-clicker { transition: transform 0.05s; box-shadow: 0 0 20px rgba(0,255,247,0.2), 0 0 40px rgba(255,0,170,0.1); }
    .nft-clicker:hover:not(.cooldown) { box-shadow: 0 0 25px rgba(0,255,247,0.35), 0 0 50px rgba(255,0,170,0.2); }
    .nft-clicker:active { transform: scale(0.97); }
    .nft-clicker.cooldown { opacity: 0.7; pointer-events: none; }
    .image-pixel { image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
    /* Loading / intro screen */
    .splash-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: #0a0a0a;
      background-image: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.3) 0%, rgba(120,20,40,0.12) 40%, transparent 70%);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .splash-card {
      background: #0a0a0a;
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      position: relative;
      border: 2px solid rgba(255,200,50,0.6);
      box-shadow: 0 0 30px rgba(255,180,0,0.4), 0 0 60px rgba(255,140,0,0.2), inset 0 0 0 1px rgba(255,220,100,0.2);
    }
    .splash-card::before {
      content: '';
      position: absolute;
      top: -2px; left: -2px; right: -2px; bottom: -2px;
      border-radius: 26px;
      background: linear-gradient(135deg, #FFD700, #FF8C00, #FFD700);
      z-index: -1;
      opacity: 0.4;
      filter: blur(8px);
    }
    .splash-title { color: #FFD700; font-size: 10px; margin-bottom: 16px; text-shadow: 0 0 12px rgba(255,215,0,0.8); line-height: 1.5; }
    .splash-cardinal { width: 160px; height: auto; margin: 16px auto; border-radius: 12px; image-rendering: pixelated; display: block; }
    .splash-text { color: rgba(255,255,255,0.9); font-size: 9px; line-height: 1.6; margin-bottom: 20px; }
    .splash-btn {
      background: linear-gradient(135deg, #FF8C00, #FFD700);
      color: #000;
      border: none;
      padding: 16px 32px;
      font-size: 10px;
      font-weight: 900;
      border-radius: 50px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      box-shadow: 0 8px 24px rgba(255,180,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .splash-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255,200,0,0.6); }
    .splash-btn:active { transform: translateY(0); }
    #app.hidden { display: none !important; }

    /* Red radial gradient background */
    body { position: relative; min-height: 100vh; }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.35) 0%, rgba(120,20,40,0.15) 40%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    #app { position: relative; z-index: 1; }

    /* Rising tiny stars */
    .stars-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .star {
      position: absolute;
      width: 2px; height: 2px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      animation: starRise linear infinite;
      box-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    @keyframes starRise {
      0% { transform: translateY(100vh) translateX(0) scale(1); opacity: 0; }
      8% { opacity: 0.8; }
      92% { opacity: 0.6; }
      100% { transform: translateY(-20px) translateX(0) scale(0.5); opacity: 0; }
    }

    /* Click effect: 8-bit feather */
    .feather-float {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      font-size: 14px;
      opacity: 1;
      animation: featherFloat 1.2s ease-out forwards;
    }
    .feather-float .feather-pixel {
      width: 8px; height: 12px;
      background: linear-gradient(135deg, #e63946, #ff6b6b);
      transform: rotate(var(--r, 0deg));
      border-radius: 1px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.3);
    }
    @keyframes featherFloat {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) translateX(0) rotate(360deg) scale(0.5); }
    }
    .feather-float.feather-drift-1 { animation: featherFloat1 1.2s ease-out forwards; }
    .feather-float.feather-drift-2 { animation: featherFloat2 1.2s ease-out forwards; }
    .feather-float.feather-drift-3 { animation: featherFloat3 1.2s ease-out forwards; }
    @keyframes featherFloat1 { 0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); } 100% { opacity: 0; transform: translateY(-80px) translateX(-25px) rotate(360deg) scale(0.5); } }
    @keyframes featherFloat2 { 0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); } 100% { opacity: 0; transform: translateY(-80px) translateX(25px) rotate(-300deg) scale(0.5); } }
    @keyframes featherFloat3 { 0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); } 100% { opacity: 0; transform: translateY(-90px) translateX(15px) rotate(280deg) scale(0.5); } }

    /* Click effect: +N token text */
    .tap-value-float {
      position: fixed;
      pointer-events: none;
      z-index: 101;
      font-size: 14px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 1px 2px rgba(0,0,0,0.8);
      animation: valueFloat 1s ease-out forwards;
      transform: translate(-50%, -50%);
    }
    @keyframes valueFloat {
      0% { opacity: 1; transform: translate(-50%, -50%) translateY(0) scale(1.2); }
      70% { opacity: 1; transform: translate(-50%, -50%) translateY(-50px) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) translateY(-70px) scale(0.9); }
    }
  </style>
</head>
<body class="bg-dark text-white font-pixel text-xs md:text-sm antialiased" style="background:#0a0a0a; color:#fff; margin:0; min-height:100vh;">
  <!-- Rising stars layer (behind app) -->
  <div class="stars-layer" id="stars-layer" aria-hidden="true"></div>

  <!-- Loading screen: cardinal + START TAPPING (shown only first visit per session) -->
  <div class="splash-screen hidden" id="splash" style="position:fixed; inset:0; z-index:9999; background:#0a0a0a; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div class="splash-card" style="background:#0a0a0a; border-radius:24px; padding:32px 24px; max-width:380px; width:100%; text-align:center; border:2px solid rgba(255,200,50,0.6);">
      <div class="splash-title" style="color:#FFD700; font-size:10px; margin-bottom:16px;">üî¥ 1N BLOCKCHAIN</div>
      <img src="assets/cardinal.png" alt="Cardinal" class="splash-cardinal image-pixel" style="width:160px; height:auto; margin:16px auto; display:block;" onerror="this.style.display='none'" />
      <p class="splash-text">Tap the Cardinal to earn tokens! Build the community one tap at a time!</p>
      <button type="button" class="splash-btn" id="splash-start">START TAPPING!</button>
    </div>
  </div>

  <!-- First-time only: set name when you first get the app (no name in storage) -->
  <div id="welcome-name-modal" class="hidden" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">WELCOME TO 1N TOKEN CLICKER</p>
      <p class="text-gray-300 text-[9px] mb-4">Enter your display name once. You can change it later in Friends ‚Üí Profile.</p>
      <input type="text" id="welcome-name-input" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <button type="button" id="welcome-name-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE</button>
    </div>
  </div>
  <!-- Profile: change name (opened from Friends) -->
  <div id="profile-name-modal" class="hidden" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">CHANGE DISPLAY NAME</p>
      <input type="text" id="profile-name-input" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <div class="flex gap-2 justify-center">
        <button type="button" id="profile-name-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE</button>
        <button type="button" id="profile-name-cancel" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CANCEL</button>
      </div>
    </div>
  </div>
  <div id="app" style="display:block;">
  <!-- Top Bar: 1N BLOCKCHAIN logo + tokens + PVP/bell -->
  <header class="sticky top-0 z-50 bg-black/90 border-b-2 border-pixel-border backdrop-blur-sm">
    <div class="max-w-lg mx-auto px-4 py-2 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <img src="assets/cardinal.png" alt="1N BLOCKCHAIN" class="h-8 md:h-9 object-contain object-left flex-shrink-0" />
        <span class="text-gray-400 shrink-0">TOKENS</span>
        <span id="top-tokens" class="neon-text-cyan font-bold shrink-0">0</span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <a href="#multiplayer" class="p-2 rounded border-2 border-neon-pink text-neon-pink hover:shadow-neon-sm text-[10px]">PVP</a>
        <button type="button" aria-label="Notifications" class="p-2 rounded border-2 border-gray-500 text-gray-400 hover:border-neon-yellow hover:text-neon-yellow">üîî</button>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto pb-20">
    <!-- Home -->
    <section id="page-home" class="page active p-4">
      <!-- Metric windows above NFT -->
      <div class="grid grid-cols-3 gap-2 mb-4">
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 text-[10px]">CLICKS/S</div>
          <div id="clicks-per-sec" class="neon-text-green">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 text-[10px]">TOTAL</div>
          <div id="total-clicks" class="neon-text-cyan">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 text-[10px]">RATE</div>
          <div id="token-rate" class="neon-text-yellow">1 / 10</div>
        </div>
      </div>
      <!-- NFT Clicker -->
      <div class="flex justify-center">
        <div class="relative inline-block">
          <button
            type="button"
            id="nft-clicker"
            class="nft-clicker w-40 h-40 md:w-52 md:h-52 pixel-border rounded-lg bg-black/80 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden"
            aria-label="Click to earn tokens"
          >
            <img src="assets/cardinal.png" alt="NFT Cardinal" class="w-full h-full object-contain image-pixel" />
          </button>
          <div class="absolute bottom-1 right-1 bg-black/80 px-2 py-1 rounded border border-gray-600">
            <span id="click-count-label">0</span> clicks
          </div>
        </div>
      </div>
      <p class="text-center text-gray-500 mt-4">Every 10 clicks = 1 token</p>
      <!-- Stats bar (match reference) -->
      <div class="mt-4 bg-pixel-panel border-2 border-gray-700 rounded px-3 py-2 text-[10px] flex flex-wrap justify-center gap-x-4 gap-y-1">
        <span>Taps: <span id="home-taps" class="text-neon-yellow">0</span></span>
        <span>Tap Power: <span id="home-power" class="text-neon-yellow">1</span>x</span>
        <span>Multiplier: <span id="home-mult" class="text-neon-yellow">1.0</span>x</span>
        <span>Regen: <span id="home-regen" class="text-neon-yellow">1</span>/s</span>
      </div>
      <!-- Badges -->
      <div class="mt-4 text-center">
        <div class="text-gray-500 text-[10px] mb-2">üèÜ BADGES</div>
        <div class="flex justify-center gap-2 flex-wrap">
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel" id="badge-1" title="First Click">üëÜ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-2" title="7-Day Streak">üî•</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-3" title="30-Day Streak">üíé</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-4" title="1K Clicks">üéØ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-5" title="10K Clicks">üöÄ</div>
        </div>
      </div>
      <!-- Upgrade strip (match reference) -->
      <div class="mt-4 grid grid-cols-3 gap-2">
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-cyan/50 transition-colors">
          <div class="text-neon-yellow text-base mb-1">‚ö°</div>
          <div class="text-[10px]">Power</div>
          <div class="text-gray-500 text-[10px]">Cost: 50</div>
        </a>
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-green/50 transition-colors">
          <div class="text-neon-green text-base mb-1">üîã</div>
          <div class="text-[10px]">Autoclick</div>
          <div class="text-gray-500 text-[10px]">Cost: 100</div>
        </a>
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-cyan/50 transition-colors">
          <div class="text-neon-cyan text-base mb-1">‚ôªÔ∏è</div>
          <div class="text-[10px]">Regen</div>
          <div class="text-gray-500 text-[10px]">Cost: 75</div>
        </a>
      </div>
    </section>

    <!-- Boosts -->
    <section id="page-boosts" class="page p-4">
      <h2 class="text-neon-cyan mb-4 border-b-2 border-gray-700 pb-2">BOOSTS</h2>
      <p class="text-gray-400 mb-4">Spend tokens on click buffs, autoclickers, and cooldown reductions.</p>
      <div class="space-y-3">
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <span>+1 token per 10 clicks (2x)</span>
          <span class="text-neon-yellow">50 tokens</span>
          <button type="button" id="buy-tappower" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="50" data-boost="tapPower">BUY</button>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <span>Autoclicker (1/s)</span>
          <span class="text-neon-yellow">100 tokens</span>
          <button type="button" id="buy-autoclicker" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="100" data-boost="autoclicker">BUY</button>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <span>Shorter cooldown (200ms)</span>
          <span class="text-neon-yellow">75 tokens</span>
          <button type="button" id="buy-cooldown" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="75" data-boost="cooldown">BUY</button>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Your balance: <span id="boosts-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Bounties -->
    <section id="page-bounties" class="page p-4">
      <h2 class="text-neon-green mb-4 border-b-2 border-gray-700 pb-2">BOUNTIES</h2>
      <p class="text-gray-400 mb-4">Daily rewards, weekly challenges, click milestones.</p>
      <div class="space-y-3">
        <div id="bounty-daily" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <div>
            <div>Daily login</div>
            <div class="text-neon-yellow text-[10px]">Claim: 5 tokens</div>
          </div>
          <button type="button" id="claim-daily" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="daily" data-reward="5">CLAIM</button>
        </div>
        <div id="bounty-100" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <div>
            <div>100 clicks today</div>
            <div class="text-[10px]">Progress: <span id="bounty-100-progress">0</span>/100 ¬∑ Reward: 10 tokens</div>
          </div>
          <button type="button" id="claim-100" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="100today" data-reward="10">CLAIM</button>
        </div>
        <div id="bounty-weekly" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <div>
            <div>Weekly: 500 clicks</div>
            <div class="text-[10px]">Progress: <span id="bounty-weekly-progress">0</span>/500 ¬∑ Reward: 50 tokens</div>
          </div>
          <button type="button" id="claim-weekly" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="weekly" data-reward="50">CLAIM</button>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Balance: <span id="bounties-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Friends -->
    <section id="page-friends" class="page p-4">
      <h2 class="text-neon-pink mb-4 border-b-2 border-gray-700 pb-2">FRIENDS</h2>
      <p class="text-gray-400 mb-4">Leaderboard & invite friends. Names stay persistent when you connect your wallet.</p>
      <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">PROFILE</div>
        <p class="text-[10px] text-gray-300 mb-2">Your name: <span id="profile-display-name" class="neon-text-cyan">‚Äî</span></p>
        <button type="button" id="profile-change-name-btn" class="py-1 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10">CHANGE NAME</button>
      </div>
      <div class="bg-pixel-panel border-2 border-neon-pink/30 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">FRIENDS (INVITED)</div>
        <p class="text-gray-500 text-[9px] mb-1">People who used your invite link appear here.</p>
        <ol id="friends-invited-list" class="space-y-1 text-[10px] min-h-[24px]">
          <li class="text-gray-500">Loading‚Ä¶</li>
        </ol>
      </div>
      <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">TOP CLICKERS (by tokens)</div>
        <ol id="leaderboard-list" class="space-y-1 text-[10px]">
          <li>1. Alpha ‚Äî 500 tokens</li>
          <li>2. Beta ‚Äî 300 tokens</li>
          <li>3. You ‚Äî 0 tokens</li>
        </ol>
      </div>
      <button type="button" id="invite-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 min-h-[44px] text-[10px]">COPY INVITE LINK</button>
      <p id="invite-feedback" class="text-neon-green text-[10px] mt-2 hidden">Link copied! Send it to friends ‚Äì when they open it on their phone, the game loads and your code is applied.</p>
      <p class="text-gray-500 mt-2 text-[10px]">Your code: <span id="referral-code" class="neon-text-cyan">------</span></p>
      <div class="mt-3 pt-3 border-t border-gray-700">
        <div class="text-[10px] text-gray-500 mb-2">PVP DUEL WINS</div>
        <ol id="leaderboard-pvp-list" class="space-y-1 text-[10px]">
          <!-- Filled from Supabase leaderboard (pvp_wins) -->
        </ol>
      </div>
    </section>

    <!-- Wallet -->
    <section id="page-wallet" class="page p-4">
      <h2 class="text-neon-yellow mb-4 border-b-2 border-gray-700 pb-2">WALLET</h2>
      <!-- Balance summary: in-game + wallet $CARD -->
      <div class="bg-pixel-panel border-2 border-neon-cyan/30 p-4 rounded mb-4">
        <div class="grid grid-cols-2 gap-3 text-center">
          <div>
            <div class="text-gray-500 text-[10px]">IN-GAME</div>
            <div id="wallet-balance" class="text-xl neon-text-cyan">0</div>
            <div class="text-gray-500 text-[9px]">tokens</div>
          </div>
          <div>
            <div class="text-gray-500 text-[10px]">WALLET $CARD</div>
            <div id="wallet-card-balance-top" class="text-xl neon-text-cyan">‚Äî</div>
            <div class="text-gray-500 text-[9px]">on-chain</div>
          </div>
        </div>
      </div>
      <!-- TON Wallet + $CARD -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
        <div class="text-gray-500 text-[10px] mb-2">TON WALLET</div>
        <p id="wallet-file-warning" class="hidden text-neon-yellow text-[9px] mb-2 p-2 bg-black/50 rounded">Wallet needs the game opened from a URL. Run in project folder: <code class="text-[8px]">npx serve -p 3001</code> then open <code class="text-[8px]">http://localhost:3001</code></p>
        <div id="wallet-connect-area">
          <p id="wallet-connection-status" class="text-[9px] min-h-[14px] mb-2 text-gray-400"></p>
          <div class="mb-2 p-2 rounded border-2 border-neon-green bg-neon-green/10">
            <p class="text-neon-green text-[10px] font-bold">üì± Play & connect on your phone</p>
            <p class="text-white text-[9px] mt-1">Open <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="text-neon-cyan underline">biggleem.github.io/nc-clicker-game-v1</a> in your phone browser. Tap Connect ‚Üí Tonkeeper opens on the same device ‚Üí Approve ‚Üí you‚Äôre connected. No desktop needed.</p>
          </div>
          <button type="button" id="ton-connect-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 text-[10px]">CONNECT WALLET (Tonkeeper / Telegram)</button>
          <p class="text-gray-500 text-[9px] mt-2">1) Tap Connect ‚Üí 2) Approve in Tonkeeper (green button) ‚Üí 3) Return to this tab. We‚Äôll detect the connection automatically, or tap the green button below.</p>
          <p class="text-neon-yellow text-[9px] mt-1">On desktop localhost: run the backend so the wallet can connect. Or use the <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="underline">live site</a>.</p>
          <button type="button" id="ton-check-connection-btn" class="w-full mt-2 py-2 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 font-bold">I approved ‚Äì check connection</button>
        </div>
        <div id="wallet-connected-area" class="hidden">
          <div class="text-[10px] text-gray-400 mb-1">Address</div>
          <div id="ton-address" class="text-neon-green text-[10px] break-all mb-2">‚Äî</div>
          <button type="button" id="ton-disconnect-btn" class="py-1 px-2 border border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-800">DISCONNECT</button>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700">
          <div class="text-gray-500 text-[10px]">$CARD (on-chain)</div>
          <div id="card-balance" class="text-xl neon-text-cyan">‚Äî</div>
          <p class="text-gray-500 text-[10px] mt-1" id="wallet-config-hint">Minter from backend config.</p>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700" id="withdraw-area">
          <div class="text-gray-500 text-[10px] mb-2">WITHDRAW TO $CARD</div>
          <p class="text-[10px] text-gray-400 mb-2">Convert in-game tokens to on-chain $CARD (sent to your connected wallet).</p>
          <div class="flex gap-2 items-center flex-wrap">
            <input type="number" id="withdraw-amount" min="1" placeholder="Amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-24 text-[10px]" />
            <button type="button" id="withdraw-btn" class="border-2 border-neon-green text-neon-green px-3 py-2 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50">WITHDRAW</button>
          </div>
          <p id="withdraw-feedback" class="text-[10px] mt-2 hidden"></p>
        </div>
      </div>
      <div class="text-[10px] text-gray-500 mb-2">OWNED NFTS (placeholder)</div>
      <div class="flex gap-2 flex-wrap">
        <div class="w-12 h-12 pixel-border rounded bg-neon-pink/20"></div>
        <div class="w-12 h-12 pixel-border rounded bg-neon-cyan/20"></div>
      </div>
      <div class="mt-4 border-t-2 border-gray-700 pt-4">
        <div class="text-[10px] text-gray-500 mb-2">EXCHANGE</div>
        <p class="text-gray-400 text-[10px]">Swap $CARD for other tokens. Coming after mainnet.</p>
      </div>
    </section>

    <!-- Multiplayer -->
    <section id="page-multiplayer" class="page p-4">
      <h2 class="text-neon-pink mb-4 border-b-2 border-gray-700 pb-2">MULTIPLAYER</h2>
      <p class="text-gray-400 mb-4">Share the game. When friends open the link on their phone, they can play and challenge you.</p>
      <!-- Invited to duel: shown when URL has ?room= (open room link) -->
      <div id="pvp-invited-card" class="hidden mb-4 p-4 rounded-lg border-2 border-neon-cyan bg-neon-cyan/5">
        <p class="text-neon-cyan text-[10px] font-bold mb-1">YOU‚ÄôRE INVITED TO A DUEL</p>
        <p class="text-gray-300 text-[9px] mb-3">Open this link to join the room and play. Enter your name, connect wallet (1 $CARD), then join.</p>
        <button type="button" id="pvp-invited-join-btn" class="w-full py-3 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/10 min-h-[48px]">JOIN & PLAY</button>
        <p id="pvp-invited-room-id" class="text-gray-500 text-[8px] mt-2 truncate"></p>
      </div>
      <!-- Share game: link that opens on mobile -->
      <div class="bg-pixel-panel border-2 border-neon-pink/50 p-4 rounded mb-4">
        <p class="text-neon-pink text-[10px] font-bold mb-2">üì± SHARE GAME</p>
        <p class="text-gray-400 text-[9px] mb-3">Send this link ‚Äì it opens in the browser on any device. On mobile, they tap to play and can join PVP.</p>
        <div class="flex gap-2 flex-wrap items-center">
          <button type="button" id="share-game-btn" class="py-2 px-4 border-2 border-neon-pink text-neon-pink rounded text-[10px] hover:bg-neon-pink/10 active:scale-[0.98] min-h-[44px]">COPY GAME LINK</button>
          <button type="button" id="share-game-native-btn" class="py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10 active:scale-[0.98] min-h-[44px] hidden">SHARE (APP)</button>
        </div>
        <p id="share-game-feedback" class="text-neon-green text-[9px] mt-2 hidden">Link copied! Paste in a message ‚Äì friend opens it on their phone to play.</p>
      </div>
      <div id="pvp-lobby-wrap">
      <p class="text-gray-500 text-[9px] mb-3">Lobby: 2-player rooms. Create a new room or join an open one.</p>
      <!-- Create new room ‚Äì always visible -->
      <div id="pvp-create-card" class="bg-pixel-panel border-2 border-neon-green/60 p-4 rounded mb-4">
        <p class="text-neon-green text-[10px] font-bold mb-2">‚ûï CREATE NEW ROOM</p>
        <p class="text-gray-400 text-[9px] mb-3">Start a room and share the link. Friends open it to join.</p>
        <div class="flex flex-wrap gap-2">
          <button type="button" id="pvp-create-room-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 min-h-[44px]">CREATE ROOM</button>
          <button type="button" id="pvp-refresh-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700 min-h-[44px]">REFRESH LIST</button>
        </div>
      </div>

      <p id="pvp-status" class="text-[9px] text-gray-500 mb-2 min-h-[14px]"></p>
      <p class="text-gray-500 text-[9px] mb-1">Open rooms first, then recent. Stake: 1 $CARD to play ‚Äî loser loses it.</p>
      <div id="pvp-rooms-list" class="grid grid-cols-1 gap-2">
        <!-- Rooms loaded from Supabase -->
      </div>
      <p id="pvp-error" class="text-neon-pink text-[9px] mt-2 hidden"></p>
      </div>

      <!-- Duel view: side-by-side clicker (shown when in active game) -->
      <div id="pvp-duel-view" class="hidden mt-4">
        <p class="text-neon-pink text-[10px] font-bold mb-2 text-center">CLICK RACE ‚Äî 30 SEC</p>
        <p id="pvp-duel-timer" class="text-center text-neon-yellow text-sm mb-3">0:30</p>
        <div class="grid grid-cols-2 gap-3">
          <div id="pvp-duel-you" class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-3 text-center">
            <p id="pvp-duel-you-name" class="text-neon-cyan text-[10px] font-bold truncate">You</p>
            <p id="pvp-duel-you-clicks" class="text-2xl neon-text-cyan">0</p>
            <button type="button" id="pvp-duel-click-btn" class="nft-clicker w-24 h-24 pixel-border rounded-lg bg-black/80 mt-2 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden disabled:opacity-50 disabled:pointer-events-none" aria-label="Click to score">
              <img src="assets/cardinal.png" alt="Tap" class="w-full h-full object-contain image-pixel" />
            </button>
          </div>
          <div id="pvp-duel-opponent" class="bg-pixel-panel border-2 border-gray-600 rounded-lg p-3 text-center">
            <p id="pvp-duel-opp-name" class="text-gray-400 text-[10px] font-bold truncate">Opponent</p>
            <p id="pvp-duel-opp-clicks" class="text-2xl text-gray-300">0</p>
            <div class="w-24 h-24 pixel-border rounded-lg bg-black/80 mt-2 mx-auto flex items-center justify-center text-3xl text-gray-600">?</div>
          </div>
        </div>
        <p id="pvp-duel-waiting" class="text-center text-gray-500 text-[9px] mt-2 hidden">Waiting for opponent‚Ä¶ Share the room link.</p>
        <div class="mt-3 text-center">
          <button type="button" id="pvp-duel-end-game-btn" class="py-2 px-4 border-2 border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10">END GAME</button>
        </div>
      </div>

      <!-- Duel result: winner / loser + rematch -->
      <div id="pvp-duel-result" class="hidden mt-4 p-4 rounded-lg border-2 text-center">
        <p id="pvp-duel-result-title" class="text-lg font-bold mb-2">‚Äî</p>
        <p id="pvp-duel-result-detail" class="text-[10px] text-gray-400 mb-4">‚Äî</p>
        <div class="flex gap-2 justify-center flex-wrap">
          <button type="button" id="pvp-duel-rematch-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">REMATCH</button>
          <button type="button" id="pvp-duel-lobby-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">BACK TO LOBBY</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav: scrolls horizontally on small screens -->
  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-black/95 border-t-2 border-pixel-border max-w-lg mx-auto overflow-hidden">
    <div class="flex flex-nowrap justify-start gap-1 py-2 px-2 overflow-x-auto overflow-y-hidden scroll-smooth scrollbar-hide min-h-[44px] items-center" style="-webkit-overflow-scrolling: touch;">
      <a href="#home" class="nav-link flex-shrink-0 px-3 py-2 rounded text-[10px] whitespace-nowrap" data-page="home">HOME</a>
      <a href="#boosts" class="nav-link flex-shrink-0 px-3 py-2 rounded text-[10px] whitespace-nowrap" data-page="boosts">BOOSTS</a>
      <a href="#bounties" class="nav-link flex-shrink-0 px-3 py-2 rounded text-[10px] whitespace-nowrap" data-page="bounties">BOUNTIES</a>
      <a href="#friends" class="nav-link flex-shrink-0 px-3 py-2 rounded text-[10px] whitespace-nowrap" data-page="friends">FRIENDS</a>
      <a href="#wallet" class="nav-link flex-shrink-0 px-3 py-2 rounded text-[10px] whitespace-nowrap" data-page="wallet">WALLET</a>
      <a href="#multiplayer" class="nav-link flex-shrink-0 px-3 py-2 rounded text-[10px] whitespace-nowrap" data-page="multiplayer">PVP</a>
    </div>
  </nav>
  </div>

  <script src="ton-config.js"></script>
  <script src="supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.anonKey && typeof window.supabase !== 'undefined') {
      window.supabaseClient = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);
    }
  </script>
  <script src="dist/wallet.js" onerror="console.warn('Wallet script failed to load')"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2/dist/tonconnect-ui.min.js"></script>
  <script>
    // --- Constants ---
    const CLICKS_PER_TOKEN = 10;
    const COOLDOWN_BASE_MS = 280;
    const COOLDOWN_REDUCED_MS = 200;

    // --- State (load from localStorage) ---
    let totalClicks = parseInt(localStorage.getItem('tokenClicker_totalClicks') || '0', 10);
    let tokens = parseInt(localStorage.getItem('tokenClicker_tokens') || '', 10);
    if (isNaN(tokens) || tokens < 0) tokens = Math.floor(totalClicks / CLICKS_PER_TOKEN);
    let tapPower = parseInt(localStorage.getItem('tokenClicker_tapPower') || '1', 10);
    let hasAutoclicker = localStorage.getItem('tokenClicker_autoclicker') === '1';
    let hasCooldownBoost = localStorage.getItem('tokenClicker_cooldown') === '1';
    let lastDailyClaim = localStorage.getItem('tokenClicker_lastDailyClaim') || '';
    let claimed100Today = localStorage.getItem('tokenClicker_claimed100Today') === '1';
    let claimedWeekly = localStorage.getItem('tokenClicker_claimedWeekly') === '1';
    let lastDate = localStorage.getItem('tokenClicker_lastDate') || '';
    let clicksToday = parseInt(localStorage.getItem('tokenClicker_clicksToday') || '0', 10);
    let weekStartKey = localStorage.getItem('tokenClicker_weekStart') || '';
    let weeklyClicks = parseInt(localStorage.getItem('tokenClicker_weeklyClicks') || '0', 10);

    let lastClickTime = 0;
    let clicksInLastSecond = 0;
    let lastSecondTime = Date.now();
    let autoclickerInterval = null;

    function todayKey() { return new Date().toISOString().slice(0, 10); }
    function weekKey() {
      const d = new Date();
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().slice(0, 10);
    }

    // --- DOM ---
    const nftClicker = document.getElementById('nft-clicker');
    const topTokens = document.getElementById('top-tokens');
    const walletBalance = document.getElementById('wallet-balance');
    const totalClicksEl = document.getElementById('total-clicks');
    const clicksPerSecEl = document.getElementById('clicks-per-sec');
    const tokenRateEl = document.getElementById('token-rate');
    const clickCountLabel = document.getElementById('click-count-label');

    function cooldownMs() { return hasCooldownBoost ? COOLDOWN_REDUCED_MS : COOLDOWN_BASE_MS; }

    function save() {
      localStorage.setItem('tokenClicker_totalClicks', String(totalClicks));
      localStorage.setItem('tokenClicker_tokens', String(tokens));
      localStorage.setItem('tokenClicker_tapPower', String(tapPower));
      localStorage.setItem('tokenClicker_autoclicker', hasAutoclicker ? '1' : '0');
      localStorage.setItem('tokenClicker_cooldown', hasCooldownBoost ? '1' : '0');
      localStorage.setItem('tokenClicker_lastDailyClaim', lastDailyClaim);
      localStorage.setItem('tokenClicker_claimed100Today', claimed100Today ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedWeekly', claimedWeekly ? '1' : '0');
      localStorage.setItem('tokenClicker_lastDate', lastDate);
      localStorage.setItem('tokenClicker_clicksToday', String(clicksToday));
      localStorage.setItem('tokenClicker_weekStart', weekStartKey);
      localStorage.setItem('tokenClicker_weeklyClicks', String(weeklyClicks));
    }

    function updateBountyProgress() {
      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) {
        clicksToday = 0;
        claimed100Today = false;
        lastDate = today;
      }
      if (week !== weekStartKey) {
        weeklyClicks = 0;
        claimedWeekly = false;
        weekStartKey = week;
      }
    }

    function updateUI() {
      if (topTokens) topTokens.textContent = tokens;
      if (walletBalance) walletBalance.textContent = tokens;
      const boostsBal = document.getElementById('boosts-balance');
      const bountiesBal = document.getElementById('bounties-balance');
      if (boostsBal) boostsBal.textContent = tokens;
      if (bountiesBal) bountiesBal.textContent = tokens;
      if (totalClicksEl) totalClicksEl.textContent = totalClicks;
      if (clickCountLabel) clickCountLabel.textContent = totalClicks;
      if (tokenRateEl) tokenRateEl.textContent = tapPower + ' / 10';
      const homeTaps = document.getElementById('home-taps');
      const homePower = document.getElementById('home-power');
      const homeMult = document.getElementById('home-mult');
      const homeRegen = document.getElementById('home-regen');
      if (homeTaps) homeTaps.textContent = totalClicks;
      if (homePower) homePower.textContent = tapPower;
      if (homeMult) homeMult.textContent = '1.0';
      if (homeRegen) homeRegen.textContent = hasAutoclicker ? '1' : '0';
      updateBadges();
      updateBoostsUI();
      updateBountiesUI();
      updateLeaderboard();
    }

    function updateBadges() {
      [['badge-1', totalClicks >= 1], ['badge-2', false], ['badge-3', false], ['badge-4', totalClicks >= 1000], ['badge-5', totalClicks >= 10000]].forEach(([id, unlocked]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('opacity-50', !unlocked);
        el.classList.toggle('border-neon-yellow', !!unlocked);
        el.classList.toggle('border-gray-600', !unlocked);
      });
    }

    function updateBoostsUI() {
      document.querySelectorAll('.boost-btn').forEach(btn => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        const owned = (boost === 'tapPower' && tapPower >= 2) || (boost === 'autoclicker' && hasAutoclicker) || (boost === 'cooldown' && hasCooldownBoost);
        btn.disabled = owned || tokens < cost;
        btn.textContent = owned ? 'OWNED' : 'BUY';
      });
    }

    function updateBountiesUI() {
      updateBountyProgress();
      const today = todayKey();
      const dailyClaimBtn = document.getElementById('claim-daily');
      const dailyCanClaim = lastDailyClaim !== today;
      if (dailyClaimBtn) {
        dailyClaimBtn.disabled = !dailyCanClaim;
        dailyClaimBtn.textContent = dailyCanClaim ? 'CLAIM' : 'CLAIMED';
      }
      const p100 = document.getElementById('bounty-100-progress');
      if (p100) p100.textContent = clicksToday;
      const claim100Btn = document.getElementById('claim-100');
      if (claim100Btn) {
        claim100Btn.disabled = clicksToday < 100 || claimed100Today;
        claim100Btn.textContent = claimed100Today ? 'CLAIMED' : 'CLAIM';
      }
      const pWeek = document.getElementById('bounty-weekly-progress');
      if (pWeek) pWeek.textContent = weeklyClicks;
      const claimWeekBtn = document.getElementById('claim-weekly');
      if (claimWeekBtn) {
        claimWeekBtn.disabled = weeklyClicks < 500 || claimedWeekly;
        claimWeekBtn.textContent = claimedWeekly ? 'CLAIMED' : 'CLAIM';
      }
      save();
    }

    function updateLeaderboard() {
      let leaderboard = [];
      try {
        leaderboard = JSON.parse(localStorage.getItem('tokenClicker_leaderboard') || '[]');
      } catch (_) {}
      if (!Array.isArray(leaderboard) || leaderboard.length === 0) {
        leaderboard = [ { name: 'Alpha', tokens: 500 }, { name: 'Beta', tokens: 300 } ];
      }
      const me = leaderboard.find(e => e.name === 'You');
      if (me) me.tokens = tokens; else leaderboard.push({ name: 'You', tokens });
      leaderboard.sort((a, b) => b.tokens - a.tokens);
      try { localStorage.setItem('tokenClicker_leaderboard', JSON.stringify(leaderboard)); } catch (_) {}
      const list = document.getElementById('leaderboard-list');
      if (list) {
        list.innerHTML = leaderboard.slice(0, 10).map((e, i) =>
          (i + 1) + '. ' + e.name + ' ‚Äî ' + e.tokens + ' tokens'
        ).join('\n');
      }
      if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
      if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
      let refCode = localStorage.getItem('tokenClicker_refCode');
      if (!refCode) {
        refCode = 'REF' + Math.random().toString(36).slice(2, 8).toUpperCase();
        localStorage.setItem('tokenClicker_refCode', refCode);
      }
      const refEl = document.getElementById('referral-code');
      if (refEl) refEl.textContent = refCode;
    }
    function loadLeaderboardPvp() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('leaderboard-pvp-list');
      if (!supabase || !list) return;
      supabase.from('leaderboard').select('name, pvp_wins').order('pvp_wins', { ascending: false }).limit(10).then(function(r) {
        if (r.error || !r.data || r.data.length === 0) {
          list.innerHTML = '<li class="text-gray-500">No duel wins yet.</li>';
          return;
        }
        list.innerHTML = r.data.map(function(e, i) {
          var wins = e.pvp_wins != null ? e.pvp_wins : 0;
          return (i + 1) + '. ' + (e.name || 'Player') + ' ‚Äî ' + wins + ' win' + (wins !== 1 ? 's' : '');
        }).join('\n');
      });
    }

    function updateClicksPerSecond() {
      const now = Date.now();
      if (now - lastSecondTime >= 1000) {
        clicksInLastSecond = 0;
        lastSecondTime = now;
      }
      if (clicksPerSecEl) clicksPerSecEl.textContent = clicksInLastSecond;
    }

    function addTokens(amount) {
      tokens += amount;
      updateUI();
      save();
    }

    function onValidClick() {
      const now = Date.now();
      if (now - lastClickTime < cooldownMs()) return -1;
      lastClickTime = now;

      totalClicks++;
      const prevEffective = (totalClicks - 1) * tapPower;
      const newEffective = totalClicks * tapPower;
      const earned = Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
      tokens += earned;

      const nowSec = now / 1000;
      if (Math.floor(nowSec) > Math.floor(lastSecondTime / 1000)) {
        lastSecondTime = now;
        clicksInLastSecond = 0;
      }
      clicksInLastSecond++;

      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) { clicksToday = 0; claimed100Today = false; lastDate = today; }
      if (week !== weekStartKey) { weeklyClicks = 0; claimedWeekly = false; weekStartKey = week; }
      clicksToday++;
      weeklyClicks++;

      updateUI();
      save();
      updateClicksPerSecond();
      return earned;
    }

    function spawnClickEffects(earned) {
      const btn = nftClicker;
      const rect = btn.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      for (let i = 0; i < 5; i++) {
        const el = document.createElement('div');
        el.className = 'feather-float feather-drift-' + (1 + (i % 3));
        el.style.left = cx + (Math.random() - 0.5) * 24 + 'px';
        el.style.top = cy + (Math.random() - 0.5) * 24 + 'px';
        el.style.setProperty('--r', (Math.random() * 120 - 60) + 'deg');
        el.innerHTML = '<div class="feather-pixel"></div>';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1300);
      }

      const valueEl = document.createElement('div');
      valueEl.className = 'tap-value-float';
      valueEl.textContent = '+1';
      valueEl.style.left = cx + 'px';
      valueEl.style.top = cy + 'px';
      document.body.appendChild(valueEl);
      setTimeout(() => valueEl.remove(), 1100);
    }

    if (nftClicker) nftClicker.addEventListener('click', (e) => {
      nftClicker.classList.add('cooldown');
      const earned = onValidClick();
      if (earned >= 0) spawnClickEffects(earned);
      setTimeout(() => nftClicker.classList.remove('cooldown'), cooldownMs());
    });

    // Boosts: buy
    document.querySelectorAll('.boost-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        if (tokens < cost) return;
        if (boost === 'tapPower' && tapPower < 2) { tokens -= cost; tapPower = 2; }
        if (boost === 'autoclicker' && !hasAutoclicker) { tokens -= cost; hasAutoclicker = true; startAutoclicker(); }
        if (boost === 'cooldown' && !hasCooldownBoost) { tokens -= cost; hasCooldownBoost = true; }
        updateUI();
        save();
      });
    });

    function startAutoclicker() {
      if (autoclickerInterval) return;
      autoclickerInterval = setInterval(() => {
        totalClicks++;
        const prevEffective = (totalClicks - 1) * tapPower;
        const newEffective = totalClicks * tapPower;
        tokens += Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
        const today = todayKey();
        const week = weekKey();
        if (today !== lastDate) { clicksToday = 0; lastDate = today; }
        if (week !== weekStartKey) { weeklyClicks = 0; weekStartKey = week; }
        clicksToday++;
        weeklyClicks++;
        updateUI();
        save();
      }, 1000);
    }
    if (hasAutoclicker) startAutoclicker();

    // Bounties: claim
    document.querySelectorAll('.bounty-claim').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const reward = parseInt(btn.dataset.reward, 10);
        if (id === 'daily' && lastDailyClaim !== todayKey()) { lastDailyClaim = todayKey(); addTokens(reward); }
        if (id === '100today' && clicksToday >= 100 && !claimed100Today) { claimed100Today = true; addTokens(reward); }
        if (id === 'weekly' && weeklyClicks >= 500 && !claimedWeekly) { claimedWeekly = true; addTokens(reward); }
        updateBountiesUI();
      });
    });

    // Share URL: use canonical game URL so shared links open on mobile (production site)
    function getShareBaseUrl() {
      var base = (window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl) || (window.location.origin + window.location.pathname).replace(/\/$/, '');
      return base;
    }
    function getInviteUrl() {
      var code = localStorage.getItem('tokenClicker_refCode') || 'REF0000';
      return getShareBaseUrl() + '/?ref=' + encodeURIComponent(code);
    }
    function getGameUrl() {
      return getShareBaseUrl() + '/';
    }

    // Friends: copy invite link (canonical URL so it opens on mobile)
    const inviteBtn = document.getElementById('invite-btn');
    const inviteFeedback = document.getElementById('invite-feedback');
    if (inviteBtn) {
      inviteBtn.addEventListener('click', () => {
        var url = getInviteUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            if (inviteFeedback) { inviteFeedback.classList.remove('hidden'); setTimeout(() => inviteFeedback.classList.add('hidden'), 3000); }
          }).catch(function() { fallbackCopy(url, inviteFeedback); });
        } else { fallbackCopy(url, inviteFeedback); }
      });
    }

    // PVP: Share game ‚Äì copy link that opens on mobile
    const shareGameBtn = document.getElementById('share-game-btn');
    const shareGameNativeBtn = document.getElementById('share-game-native-btn');
    const shareGameFeedback = document.getElementById('share-game-feedback');
    function fallbackCopy(text, feedbackEl) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); if (feedbackEl) { feedbackEl.classList.remove('hidden'); setTimeout(function() { feedbackEl.classList.add('hidden'); }, 3000); } } catch (e) {}
      document.body.removeChild(ta);
    }
    if (shareGameBtn) {
      shareGameBtn.addEventListener('click', function() {
        var url = getGameUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            if (shareGameFeedback) { shareGameFeedback.classList.remove('hidden'); setTimeout(function() { shareGameFeedback.classList.add('hidden'); }, 4000); }
          }).catch(function() { fallbackCopy(url, shareGameFeedback); });
        } else { fallbackCopy(url, shareGameFeedback); }
      });
    }
    if (shareGameNativeBtn && navigator.share) {
      shareGameNativeBtn.classList.remove('hidden');
      shareGameNativeBtn.addEventListener('click', function() {
        navigator.share({
          title: '1N Blockchain Token Clicker',
          text: 'Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends!',
          url: getGameUrl(),
        }).then(function() { if (shareGameFeedback) { shareGameFeedback.textContent = 'Shared!'; shareGameFeedback.classList.remove('hidden'); setTimeout(function() { shareGameFeedback.classList.add('hidden'); }, 3000); } }).catch(function() {});
      });
    }

    // TON Wallet: connector + optional TonConnect UI modal; we prefer direct connect + link for reliability
    var walletStatusEl = document.getElementById('wallet-connection-status');
    function setWalletStatus(msg, isError) {
      if (walletStatusEl) { walletStatusEl.textContent = msg || ''; walletStatusEl.className = 'text-[9px] min-h-[14px] mb-2 ' + (isError ? 'text-neon-pink' : 'text-gray-400'); }
    }
    let tonConnectUI = null;
    if (window.TonWallet && typeof TON_CONNECT_UI !== 'undefined') {
      try {
        tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ connector: window.TonWallet.getConnector() });
        window.tonConnectUI = tonConnectUI;
        if (tonConnectUI.onStatusChange) tonConnectUI.onStatusChange(function() { updateWalletUI(); setWalletStatus(''); });
      } catch (e) { console.warn('TonConnect UI init:', e); }
    }
    var lastCardBalanceFetch = 0;
    function fetchCardBalanceFromBackend() {
      const TW = window.TonWallet;
      const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
      if (!TW || !backendUrl) return;
      const addr = TW.getAddress();
      if (!addr) return;
      if (Date.now() - lastCardBalanceFetch < 15000) return;
      lastCardBalanceFetch = Date.now();
      fetch(backendUrl.replace(/\/$/, '') + '/api/wallet/card-balance?address=' + encodeURIComponent(addr))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data.balance != null && TW.setCardBalance) TW.setCardBalance(data.balance);
          updateWalletUI();
        })
        .catch(function() { updateWalletUI(); });
    }
    function updateWalletUI() {
      const TW = window.TonWallet;
      if (!TW) return;
      const addr = TW.getAddress();
      const connectArea = document.getElementById('wallet-connect-area');
      const connectedArea = document.getElementById('wallet-connected-area');
      const tonAddress = document.getElementById('ton-address');
      const cardBalanceEl = document.getElementById('card-balance');
      if (connectArea) connectArea.classList.toggle('hidden', !!addr);
      if (connectedArea) connectedArea.classList.toggle('hidden', !addr);
      if (tonAddress && addr) tonAddress.textContent = addr.slice(0, 8) + '‚Ä¶' + addr.slice(-8);
      if (cardBalanceEl) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardBalanceEl.textContent = String(TW.cardBalance);
        } else {
          cardBalanceEl.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      var cardTop = document.getElementById('wallet-card-balance-top');
      if (cardTop) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardTop.textContent = String(TW.cardBalance);
        } else {
          cardTop.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      if (addr) {
        fetchCardBalanceFromBackend();
        persistNameToLeaderboard();
        if (!getPlayerName() && window.supabaseClient) {
          window.supabaseClient.from('leaderboard').select('name').eq('wallet_address', addr).maybeSingle().then(function(r) {
            if (r.data && r.data.name) localStorage.setItem('tokenClicker_playerName', r.data.name.trim().slice(0, 20));
          });
        }
      }
    }
    const tonConnectBtn = document.getElementById('ton-connect-btn');
    const tonDisconnectBtn = document.getElementById('ton-disconnect-btn');
    var connectionPollTimer = null;
    function startConnectionPolling() {
      if (connectionPollTimer) return;
      setWalletStatus('Waiting for approval‚Ä¶ Return to this tab after approving in Tonkeeper.');
      var attempts = 0;
      var maxAttempts = 40;
      function poll() {
        if (window.TonWallet && window.TonWallet.getAddress()) {
          connectionPollTimer = null;
          setWalletStatus('');
          updateWalletUI();
          return;
        }
        attempts++;
        if (attempts >= maxAttempts) {
          connectionPollTimer = null;
          setWalletStatus('No connection yet. Click "I approved ‚Äì check connection" or try again.');
          return;
        }
        var unPause = window.TonWallet && window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') unPause().catch(function() {});
        window.TonWallet.restoreConnection().then(function() {
          updateWalletUI();
          if (window.TonWallet.getAddress()) { connectionPollTimer = null; setWalletStatus(''); return; }
          connectionPollTimer = setTimeout(poll, 2000);
        }).catch(function() { connectionPollTimer = setTimeout(poll, 2000); });
      }
      if (window.TonWallet && window.TonWallet.unPauseConnection) {
        window.TonWallet.unPauseConnection().then(function() { poll(); }).catch(function() { poll(); });
      } else {
        poll();
      }
    }
    if (tonConnectBtn) {
      tonConnectBtn.addEventListener('click', function() {
        if (!window.TonWallet) { setWalletStatus('Wallet script not loaded.', true); return; }
        setWalletStatus('Opening Tonkeeper‚Ä¶');
        tonConnectBtn.disabled = true;
        window.TonWallet.connect()
          .then(function() {
            updateWalletUI();
            if (window.TonWallet.getAddress()) { setWalletStatus(''); tonConnectBtn.disabled = false; return; }
            startConnectionPolling();
            tonConnectBtn.disabled = false;
          })
          .catch(function(err) {
            var msg = (err && err.message) || 'Connect failed';
            if (msg.indexOf('POPUP_BLOCKED') !== -1) msg = 'Popup blocked. Allow popups for this site or use the link that opened.';
            setWalletStatus(msg, true);
            tonConnectBtn.disabled = false;
          });
      });
    }
    const tonCheckBtn = document.getElementById('ton-check-connection-btn');
    if (tonCheckBtn && window.TonWallet) {
      tonCheckBtn.addEventListener('click', function() {
        if (connectionPollTimer) { clearTimeout(connectionPollTimer); connectionPollTimer = null; }
        const origText = tonCheckBtn.textContent;
        tonCheckBtn.disabled = true;
        tonCheckBtn.textContent = 'Checking‚Ä¶';
        setWalletStatus('Checking connection‚Ä¶');
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') Promise.resolve(unPause()).catch(function() {});
        function done() {
          updateWalletUI();
          tonCheckBtn.disabled = false;
          tonCheckBtn.textContent = origText;
          setWalletStatus('');
        }
        var attempts = 0;
        var maxAttempts = 12;
        function poll() {
          window.TonWallet.restoreConnection()
            .then(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setWalletStatus('Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')');
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Not yet. Try again or refresh.';
                tonCheckBtn.disabled = false;
                setWalletStatus('No connection yet. Approve in Tonkeeper and try again.');
              }
            })
            .catch(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Try again or refresh page.';
                tonCheckBtn.disabled = false;
                setWalletStatus('Try again or refresh.');
              }
            });
        }
        poll();
      });
    }
    if (tonDisconnectBtn && window.TonWallet) {
      tonDisconnectBtn.addEventListener('click', () => {
        window.TonWallet.disconnect();
        updateWalletUI();
      });
    }
    if (window.TonWallet) {
      const fileWarning = document.getElementById('wallet-file-warning');
      if (fileWarning && (typeof location !== 'undefined' && location.protocol === 'file:')) {
        fileWarning.classList.remove('hidden');
      }
      window.TonWallet.onStatusChange(updateWalletUI);
      window.TonWallet.restoreConnection().then(() => {
        updateWalletUI();
      }).catch(() => { updateWalletUI(); });
      // When user returns to this tab after approving in Tonkeeper, unpause bridge and sync
      window.addEventListener('focus', function() {
        if (!window.TonWallet) return;
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') {
          unPause().then(function() {
            window.TonWallet.restoreConnection().then(updateWalletUI).catch(updateWalletUI);
          }).catch(function() { updateWalletUI(); });
        }
      });
    }

    // Backend config: load minter address (and network) from backend
    const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
    if (backendUrl) {
      fetch(backendUrl.replace(/\/$/, '') + '/api/config')
        .then(r => r.json())
        .then(data => {
          if (data.cardMinterAddress && window.TonWallet) {
            window.TonWallet.setCardMinterAddress(data.cardMinterAddress);
          }
          const hint = document.getElementById('wallet-config-hint');
          if (hint) hint.textContent = data.cardMinterAddress ? 'Minter: ' + data.cardMinterAddress.slice(0, 8) + '‚Ä¶' : 'Set backendUrl in ton-config.js and add minter to backend .env';
        })
        .catch(() => {});
    }

    // Withdraw: send in-game tokens to backend, backend mints $CARD to user
    const withdrawAmount = document.getElementById('withdraw-amount');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const withdrawFeedback = document.getElementById('withdraw-feedback');
    if (withdrawBtn && backendUrl) {
      withdrawBtn.addEventListener('click', async () => {
        const amount = withdrawAmount ? parseInt(withdrawAmount.value, 10) : 0;
        if (!amount || amount < 1) { withdrawFeedback.textContent = 'Enter amount (1+).'; withdrawFeedback.classList.remove('hidden'); return; }
        const addr = window.TonWallet && window.TonWallet.getAddress();
        if (!addr) { withdrawFeedback.textContent = 'Connect wallet first.'; withdrawFeedback.classList.remove('hidden'); return; }
        if (tokens < amount) { withdrawFeedback.textContent = 'Not enough in-game balance.'; withdrawFeedback.classList.remove('hidden'); return; }
        withdrawBtn.disabled = true;
        withdrawFeedback.textContent = 'Sending‚Ä¶';
        withdrawFeedback.classList.remove('hidden');
        withdrawFeedback.classList.remove('text-neon-green', 'text-neon-pink');
        try {
          const res = await fetch(backendUrl.replace(/\/$/, '') + '/api/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, amount }),
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.success) {
            tokens -= amount;
            save();
            updateUI();
            withdrawFeedback.textContent = 'Withdraw sent! Check your wallet for $CARD.';
            withdrawFeedback.classList.add('text-neon-green');
            if (withdrawAmount) withdrawAmount.value = '';
          } else {
            withdrawFeedback.textContent = data.error || 'Withdraw failed.';
            withdrawFeedback.classList.add('text-neon-pink');
          }
        } catch (e) {
          withdrawFeedback.textContent = e.message || 'Network error.';
          withdrawFeedback.classList.add('text-neon-pink');
        }
        withdrawBtn.disabled = false;
      });
    } else if (document.getElementById('withdraw-area')) {
      document.getElementById('withdraw-area').querySelector('.text-[10px]').textContent = 'Set backendUrl in ton-config.js to enable withdraw.';
    }

    // --- PVP: player name, onboarding, 1 $CARD requirement ---
    var PVP_STAKE = 1;
    var PVP_GAME_DURATION_SEC = 30;
    var PVP_CLICK_COOLDOWN_MS = 200;

    function getPlayerName() {
      return (localStorage.getItem('tokenClicker_playerName') || '').trim().slice(0, 20) || null;
    }
    function setPlayerName(name) {
      name = (name || '').trim().slice(0, 20);
      if (name) {
        localStorage.setItem('tokenClicker_playerName', name);
        registerReferralIfNeeded(name);
        persistNameToLeaderboard();
      }
    }
    function registerReferralIfNeeded(invitedName) {
      var inviterCode = localStorage.getItem('tokenClicker_invitedBy');
      if (!inviterCode || !invitedName) return;
      var supabase = window.supabaseClient;
      if (!supabase) { localStorage.removeItem('tokenClicker_invitedBy'); return; }
      var wallet = getPvpPlayerId();
      if (wallet && wallet.indexOf('guest_') === 0) wallet = null;
      supabase.from('referrals').insert({ inviter_ref_code: inviterCode, invited_name: invitedName, invited_wallet: wallet }).then(function() {
        localStorage.removeItem('tokenClicker_invitedBy');
        if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      }).catch(function() { localStorage.removeItem('tokenClicker_invitedBy'); });
    }
    function loadFriendsInvited() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('friends-invited-list');
      if (!supabase || !list) return;
      var refCode = localStorage.getItem('tokenClicker_refCode') || '';
      if (!refCode) { list.innerHTML = '<li class="text-gray-500">Your code not set yet.</li>'; return; }
      supabase.from('referrals').select('invited_name, invited_wallet, created_at').eq('inviter_ref_code', refCode).order('created_at', { ascending: false }).limit(50)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No one has used your invite link yet.</li>';
            return;
          }
          list.innerHTML = r.data.map(function(e, i) {
            var name = e.invited_name || 'Player';
            var wallet = e.invited_wallet ? (e.invited_wallet.slice(0, 6) + '‚Ä¶') : '';
            return (i + 1) + '. ' + name + (wallet ? ' (' + wallet + ')' : '');
          }).join('\n');
        })
        .catch(function() { list.innerHTML = '<li class="text-gray-500">Could not load.</li>'; });
    }
    function persistNameToLeaderboard() {
      var name = getPlayerName();
      var wallet = getPvpPlayerId();
      if (!name || !wallet || wallet.indexOf('guest_') === 0) return;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('leaderboard').select('id').eq('wallet_address', wallet).maybeSingle().then(function(r) {
        var row = r.data;
        if (row) {
          supabase.from('leaderboard').update({ name: name, updated_at: new Date().toISOString() }).eq('id', row.id).then(function() {});
        } else {
          supabase.from('leaderboard').insert({ name: name, wallet_address: wallet, tokens: 0, ref_code: localStorage.getItem('tokenClicker_refCode') || null }).then(function() {});
        }
      });
    }
    function hasWalletAndStake() {
      if (!window.TonWallet || !window.TonWallet.getAddress()) return false;
      var bal = window.TonWallet.cardBalance;
      if (bal == null || bal === undefined) return false;
      return Number(bal) >= PVP_STAKE;
    }
    function showPvpOnboarding(reason, roomId) {
      window.location.hash = 'multiplayer';
      if (typeof showPage === 'function') showPage('multiplayer');
      var errEl = document.getElementById('pvp-error');
      if (!errEl) return;
      errEl.classList.remove('hidden');
      if (reason === 'name') {
        if (!getPlayerName()) setPlayerName('Player');
        errEl.textContent = '';
        errEl.classList.add('hidden');
        return;
      }
      if (reason === 'wallet') {
        errEl.textContent = 'Connect your TON wallet (Wallet tab) to play.';
        return;
      }
      if (reason === 'card') {
        errEl.textContent = 'You need at least 1 $CARD in your wallet to duel. Loser loses their stake.';
        return;
      }
    }
    function hideWelcomeNameModal() {
      var m = document.getElementById('welcome-name-modal');
      if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    function hideProfileNameModal() {
      var m = document.getElementById('profile-name-modal');
      if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    document.getElementById('welcome-name-save') && document.getElementById('welcome-name-save').addEventListener('click', function() {
      var input = document.getElementById('welcome-name-input');
      var name = input && input.value.trim().slice(0, 20);
      if (name) { setPlayerName(name); hideWelcomeNameModal(); updateUI(); }
    });
    document.getElementById('profile-change-name-btn') && document.getElementById('profile-change-name-btn').addEventListener('click', function() {
      var modal = document.getElementById('profile-name-modal');
      var input = document.getElementById('profile-name-input');
      if (input) input.value = getPlayerName() || '';
      if (modal) { modal.classList.remove('hidden'); modal.style.display = 'flex'; }
    });
    document.getElementById('profile-name-save') && document.getElementById('profile-name-save').addEventListener('click', function() {
      var input = document.getElementById('profile-name-input');
      var name = input && input.value.trim().slice(0, 20);
      if (name) { setPlayerName(name); hideProfileNameModal(); updateProfileDisplayName(); updateUI(); }
    });
    document.getElementById('profile-name-cancel') && document.getElementById('profile-name-cancel').addEventListener('click', hideProfileNameModal);
    function updateProfileDisplayName() {
      var el = document.getElementById('profile-display-name');
      if (el) el.textContent = getPlayerName() || '‚Äî';
    }

    // --- PVP: rooms from Supabase ---
    function getPvpPlayerId() {
      if (window.TonWallet && typeof window.TonWallet.getAddress === 'function') {
        var addr = window.TonWallet.getAddress();
        if (addr) return addr;
      }
      var guest = localStorage.getItem('tokenClicker_pvp_guest_id');
      if (!guest) {
        guest = 'guest_' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('tokenClicker_pvp_guest_id', guest);
      }
      return guest;
    }
    function loadPvpRooms() {
      var list = document.getElementById('pvp-rooms-list');
      var status = document.getElementById('pvp-status');
      var errEl = document.getElementById('pvp-error');
      if (!list) return;
      if (errEl) errEl.classList.add('hidden');
      var supabase = window.supabaseClient;
      if (!supabase) {
        if (status) status.textContent = 'Supabase not configured.';
        list.innerHTML = '<p class="text-gray-500 text-[10px] p-3">Add Supabase URL and anon key in supabase-config.js and run the migration.</p>';
        return;
      }
      if (status) status.textContent = 'Loading rooms‚Ä¶';
      // Auto-close open rooms that no one joined after 1 minute
      var oneMinAgo = new Date(Date.now() - 60 * 1000).toISOString();
      supabase.from('rooms').update({ status: 'finished', updated_at: new Date().toISOString() }).eq('status', 'open').lt('created_at', oneMinAgo).then(function() {});
      supabase.from('rooms').select('id, status, player1_wallet, player2_wallet, player1_name, player2_name, player1_clicks, player2_clicks, game_started_at, game_ends_at, winner_wallet, created_at').in('status', ['open', 'in_progress']).order('created_at', { ascending: false }).limit(20)
        .then(function(r) {
          if (status) status.textContent = '';
          if (r.error) {
            if (status) status.textContent = 'Could not load rooms.';
            if (errEl) { errEl.textContent = r.error.message || 'Error'; errEl.classList.remove('hidden'); }
            list.innerHTML = '';
            return;
          }
          var rooms = (r.data || []).filter(function(room) {
            var s = (room.status || '').toLowerCase();
            return s === 'open' || s === 'in_progress';
          });
          var order = { open: 0, in_progress: 1 };
          rooms.sort(function(a, b) {
            var oa = order[a.status] !== undefined ? order[a.status] : 3;
            var ob = order[b.status] !== undefined ? order[b.status] : 3;
            if (oa !== ob) return oa - ob;
            return new Date(b.created_at) - new Date(a.created_at);
          });
          var me = getPvpPlayerId();
          list.innerHTML = rooms.map(function(room) {
            var p1 = room.player1_wallet || '‚Äî';
            var p2 = room.player2_wallet || '‚Äî';
            var count = (p1 && p1 !== '‚Äî' ? 1 : 0) + (p2 && p2 !== '‚Äî' ? 1 : 0);
            var isOpen = room.status === 'open' && count < 2;
            var isMine = p1 === me || p2 === me;
            var shortId = room.id.slice(0, 8);
            var joinBtn = isOpen && p1 !== me ? '<button type="button" class="pvp-join-btn mt-2 py-1 px-2 border border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10" data-room-id="' + room.id + '">JOIN GAME</button>' : '';
            var enterDuelBtn = room.status === 'in_progress' && isMine ? '<button type="button" class="pvp-enter-duel-btn mt-2 py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-room-id="' + room.id + '">ENTER DUEL</button>' : '';
            var endGameBtn = room.status === 'in_progress' && isMine ? '<button type="button" class="pvp-end-game-btn flex-shrink-0 py-2 px-3 border-2 border-neon-pink text-neon-pink rounded text-[10px] font-bold hover:bg-neon-pink/10 min-h-[36px]" data-room-id="' + room.id + '">END GAME</button>' : '';
            var isCreator = p1 === me;
            var closeBtn = room.status === 'open' && isCreator ? '<button type="button" class="pvp-close-room-btn flex-shrink-0 py-2 px-3 border-2 border-neon-pink text-neon-pink rounded text-[10px] font-bold hover:bg-neon-pink/10 min-h-[36px]" data-room-id="' + room.id + '">CLOSE ROOM</button>' : '';
            var base = (window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl ? window.TON_CONFIG.gameBaseUrl : (window.location.origin + window.location.pathname)).replace(/\/?$/, '');
            var shareLink = base + '/play.html?room=' + room.id;
            var cardAction = isOpen && p1 !== me ? 'join' : (room.status === 'in_progress' && isMine ? 'enter-duel' : '');
            return '<div class="pvp-room-card bg-pixel-panel border-2 border-gray-700 p-3 rounded text-left cursor-pointer hover:border-gray-500" data-room-id="' + room.id + '" data-room-action="' + cardAction + '">' +
              '<div class="text-[10px] text-neon-pink">Room ' + shortId + (isMine ? ' (you)' : '') + (isCreator && room.status === 'open' ? ' ¬∑ You created' : '') + '</div>' +
              '<div class="text-gray-500 text-[9px] mt-1">' + count + '/2 ¬∑ ' + room.status + '</div>' +
              '<div class="mt-2 flex flex-wrap gap-2 items-center">' + closeBtn + endGameBtn + joinBtn + enterDuelBtn +
              '<button type="button" class="pvp-copy-link-btn py-1 px-2 border border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" data-room-id="' + room.id + '" data-room-url="' + shareLink + '">COPY LINK</button>' +
              '</div></div>';
          }).join('');
          if (rooms.length === 0) list.innerHTML = '<p class="text-gray-500 text-[10px] p-3">No rooms yet. Create one above.</p>';
          // Use one delegated click on the list so all buttons and card clicks work
          list.onclick = function(ev) {
            var target = ev.target;
            var roomId = target.getAttribute && target.getAttribute('data-room-id');
            if (!roomId) {
              var card = target.closest && target.closest('.pvp-room-card');
              if (card) {
                roomId = card.getAttribute('data-room-id');
                var action = card.getAttribute('data-room-action');
                if (action === 'join') { ev.preventDefault(); joinPvpRoom(roomId); return; }
                if (action === 'enter-duel') { ev.preventDefault(); enterDuel(roomId); return; }
              }
              return;
            }
            if (target.classList && target.classList.contains('pvp-join-btn')) { ev.preventDefault(); joinPvpRoom(roomId); return; }
            if (target.classList && target.classList.contains('pvp-enter-duel-btn')) { ev.preventDefault(); enterDuel(roomId); return; }
            if (target.classList && target.classList.contains('pvp-close-room-btn')) { ev.preventDefault(); closePvpRoom(roomId); return; }
            if (target.classList && target.classList.contains('pvp-end-game-btn')) { ev.preventDefault(); endPvpGameFromLobby(roomId); return; }
            if (target.classList && target.classList.contains('pvp-copy-link-btn')) {
              ev.preventDefault();
              var url = target.getAttribute('data-room-url');
              if (url && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(function() {
                  var statusEl = document.getElementById('pvp-status');
                  if (statusEl) { statusEl.textContent = 'Room link copied!'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
                });
              }
              return;
            }
            var card = target.closest && target.closest('.pvp-room-card');
            if (card) {
              var action = card.getAttribute('data-room-action');
              if (action === 'join') { ev.preventDefault(); joinPvpRoom(roomId); return; }
              if (action === 'enter-duel') { ev.preventDefault(); enterDuel(roomId); return; }
            }
          };
        })
        .catch(function(e) {
          if (status) status.textContent = '';
          if (errEl) { errEl.textContent = e.message || 'Network error'; errEl.classList.remove('hidden'); }
          list.innerHTML = '';
        });
    }
    function createPvpRoom() {
      var supabase = window.supabaseClient;
      var btn = document.getElementById('pvp-create-room-btn');
      var errEl = document.getElementById('pvp-error');
      if (!supabase) { if (errEl) { errEl.textContent = 'Supabase not configured.'; errEl.classList.remove('hidden'); } return; }
      var name = getPlayerName();
      if (!name) setPlayerName('Player');
      name = getPlayerName();
      if (!window.TonWallet || !window.TonWallet.getAddress()) { showPvpOnboarding('wallet'); return; }
      if (!hasWalletAndStake()) { showPvpOnboarding('card'); return; }
      if (btn) btn.disabled = true;
      var me = getPvpPlayerId();
      supabase.from('rooms').insert({ status: 'open', player1_wallet: me, player1_name: name, stake_amount: PVP_STAKE }).select('id').single()
        .then(function(r) {
          if (btn) btn.disabled = false;
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Failed to create room'; errEl.classList.remove('hidden'); } return; }
          var status = document.getElementById('pvp-status');
          if (status) { status.textContent = 'Room created! Share the link. When someone joins, the duel starts.'; status.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { status.textContent = ''; status.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 4000); }
          loadPvpRooms();
          if (errEl) errEl.classList.add('hidden');
        })
        .catch(function(e) {
          if (btn) btn.disabled = false;
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function closePvpRoom(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var me = getPvpPlayerId();
      supabase.from('rooms').update({ status: 'finished', updated_at: new Date().toISOString() }).eq('id', roomId).eq('status', 'open').eq('player1_wallet', me)
        .then(function(r) {
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Could not close room'; errEl.classList.remove('hidden'); } return; }
          if (errEl) errEl.classList.add('hidden');
          loadPvpRooms();
          var statusEl = document.getElementById('pvp-status');
          if (statusEl) { statusEl.textContent = 'Room closed.'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
        })
        .catch(function(e) {
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function endPvpGameFromLobby(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var me = getPvpPlayerId();
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) { if (errEl) { errEl.textContent = 'Room not found.'; errEl.classList.remove('hidden'); } return; }
        var room = r.data;
        if (room.status === 'finished') {
          loadPvpRooms();
          if (pvpDuelRoomId === roomId) { pvpDuelRoomId = null; pvpDuelMyRole = 0; showDuelLobby(); }
          return;
        }
        var isMine = room.player1_wallet === me || room.player2_wallet === me;
        if (!isMine) { if (errEl) { errEl.textContent = 'You are not in this game.'; errEl.classList.remove('hidden'); } return; }
        var c1 = room.player1_clicks || 0, c2 = room.player2_clicks || 0;
        var winner = c1 > c2 ? room.player1_wallet : (c2 > c1 ? room.player2_wallet : null);
        supabase.from('rooms').update({ status: 'finished', winner_wallet: winner, updated_at: new Date().toISOString() }).eq('id', roomId)
          .then(function(up) {
            if (up.error) { if (errEl) { errEl.textContent = up.error.message || 'Could not end game'; errEl.classList.remove('hidden'); } return; }
            if (errEl) errEl.classList.add('hidden');
            room.status = 'finished';
            room.winner_wallet = winner;
            if (winner) upsertLeaderboardWin(winner, room.player1_wallet === winner ? room.player1_name : room.player2_name);
            if (pvpDuelRoomId === roomId) {
              if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
              if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
              if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
              pvpDuelRoomId = null;
              pvpDuelMyRole = 0;
              showDuelResult(room);
            } else {
              loadPvpRooms();
              var statusEl = document.getElementById('pvp-status');
              if (statusEl) { statusEl.textContent = 'Game ended.'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
            }
          });
      }).catch(function(e) {
        if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
      });
    }
    function joinPvpRoom(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var name = getPlayerName();
      if (!name) setPlayerName('Player');
      name = getPlayerName();
      if (!window.TonWallet || !window.TonWallet.getAddress()) { showPvpOnboarding('wallet', roomId); return; }
      if (!hasWalletAndStake()) { showPvpOnboarding('card', roomId); return; }
      var me = getPvpPlayerId();
      supabase.from('rooms').select('status, player1_wallet, player2_wallet').eq('id', roomId).single().then(function(check) {
        if (check.error || !check.data) { if (errEl) { errEl.textContent = 'Room not found.'; errEl.classList.remove('hidden'); } return; }
        var room = check.data;
        if (room.status !== 'open') { if (errEl) { errEl.textContent = 'Room is full or game already started. No other players can enter.'; errEl.classList.remove('hidden'); } return; }
        if (room.player2_wallet) { if (errEl) { errEl.textContent = 'Room is full. Only 2 players per game.'; errEl.classList.remove('hidden'); } return; }
        if (room.player1_wallet === me) { if (errEl) { errEl.textContent = 'You already created this room. Wait for opponent or close it.'; errEl.classList.remove('hidden'); } return; }
        doJoinPvpRoom(roomId, me, name, errEl);
      });
    }
    function doJoinPvpRoom(roomId, me, name, errEl) {
      var supabase = window.supabaseClient;
      var now = new Date();
      var endsAt = new Date(now.getTime() + PVP_GAME_DURATION_SEC * 1000);
      supabase.from('rooms').update({
        player2_wallet: me,
        player2_name: name,
        status: 'in_progress',
        game_started_at: now.toISOString(),
        game_ends_at: endsAt.toISOString(),
        updated_at: now.toISOString()
      }).eq('id', roomId).eq('status', 'open')
        .then(function(r) {
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Could not join'; errEl.classList.remove('hidden'); } return; }
          loadPvpRooms();
          if (errEl) errEl.classList.add('hidden');
          enterDuel(roomId);
        })
        .catch(function(e) {
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }

    // --- PVP: duel view, realtime clicks, timer, winner, rematch ---
    var pvpDuelRoomId = null;
    var pvpDuelMyRole = 0; // 1 or 2
    var pvpDuelTimerId = null;
    var pvpDuelRealtimeUnsub = null;
    var pvpDuelPollId = null;
    var pvpDuelLastClickAt = 0;

    function showDuelLobby() {
      document.getElementById('pvp-duel-view').classList.add('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-create-card').classList.remove('hidden');
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = '';
      if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
      if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
      if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
      pvpDuelRoomId = null;
      pvpDuelMyRole = 0;
    }
    function enterDuel(roomId) {
      pvpDuelRoomId = roomId;
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = 'none';
      document.getElementById('pvp-duel-view').classList.remove('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-duel-waiting').classList.add('hidden');
      var me = getPvpPlayerId();
      var supabase = window.supabaseClient;
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status === 'finished') { showDuelResult(room); document.getElementById('pvp-duel-view').classList.add('hidden'); document.getElementById('pvp-duel-result').classList.remove('hidden'); var lobbyWrap = document.getElementById('pvp-lobby-wrap'); if (lobbyWrap) lobbyWrap.style.display = 'none'; return; }
        pvpDuelMyRole = room.player1_wallet === me ? 1 : (room.player2_wallet === me ? 2 : 0);
        var youName = pvpDuelMyRole === 1 ? (room.player1_name || 'You') : (room.player2_name || 'You');
        var oppName = pvpDuelMyRole === 1 ? (room.player2_name || 'Opponent') : (room.player1_name || 'Opponent');
        document.getElementById('pvp-duel-you-name').textContent = youName;
        document.getElementById('pvp-duel-opp-name').textContent = oppName;
        document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
        document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
        var endsAt = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
        if (!endsAt && room.status === 'in_progress') {
          document.getElementById('pvp-duel-waiting').classList.remove('hidden');
        }
        startDuelTimer(endsAt);
        subscribeDuelRoom(roomId);
        if (pvpDuelPollId) clearInterval(pvpDuelPollId);
        pvpDuelPollId = setInterval(function() {
          if (!pvpDuelRoomId) { if (pvpDuelPollId) clearInterval(pvpDuelPollId); pvpDuelPollId = null; return; }
          supabase.from('rooms').select('player1_clicks, player2_clicks, status, game_ends_at').eq('id', roomId).single().then(function(r) {
            if (r.error || !r.data) return;
            var room = r.data;
            document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
            document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
            if (room.status === 'finished') { if (pvpDuelPollId) clearInterval(pvpDuelPollId); pvpDuelPollId = null; if (pvpDuelTimerId) clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; endDuelGame(); }
          });
        }, 600);
      });
    }
    function startDuelTimer(endsAtMs) {
      if (pvpDuelTimerId) clearInterval(pvpDuelTimerId);
      function tick() {
        var now = Date.now();
        if (endsAtMs <= 0) return;
        var left = Math.max(0, Math.ceil((endsAtMs - now) / 1000));
        var el = document.getElementById('pvp-duel-timer');
        if (el) el.textContent = '0:' + (left < 10 ? '0' : '') + left;
        if (left <= 0) {
          clearInterval(pvpDuelTimerId);
          pvpDuelTimerId = null;
          endDuelGame();
        }
      }
      tick();
      pvpDuelTimerId = setInterval(tick, 200);
    }
    function subscribeDuelRoom(roomId) {
      var supabase = window.supabaseClient;
      if (!supabase) return;
      if (pvpDuelRealtimeUnsub) pvpDuelRealtimeUnsub();
      var me = getPvpPlayerId();
      var channel = supabase.channel('room-' + roomId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, function(payload) {
        var room = payload.new;
        if (!room || room.id !== roomId) return;
        document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
        document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
        var endsAt = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
        if (endsAt && !pvpDuelTimerId) startDuelTimer(endsAt);
        if (room.status === 'finished') {
          if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
          showDuelResult(room);
        }
      }).subscribe();
      pvpDuelRealtimeUnsub = function() { supabase.removeChannel(channel); };
    }
    function endDuelGame() {
      if (!pvpDuelRoomId) return;
      var supabase = window.supabaseClient;
      supabase.from('rooms').select('*').eq('id', pvpDuelRoomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status === 'finished') { showDuelResult(room); return; }
        var c1 = room.player1_clicks || 0, c2 = room.player2_clicks || 0;
        var winner = c1 > c2 ? room.player1_wallet : (c2 > c1 ? room.player2_wallet : null);
        supabase.from('rooms').update({ status: 'finished', winner_wallet: winner, updated_at: new Date().toISOString() }).eq('id', pvpDuelRoomId).then(function() {
          room.status = 'finished';
          room.winner_wallet = winner;
          showDuelResult(room);
          if (winner) upsertLeaderboardWin(winner, room.player1_wallet === winner ? room.player1_name : room.player2_name);
        });
      });
    }
    function endDuelEarly() {
      if (!pvpDuelRoomId) return;
      if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
      if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
      endDuelGame();
    }
    function showDuelResult(room) {
      if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
      document.getElementById('pvp-duel-view').classList.add('hidden');
      var resultEl = document.getElementById('pvp-duel-result');
      resultEl.classList.remove('hidden');
      var me = getPvpPlayerId();
      var winnerWallet = room.winner_wallet;
      var winName = room.player1_wallet === winnerWallet ? room.player1_name : (room.player2_name || 'Winner');
      if (winnerWallet === me) {
        document.getElementById('pvp-duel-result-title').textContent = 'YOU WIN!';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-green';
        document.getElementById('pvp-duel-result-detail').textContent = 'You\'re on the leaderboard. Loser loses 1 $CARD (transfer can be added later).';
      } else if (winnerWallet) {
        document.getElementById('pvp-duel-result-title').textContent = 'YOU LOSE';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-pink';
        document.getElementById('pvp-duel-result-detail').textContent = winName + ' won. You lose your 1 $CARD stake.';
      } else {
        document.getElementById('pvp-duel-result-title').textContent = 'DRAW';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 text-gray-400';
        document.getElementById('pvp-duel-result-detail').textContent = 'Tie! No winner.';
      }
    }
    function upsertLeaderboardWin(wallet, name) {
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('leaderboard').select('id, pvp_wins, name').eq('wallet_address', wallet).maybeSingle().then(function(r) {
        var row = r.data;
        var wins = (row && (row.pvp_wins || 0)) || 0;
        if (row) {
          supabase.from('leaderboard').update({ pvp_wins: wins + 1, name: name || row.name, updated_at: new Date().toISOString() }).eq('id', row.id).then(function() { if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp(); });
        } else {
          supabase.from('leaderboard').insert({ name: name || 'Player', wallet_address: wallet, tokens: 0, pvp_wins: 1 }).then(function() { if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp(); });
        }
      });
    }
    document.getElementById('pvp-duel-click-btn') && document.getElementById('pvp-duel-click-btn').addEventListener('click', function() {
      if (!pvpDuelRoomId || !pvpDuelMyRole) return;
      var now = Date.now();
      if (now - pvpDuelLastClickAt < PVP_CLICK_COOLDOWN_MS) return;
      pvpDuelLastClickAt = now;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.rpc('increment_pvp_clicks', { room_id: pvpDuelRoomId, player_num: pvpDuelMyRole }).then(function(r) {
        if (r.data && r.data.clicks != null) document.getElementById('pvp-duel-you-clicks').textContent = String(r.data.clicks);
      });
    });
    document.getElementById('pvp-duel-end-game-btn') && document.getElementById('pvp-duel-end-game-btn').addEventListener('click', function() {
      endDuelEarly();
    });
    document.getElementById('pvp-duel-rematch-btn') && document.getElementById('pvp-duel-rematch-btn').addEventListener('click', function() {
      showDuelLobby();
      if (typeof loadPvpRooms === 'function') loadPvpRooms();
      createPvpRoom();
    });
    document.getElementById('pvp-duel-lobby-btn') && document.getElementById('pvp-duel-lobby-btn').addEventListener('click', function() {
      showDuelLobby();
      if (typeof loadPvpRooms === 'function') loadPvpRooms();
    });

    // Creator: when player2 joins, start game (set game_ends_at) and enter duel
    function checkMyRoomStarted(roomId) {
      var me = getPvpPlayerId();
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status !== 'in_progress' || room.player1_wallet !== me) return;
        if (!room.game_ends_at) {
          var now = new Date();
          var endsAt = new Date(now.getTime() + PVP_GAME_DURATION_SEC * 1000);
          supabase.from('rooms').update({ game_started_at: now.toISOString(), game_ends_at: endsAt.toISOString(), updated_at: now.toISOString() }).eq('id', roomId).then(function() { enterDuel(roomId); });
        } else {
          enterDuel(roomId);
        }
      });
    }
    window.enterDuel = enterDuel;
    window.checkMyRoomStarted = checkMyRoomStarted;
    var pvpCreateBtn = document.getElementById('pvp-create-room-btn');
    var pvpRefreshBtn = document.getElementById('pvp-refresh-btn');
    if (pvpCreateBtn) pvpCreateBtn.addEventListener('click', createPvpRoom);
    if (pvpRefreshBtn) pvpRefreshBtn.addEventListener('click', function() { loadPvpRooms(); });
    document.getElementById('pvp-invited-join-btn') && document.getElementById('pvp-invited-join-btn').addEventListener('click', function() {
      var roomId = window._pvpInvitedRoomId || new URLSearchParams(window.location.search).get('room');
      if (roomId) joinPvpRoom(roomId);
    });
    window.loadPvpRooms = loadPvpRooms;

    document.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });
    setInterval(updateClicksPerSecond, 200);

    // Routing
    function getPageFromHash() {
      const hash = (window.location.hash || '#home').slice(1).toLowerCase();
      return hash === '' ? 'home' : hash;
    }
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById('page-' + pageId);
      if (el) el.classList.add('active');
      document.querySelectorAll('.nav-link').forEach(a => {
        a.classList.toggle('text-neon-cyan', a.getAttribute('data-page') === pageId);
        a.classList.toggle('text-gray-400', a.getAttribute('data-page') !== pageId);
      });
      if (pageId === 'friends') {
        if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
        if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
      }
      if (pageId === 'multiplayer') {
        if (typeof window.loadPvpRooms === 'function') window.loadPvpRooms();
        var roomParam = new URLSearchParams(window.location.search).get('room');
        var invitedCard = document.getElementById('pvp-invited-card');
        var invitedRoomEl = document.getElementById('pvp-invited-room-id');
        if (invitedCard) {
          if (roomParam) {
            invitedCard.classList.remove('hidden');
            if (invitedRoomEl) invitedRoomEl.textContent = 'Room: ' + roomParam;
            window._pvpInvitedRoomId = roomParam;
          } else {
            invitedCard.classList.add('hidden');
            window._pvpInvitedRoomId = null;
          }
        }
      }
    }
    window.addEventListener('hashchange', () => showPage(getPageFromHash()));

    // Loading screen: show app when user taps START TAPPING
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    const splashStart = document.getElementById('splash-start');
    function startGame() {
      if (splash) splash.classList.add('hidden');
      if (app) app.classList.remove('hidden');
      updateBountyProgress();
      save();
      showPage(getPageFromHash());
      updateUI();
    }
    if (splashStart) splashStart.addEventListener('click', startGame);

    function createStars() {
      const layer = document.getElementById('stars-layer');
      if (!layer) return;
      for (let i = 0; i < 45; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDuration = (4 + Math.random() * 6) + 's';
        star.style.animationDelay = Math.random() * 8 + 's';
        layer.appendChild(star);
      }
    }

    window.addEventListener('load', () => {
      createStars();
      updateBountyProgress();
      save();
      var params = new URLSearchParams(window.location.search);
      var refParam = params.get('ref');
      if (refParam) localStorage.setItem('tokenClicker_invitedBy', refParam);
      if (params.get('room')) {
        window.location.hash = 'multiplayer';
        window._pvpInvitedRoomId = params.get('room');
        if (typeof window.loadPvpRooms === 'function') setTimeout(window.loadPvpRooms, 300);
      }
      showPage(getPageFromHash());
      updateUI();
      if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
    });
  </script>
</body>
</html>
