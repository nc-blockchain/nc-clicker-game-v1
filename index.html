<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fix GitHub Pages: base URL so scripts/assets load from repo root (e.g. /nc-clicker-game-v1/) -->
  <script>
    (function(){
      var path = location.pathname.replace(/\/?$/, '');
      var basePath = (path === '' ? '/' : path + '/');
      document.write('<base href="' + location.origin + basePath + '" />');
    })();
  </script>
  <title>1N Blockchain Token Clicker ‚Äì Tap to earn $CARD</title>
  <!-- Share preview: opens nicely on mobile when link is shared -->
  <meta property="og:title" content="1N Blockchain Token Clicker" />
  <meta property="og:description" content="Tap the Cardinal to earn tokens. Play on your phone ‚Äì connect wallet, claim $CARD, challenge friends in PVP." />
  <meta property="og:image" content="https://biggleem.github.io/nc-clicker-game-v1/assets/cardinal.png" />
  <meta property="og:url" content="https://biggleem.github.io/nc-clicker-game-v1/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="1N Blockchain Token Clicker" />
  <meta name="twitter:description" content="Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends." />
  <link rel="icon" href="assets/cardinal.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/cardinal.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#0a0a0a',
            neon: {
              cyan: '#00fff7',
              pink: '#ff00aa',
              green: '#00ff88',
              yellow: '#ffff00',
              purple: '#b366ff',
            },
            pixel: { border: '#333', panel: '#1a1a1a' }
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'monospace'],
          },
          boxShadow: {
            neon: '0 0 10px currentColor, 0 0 20px currentColor',
            'neon-sm': '0 0 5px currentColor',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    html, body { -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }
    ::selection { background: transparent; color: inherit; }
    ::-moz-selection { background: transparent; color: inherit; }
    /* Bottom nav: hide scrollbar but keep scroll on small devices */
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    /* Bottom nav: left-aligned, scroll on small screens */
    .bottom-nav-inner { display: flex; flex-wrap: nowrap; justify-content: flex-start; align-items: center; gap: 2px; padding: 6px 8px; min-height: 44px; overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
    .bottom-nav-inner::-webkit-scrollbar { display: none; }
    @media (min-width: 400px) { .bottom-nav-inner { gap: 4px; padding: 8px 10px; } }
    .bottom-nav-link { flex-shrink: 0; padding: 6px 8px; font-size: 8px; border-radius: 6px; white-space: nowrap; }
    @media (min-width: 360px) { .bottom-nav-link { padding: 6px 10px; font-size: 9px; } }
    @media (min-width: 400px) { .bottom-nav-link { padding: 8px 12px; font-size: 10px; } }
    /* Home center: smaller font on small screens */
    .home-center-text { font-size: 8px; }
    @media (min-width: 360px) { .home-center-text { font-size: 9px; } }
    @media (min-width: 400px) { .home-center-text { font-size: 10px; } }
    .home-center-value { font-size: 12px; }
    @media (min-width: 360px) { .home-center-value { font-size: 14px; } }
    @media (min-width: 400px) { .home-center-value { font-size: 16px; } }
    .pixel-border { border: 3px solid #333; image-rendering: pixelated; }
    .neon-text-cyan { color: #00fff7; text-shadow: 0 0 10px #00fff7; }
    .neon-text-pink { color: #ff00aa; text-shadow: 0 0 10px #ff00aa; }
    .neon-text-green { color: #00ff88; text-shadow: 0 0 10px #00ff88; }
    .page { display: none; min-height: calc(100vh - 120px); }
    .page.active { display: block; }
    .nft-clicker { transition: transform 0.05s; box-shadow: 0 0 20px rgba(0,255,247,0.2), 0 0 40px rgba(255,0,170,0.1); }
    .nft-clicker:hover:not(.cooldown) { box-shadow: 0 0 25px rgba(0,255,247,0.35), 0 0 50px rgba(255,0,170,0.2); }
    .pvp-duel-tap-pulse { animation: pvpTapPulse 0.12s ease-out; }
    @keyframes pvpTapPulse { 0% { transform: scale(1); } 40% { transform: scale(0.9); } 100% { transform: scale(1); } }
    .nft-clicker:active { transform: scale(0.97); }
    .nft-clicker.cooldown { opacity: 0.7; pointer-events: none; }
    .nft-clicker.bird-dead { opacity: 0.5; filter: grayscale(0.8); }
    .image-pixel { image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
    /* Bounties: square colored cards + bird card */
    .bounty-row { position: relative; border-radius: 8px; border: 2px solid; }
    .bounty-row.bounty-card-green { border-color: #00ff88; background: rgba(0,255,136,0.12); }
    .bounty-row.bounty-card-yellow { border-color: #ffff00; background: rgba(255,255,0,0.12); }
    .bounty-row.bounty-card-cyan { border-color: #00fff7; background: rgba(0,255,247,0.12); }
    .bounty-row.bounty-card-pink { border-color: #ff00aa; background: rgba(255,0,170,0.12); }
    .bounty-bird-card {
      flex-shrink: 0;
      width: 44px; height: 44px; border: 2px solid; border-radius: 6px;
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); box-shadow: 0 0 8px currentColor;
    }
    .bounty-bird-card img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    .bounty-bird-card.bird-green { border-color: #00ff88; color: #00ff88; }
    .bounty-bird-card.bird-yellow { border-color: #ffff00; color: #ffff00; }
    .bounty-bird-card.bird-cyan { border-color: #00fff7; color: #00fff7; }
    .bounty-bird-card.bird-pink { border-color: #ff00aa; color: #ff00aa; }
    .bounty-collection-card {
      border: 2px solid; border-radius: 8px;
      padding: 0.5rem; text-align: center; min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .bounty-collection-card .bird-thumb { width: 36px; height: 36px; object-fit: contain; image-rendering: pixelated; margin-bottom: 4px; }
    .bounty-collection-card .bird-name { font-size: 9px; line-height: 1.2; color: #e5e5e5; }
    .bounty-collection-card .bird-reward { font-size: 8px; color: currentColor; }
    .bounty-collection-card .bounty-card-claim { color: inherit; background: transparent; }
    .bounty-collection-card.bird-green { border-color: #00ff88; color: #00ff88; background: rgba(0,255,136,0.2); }
    .bounty-collection-card.bird-yellow { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.2); }
    .bounty-collection-card.bird-cyan { border-color: #00fff7; color: #00fff7; background: rgba(0,255,247,0.2); }
    .bounty-collection-card.bird-pink { border-color: #ff00aa; color: #ff00aa; background: rgba(255,0,170,0.2); }
    /* TO CLAIM list: same design as Boosts (gray panels) */
    #bounties-list.bounty-toclaim-list .bounty-row { border-color: #374151; background: #1a1a1a; }
    #bounties-list.bounty-toclaim-list .bounty-bird-card { display: none; }
    .bounty-category { margin-bottom: 1.25rem; }
    .bounty-category-title { font-size: 11px; font-weight: bold; color: #9ca3af; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
    /* Loading / intro screen */
    .splash-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: #0a0a0a;
      background-image: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.3) 0%, rgba(120,20,40,0.12) 40%, transparent 70%);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .splash-card {
      background: #0a0a0a;
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      position: relative;
      border: 2px solid rgba(255,200,50,0.6);
      box-shadow: 0 0 30px rgba(255,180,0,0.4), 0 0 60px rgba(255,140,0,0.2), inset 0 0 0 1px rgba(255,220,100,0.2);
    }
    .splash-card::before {
      content: '';
      position: absolute;
      top: -2px; left: -2px; right: -2px; bottom: -2px;
      border-radius: 26px;
      background: linear-gradient(135deg, #FFD700, #FF8C00, #FFD700);
      z-index: -1;
      opacity: 0.4;
      filter: blur(8px);
    }
    .splash-title { color: #FFD700; font-size: 10px; margin-bottom: 16px; text-shadow: 0 0 12px rgba(255,215,0,0.8); line-height: 1.5; }
    .splash-cardinal { width: 160px; height: auto; margin: 16px auto; border-radius: 12px; image-rendering: pixelated; display: block; }
    .splash-text { color: rgba(255,255,255,0.9); font-size: 9px; line-height: 1.6; margin-bottom: 20px; }
    .splash-btn {
      background: linear-gradient(135deg, #FF8C00, #FFD700);
      color: #000;
      border: none;
      padding: 16px 32px;
      font-size: 10px;
      font-weight: 900;
      border-radius: 50px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      box-shadow: 0 8px 24px rgba(255,180,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .splash-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255,200,0,0.6); }
    .splash-btn:active { transform: translateY(0); }
    #app.hidden { display: none !important; }

    /* Red radial gradient background */
    body { position: relative; min-height: 100vh; }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.35) 0%, rgba(120,20,40,0.15) 40%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    #app { position: relative; z-index: 1; }

    /* Rising tiny stars */
    .stars-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .star {
      position: absolute;
      width: 2px; height: 2px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      animation: starRise linear infinite;
      box-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    @keyframes starRise {
      0% { transform: translateY(100vh) translateX(0) scale(1); opacity: 0; }
      8% { opacity: 0.8; }
      92% { opacity: 0.6; }
      100% { transform: translateY(-20px) translateX(0) scale(0.5); opacity: 0; }
    }

    /* Click effect: feather with falling physics */
    .feather-fall {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      width: 52px;
      height: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      transform-origin: center center;
      animation: featherFall 1.4s ease-in forwards;
    }
    .feather-fall.feather-sway1 { animation: featherFall1 1.4s ease-in forwards; }
    .feather-fall.feather-sway2 { animation: featherFall2 1.4s ease-in forwards; }
    .feather-fall.feather-sway3 { animation: featherFall3 1.4s ease-in forwards; }
    @keyframes featherFall {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(120px) translateX(0) rotate(180deg) scale(0.9); }
    }
    @keyframes featherFall1 {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(130px) translateX(18px) rotate(220deg) scale(0.9); }
    }
    @keyframes featherFall2 {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(125px) translateX(-15px) rotate(-160deg) scale(0.9); }
    }
    @keyframes featherFall3 {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0.6; transform: translateY(115px) translateX(8px) rotate(90deg) scale(0.9); }
    }

    /* Click effect: +N token text */
    .tap-value-float {
      position: fixed;
      pointer-events: none;
      z-index: 101;
      font-size: 14px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 1px 2px rgba(0,0,0,0.8);
      animation: valueFloat 1s ease-out forwards;
      transform: translate(-50%, -50%);
    }
    @keyframes valueFloat {
      0% { opacity: 1; transform: translate(-50%, -50%) translateY(0) scale(1.2); }
      70% { opacity: 1; transform: translate(-50%, -50%) translateY(-50px) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) translateY(-70px) scale(0.9); }
    }
  </style>
</head>
<body class="bg-dark text-white font-pixel text-xs md:text-sm antialiased" style="background:#0a0a0a; color:#fff; margin:0; min-height:100vh;">
  <!-- Rising stars layer (behind app) -->
  <div class="stars-layer" id="stars-layer" aria-hidden="true"></div>

  <!-- Onboarding: multi-step intro for new users (first visit only) -->
  <div id="onboarding-overlay" class="hidden" style="position:fixed;inset:0;z-index:9999;background:#0a0a0a;display:none;align-items:center;justify-content:center;padding:20px;">
    <button type="button" id="onboarding-skip" class="absolute top-4 right-4 text-gray-500 text-[8px] hover:text-gray-300 py-1 px-2 z-10">Skip intro</button>
    <div class="onboarding-card bg-black border-2 border-neon-cyan rounded-xl p-6 max-w-sm w-full text-center relative" style="box-shadow:0 0 40px rgba(0,255,247,0.3);">
      <div id="onboarding-step" class="step">
        <!-- Step content injected by JS -->
      </div>
      <div class="flex justify-between items-center mt-6 gap-3">
        <button type="button" id="onboarding-back" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700 hidden">BACK</button>
        <div class="flex-1"></div>
        <button type="button" id="onboarding-next" class="py-2 px-5 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10 font-bold">NEXT</button>
      </div>
      <div class="flex justify-center gap-1.5 mt-3">
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="0"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="1"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="2"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="3"></span>
        <span class="onboarding-dot w-2 h-2 rounded-full bg-gray-600" data-step="4"></span>
      </div>
    </div>
  </div>

  <!-- First-time only: set name when you first get the app (no name in storage) -->
  <div id="welcome-name-modal" class="hidden" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">WELCOME TO 1N TOKEN CLICKER</p>
      <p class="text-gray-300 text-[9px] mb-4">Enter your display name once. You can change it later in Wallet ‚Üí Settings.</p>
      <input type="text" id="welcome-name-input" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <button type="button" id="welcome-name-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE</button>
    </div>
  </div>
  <!-- Profile: change name (opened from Wallet ‚Üí Settings) -->
  <div id="profile-name-modal" class="hidden" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">CHANGE DISPLAY NAME</p>
      <input type="text" id="profile-name-input" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <div class="flex gap-2 justify-center">
        <button type="button" id="profile-name-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE</button>
        <button type="button" id="profile-name-cancel" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CANCEL</button>
      </div>
    </div>
  </div>
  <!-- Notifications center -->
  <div id="notifications-modal" class="hidden" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-yellow rounded-lg p-4 max-w-sm w-full max-h-[80vh] flex flex-col">
      <p class="text-neon-yellow text-[10px] font-bold mb-3">NOTIFICATIONS</p>
      <div class="mb-3">
        <p class="text-gray-400 text-[9px] mb-1">Browser notifications: <span id="notifications-permission">‚Äî</span></p>
        <button type="button" id="notifications-request-btn" class="py-1 px-2 border-2 border-neon-yellow text-neon-yellow rounded text-[9px] hover:bg-neon-yellow/10">ENABLE</button>
      </div>
      <div class="text-gray-500 text-[9px] mb-1">Recent activity</div>
      <ul id="notifications-list" class="space-y-1 text-[9px] text-gray-300 overflow-y-auto flex-1 min-h-0 max-h-48"></ul>
      <button type="button" id="notifications-close" class="mt-3 py-2 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CLOSE</button>
    </div>
  </div>
  <!-- Wallet Settings modal (opened by SETTINGS button in Wallet) -->
  <div id="wallet-settings-modal" class="hidden" style="position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full max-h-[90vh] overflow-y-auto">
      <p class="text-neon-cyan text-[10px] font-bold mb-3">SETTINGS</p>
      <div class="space-y-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <span class="text-[10px] text-gray-400">Player ¬∑ Profile name:</span>
          <span id="wallet-settings-name" class="neon-text-cyan text-[10px]">‚Äî</span>
          <button type="button" id="wallet-settings-btn" class="py-1 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10">CHANGE NAME</button>
        </div>
        <div class="flex flex-wrap items-center justify-between gap-2">
          <span class="text-[10px] text-gray-400">Game ¬∑ Feather effects:</span>
          <label class="inline-flex items-center gap-1.5 cursor-pointer">
            <input type="checkbox" id="wallet-setting-feather-effects" class="rounded border-2 border-gray-500 bg-black text-neon-cyan focus:ring-neon-cyan" checked />
            <span id="wallet-setting-feather-label" class="text-[9px] text-gray-300">On</span>
          </label>
        </div>
      </div>
      <div class="mt-4 pt-3 border-t border-gray-700">
        <p class="text-neon-cyan text-[10px] font-bold mb-2">WALLET HELP</p>
        <div class="p-2 rounded border-2 border-neon-green/50 bg-neon-green/5 mb-2">
          <p class="text-neon-green text-[9px] font-bold">üì± On phone</p>
          <p class="text-gray-300 text-[9px] mt-1">Open <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="text-neon-cyan underline">biggleem.github.io/nc-clicker-game-v1</a> in your browser. Tap CONNECT WALLET ‚Üí Tonkeeper opens ‚Üí Approve. No desktop needed.</p>
        </div>
        <p class="text-gray-400 text-[9px] mb-1">1) Tap CONNECT WALLET on the Wallet tab ‚Üí 2) Approve in Tonkeeper (green button) ‚Üí 3) Return here. If it didn‚Äôt detect, tap below:</p>
        <button type="button" id="ton-check-connection-btn" class="w-full mt-2 py-2 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 font-bold">I APPROVED ‚Äì CHECK CONNECTION</button>
        <p class="text-neon-yellow text-[8px] mt-2">On desktop localhost: run the backend or use the <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="underline">live site</a>.</p>
      </div>
      <div class="mt-4 pt-3 border-t border-gray-700">
        <p class="text-neon-yellow text-[10px] font-bold mb-2">LEVELS & DEATH RULES</p>
        <p class="text-gray-400 text-[9px] mb-1">Levels (by total taps):</p>
        <ul class="text-gray-500 text-[8px] mb-2 space-y-0.5 list-none">
          <li>ü•ö Egg: 0</li>
          <li>üê£ Chick Lv.1‚Äì5: 1‚Äì199, 200‚Äì399, 400‚Äì599, 600‚Äì799, 800‚Äì999</li>
          <li>üê¶ Adult Lv.1‚Äì5: 1,000‚Äì1,199 ‚Ä¶ 1,800‚Äì1,999</li>
          <li>üèÖ Elite Lv.1‚Äì5: 2,000‚Äì2,199 ‚Ä¶ 2,800‚Äì2,999</li>
          <li>üèÜ Legend Lv.1‚Äì5: 3,000+</li>
        </ul>
        <p class="text-gray-400 text-[9px] mb-1">Death: If away &gt; 48 hours, your bird dies üïäÔ∏è</p>
        <p class="text-gray-400 text-[9px] mb-1">Revive: Pay tokens (20 or 10% of balance, min 10) to revive.</p>
      </div>
      <button type="button" id="wallet-settings-replay-intro" class="mt-2 w-full py-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:bg-gray-700">REPLAY INTRO</button>
      <button type="button" id="wallet-settings-modal-close" class="mt-4 w-full py-2 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">CLOSE</button>
    </div>
  </div>
  <!-- Wallet: no wallet / connect help ‚Äì Back to game or open install in new tab -->
  <div id="wallet-connect-help-modal" class="hidden" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-4 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-2">CONNECT WALLET</p>
      <p class="text-gray-300 text-[9px] mb-3">Don't have Tonkeeper? Install or sign in opens in a new tab so you can keep playing here.</p>
      <div class="flex flex-col gap-2">
        <a id="wallet-help-download-link" href="https://tonkeeper.com" target="_blank" rel="noopener noreferrer" class="py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10">DOWNLOAD TONKEEPER (NEW TAB)</a>
        <button type="button" id="wallet-help-back-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">BACK TO GAME</button>
      </div>
    </div>
  </div>
  <!-- Death modal: bird died from inactivity, revive with tokens -->
  <div id="death-modal" class="hidden" style="position:fixed;inset:0;z-index:10003;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-gray-600 rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-4xl mb-2">üïäÔ∏è</p>
      <p class="text-neon-yellow text-[10px] font-bold mb-2">YOUR BIRD DIED</p>
      <p class="text-gray-500 text-[8px] mb-1">Deaths: <span id="death-count">0</span></p>
      <p class="text-gray-300 text-[9px] mb-3">You were away too long. Use tokens to revive and keep playing.</p>
      <p id="death-revive-cost" class="text-neon-cyan text-[10px] mb-3">Revive cost: 20 tokens</p>
      <p id="death-balance" class="text-gray-500 text-[9px] mb-3">Your balance: 0 tokens</p>
      <div class="flex gap-2 justify-center flex-wrap">
        <button type="button" id="death-revive-btn" class="py-2 px-5 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 font-bold disabled:opacity-50 disabled:cursor-not-allowed">REVIVE</button>
        <a href="#bounties" id="death-earn-tokens" class="py-2 px-5 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">EARN TOKENS</a>
      </div>
      <p class="text-gray-600 text-[8px] mt-2">Rules in Wallet ‚Üí Settings</p>
    </div>
  </div>
  <!-- Share confirmation: proof user shared on platform -->
  <div id="share-confirm-modal" class="hidden" style="position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-cyan text-[10px] font-bold mb-2">SHARE CONFIRMATION</p>
      <p id="share-confirm-msg" class="text-gray-300 text-[9px] mb-4">Did you share the game?</p>
      <div class="flex gap-2 justify-center flex-wrap">
        <button type="button" id="share-confirm-yes" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">Yes, I shared</button>
        <button type="button" id="share-confirm-no" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">Not yet</button>
      </div>
    </div>
  </div>
  <!-- PVP Onboarding: name + enough in-game tokens for wager -->
  <div id="pvp-onboarding-modal" class="hidden" style="position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;">
    <div class="bg-pixel-panel border-2 border-neon-pink rounded-lg p-6 max-w-sm w-full text-center">
      <p class="text-neon-pink text-[10px] font-bold mb-3">JOIN PVP DUEL</p>
      <p id="pvp-onboarding-msg" class="text-gray-300 text-[9px] mb-4">Enter your name to play. You need enough in-game tokens for the room's wager.</p>
      <input type="text" id="pvp-onboarding-name" placeholder="Your name" maxlength="20" class="w-full bg-black border-2 border-gray-600 rounded px-3 py-2 text-white text-[10px] mb-3" />
      <div id="pvp-onboarding-step-connect" class="hidden mb-3">
        <p class="text-neon-yellow text-[9px] mb-2">You need enough in-game tokens for the room's wager. Earn tokens by tapping or claiming bounties.</p>
        <a href="#wallet" class="inline-block py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px]">GO TO WALLET</a>
      </div>
      <div id="pvp-onboarding-step-card" class="hidden mb-3">
        <p class="text-neon-yellow text-[9px]">You need at least the room's wager in in-game tokens. Loser pays winner.</p>
      </div>
      <div class="flex gap-2 justify-center flex-wrap">
        <button type="button" id="pvp-onboarding-save" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">SAVE & CONTINUE</button>
        <button type="button" id="pvp-onboarding-skip" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">SKIP (lobby only)</button>
      </div>
    </div>
  </div>

  <div id="app" style="display:block;">
  <!-- Top Bar: 1N BLOCKCHAIN logo + tokens + PVP/bell -->
  <header class="sticky top-0 z-50 bg-black/90 border-b-2 border-pixel-border backdrop-blur-sm">
    <div class="max-w-lg mx-auto px-4 py-2 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <img src="assets/cardinal.png" alt="1N BLOCKCHAIN" class="h-8 md:h-9 object-contain object-left flex-shrink-0" />
        <span class="text-gray-400 shrink-0">TOKENS</span>
        <span id="top-tokens" class="neon-text-cyan font-bold shrink-0">0</span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <a href="#multiplayer" class="p-2 rounded border-2 border-neon-pink text-neon-pink hover:shadow-neon-sm text-[10px]">PVP</a>
        <button type="button" id="notifications-btn" aria-label="Notifications" class="p-2 rounded border-2 border-gray-500 text-gray-400 hover:border-neon-yellow hover:text-neon-yellow">üîî</button>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto pb-20">
    <!-- Home -->
    <section id="page-home" class="page active p-4">
      <!-- Metric windows above NFT -->
      <div class="grid grid-cols-3 gap-2 mb-4">
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 home-center-text">TAP/SEC</div>
          <div id="clicks-per-sec" class="neon-text-green home-center-value">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 home-center-text">TOTAL TAPS</div>
          <div id="total-clicks" class="neon-text-cyan home-center-value">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 home-center-text">TAP RATE</div>
          <div id="token-rate" class="neon-text-yellow home-center-value">1 / 10</div>
        </div>
      </div>
      <!-- NFT Clicker -->
      <div class="flex justify-center">
        <div class="relative inline-block">
          <button
            type="button"
            id="nft-clicker"
            class="nft-clicker w-40 h-40 md:w-52 md:h-52 pixel-border rounded-lg bg-black/80 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden relative"
            aria-label="Click to earn tokens"
          >
            <img src="assets/cardinal.png" alt="NFT Cardinal" class="w-full h-full object-contain image-pixel" />
            <span id="bird-level-badge" class="absolute bottom-1 right-1 flex items-center gap-0.5 bg-black/80 rounded px-1 border border-gray-600" title="Level"><span class="text-base">ü•ö</span><span class="text-[8px] text-gray-400">Egg</span></span>
          </button>
        </div>
      </div>
      <p class="text-center text-gray-500 mt-4 home-center-text">Every 10 clicks = 1 token</p>
      <!-- Stats bar (match reference) -->
      <div class="mt-4 bg-pixel-panel border-2 border-gray-700 rounded px-3 py-2 home-center-text flex flex-wrap justify-center gap-x-4 gap-y-1">
        <span>Tap Power: <span id="home-power" class="text-neon-yellow">1</span>x</span>
        <span>Multiplier: <span id="home-mult" class="text-neon-yellow">1.0</span>x</span>
        <span>Regen: <span id="home-regen" class="text-neon-yellow">1</span>/s</span>
      </div>
      <!-- Badges -->
      <div class="mt-4 text-center">
        <div class="text-gray-500 home-center-text mb-2">üèÜ BADGES</div>
        <div class="flex justify-center gap-2 flex-wrap">
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel" id="badge-1" title="First Click">üëÜ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-2" title="100 Clicks">‚≠ê</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-3" title="500 Clicks">üåü</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-4" title="1K Clicks">üéØ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-5" title="5K Clicks">üí´</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-6" title="10K Clicks">üöÄ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-7" title="25K Clicks">üëë</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-8" title="7-Day Streak">üî•</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-9" title="First PVP Win">üèÜ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-10" title="First Friend">üë•</div>
        </div>
      </div>
      <!-- Upgrade strip (match reference) -->
      <div class="mt-4 grid grid-cols-3 gap-2">
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-cyan/50 transition-colors">
          <div class="text-neon-yellow text-base mb-1">‚ö°</div>
          <div class="home-center-text">Power</div>
          <div class="text-gray-500 home-center-text">Cost: 50</div>
        </a>
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-green/50 transition-colors">
          <div class="text-neon-green text-base mb-1">üîã</div>
          <div class="home-center-text">Autoclick</div>
          <div class="text-gray-500 home-center-text">Cost: 100</div>
        </a>
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-cyan/50 transition-colors">
          <div class="text-neon-cyan text-base mb-1">‚ôªÔ∏è</div>
          <div class="home-center-text">Regen</div>
          <div class="text-gray-500 home-center-text">Cost: 75</div>
        </a>
      </div>
    </section>

    <!-- Boosts -->
    <section id="page-boosts" class="page p-4">
      <h2 class="text-neon-cyan mb-4 border-b-2 border-gray-700 pb-2">BOOSTS</h2>
      <p class="text-gray-400 mb-4">Spend tokens on click buffs, autoclickers, and cooldown reductions.</p>
      <!-- Badges above first boost -->
      <div class="mb-4 p-3 bg-black border-2 border-gray-700 rounded">
        <div class="text-gray-500 text-[9px] mb-2">üèÜ BADGES</div>
        <div class="flex justify-center gap-2 flex-wrap">
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel" id="badge-boost-1" title="First Click">üëÜ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-2" title="100 Clicks">‚≠ê</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-3" title="500 Clicks">üåü</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-4" title="1K Clicks">üéØ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-5" title="5K Clicks">üí´</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-6" title="10K Clicks">üöÄ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-7" title="25K Clicks">üëë</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-8" title="7-Day Streak">üî•</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-9" title="First PVP Win">üèÜ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-boost-10" title="First Friend">üë•</div>
        </div>
      </div>
      <div class="space-y-4">
        <div class="boost-category">
          <div class="text-neon-yellow text-[10px] font-bold mb-2 uppercase tracking-wider">‚ö° Tap Power</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+1 token per 10 clicks (2x)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">50 tokens</div></div>
              <button type="button" id="buy-tappower" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="50" data-boost="tapPower">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+1 token per 10 clicks (3x)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">150 tokens</div></div>
              <button type="button" id="buy-tappower3" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="150" data-boost="tapPower3">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>+1 token per 10 clicks (4x)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">350 tokens</div></div>
              <button type="button" id="buy-tappower4" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="350" data-boost="tapPower4">BUY</button>
            </div>
          </div>
        </div>
        <div class="boost-category">
          <div class="text-neon-green text-[10px] font-bold mb-2 uppercase tracking-wider">üîã Autoclickers</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Autoclicker (1/s)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">100 tokens</div></div>
              <button type="button" id="buy-autoclicker" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="100" data-boost="autoclicker">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Turbo Autoclicker (2/s)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">250 tokens</div></div>
              <button type="button" id="buy-turbo-autoclicker" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="250" data-boost="turboAutoclicker">BUY</button>
            </div>
          </div>
        </div>
        <div class="boost-category">
          <div class="text-neon-cyan text-[10px] font-bold mb-2 uppercase tracking-wider">‚ôªÔ∏è Cooldowns</div>
          <div class="space-y-2">
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Shorter cooldown (200ms)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">75 tokens</div></div>
              <button type="button" id="buy-cooldown" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="75" data-boost="cooldown">BUY</button>
            </div>
            <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
              <div class="flex-1 min-w-0"><span>Super cooldown (150ms)</span><div class="text-neon-yellow text-[10px] font-bold mt-1">150 tokens</div></div>
              <button type="button" id="buy-super-cooldown" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="150" data-boost="superCooldown">BUY</button>
            </div>
          </div>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Your balance: <span id="boosts-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Bounties -->
    <section id="page-bounties" class="page p-4">
      <h2 class="text-neon-green mb-4 border-b-2 border-gray-700 pb-2">BOUNTIES</h2>
      <p class="text-gray-400 mb-4">Daily rewards, weekly challenges, click milestones. Collect the bird cards!</p>
      <div id="graduating-bounty-bar" class="mb-3 p-3 bg-black border-2 border-neon-green/50 rounded text-[9px]">
        <div class="text-neon-green font-bold mb-1">ACTIVE & NEXT BOUNTY</div>
        <div id="grad-current" class="text-gray-300">Active: 500 taps ‚Äî 0/500 ¬∑ 15 tokens</div>
        <div id="grad-next" class="text-gray-500">Next: 1,000 taps ‚Äî 0/1,000 ¬∑ 25 tokens</div>
      </div>
      <div class="flex gap-2 mb-3">
        <button type="button" id="bounty-tab-toclaim" class="bounty-tab border-2 border-neon-green text-neon-green px-3 py-1.5 rounded text-[10px] hover:bg-neon-green/10 bg-neon-green/10">Available</button>
        <button type="button" id="bounty-tab-claimed" class="bounty-tab border-2 border-gray-500 text-gray-400 px-3 py-1.5 rounded text-[10px] hover:bg-gray-700">Claimed</button>
      </div>
      <div class="space-y-3 hidden" id="bounties-list">
        <!-- Daily Bounties -->
        <div class="bounty-category">
          <div class="bounty-category-title">Daily Bounties</div>
          <div class="space-y-3">
        <div id="bounty-daily" class="bounty-row bounty-card-yellow p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="daily" data-bounty-name="Daily login" data-bounty-reward="5">
          <div class="flex-1 min-w-0"><div>Daily login</div><div class="text-[10px] text-gray-400">Claim once per day</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 5 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-yellow"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-daily" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="daily" data-reward="5">CLAIM</button>
          </div>
        </div>
        <div id="bounty-50today" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="50today" data-bounty-name="50 taps today" data-bounty-reward="5">
          <div class="flex-1 min-w-0"><div>50 taps today</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-50-progress">0</span>/50</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 5 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-50" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="50today" data-reward="5">CLAIM</button>
          </div>
        </div>
        <div id="bounty-100" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="100today" data-bounty-name="100 clicks today" data-bounty-reward="10">
          <div class="flex-1 min-w-0"><div>100 clicks today</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-100-progress">0</span>/100</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 10 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-100" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="100today" data-reward="10">CLAIM</button>
          </div>
        </div>
        <div id="bounty-weekly" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="weekly" data-bounty-name="Weekly 500" data-bounty-reward="50">
          <div class="flex-1 min-w-0"><div>Weekly: 500 clicks</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-weekly-progress">0</span>/500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 50 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-weekly" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="weekly" data-reward="50">CLAIM</button>
          </div>
        </div>
        <div id="bounty-share" class="bounty-row bounty-card-cyan p-3 flex flex-col gap-2" data-bounty-id="share" data-bounty-name="Share the game" data-bounty-reward="15">
          <div class="flex flex-wrap justify-between items-center gap-2">
            <div class="flex-1 min-w-0"><div>Share the game</div><div class="text-[10px] text-gray-400">Share via X, Telegram, Facebook, email, or SMS once per day</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 15 tokens</div></div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <div class="bounty-bird-card bird-cyan"><img src="assets/cardinal.png" alt="" /></div>
              <button type="button" id="claim-share" class="bounty-claim border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50" data-id="share" data-reward="15">CLAIM</button>
            </div>
          </div>
          <div class="flex flex-wrap gap-1.5 pt-1 border-t border-gray-700/50">
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="x" title="Share on X">ùïè</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="telegram" title="Share on Telegram">Telegram</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="facebook" title="Share on Facebook">Facebook</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="email" title="Share via Email">Email</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="sms" title="Share via SMS">SMS</button>
            <button type="button" class="share-bounty-btn py-1.5 px-2 border border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-cyan/50 hover:text-neon-cyan" data-share="copy" title="Copy link">Copy</button>
          </div>
        </div>
          </div>
        </div>
        <!-- Graduating Bounties -->
        <div class="bounty-category">
          <div class="bounty-category-title">Graduating Bounties</div>
          <div class="space-y-3">
        <div id="bounty-500" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="500total" data-bounty-name="500 taps" data-bounty-reward="15">
          <div class="flex-1 min-w-0"><div>500 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-500-progress">0</span>/500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 15 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-500" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="500total" data-reward="15">CLAIM</button>
          </div>
        </div>
        <div id="bounty-1000" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="1000total" data-bounty-name="1,000 taps" data-bounty-reward="25">
          <div class="flex-1 min-w-0"><div>1,000 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-1000-progress">0</span>/1,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 25 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-1000" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="1000total" data-reward="25">CLAIM</button>
          </div>
        </div>
        <div id="bounty-2500" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="2500total" data-bounty-name="2,500 taps" data-bounty-reward="50">
          <div class="flex-1 min-w-0"><div>2,500 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-2500-progress">0</span>/2,500</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 50 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-2500" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="2500total" data-reward="50">CLAIM</button>
          </div>
        </div>
        <div id="bounty-5000" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="5000total" data-bounty-name="5,000 taps" data-bounty-reward="100">
          <div class="flex-1 min-w-0"><div>5,000 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-5000-progress">0</span>/5,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 100 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-5000" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="5000total" data-reward="100">CLAIM</button>
          </div>
        </div>
        <div id="bounty-10000" class="bounty-row bounty-card-green p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="10000total" data-bounty-name="10,000 taps" data-bounty-reward="200">
          <div class="flex-1 min-w-0"><div>10,000 total taps</div><div class="text-[10px] text-gray-400">Progress: <span id="bounty-10000-progress">0</span>/10,000</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 200 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-green"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-10000" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="10000total" data-reward="200">CLAIM</button>
          </div>
        </div>
          </div>
        </div>
        <!-- Fun Bounties -->
        <div class="bounty-category">
          <div class="bounty-category-title">Fun Bounties</div>
          <div class="space-y-3">
        <div id="bounty-firstfriend" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="firstfriend" data-bounty-name="First friend" data-bounty-reward="10">
          <div class="flex-1 min-w-0"><div>Add your first friend</div><div class="text-[10px] text-gray-400">Paste a friend's code or link</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 10 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-firstfriend" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="firstfriend" data-reward="10">CLAIM</button>
          </div>
        </div>
        <div id="bounty-lucky7" class="bounty-row bounty-card-yellow p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="lucky777" data-bounty-name="Lucky 777" data-bounty-reward="17">
          <div class="flex-1 min-w-0"><div>Lucky 777</div><div class="text-[10px] text-gray-400">Reach 777 total taps</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 17 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-yellow"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-lucky7" class="bounty-claim border-2 border-neon-yellow text-neon-yellow px-3 py-1 rounded text-[10px] hover:bg-neon-yellow/10 disabled:opacity-50" data-id="lucky777" data-reward="17">CLAIM</button>
          </div>
        </div>
        <div id="bounty-speed" class="bounty-row bounty-card-pink p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="speeddemon" data-bounty-name="Speed demon" data-bounty-reward="20">
          <div class="flex-1 min-w-0"><div>Speed demon</div><div class="text-[10px] text-gray-400">Hit 8+ taps in one second</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 20 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-pink"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-speed" class="bounty-claim border-2 border-neon-pink text-neon-pink px-3 py-1 rounded text-[10px] hover:bg-neon-pink/10 disabled:opacity-50" data-id="speeddemon" data-reward="20">CLAIM</button>
          </div>
        </div>
        <div id="bounty-hoarder" class="bounty-row bounty-card-cyan p-3 flex flex-wrap justify-between items-center gap-2" data-bounty-id="hoarder" data-bounty-name="Token hoarder" data-bounty-reward="25">
          <div class="flex-1 min-w-0"><div>Token hoarder</div><div class="text-[10px] text-gray-400">Reach 100 tokens balance</div><div class="text-neon-yellow text-[10px] font-bold mt-1">Reward: 25 tokens</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <div class="bounty-bird-card bird-cyan"><img src="assets/cardinal.png" alt="" /></div>
            <button type="button" id="claim-hoarder" class="bounty-claim border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50" data-id="hoarder" data-reward="25">CLAIM</button>
          </div>
        </div>
          </div>
        </div>
      </div>
      <div id="bounties-toclaim-cards" class="hidden grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
      <p id="bounties-toclaim-empty" class="hidden text-gray-500 text-[10px] py-4">All bounties claimed! Check Claimed for your collection.</p>
      <div id="bounties-claimed-cards" class="hidden grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
      <p id="bounties-claimed-empty" class="hidden text-gray-500 text-[10px] py-4">No claimed bounties yet. Claim bounties from the Available tab!</p>
      <p class="text-gray-500 mt-4 text-[10px]">Balance: <span id="bounties-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Friends -->
    <section id="page-friends" class="page p-4">
      <h2 class="text-neon-pink mb-4 border-b-2 border-gray-700 pb-2">FRIENDS</h2>
      <p class="text-gray-400 mb-4">Leaderboard & invite friends. Edit your name in Wallet ‚Üí Settings.</p>
      <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">TOP CLICKERS (by tokens)</div>
        <ol id="leaderboard-list" class="space-y-1 text-[10px] list-decimal list-inside text-gray-300 min-h-[24px]">
          <li class="text-gray-500">Loading‚Ä¶</li>
        </ol>
      </div>
      <div class="bg-pixel-panel border-2 border-neon-pink/30 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">FRIENDS (INVITED)</div>
        <p class="text-gray-500 text-[9px] mb-1">People who used your invite link appear here.</p>
        <ol id="friends-invited-list" class="space-y-1 text-[10px] min-h-[24px]">
          <li class="text-gray-500">Loading‚Ä¶</li>
        </ol>
      </div>
      <div class="bg-pixel-panel border-2 border-neon-cyan/30 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">ADD FRIEND BY INVITE CODE</div>
        <p class="text-gray-500 text-[9px] mb-2">Enter a friend's invite code; their name will appear in your list below.</p>
        <div class="flex gap-2 flex-wrap items-center mb-2">
          <input type="text" id="friend-code-input" placeholder="e.g. REFABC12" maxlength="20" class="flex-1 min-w-[120px] bg-black border-2 border-gray-600 rounded px-3 py-2 text-neon-cyan text-[10px] uppercase" />
          <button type="button" id="friend-code-add-btn" class="py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10 whitespace-nowrap">ADD</button>
        </div>
        <p id="friend-code-feedback" class="text-[9px] min-h-[14px] hidden"></p>
        <div class="text-[10px] text-gray-500 mt-2 mb-1">FRIENDS (ADDED BY CODE)</div>
        <ol id="friends-added-list" class="space-y-1 text-[10px] min-h-[24px]">
          <li class="text-gray-500">Loading‚Ä¶</li>
        </ol>
      </div>
      <button type="button" id="invite-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 min-h-[44px] text-[10px]">COPY INVITE LINK</button>
      <p id="invite-feedback" class="text-neon-green text-[10px] mt-2 hidden">Link copied! Send it to friends ‚Äì when they open it on their phone, the game loads and your code is applied.</p>
      <p class="text-gray-500 mt-2 text-[10px]">Your code: <span id="referral-code" class="neon-text-cyan">------</span></p>
    </section>

    <!-- Wallet -->
    <section id="page-wallet" class="page p-4">
      <div class="flex items-center justify-between gap-2 mb-4 border-b-2 border-gray-700 pb-2">
        <h2 class="text-neon-yellow">WALLET</h2>
        <button type="button" id="wallet-settings-open-btn" class="py-1.5 px-3 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10">SETTINGS</button>
      </div>
      <!-- Balances -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
        <div class="grid grid-cols-2 gap-4 text-center">
          <div>
            <div class="text-gray-500 text-[10px]">IN-GAME</div>
            <div id="wallet-balance" class="text-xl neon-text-cyan">0</div>
            <div class="text-gray-500 text-[9px]">tokens</div>
          </div>
          <div>
            <div class="text-gray-500 text-[10px]">$CARD (on-chain)</div>
            <div id="card-balance" class="text-xl neon-text-cyan">‚Äî</div>
            <div class="text-gray-500 text-[9px]" id="wallet-config-hint">connect wallet</div>
          </div>
        </div>
      </div>
      <!-- TON Wallet + $CARD -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
        <div class="text-gray-500 text-[10px] mb-2">TON WALLET</div>
        <p id="wallet-file-warning" class="hidden text-neon-yellow text-[9px] mb-2 p-2 bg-black/50 rounded">Wallet needs the game opened from a URL. Run in project folder: <code class="text-[8px]">npx serve -p 3001</code> then open <code class="text-[8px]">http://localhost:3001</code></p>
        <div id="wallet-connect-area">
          <p id="wallet-connection-status" class="text-[9px] min-h-[14px] mb-2 text-gray-400"></p>
          <p class="text-gray-500 text-[8px] mb-1">Opens in a new tab so you can stay in the game. Return here after approving.</p>
          <button type="button" id="ton-connect-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 text-[10px]">CONNECT WALLET (Tonkeeper / Telegram)</button>
          <p class="text-gray-500 text-[9px] mt-2">Need help? Open SETTINGS (top right) for instructions and I approved ‚Äì check connection.</p>
          <p class="text-neon-yellow text-[9px] mt-1 hidden" id="wallet-localhost-hint">On desktop localhost: run the backend so the wallet can connect. Or use the <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="underline">live site</a>.</p>
        </div>
        <div id="wallet-connected-area" class="hidden">
          <div class="text-[10px] text-gray-400 mb-1">Address</div>
          <div id="ton-address" class="text-neon-green text-[10px] break-all mb-2">‚Äî</div>
          <button type="button" id="ton-disconnect-btn" class="py-1 px-2 border border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-800">DISCONNECT</button>
        </div>
      </div>
      <!-- Swap: $CARD to in-game tokens -->
      <div class="bg-pixel-panel border-2 border-neon-green/30 p-4 rounded mb-4" id="swap-area">
        <div class="flex items-center justify-between gap-2 mb-2">
          <span class="text-gray-500 text-[10px]">SWAP $CARD ‚Üí TOKENS</span>
          <span id="ton-price-display" class="text-[9px] text-gray-400">TON: ‚Äî</span>
        </div>
        <p class="text-[10px] text-gray-400 mb-2">Exchange on-chain $CARD for in-game tokens to play.</p>
        <div class="flex gap-2 items-center flex-wrap">
          <input type="number" id="swap-amount" min="1" step="1" placeholder="$CARD amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-28 text-[10px]" />
          <button type="button" id="swap-btn" class="border-2 border-neon-green text-neon-green px-3 py-2 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50">SWAP</button>
        </div>
        <p class="text-gray-500 text-[9px] mt-1">Rate: 1 $CARD = 10 in-game tokens</p>
        <p id="swap-feedback" class="text-[10px] mt-2 hidden"></p>
      </div>
      <!-- Withdraw: tokens to $CARD -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4" id="withdraw-area">
        <div class="text-gray-500 text-[10px] mb-2">WITHDRAW TOKENS ‚Üí $CARD</div>
        <p id="withdraw-area-hint" class="text-[10px] text-gray-400 mb-2">Convert in-game tokens to on-chain $CARD (sent to your connected wallet).</p>
        <div class="flex gap-2 items-center flex-wrap">
          <input type="number" id="withdraw-amount" min="1" placeholder="Amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-24 text-[10px]" />
          <button type="button" id="withdraw-btn" class="border-2 border-neon-green text-neon-green px-3 py-2 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50">WITHDRAW</button>
        </div>
        <p id="withdraw-feedback" class="text-[10px] mt-2 hidden"></p>
      </div>
      <!-- Backend / Admin (black square); shown when backendUrl is set -->
      <div id="wallet-backend-square" class="bg-black border-2 border-gray-700 p-4 rounded mb-4 hidden">
        <p class="text-gray-500 text-[9px] mb-2">BACKEND</p>
        <div class="flex flex-wrap gap-2">
          <a id="wallet-backend-link" href="#" target="_blank" rel="noopener noreferrer" class="py-2 px-3 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-800 hover:text-white">OPEN BACKEND</a>
          <a id="wallet-admin-setup-link" href="#" target="_blank" rel="noopener noreferrer" class="py-2 px-3 border-2 border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-800 hover:text-white">ADMIN SETUP</a>
        </div>
      </div>
    </section>

    <!-- Multiplayer -->
    <section id="page-multiplayer" class="page p-4">
      <h2 class="text-neon-pink mb-4 border-b-2 border-gray-700 pb-2">MULTIPLAYER</h2>
      <p class="text-gray-400 mb-4">Share the game. When friends open the link on their phone, they can play and challenge you.</p>
      <!-- PVP wins leaderboard ‚Äì at top of PVP page -->
      <div class="bg-pixel-panel border-2 border-neon-pink/30 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">PVP DUEL WINS (TOP 5)</div>
        <ol id="leaderboard-pvp-list" class="space-y-1 text-[10px] list-decimal list-inside text-gray-300 min-h-[24px]">
          <li class="text-gray-500">Loading‚Ä¶</li>
        </ol>
      </div>
      <!-- Invited to duel: shown when URL has ?room= (open room link) -->
      <div id="pvp-invited-card" class="hidden mb-4 p-4 rounded-lg border-2 border-neon-cyan bg-neon-cyan/5">
        <p class="text-neon-cyan text-[10px] font-bold mb-1">YOU‚ÄôRE INVITED TO A DUEL</p>
        <p class="text-gray-300 text-[9px] mb-3">Open this link to join the room and play. Enter your name and have enough in-game tokens for the wager, then join.</p>
        <button type="button" id="pvp-invited-join-btn" class="w-full py-3 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] font-bold hover:bg-neon-green/10 min-h-[48px]">JOIN & PLAY</button>
        <p id="pvp-invited-room-id" class="text-gray-500 text-[8px] mt-2 truncate"></p>
      </div>
      <!-- Share game: link that opens on mobile -->
      <div class="bg-pixel-panel border-2 border-neon-pink/50 p-4 rounded mb-4">
        <p class="text-neon-pink text-[10px] font-bold mb-2">üì± SHARE GAME</p>
        <p class="text-gray-400 text-[9px] mb-3">Send this link ‚Äì it opens in the browser on any device. On mobile, they tap to play and can join PVP.</p>
        <div class="flex gap-2 flex-wrap items-center">
          <button type="button" id="share-game-btn" class="py-2 px-4 border-2 border-neon-pink text-neon-pink rounded text-[10px] hover:bg-neon-pink/10 active:scale-[0.98] min-h-[44px]">COPY GAME LINK</button>
          <button type="button" id="share-game-native-btn" class="py-2 px-4 border-2 border-neon-cyan text-neon-cyan rounded text-[10px] hover:bg-neon-cyan/10 active:scale-[0.98] min-h-[44px] hidden">SHARE (APP)</button>
        </div>
        <p id="share-game-feedback" class="text-neon-green text-[9px] mt-2 hidden">Link copied! Paste in a message ‚Äì friend opens it on their phone to play.</p>
      </div>
      <div id="pvp-lobby-wrap">
      <p class="text-gray-500 text-[9px] mb-3">Lobby: 2-player rooms. Create a new room or join an open one.</p>
      <!-- Create new room ‚Äì always visible -->
      <div id="pvp-create-card" class="bg-pixel-panel border-2 border-neon-green/60 p-4 rounded mb-4">
        <p class="text-neon-green text-[10px] font-bold mb-2">‚ûï CREATE NEW ROOM</p>
        <p class="text-gray-400 text-[9px] mb-2">Wager in-game tokens. Loser pays winner. Choose stake:</p>
        <div class="flex flex-wrap gap-2 mb-2">
          <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50" data-stake="2">2</button>
          <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-neon-green text-neon-green rounded text-[9px] bg-neon-green/10" data-stake="5">5</button>
          <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50" data-stake="7">7</button>
          <button type="button" class="pvp-stake-btn py-1.5 px-2 border-2 border-gray-600 text-gray-400 rounded text-[9px] hover:border-neon-green/50" data-stake="10">10</button>
        </div>
        <p class="text-gray-500 text-[8px] mb-1">Or custom wager (tokens):</p>
        <div class="flex flex-wrap gap-2 items-center mb-3">
          <input type="number" id="pvp-custom-stake" min="1" max="999" placeholder="e.g. 20" class="w-16 bg-black border-2 border-gray-600 rounded px-2 py-1 text-[10px] text-white" />
          <span class="text-gray-500 text-[9px]">‚Äî joiner accepts by joining</span>
        </div>
        <div class="flex flex-wrap gap-2">
          <button type="button" id="pvp-create-room-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 min-h-[44px]">CREATE ROOM</button>
          <button type="button" id="pvp-refresh-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700 min-h-[44px]">REFRESH LIST</button>
        </div>
      </div>
      <!-- Play vs Computer: no friends / no stake needed -->
      <div class="bg-pixel-panel border-2 border-neon-yellow/60 p-4 rounded mb-4">
        <p class="text-neon-yellow text-[10px] font-bold mb-2">üñ•Ô∏è PLAY VS COMPUTER</p>
        <p class="text-gray-400 text-[9px] mb-3">No friends online? Tap against the computer. No wallet or stake required. Practice only.</p>
        <button type="button" id="pvp-vs-computer-btn" class="py-2 px-4 border-2 border-neon-yellow text-neon-yellow rounded text-[10px] hover:bg-neon-yellow/10 min-h-[44px]">PLAY VS COMPUTER</button>
      </div>

      <p id="pvp-status" class="text-[9px] text-gray-500 mb-2 min-h-[14px]"></p>
      <p class="text-gray-500 text-[9px] mb-1">Open rooms first, then recent. Stake is in-game tokens ‚Äî loser pays winner.</p>
      <div id="pvp-rooms-list" class="grid grid-cols-1 gap-2">
        <!-- Rooms loaded from Supabase -->
      </div>
      <p id="pvp-error" class="text-neon-pink text-[9px] mt-2 hidden"></p>
      </div>

      <!-- Duel view: side-by-side clicker (shown when in active game) -->
      <div id="pvp-duel-view" class="hidden mt-4">
        <p class="text-neon-pink text-[10px] font-bold mb-2 text-center">CLICK RACE ‚Äî 30 SEC</p>
        <p id="pvp-duel-timer" class="text-center text-neon-yellow text-sm mb-3">0:30</p>
        <div class="grid grid-cols-2 gap-3">
          <div id="pvp-duel-you" class="bg-pixel-panel border-2 border-neon-cyan rounded-lg p-3 text-center">
            <p id="pvp-duel-you-name" class="text-neon-cyan text-[10px] font-bold truncate">You</p>
            <p id="pvp-duel-you-clicks" class="text-2xl neon-text-cyan">0</p>
            <button type="button" id="pvp-duel-click-btn" class="nft-clicker w-24 h-24 pixel-border rounded-lg bg-black/80 mt-2 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden disabled:opacity-50 disabled:pointer-events-none" aria-label="Click to score">
              <img src="assets/cardinal.png" alt="Tap" class="w-full h-full object-contain image-pixel" />
            </button>
          </div>
          <div id="pvp-duel-opponent" class="bg-pixel-panel border-2 border-gray-600 rounded-lg p-3 text-center">
            <p id="pvp-duel-opp-name" class="text-gray-400 text-[10px] font-bold truncate">Opponent</p>
            <p id="pvp-duel-opp-clicks" class="text-2xl text-gray-300">0</p>
            <div class="w-24 h-24 pixel-border rounded-lg bg-black/80 mt-2 mx-auto flex items-center justify-center text-3xl text-gray-600">?</div>
          </div>
        </div>
        <p id="pvp-duel-waiting" class="text-center text-gray-500 text-[9px] mt-2 hidden">Waiting for opponent‚Ä¶ Share the room link.</p>
        <div class="mt-3 text-center">
          <button type="button" id="pvp-duel-end-game-btn" class="py-2 px-4 border-2 border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10">END GAME</button>
        </div>
      </div>

      <!-- Duel result: winner / loser + 60s rematch window -->
      <div id="pvp-duel-result" class="hidden mt-4 p-4 rounded-lg border-2 text-center">
        <p id="pvp-duel-result-title" class="text-lg font-bold mb-2">‚Äî</p>
        <p id="pvp-duel-result-detail" class="text-[10px] text-gray-400 mb-2">‚Äî</p>
        <p id="pvp-duel-rematch-countdown" class="text-[9px] text-neon-cyan mb-2 hidden">Rematch ‚Äî 60s</p>
        <div class="flex gap-2 justify-center flex-wrap">
          <button type="button" id="pvp-duel-rematch-btn" class="py-2 px-4 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10">REMATCH</button>
          <button type="button" id="pvp-duel-lobby-btn" class="py-2 px-4 border-2 border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-700">BACK TO LOBBY</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav: left-aligned, responsive so full menu fits on screen -->
  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-black/95 border-t-2 border-pixel-border max-w-lg mx-auto">
    <div class="bottom-nav-inner">
      <a href="#home" class="nav-link bottom-nav-link" data-page="home">HOME</a>
      <a href="#boosts" class="nav-link bottom-nav-link" data-page="boosts">BOOSTS</a>
      <a href="#bounties" class="nav-link bottom-nav-link" data-page="bounties">BOUNTIES</a>
      <a href="#friends" class="nav-link bottom-nav-link" data-page="friends">FRIENDS</a>
      <a href="#wallet" class="nav-link bottom-nav-link" data-page="wallet">WALLET</a>
    </div>
  </nav>
  </div>

  <script src="ton-config.js"></script>
  <script src="supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.anonKey && typeof window.supabase !== 'undefined') {
      window.supabaseClient = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);
    }
  </script>
  <script src="dist/wallet.js" onerror="console.warn('Wallet script failed to load')"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2/dist/tonconnect-ui.min.js"></script>
  <script>
    // --- Constants ---
    const CLICKS_PER_TOKEN = 10;
    const COOLDOWN_BASE_MS = 280;
    const COOLDOWN_REDUCED_MS = 200;
    const COOLDOWN_SUPER_MS = 150;
    const DEATH_IDLE_HOURS = 48;
    const REVIVE_BASE_COST = 20;
    const REVIVE_PERCENT = 0.1;
    const REVIVE_MIN = 10;
    const BIRD_LEVELS = [
      { taps: 0, emoji: 'ü•ö', name: 'Egg' },
      { taps: 1, emoji: 'üê£', name: 'Chick Lv.1' },
      { taps: 200, emoji: 'üê£', name: 'Chick Lv.2' },
      { taps: 400, emoji: 'üê£', name: 'Chick Lv.3' },
      { taps: 600, emoji: 'üê§', name: 'Chick Lv.4' },
      { taps: 800, emoji: 'üê§', name: 'Chick Lv.5' },
      { taps: 1000, emoji: 'üê¶', name: 'Adult Lv.1' },
      { taps: 1200, emoji: 'üê¶', name: 'Adult Lv.2' },
      { taps: 1400, emoji: 'üê¶', name: 'Adult Lv.3' },
      { taps: 1600, emoji: 'üê¶', name: 'Adult Lv.4' },
      { taps: 1800, emoji: 'üê¶', name: 'Adult Lv.5' },
      { taps: 2000, emoji: 'üèÖ', name: 'Elite Lv.1' },
      { taps: 2200, emoji: 'üèÖ', name: 'Elite Lv.2' },
      { taps: 2400, emoji: 'üèÖ', name: 'Elite Lv.3' },
      { taps: 2600, emoji: 'üèÖ', name: 'Elite Lv.4' },
      { taps: 2800, emoji: 'üèÖ', name: 'Elite Lv.5' },
      { taps: 3000, emoji: 'üèÜ', name: 'Legend Lv.1' },
      { taps: 3200, emoji: 'üèÜ', name: 'Legend Lv.2' },
      { taps: 3400, emoji: 'üèÜ', name: 'Legend Lv.3' },
      { taps: 3600, emoji: 'üèÜ', name: 'Legend Lv.4' },
      { taps: 3800, emoji: 'üèÜ', name: 'Legend Lv.5' }
    ];

    // --- State (load from localStorage) ---
    let totalClicks = parseInt(localStorage.getItem('tokenClicker_totalClicks') || '0', 10);
    let tokens = parseInt(localStorage.getItem('tokenClicker_tokens') || '', 10);
    if (isNaN(tokens) || tokens < 0) tokens = Math.floor(totalClicks / CLICKS_PER_TOKEN);
    let tapPower = parseInt(localStorage.getItem('tokenClicker_tapPower') || '1', 10);
    let hasAutoclicker = localStorage.getItem('tokenClicker_autoclicker') === '1';
    let hasTurboAutoclicker = localStorage.getItem('tokenClicker_turboAutoclicker') === '1';
    let hasCooldownBoost = localStorage.getItem('tokenClicker_cooldown') === '1';
    let hasSuperCooldownBoost = localStorage.getItem('tokenClicker_superCooldown') === '1';
    let lastDailyClaim = localStorage.getItem('tokenClicker_lastDailyClaim') || '';
    let lastShareClaim = localStorage.getItem('tokenClicker_lastShareClaim') || '';
    let claimed100Today = localStorage.getItem('tokenClicker_claimed100Today') === '1';
    let claimedWeekly = localStorage.getItem('tokenClicker_claimedWeekly') === '1';
    let claimed50Today = localStorage.getItem('tokenClicker_claimed50Today') === '1';
    let claimedFirstFriend = localStorage.getItem('tokenClicker_claimedFirstFriend') === '1';
    let claimed500total = localStorage.getItem('tokenClicker_claimed500total') === '1';
    let claimed1000total = localStorage.getItem('tokenClicker_claimed1000total') === '1';
    let claimed2500total = localStorage.getItem('tokenClicker_claimed2500total') === '1';
    let claimed5000total = localStorage.getItem('tokenClicker_claimed5000total') === '1';
    let claimed10000total = localStorage.getItem('tokenClicker_claimed10000total') === '1';
    let claimedLucky777 = localStorage.getItem('tokenClicker_claimedLucky777') === '1';
    let claimedSpeedDemon = localStorage.getItem('tokenClicker_speedDemonClaimed') === '1';
    let claimedHoarder = localStorage.getItem('tokenClicker_claimedHoarder') === '1';
    let currentBountyTab = localStorage.getItem('tokenClicker_bountyTab') || 'toclaim';
    let lastDate = localStorage.getItem('tokenClicker_lastDate') || '';
    let clicksToday = parseInt(localStorage.getItem('tokenClicker_clicksToday') || '0', 10);
    let weekStartKey = localStorage.getItem('tokenClicker_weekStart') || '';
    let weeklyClicks = parseInt(localStorage.getItem('tokenClicker_weeklyClicks') || '0', 10);
    let lastActivityAt = parseInt(localStorage.getItem('tokenClicker_lastActivityAt') || String(Date.now()), 10);
    let isDead = localStorage.getItem('tokenClicker_isDead') === '1';
    let deathCount = parseInt(localStorage.getItem('tokenClicker_deathCount') || '0', 10);

    let lastClickTime = 0;
    let clicksInLastSecond = 0;
    let lastSecondTime = Date.now();
    let autoclickerInterval = null;

    function todayKey() { return new Date().toISOString().slice(0, 10); }
    function weekKey() {
      const d = new Date();
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().slice(0, 10);
    }

    // --- DOM ---
    const nftClicker = document.getElementById('nft-clicker');
    const topTokens = document.getElementById('top-tokens');
    const walletBalance = document.getElementById('wallet-balance');
    const totalClicksEl = document.getElementById('total-clicks');
    const clicksPerSecEl = document.getElementById('clicks-per-sec');
    const tokenRateEl = document.getElementById('token-rate');
    const clickCountLabel = document.getElementById('click-count-label');

    function cooldownMs() { return hasSuperCooldownBoost ? COOLDOWN_SUPER_MS : (hasCooldownBoost ? COOLDOWN_REDUCED_MS : COOLDOWN_BASE_MS); }

    var lastTokensSyncAt = 0;
    var TOKENS_SYNC_INTERVAL_MS = 5000;
    function syncTokensToLeaderboard() {
      var wallet = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!wallet || wallet.indexOf('guest_') === 0) return;
      var supabase = window.supabaseClient;
      if (!supabase || Date.now() - lastTokensSyncAt < TOKENS_SYNC_INTERVAL_MS) return;
      lastTokensSyncAt = Date.now();
      supabase.from('leaderboard').select('id').eq('wallet_address', wallet).maybeSingle().then(function(r) {
        var row = r.data;
        if (row) {
          supabase.from('leaderboard').update({ tokens: Math.max(0, tokens), updated_at: new Date().toISOString() }).eq('id', row.id).then(function() {});
        }
      });
    }
    function save() {
      localStorage.setItem('tokenClicker_totalClicks', String(totalClicks));
      localStorage.setItem('tokenClicker_tokens', String(tokens));
      localStorage.setItem('tokenClicker_tapPower', String(tapPower));
      localStorage.setItem('tokenClicker_autoclicker', hasAutoclicker ? '1' : '0');
      localStorage.setItem('tokenClicker_turboAutoclicker', hasTurboAutoclicker ? '1' : '0');
      localStorage.setItem('tokenClicker_cooldown', hasCooldownBoost ? '1' : '0');
      localStorage.setItem('tokenClicker_superCooldown', hasSuperCooldownBoost ? '1' : '0');
      localStorage.setItem('tokenClicker_lastDailyClaim', lastDailyClaim);
      localStorage.setItem('tokenClicker_lastShareClaim', lastShareClaim);
      localStorage.setItem('tokenClicker_claimed100Today', claimed100Today ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedWeekly', claimedWeekly ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed50Today', claimed50Today ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedFirstFriend', claimedFirstFriend ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed500total', claimed500total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed1000total', claimed1000total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed2500total', claimed2500total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed5000total', claimed5000total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimed10000total', claimed10000total ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedLucky777', claimedLucky777 ? '1' : '0');
      localStorage.setItem('tokenClicker_speedDemonClaimed', claimedSpeedDemon ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedHoarder', claimedHoarder ? '1' : '0');
      localStorage.setItem('tokenClicker_bountyTab', currentBountyTab);
      localStorage.setItem('tokenClicker_lastDate', lastDate);
      localStorage.setItem('tokenClicker_clicksToday', String(clicksToday));
      localStorage.setItem('tokenClicker_weekStart', weekStartKey);
      localStorage.setItem('tokenClicker_weeklyClicks', String(weeklyClicks));
      localStorage.setItem('tokenClicker_lastActivityAt', String(lastActivityAt));
      localStorage.setItem('tokenClicker_isDead', isDead ? '1' : '0');
      localStorage.setItem('tokenClicker_deathCount', String(deathCount));
      if (typeof syncTokensToLeaderboard === 'function') syncTokensToLeaderboard();
    }

    function getBirdLevel(taps) {
      let level = BIRD_LEVELS[0];
      for (let i = BIRD_LEVELS.length - 1; i >= 0; i--) {
        if (taps >= BIRD_LEVELS[i].taps) { level = BIRD_LEVELS[i]; break; }
      }
      return level;
    }
    function getReviveCost() {
      const percentCost = Math.ceil(tokens * REVIVE_PERCENT);
      return Math.max(REVIVE_MIN, Math.max(REVIVE_BASE_COST, percentCost));
    }
    function reviveBird() {
      const cost = getReviveCost();
      if (tokens < cost) return;
      tokens -= cost;
      isDead = false;
      lastActivityAt = Date.now();
      save();
      updateUI();
    }
    function checkDeath() {
      const idleMs = Date.now() - lastActivityAt;
      const idleHours = idleMs / (1000 * 60 * 60);
      if (idleHours >= DEATH_IDLE_HOURS && !isDead) {
        isDead = true;
        deathCount++;
        save();
      }
    }

    function getBountyClaimed(id) {
      switch (id) {
        case 'daily': return lastDailyClaim === todayKey();
        case '50today': return claimed50Today;
        case '100today': return claimed100Today;
        case 'weekly': return claimedWeekly;
        case 'share': return lastShareClaim === todayKey();
        case 'firstfriend': return claimedFirstFriend;
        case '500total': return claimed500total;
        case '1000total': return claimed1000total;
        case '2500total': return claimed2500total;
        case '5000total': return claimed5000total;
        case '10000total': return claimed10000total;
        case 'lucky777': return claimedLucky777;
        case 'speeddemon': return claimedSpeedDemon;
        case 'hoarder': return claimedHoarder;
        default: return false;
      }
    }
    function switchBountyTab(tab) {
      currentBountyTab = tab;
      var isClaimed = tab === 'claimed';
      var list = document.getElementById('bounties-list');
      var toclaimCardsEl = document.getElementById('bounties-toclaim-cards');
      var claimedCardsEl = document.getElementById('bounties-claimed-cards');
      var claimedCount = 0;
      var claimedRows = [];
      var toclaimCount = 0;
      if (list) {
        list.querySelectorAll('.bounty-row').forEach(function(el) {
          var id = el.getAttribute('data-bounty-id');
          var claimed = getBountyClaimed(id);
          if (claimed) {
            claimedCount++;
            var cardEl = el.querySelector('.bounty-bird-card');
            var birdClass = cardEl ? (cardEl.className.match(/\bbird-\w+/) || ['bird-green'])[0] : 'bird-green';
            claimedRows.push({ id: id, name: el.getAttribute('data-bounty-name') || id, reward: el.getAttribute('data-bounty-reward') || '', birdClass: birdClass });
            el.classList.add('hidden');
          } else {
            toclaimCount++;
            el.classList.remove('hidden');
          }
        });
        if (isClaimed) {
          list.classList.add('hidden');
          list.classList.remove('bounty-toclaim-list');
        } else {
          list.classList.toggle('hidden', toclaimCount === 0);
          list.classList.add('bounty-toclaim-list');
        }
      }
      if (toclaimCardsEl) toclaimCardsEl.classList.add('hidden');
      if (claimedCardsEl) {
        claimedCardsEl.classList.toggle('hidden', !isClaimed || claimedCount === 0);
        claimedCardsEl.innerHTML = '';
        if (isClaimed && claimedCount > 0) {
          claimedRows.forEach(function(r) {
            var card = document.createElement('div');
            card.className = 'bounty-collection-card ' + r.birdClass;
            card.innerHTML = '<img src="assets/cardinal.png" alt="" class="bird-thumb image-pixel" /><span class="bird-name">' + (r.name || r.id) + '</span><span class="bird-reward">+' + r.reward + ' tokens</span>';
            claimedCardsEl.appendChild(card);
          });
        }
      }
      var toclaimEmptyEl = document.getElementById('bounties-toclaim-empty');
      if (toclaimEmptyEl) toclaimEmptyEl.classList.toggle('hidden', isClaimed || toclaimCount > 0);
      var claimedEmptyEl = document.getElementById('bounties-claimed-empty');
      if (claimedEmptyEl) claimedEmptyEl.classList.toggle('hidden', !isClaimed || claimedCount > 0);
      var toclaimTabBtn = document.getElementById('bounty-tab-toclaim');
      var claimedTabBtn = document.getElementById('bounty-tab-claimed');
      if (toclaimTabBtn) toclaimTabBtn.className = 'bounty-tab border-2 px-3 py-1.5 rounded text-[10px] ' + (isClaimed ? 'border-gray-500 text-gray-400 hover:bg-gray-700' : 'border-neon-green text-neon-green hover:bg-neon-green/10 bg-neon-green/10');
      if (claimedTabBtn) claimedTabBtn.className = 'bounty-tab border-2 px-3 py-1.5 rounded text-[10px] ' + (isClaimed ? 'border-neon-green text-neon-green hover:bg-neon-green/10 bg-neon-green/10' : 'border-gray-500 text-gray-400 hover:bg-gray-700');
    }
    function updateBountyProgress() {
      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) {
        clicksToday = 0;
        claimed100Today = false;
        claimed50Today = false;
        lastDate = today;
      }
      if (week !== weekStartKey) {
        weeklyClicks = 0;
        claimedWeekly = false;
        weekStartKey = week;
      }
    }

    function updateUI() {
      if (topTokens) topTokens.textContent = tokens;
      if (walletBalance) walletBalance.textContent = tokens;
      const boostsBal = document.getElementById('boosts-balance');
      const bountiesBal = document.getElementById('bounties-balance');
      if (boostsBal) boostsBal.textContent = tokens;
      if (bountiesBal) bountiesBal.textContent = tokens;
      if (totalClicksEl) totalClicksEl.textContent = totalClicks;
      if (clickCountLabel) clickCountLabel.textContent = totalClicks;
      if (tokenRateEl) tokenRateEl.textContent = tapPower + ' / 10';
      const homePower = document.getElementById('home-power');
      const homeMult = document.getElementById('home-mult');
      const homeRegen = document.getElementById('home-regen');
      if (homePower) homePower.textContent = tapPower;
      if (homeMult) homeMult.textContent = tapPower + '.0';
      if (homeRegen) homeRegen.textContent = hasTurboAutoclicker ? '2' : (hasAutoclicker ? '1' : '0');
      updateBadges();
      updateBoostsUI();
      updateBountiesUI();
      updateGraduatingBountyBar();
      updateLeaderboard();
      updateLevelBadge();
      var dm = document.getElementById('death-modal');
      var onHome = document.getElementById('page-home') && document.getElementById('page-home').classList.contains('active');
      if (isDead && onHome) {
        var costEl = document.getElementById('death-revive-cost');
        var balEl = document.getElementById('death-balance');
        var revBtn = document.getElementById('death-revive-btn');
        if (dm) { dm.classList.remove('hidden'); dm.style.display = 'flex'; }
        if (costEl) costEl.textContent = 'Revive cost: ' + getReviveCost() + ' tokens';
        if (balEl) balEl.textContent = 'Your balance: ' + tokens + ' tokens';
        if (revBtn) revBtn.disabled = tokens < getReviveCost();
        var dcEl = document.getElementById('death-count');
        if (dcEl) dcEl.textContent = deathCount;
      } else {
        if (dm) { dm.classList.add('hidden'); dm.style.display = 'none'; }
      }
    }
    function updateLevelBadge() {
      var badge = document.getElementById('bird-level-badge');
      var clicker = document.getElementById('nft-clicker');
      if (badge) {
        if (isDead) {
          badge.innerHTML = '<span class="text-base">üïäÔ∏è</span><span class="text-[8px] text-gray-400">Dead</span>';
          badge.title = 'Dead ‚Äì revive with tokens';
        } else {
          var level = getBirdLevel(totalClicks);
          badge.innerHTML = '<span class="text-base">' + level.emoji + '</span><span class="text-[8px] text-gray-400">' + level.name + '</span>';
          badge.title = level.name + ' (' + totalClicks + ' taps)';
        }
      }
      if (clicker) clicker.classList.toggle('bird-dead', isDead);
    }

    function updateGraduatingBountyBar() {
      const GRADUATING = [
        { id: '500total', target: 500, reward: 15, name: '500 taps' },
        { id: '1000total', target: 1000, reward: 25, name: '1,000 taps' },
        { id: '2500total', target: 2500, reward: 50, name: '2,500 taps' },
        { id: '5000total', target: 5000, reward: 100, name: '5,000 taps' },
        { id: '10000total', target: 10000, reward: 200, name: '10,000 taps' }
      ];
      const getClaimed = (id) => {
        if (id === '500total') return claimed500total;
        if (id === '1000total') return claimed1000total;
        if (id === '2500total') return claimed2500total;
        if (id === '5000total') return claimed5000total;
        if (id === '10000total') return claimed10000total;
        return false;
      };
      let current = null, next = null;
      for (let i = 0; i < GRADUATING.length; i++) {
        const g = GRADUATING[i];
        if (!getClaimed(g.id)) {
          if (!current) { current = g; next = GRADUATING[i + 1] || null; break; }
        }
      }
      const curEl = document.getElementById('grad-current');
      const nextEl = document.getElementById('grad-next');
      if (curEl) {
        if (current) {
          const prog = Math.min(totalClicks, current.target);
          curEl.textContent = 'Active: ' + current.name + ' ‚Äî ' + prog + '/' + current.target.toLocaleString() + ' ¬∑ ' + current.reward + ' tokens';
          curEl.classList.remove('text-gray-500');
          curEl.classList.add('text-gray-300');
        } else {
          curEl.textContent = 'All graduating bounties claimed!';
          curEl.classList.add('text-neon-green');
        }
      }
      if (nextEl) {
        if (next) {
          const prog = Math.min(totalClicks, next.target);
          nextEl.textContent = 'Next: ' + next.name + ' ‚Äî ' + prog + '/' + next.target.toLocaleString() + ' ¬∑ ' + next.reward + ' tokens';
          nextEl.classList.remove('hidden');
        } else {
          nextEl.textContent = '';
          nextEl.classList.add('hidden');
        }
      }
    }

    function updateBadges() {
      const firstPvpWin = localStorage.getItem('tokenClicker_firstPvpWin') === '1';
      const firstFriend = !!localStorage.getItem('tokenClicker_invitedBy');
      const pairs = [
        [['badge-1', 'badge-boost-1'], totalClicks >= 1],
        [['badge-2', 'badge-boost-2'], totalClicks >= 100],
        [['badge-3', 'badge-boost-3'], totalClicks >= 500],
        [['badge-4', 'badge-boost-4'], totalClicks >= 1000],
        [['badge-5', 'badge-boost-5'], totalClicks >= 5000],
        [['badge-6', 'badge-boost-6'], totalClicks >= 10000],
        [['badge-7', 'badge-boost-7'], totalClicks >= 25000],
        [['badge-8', 'badge-boost-8'], false],
        [['badge-9', 'badge-boost-9'], firstPvpWin],
        [['badge-10', 'badge-boost-10'], firstFriend]
      ];
      pairs.forEach(([ids, unlocked]) => {
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.classList.toggle('opacity-50', !unlocked);
          el.classList.toggle('border-neon-yellow', !!unlocked);
          el.classList.toggle('border-gray-600', !unlocked);
        });
      });
    }

    function updateBoostsUI() {
      document.querySelectorAll('.boost-btn').forEach(btn => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        let owned = false;
        if (boost === 'tapPower') owned = tapPower >= 2;
        else if (boost === 'tapPower3') owned = tapPower >= 3;
        else if (boost === 'tapPower4') owned = tapPower >= 4;
        else if (boost === 'autoclicker') owned = hasAutoclicker;
        else if (boost === 'turboAutoclicker') owned = hasTurboAutoclicker;
        else if (boost === 'cooldown') owned = hasCooldownBoost;
        else if (boost === 'superCooldown') owned = hasSuperCooldownBoost;
        let blocked = false;
        if (boost === 'tapPower3' && tapPower < 2) blocked = true;
        if (boost === 'tapPower4' && tapPower < 3) blocked = true;
        if (boost === 'turboAutoclicker' && !hasAutoclicker) blocked = true;
        if (boost === 'superCooldown' && !hasCooldownBoost) blocked = true;
        btn.disabled = owned || blocked || tokens < cost;
        btn.textContent = owned ? 'OWNED' : blocked ? 'UPGRADE' : 'BUY';
      });
    }

    function updateBountiesUI() {
      updateBountyProgress();
      const today = todayKey();
      const dailyClaimBtn = document.getElementById('claim-daily');
      if (dailyClaimBtn) {
        dailyClaimBtn.disabled = lastDailyClaim === today;
        dailyClaimBtn.textContent = lastDailyClaim === today ? 'CLAIMED' : 'CLAIM';
      }
      const p50 = document.getElementById('bounty-50-progress');
      if (p50) p50.textContent = clicksToday;
      const claim50Btn = document.getElementById('claim-50');
      if (claim50Btn) {
        claim50Btn.disabled = clicksToday < 50 || claimed50Today;
        claim50Btn.textContent = claimed50Today ? 'CLAIMED' : 'CLAIM';
      }
      const p100 = document.getElementById('bounty-100-progress');
      if (p100) p100.textContent = clicksToday;
      const claim100Btn = document.getElementById('claim-100');
      if (claim100Btn) {
        claim100Btn.disabled = clicksToday < 100 || claimed100Today;
        claim100Btn.textContent = claimed100Today ? 'CLAIMED' : 'CLAIM';
      }
      const pWeek = document.getElementById('bounty-weekly-progress');
      if (pWeek) pWeek.textContent = weeklyClicks;
      const claimWeekBtn = document.getElementById('claim-weekly');
      if (claimWeekBtn) {
        claimWeekBtn.disabled = weeklyClicks < 500 || claimedWeekly;
        claimWeekBtn.textContent = claimedWeekly ? 'CLAIMED' : 'CLAIM';
      }
      var shareDate = localStorage.getItem('tokenClicker_shareDate') || '';
      var hasSharedToday = shareDate === todayKey();
      var claimedShareToday = lastShareClaim === todayKey();
      var claimShareBtn = document.getElementById('claim-share');
      if (claimShareBtn) {
        claimShareBtn.disabled = !hasSharedToday || claimedShareToday;
        claimShareBtn.textContent = claimedShareToday ? 'CLAIMED' : 'CLAIM';
      }
      var hasFriend = !!localStorage.getItem('tokenClicker_invitedBy');
      var claimFirstFriendBtn = document.getElementById('claim-firstfriend');
      if (claimFirstFriendBtn) {
        claimFirstFriendBtn.disabled = !hasFriend || claimedFirstFriend;
        claimFirstFriendBtn.textContent = claimedFirstFriend ? 'CLAIMED' : 'CLAIM';
      }
      [500, 1000, 2500, 5000, 10000].forEach(function(goal) {
        var p = document.getElementById('bounty-' + goal + '-progress');
        if (p) p.textContent = totalClicks;
        var btn = document.getElementById('claim-' + goal);
        if (!btn) return;
        var claimed = goal === 500 ? claimed500total : goal === 1000 ? claimed1000total : goal === 2500 ? claimed2500total : goal === 5000 ? claimed5000total : claimed10000total;
        btn.disabled = totalClicks < goal || claimed;
        btn.textContent = claimed ? 'CLAIMED' : 'CLAIM';
      });
      var claimLuckyBtn = document.getElementById('claim-lucky7');
      if (claimLuckyBtn) {
        claimLuckyBtn.disabled = totalClicks < 777 || claimedLucky777;
        claimLuckyBtn.textContent = claimedLucky777 ? 'CLAIMED' : 'CLAIM';
      }
      var speedUnlocked = localStorage.getItem('tokenClicker_speedDemon') === '1';
      var claimSpeedBtn = document.getElementById('claim-speed');
      if (claimSpeedBtn) {
        claimSpeedBtn.disabled = !speedUnlocked || claimedSpeedDemon;
        claimSpeedBtn.textContent = claimedSpeedDemon ? 'CLAIMED' : 'CLAIM';
      }
      var claimHoarderBtn = document.getElementById('claim-hoarder');
      if (claimHoarderBtn) {
        claimHoarderBtn.disabled = tokens < 100 || claimedHoarder;
        claimHoarderBtn.textContent = claimedHoarder ? 'CLAIMED' : 'CLAIM';
      }
      switchBountyTab(currentBountyTab);
      save();
    }

    function updateLeaderboard() {
      let leaderboard = [];
      try {
        leaderboard = JSON.parse(localStorage.getItem('tokenClicker_leaderboard') || '[]');
      } catch (_) {}
      if (!Array.isArray(leaderboard) || leaderboard.length === 0) {
        leaderboard = [ { name: 'Alpha', tokens: 500 }, { name: 'Beta', tokens: 300 } ];
      }
      const me = leaderboard.find(e => e.name === 'You');
      if (me) me.tokens = tokens; else leaderboard.push({ name: 'You', tokens });
      leaderboard.sort((a, b) => b.tokens - a.tokens);
      try { localStorage.setItem('tokenClicker_leaderboard', JSON.stringify(leaderboard)); } catch (_) {}
      const list = document.getElementById('leaderboard-list');
      if (list) {
        var name = function(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); };
        list.innerHTML = leaderboard.slice(0, 10).map(function(e) {
          return '<li>' + name(e.name) + ' ‚Äî ' + e.tokens + ' tokens</li>';
        }).join('');
      }
      if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
      if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
      let refCode = localStorage.getItem('tokenClicker_refCode');
      if (!refCode) {
        refCode = 'REF' + Math.random().toString(36).slice(2, 8).toUpperCase();
        localStorage.setItem('tokenClicker_refCode', refCode);
      }
      const refEl = document.getElementById('referral-code');
      if (refEl) refEl.textContent = refCode;
    }
    function loadLeaderboardPvp() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('leaderboard-pvp-list');
      if (!list) return;
      if (!supabase) {
        list.innerHTML = '<li class="text-gray-500">Leaderboard unavailable. Add Supabase in supabase-config.js.</li>';
        return;
      }
      list.innerHTML = '<li class="text-gray-500">Loading‚Ä¶</li>';
      supabase.from('leaderboard').select('name, pvp_wins').order('pvp_wins', { ascending: false }).limit(5).then(function(r) {
        if (r.error || !r.data || r.data.length === 0) {
          list.innerHTML = '<li class="text-gray-500">No duel wins yet.</li>';
          return;
        }
        list.innerHTML = r.data.map(function(e, i) {
          var wins = e.pvp_wins != null ? e.pvp_wins : 0;
          return '<li>' + (e.name || 'Player') + ' ‚Äî ' + wins + ' win' + (wins !== 1 ? 's' : '') + '</li>';
        }).join('');
      });
    }
    function loadPvpFullList() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('pvp-full-list-content');
      if (!supabase || !list) return;
      list.innerHTML = '<li class="text-gray-500">Loading‚Ä¶</li>';
      supabase.from('leaderboard').select('name, pvp_wins').order('pvp_wins', { ascending: false }).limit(100).then(function(r) {
        if (r.error || !r.data || r.data.length === 0) {
          list.innerHTML = '<li class="text-gray-500">No duel wins yet.</li>';
          return;
        }
        list.innerHTML = r.data.map(function(e, i) {
          var wins = e.pvp_wins != null ? e.pvp_wins : 0;
          return '<li>' + (e.name || 'Player') + ' ‚Äî ' + wins + ' win' + (wins !== 1 ? 's' : '') + '</li>';
        }).join('');
      });
    }

    function updateClicksPerSecond() {
      const now = Date.now();
      if (now - lastSecondTime >= 1000) {
        clicksInLastSecond = 0;
        lastSecondTime = now;
      }
      if (clicksPerSecEl) clicksPerSecEl.textContent = clicksInLastSecond;
    }

    function addTokens(amount) {
      tokens += amount;
      updateUI();
      save();
    }

    function onValidClick() {
      if (isDead) return -1;
      const now = Date.now();
      if (now - lastClickTime < cooldownMs()) return -1;
      lastClickTime = now;
      lastActivityAt = now;

      totalClicks++;
      const prevEffective = (totalClicks - 1) * tapPower;
      const newEffective = totalClicks * tapPower;
      const earned = Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
      tokens += earned;

      const nowSec = now / 1000;
      if (Math.floor(nowSec) > Math.floor(lastSecondTime / 1000)) {
        lastSecondTime = now;
        clicksInLastSecond = 0;
      }
      clicksInLastSecond++;
      if (clicksInLastSecond >= 8) try { localStorage.setItem('tokenClicker_speedDemon', '1'); } catch (e) {}

      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) { clicksToday = 0; claimed100Today = false; claimed50Today = false; lastDate = today; }
      if (week !== weekStartKey) { weeklyClicks = 0; claimedWeekly = false; weekStartKey = week; }
      clicksToday++;
      weeklyClicks++;

      updateUI();
      save();
      updateClicksPerSecond();
      return earned;
    }

    function spawnFeathersAt(cx, cy) {
      for (var i = 0; i < 3; i++) {
        var el = document.createElement('div');
        el.className = 'feather-fall feather-sway' + (1 + (i % 3));
        el.style.left = (cx + (Math.random() - 0.5) * 20) + 'px';
        el.style.top = cy + 'px';
        el.style.marginLeft = '-26px';
        el.style.marginTop = '-16px';
        var img = document.createElement('img');
        img.src = 'assets/cardinal-feather.png';
        img.alt = '';
        img.className = 'image-pixel';
        img.style.width = '52px';
        img.style.height = 'auto';
        img.style.display = 'block';
        el.appendChild(img);
        document.body.appendChild(el);
        (function(featherEl) {
          setTimeout(function() { if (featherEl.parentNode) featherEl.remove(); }, 1500);
        })(el);
      }
    }
    function spawnClickEffects(earned, clickEvent) {
      var showFeathers = localStorage.getItem('tokenClicker_featherEffects') !== '0';
      var cx = clickEvent && typeof clickEvent.clientX === 'number' ? clickEvent.clientX : (nftClicker && nftClicker.getBoundingClientRect().left + nftClicker.getBoundingClientRect().width / 2);
      var cy = clickEvent && typeof clickEvent.clientY === 'number' ? clickEvent.clientY : (nftClicker && nftClicker.getBoundingClientRect().top + nftClicker.getBoundingClientRect().height / 2);

      if (showFeathers) spawnFeathersAt(cx, cy);

      var valueEl = document.createElement('div');
      valueEl.className = 'tap-value-float';
      valueEl.textContent = '+1';
      valueEl.style.left = cx + 'px';
      valueEl.style.top = cy + 'px';
      document.body.appendChild(valueEl);
      setTimeout(function() { if (valueEl.parentNode) valueEl.remove(); }, 1100);
    }

    if (nftClicker) nftClicker.addEventListener('click', function(e) {
      nftClicker.classList.add('cooldown');
      var earned = onValidClick();
      if (earned >= 0) spawnClickEffects(earned, e);
      setTimeout(function() { nftClicker.classList.remove('cooldown'); }, cooldownMs());
    });

    document.getElementById('death-revive-btn') && document.getElementById('death-revive-btn').addEventListener('click', function() {
      reviveBird();
    });

    // Boosts: buy
    document.querySelectorAll('.boost-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        if (tokens < cost) return;
        if (boost === 'tapPower' && tapPower < 2) { tokens -= cost; tapPower = 2; }
        if (boost === 'tapPower3' && tapPower >= 2 && tapPower < 3) { tokens -= cost; tapPower = 3; }
        if (boost === 'tapPower4' && tapPower >= 3 && tapPower < 4) { tokens -= cost; tapPower = 4; }
        if (boost === 'autoclicker' && !hasAutoclicker) { tokens -= cost; hasAutoclicker = true; startAutoclicker(); }
        if (boost === 'turboAutoclicker' && hasAutoclicker && !hasTurboAutoclicker) { tokens -= cost; hasTurboAutoclicker = true; restartAutoclicker(); }
        if (boost === 'cooldown' && !hasCooldownBoost) { tokens -= cost; hasCooldownBoost = true; }
        if (boost === 'superCooldown' && hasCooldownBoost && !hasSuperCooldownBoost) { tokens -= cost; hasSuperCooldownBoost = true; }
        updateUI();
        save();
      });
    });

    function getAutoclickerIntervalMs() { return (hasAutoclicker && hasTurboAutoclicker) ? 500 : 1000; }
    function startAutoclicker() {
      if (autoclickerInterval) return;
      const ms = getAutoclickerIntervalMs();
      autoclickerInterval = setInterval(() => {
        totalClicks++;
        const prevEffective = (totalClicks - 1) * tapPower;
        const newEffective = totalClicks * tapPower;
        tokens += Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
        const today = todayKey();
        const week = weekKey();
        if (today !== lastDate) { clicksToday = 0; lastDate = today; }
        if (week !== weekStartKey) { weeklyClicks = 0; weekStartKey = week; }
        clicksToday++;
        weeklyClicks++;
        updateUI();
        save();
      }, ms);
    }
    function restartAutoclicker() {
      if (autoclickerInterval) { clearInterval(autoclickerInterval); autoclickerInterval = null; }
      if (hasAutoclicker) startAutoclicker();
    }
    if (hasAutoclicker) startAutoclicker();

    // Bounties: claim
    document.querySelectorAll('.bounty-claim').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const reward = parseInt(btn.dataset.reward, 10);
        if (!id || btn.disabled) return;
        let didClaim = false;
        if (id === 'daily' && lastDailyClaim !== todayKey()) { lastDailyClaim = todayKey(); addTokens(reward); didClaim = true; }
        if (id === '50today' && clicksToday >= 50 && !claimed50Today) { claimed50Today = true; addTokens(reward); didClaim = true; }
        if (id === '100today' && clicksToday >= 100 && !claimed100Today) { claimed100Today = true; addTokens(reward); didClaim = true; }
        if (id === 'weekly' && weeklyClicks >= 500 && !claimedWeekly) { claimedWeekly = true; addTokens(reward); didClaim = true; }
        if (id === 'share' && localStorage.getItem('tokenClicker_shareDate') === todayKey() && lastShareClaim !== todayKey()) { lastShareClaim = todayKey(); addTokens(reward); didClaim = true; }
        if (id === 'firstfriend' && !!localStorage.getItem('tokenClicker_invitedBy') && !claimedFirstFriend) { claimedFirstFriend = true; addTokens(reward); didClaim = true; }
        if (id === '500total' && totalClicks >= 500 && !claimed500total) { claimed500total = true; addTokens(reward); didClaim = true; }
        if (id === '1000total' && totalClicks >= 1000 && !claimed1000total) { claimed1000total = true; addTokens(reward); didClaim = true; }
        if (id === '2500total' && totalClicks >= 2500 && !claimed2500total) { claimed2500total = true; addTokens(reward); didClaim = true; }
        if (id === '5000total' && totalClicks >= 5000 && !claimed5000total) { claimed5000total = true; addTokens(reward); didClaim = true; }
        if (id === '10000total' && totalClicks >= 10000 && !claimed10000total) { claimed10000total = true; addTokens(reward); didClaim = true; }
        if (id === 'lucky777' && totalClicks >= 777 && !claimedLucky777) { claimedLucky777 = true; addTokens(reward); didClaim = true; }
        if (id === 'speeddemon' && localStorage.getItem('tokenClicker_speedDemon') === '1' && !claimedSpeedDemon) { claimedSpeedDemon = true; addTokens(reward); didClaim = true; }
        if (id === 'hoarder' && tokens >= 100 && !claimedHoarder) { claimedHoarder = true; addTokens(reward); didClaim = true; }
        if (didClaim) {
          save();
          try { pushNotification('Bounty claimed: +' + reward + ' tokens'); } catch (e) {}
        }
        updateBountiesUI();
      });
    });
    document.getElementById('bounty-tab-toclaim') && document.getElementById('bounty-tab-toclaim').addEventListener('click', function() { switchBountyTab('toclaim'); });
    document.getElementById('bounty-tab-claimed') && document.getElementById('bounty-tab-claimed').addEventListener('click', function() { switchBountyTab('claimed'); });

    // Share URL: use canonical game URL so shared links open on mobile (production site)
    function getShareBaseUrl() {
      var base = (window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl) || (window.location.origin + window.location.pathname).replace(/\/$/, '');
      return base;
    }
    function getInviteUrl() {
      var code = localStorage.getItem('tokenClicker_refCode') || 'REF0000';
      return getShareBaseUrl() + '/?ref=' + encodeURIComponent(code);
    }
    function getGameUrl() {
      return getShareBaseUrl() + '/';
    }
    function getShareText() { return 'Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends!'; }
    function markSharedGame() {
      try {
        localStorage.setItem('tokenClicker_hasSharedGame', '1');
        localStorage.setItem('tokenClicker_shareDate', todayKey());
      } catch (e) {}
      if (typeof updateBountiesUI === 'function') updateBountiesUI();
    }
    var platformNames = { x: 'X', telegram: 'Telegram', facebook: 'Facebook', email: 'Email', sms: 'SMS' };
    function showShareConfirmModal(platform, onConfirm) {
      var modal = document.getElementById('share-confirm-modal');
      var msg = document.getElementById('share-confirm-msg');
      var yesBtn = document.getElementById('share-confirm-yes');
      var noBtn = document.getElementById('share-confirm-no');
      if (!modal || !msg) return;
      msg.textContent = 'Did you share the game on ' + (platformNames[platform] || platform) + '?';
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      function closeModal() { modal.classList.add('hidden'); modal.style.display = 'none'; }
      yesBtn.onclick = function() { closeModal(); if (onConfirm) onConfirm(); yesBtn.onclick = null; noBtn.onclick = null; };
      noBtn.onclick = function() { closeModal(); yesBtn.onclick = null; noBtn.onclick = null; };
    }
    function doShareGame(channel) {
      var url = getGameUrl();
      var text = getShareText();
      var encodedUrl = encodeURIComponent(url);
      var encodedText = encodeURIComponent(text);
      var fullText = text + ' ' + url;
      if (channel === 'copy') {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() { markSharedGame(); }).catch(function() {});
        } else {
          var ta = document.createElement('textarea');
          ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = '0';
          document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); markSharedGame(); } catch (e) {}
          document.body.removeChild(ta);
        }
        return;
      }
      if (channel === 'x') { window.open('https://x.com/intent/tweet?text=' + encodedText + '&url=' + encodedUrl, '_blank', 'width=550,height=420'); showShareConfirmModal('x', markSharedGame); return; }
      if (channel === 'telegram') { window.open('https://t.me/share/url?url=' + encodedUrl + '&text=' + encodedText, '_blank', 'width=550,height=420'); showShareConfirmModal('telegram', markSharedGame); return; }
      if (channel === 'facebook') { window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodedUrl, '_blank', 'width=550,height=420'); showShareConfirmModal('facebook', markSharedGame); return; }
      if (channel === 'email') { window.location.href = 'mailto:?subject=' + encodeURIComponent('1N Blockchain Token Clicker') + '&body=' + encodeURIComponent(fullText); showShareConfirmModal('email', markSharedGame); return; }
      if (channel === 'sms') { window.location.href = 'sms:?body=' + encodeURIComponent(fullText); showShareConfirmModal('sms', markSharedGame); return; }
    }

    // Friends: copy invite link (canonical URL so it opens on mobile)
    const inviteBtn = document.getElementById('invite-btn');
    const inviteFeedback = document.getElementById('invite-feedback');
    if (inviteBtn) {
      inviteBtn.addEventListener('click', () => {
        var url = getInviteUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(() => {
            if (inviteFeedback) { inviteFeedback.classList.remove('hidden'); setTimeout(() => inviteFeedback.classList.add('hidden'), 3000); }
          }).catch(function() { fallbackCopy(url, inviteFeedback); });
        } else { fallbackCopy(url, inviteFeedback); }
      });
    }
    var friendCodeAddBtn = document.getElementById('friend-code-add-btn');
    var friendCodeInput = document.getElementById('friend-code-input');
    if (friendCodeAddBtn) friendCodeAddBtn.addEventListener('click', function() { addFriendByCode(); });
    if (friendCodeInput) friendCodeInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); addFriendByCode(); } });

    // PVP: Share game ‚Äì copy link that opens on mobile
    const shareGameBtn = document.getElementById('share-game-btn');
    const shareGameNativeBtn = document.getElementById('share-game-native-btn');
    const shareGameFeedback = document.getElementById('share-game-feedback');
    function fallbackCopy(text, feedbackEl) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); if (feedbackEl) { feedbackEl.classList.remove('hidden'); setTimeout(function() { feedbackEl.classList.add('hidden'); }, 3000); } } catch (e) {}
      document.body.removeChild(ta);
    }
    if (shareGameBtn) {
      shareGameBtn.addEventListener('click', function() {
        var url = getGameUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            if (typeof markSharedGame === 'function') markSharedGame();
            if (shareGameFeedback) { shareGameFeedback.classList.remove('hidden'); setTimeout(function() { shareGameFeedback.classList.add('hidden'); }, 4000); }
          }).catch(function() { fallbackCopy(url, shareGameFeedback); if (typeof markSharedGame === 'function') markSharedGame(); });
        } else { fallbackCopy(url, shareGameFeedback); if (typeof markSharedGame === 'function') markSharedGame(); }
      });
    }
    if (shareGameNativeBtn && navigator.share) {
      shareGameNativeBtn.classList.remove('hidden');
      shareGameNativeBtn.addEventListener('click', function() {
        navigator.share({
          title: '1N Blockchain Token Clicker',
          text: (typeof getShareText === 'function' ? getShareText() : 'Tap the Cardinal to earn tokens. Play on your phone ‚Äì PVP with friends!'),
          url: getGameUrl(),
        }).then(function() { if (typeof markSharedGame === 'function') markSharedGame(); if (shareGameFeedback) { shareGameFeedback.textContent = 'Shared!'; shareGameFeedback.classList.remove('hidden'); setTimeout(function() { shareGameFeedback.classList.add('hidden'); }, 3000); } }).catch(function() {});
      });
    }
    document.querySelectorAll('.share-bounty-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var channel = btn.getAttribute('data-share') || 'copy';
        if (typeof doShareGame === 'function') doShareGame(channel);
      });
    });

    // TON Wallet: connector + optional TonConnect UI modal; we prefer direct connect + link for reliability
    var walletStatusEl = document.getElementById('wallet-connection-status');
    function setWalletStatus(msg, isError) {
      if (walletStatusEl) { walletStatusEl.textContent = msg || ''; walletStatusEl.className = 'text-[9px] min-h-[14px] mb-2 ' + (isError ? 'text-neon-pink' : 'text-gray-400'); }
    }
    let tonConnectUI = null;
    if (window.TonWallet && typeof TON_CONNECT_UI !== 'undefined') {
      try {
        tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ connector: window.TonWallet.getConnector() });
        window.tonConnectUI = tonConnectUI;
        if (tonConnectUI.onStatusChange) tonConnectUI.onStatusChange(function() { updateWalletUI(); setWalletStatus(''); });
      } catch (e) { console.warn('TonConnect UI init:', e); }
    }
    var lastCardBalanceFetch = 0;
    function fetchCardBalanceFromBackend() {
      const TW = window.TonWallet;
      const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
      if (!TW || !backendUrl) return;
      const addr = TW.getAddress();
      if (!addr) return;
      if (Date.now() - lastCardBalanceFetch < 15000) return;
      lastCardBalanceFetch = Date.now();
      fetch(backendUrl.replace(/\/$/, '') + '/api/wallet/card-balance?address=' + encodeURIComponent(addr))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data.balance != null && TW.setCardBalance) TW.setCardBalance(data.balance);
          updateWalletUI();
        })
        .catch(function() { updateWalletUI(); });
    }
    var lastTonPriceFetch = 0;
    function fetchTonPrice() {
      var el = document.getElementById('ton-price-display');
      if (!el) return;
      if (Date.now() - lastTonPriceFetch < 60000) return;
      lastTonPriceFetch = Date.now();
      fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data['the-open-network'] && data['the-open-network'].usd != null) {
            el.textContent = 'TON: $' + Number(data['the-open-network'].usd).toFixed(4);
          } else { el.textContent = 'TON: ‚Äî'; }
        })
        .catch(function() { el.textContent = 'TON: ‚Äî'; });
    }
    function updateWalletUI() {
      const TW = window.TonWallet;
      if (!TW) return;
      const addr = TW.getAddress();
      const connectArea = document.getElementById('wallet-connect-area');
      const connectedArea = document.getElementById('wallet-connected-area');
      const tonAddress = document.getElementById('ton-address');
      const cardBalanceEl = document.getElementById('card-balance');
      if (connectArea) connectArea.classList.toggle('hidden', !!addr);
      if (connectedArea) connectedArea.classList.toggle('hidden', !addr);
      if (tonAddress && addr) tonAddress.textContent = addr.slice(0, 8) + '‚Ä¶' + addr.slice(-8);
      if (cardBalanceEl) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardBalanceEl.textContent = String(TW.cardBalance);
        } else {
          cardBalanceEl.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      var cardTop = document.getElementById('wallet-card-balance-top');
      if (cardTop) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardTop.textContent = String(TW.cardBalance);
        } else {
          cardTop.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      if (addr) {
        fetchCardBalanceFromBackend();
        persistNameToLeaderboard();
        if (!getPlayerName() && window.supabaseClient) {
          window.supabaseClient.from('leaderboard').select('name').eq('wallet_address', addr).maybeSingle().then(function(r) {
            if (r.data && r.data.name) localStorage.setItem('tokenClicker_playerName', r.data.name.trim().slice(0, 20));
          });
        }
      }
    }
    const tonConnectBtn = document.getElementById('ton-connect-btn');
    const tonDisconnectBtn = document.getElementById('ton-disconnect-btn');
    var connectionPollTimer = null;
    function startConnectionPolling() {
      if (connectionPollTimer) return;
      setWalletStatus('Waiting for approval‚Ä¶ Return to this tab after approving in Tonkeeper.');
      var attempts = 0;
      var maxAttempts = 40;
      function poll() {
        if (window.TonWallet && window.TonWallet.getAddress()) {
          connectionPollTimer = null;
          setWalletStatus('');
          updateWalletUI();
          return;
        }
        attempts++;
        if (attempts >= maxAttempts) {
          connectionPollTimer = null;
          setWalletStatus('No connection yet. Click "I approved ‚Äì check connection" or try again.');
          return;
        }
        var unPause = window.TonWallet && window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') unPause().catch(function() {});
        window.TonWallet.restoreConnection().then(function() {
          updateWalletUI();
          if (window.TonWallet.getAddress()) { connectionPollTimer = null; setWalletStatus(''); return; }
          connectionPollTimer = setTimeout(poll, 2000);
        }).catch(function() { connectionPollTimer = setTimeout(poll, 2000); });
      }
      if (window.TonWallet && window.TonWallet.unPauseConnection) {
        window.TonWallet.unPauseConnection().then(function() { poll(); }).catch(function() { poll(); });
      } else {
        poll();
      }
    }
    if (tonConnectBtn) {
      tonConnectBtn.addEventListener('click', function() {
        if (!window.TonWallet) { setWalletStatus('Wallet script not loaded.', true); return; }
        setWalletStatus('Opening in new tab‚Ä¶ Stay here; return after approving.');
        tonConnectBtn.disabled = true;
        window.TonWallet.connect()
          .then(function() {
            updateWalletUI();
            if (window.TonWallet.getAddress()) { setWalletStatus(''); tonConnectBtn.disabled = false; return; }
            startConnectionPolling();
            tonConnectBtn.disabled = false;
          })
          .catch(function(err) {
            var msg = (err && err.message) || 'Connect failed';
            if (msg.indexOf('POPUP_BLOCKED') !== -1) msg = 'Popup blocked. Allow popups for this site or use the link that opened.';
            setWalletStatus(msg, true);
            tonConnectBtn.disabled = false;
            var helpModal = document.getElementById('wallet-connect-help-modal');
            if (helpModal) {
              helpModal.classList.remove('hidden');
              helpModal.style.display = 'flex';
            }
          });
      });
    var walletHelpBackBtn = document.getElementById('wallet-help-back-btn');
    var walletConnectHelpModal = document.getElementById('wallet-connect-help-modal');
    if (walletHelpBackBtn && walletConnectHelpModal) {
      walletHelpBackBtn.addEventListener('click', function() {
        walletConnectHelpModal.classList.add('hidden');
        walletConnectHelpModal.style.display = 'none';
        setWalletStatus('');
      });
    }
    }
    const tonCheckBtn = document.getElementById('ton-check-connection-btn');
    if (tonCheckBtn && window.TonWallet) {
      tonCheckBtn.addEventListener('click', function() {
        if (connectionPollTimer) { clearTimeout(connectionPollTimer); connectionPollTimer = null; }
        const origText = tonCheckBtn.textContent;
        tonCheckBtn.disabled = true;
        tonCheckBtn.textContent = 'Checking‚Ä¶';
        setWalletStatus('Checking connection‚Ä¶');
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') Promise.resolve(unPause()).catch(function() {});
        function done() {
          updateWalletUI();
          tonCheckBtn.disabled = false;
          tonCheckBtn.textContent = origText;
          setWalletStatus('');
        }
        var attempts = 0;
        var maxAttempts = 12;
        function poll() {
          window.TonWallet.restoreConnection()
            .then(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setWalletStatus('Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')');
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Not yet. Try again or refresh.';
                tonCheckBtn.disabled = false;
                setWalletStatus('No connection yet. Approve in Tonkeeper and try again.');
              }
            })
            .catch(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Try again or refresh page.';
                tonCheckBtn.disabled = false;
                setWalletStatus('Try again or refresh.');
              }
            });
        }
        poll();
      });
    }
    if (tonDisconnectBtn && window.TonWallet) {
      tonDisconnectBtn.addEventListener('click', () => {
        window.TonWallet.disconnect();
        updateWalletUI();
      });
    }
    if (window.TonWallet) {
      const fileWarning = document.getElementById('wallet-file-warning');
      if (fileWarning && (typeof location !== 'undefined' && location.protocol === 'file:')) {
        fileWarning.classList.remove('hidden');
      }
      window.TonWallet.onStatusChange(updateWalletUI);
      window.TonWallet.restoreConnection().then(() => {
        updateWalletUI();
      }).catch(() => { updateWalletUI(); });
      // When user returns to this tab after approving in Tonkeeper, unpause bridge and sync
      window.addEventListener('focus', function() {
        if (!window.TonWallet) return;
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') {
          unPause().then(function() {
            window.TonWallet.restoreConnection().then(updateWalletUI).catch(updateWalletUI);
          }).catch(function() { updateWalletUI(); });
        }
      });
    }

    // Backend config: load minter address (and network) from backend
    const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
    if (backendUrl) {
      fetch(backendUrl.replace(/\/$/, '') + '/api/config')
        .then(r => r.json())
        .then(data => {
          if (data.cardMinterAddress && window.TonWallet) {
            window.TonWallet.setCardMinterAddress(data.cardMinterAddress);
          }
          const hint = document.getElementById('wallet-config-hint');
          if (hint) hint.textContent = data.cardMinterAddress ? 'Minter: ' + data.cardMinterAddress.slice(0, 8) + '‚Ä¶' : 'Set backendUrl in ton-config.js and add minter to backend .env';
        })
        .catch(() => {});
    }
    // Wallet: backend / admin links in black square (open in new tab)
    var walletBackendSquare = document.getElementById('wallet-backend-square');
    var walletBackendLink = document.getElementById('wallet-backend-link');
    var walletAdminSetupLink = document.getElementById('wallet-admin-setup-link');
    if (backendUrl) {
      if (walletBackendSquare) walletBackendSquare.classList.remove('hidden');
      if (walletBackendLink) walletBackendLink.href = backendUrl.replace(/\/$/, '');
      if (walletAdminSetupLink) walletAdminSetupLink.href = backendUrl.replace(/\/$/, '') + '/setup';
    }

    // Withdraw: send in-game tokens to backend, backend mints $CARD to user
    const withdrawAmount = document.getElementById('withdraw-amount');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const withdrawFeedback = document.getElementById('withdraw-feedback');
    if (withdrawBtn && backendUrl) {
      withdrawBtn.addEventListener('click', async () => {
        const amount = withdrawAmount ? parseInt(withdrawAmount.value, 10) : 0;
        if (!amount || amount < 1) { withdrawFeedback.textContent = 'Enter amount (1+).'; withdrawFeedback.classList.remove('hidden'); return; }
        const addr = window.TonWallet && window.TonWallet.getAddress();
        if (!addr) { withdrawFeedback.textContent = 'Connect wallet first.'; withdrawFeedback.classList.remove('hidden'); return; }
        if (tokens < amount) { withdrawFeedback.textContent = 'Not enough in-game balance.'; withdrawFeedback.classList.remove('hidden'); return; }
        withdrawBtn.disabled = true;
        withdrawFeedback.textContent = 'Sending‚Ä¶';
        withdrawFeedback.classList.remove('hidden');
        withdrawFeedback.classList.remove('text-neon-green', 'text-neon-pink');
        try {
          const res = await fetch(backendUrl.replace(/\/$/, '') + '/api/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, amount }),
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.success) {
            tokens -= amount;
            save();
            updateUI();
            withdrawFeedback.textContent = 'Withdraw sent! Check your wallet for $CARD.';
            withdrawFeedback.classList.add('text-neon-green');
            if (withdrawAmount) withdrawAmount.value = '';
          } else {
            withdrawFeedback.textContent = data.error || 'Withdraw failed.';
            withdrawFeedback.classList.add('text-neon-pink');
          }
        } catch (e) {
          withdrawFeedback.textContent = e.message || 'Network error.';
          withdrawFeedback.classList.add('text-neon-pink');
        }
        withdrawBtn.disabled = false;
      });
    } else {
      var withdrawHint = document.getElementById('withdraw-area-hint');
      if (withdrawHint) withdrawHint.textContent = 'Set backendUrl in ton-config.js to enable withdraw.';
    }
    // Swap: $CARD ‚Üí in-game tokens (backend verifies balance, frontend credits tokens)
    var swapAmountEl = document.getElementById('swap-amount');
    var swapBtn = document.getElementById('swap-btn');
    var swapFeedback = document.getElementById('swap-feedback');
    if (swapBtn && backendUrl) {
      swapBtn.addEventListener('click', async function() {
        var amount = swapAmountEl ? parseInt(swapAmountEl.value, 10) : 0;
        if (!amount || amount < 1) {
          if (swapFeedback) { swapFeedback.textContent = 'Enter $CARD amount (1+).'; swapFeedback.classList.remove('hidden'); }
          return;
        }
        var addr = window.TonWallet && window.TonWallet.getAddress();
        if (!addr) {
          if (swapFeedback) { swapFeedback.textContent = 'Connect wallet first.'; swapFeedback.classList.remove('hidden'); }
          return;
        }
        swapBtn.disabled = true;
        if (swapFeedback) { swapFeedback.textContent = 'Swapping‚Ä¶'; swapFeedback.classList.remove('hidden'); swapFeedback.classList.remove('text-neon-green', 'text-neon-pink'); }
        try {
          var res = await fetch(backendUrl.replace(/\/$/, '') + '/api/swap', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, amount: amount }),
          });
          var data = await res.json().catch(function() { return {}; });
          if (data.success && data.tokensToCredit) {
            tokens += data.tokensToCredit;
            save();
            updateUI();
            if (swapAmountEl) swapAmountEl.value = '';
            if (swapFeedback) { swapFeedback.textContent = 'Swapped! +' + data.tokensToCredit + ' tokens.'; swapFeedback.classList.add('text-neon-green'); }
            if (window.TonWallet && window.TonWallet.setCardBalance && data.cardAmount != null) {
              var cur = window.TonWallet.cardBalance;
              if (cur != null) window.TonWallet.setCardBalance(Math.max(0, Number(cur) - data.cardAmount));
            }
            fetchCardBalanceFromBackend();
          } else {
            if (swapFeedback) { swapFeedback.textContent = data.error || 'Swap failed.'; swapFeedback.classList.add('text-neon-pink'); }
          }
        } catch (e) {
          if (swapFeedback) { swapFeedback.textContent = e.message || 'Network error.'; swapFeedback.classList.add('text-neon-pink'); }
        }
        swapBtn.disabled = false;
      });
    } else {
      var swapArea = document.getElementById('swap-area');
      if (swapArea) {
        var desc = swapArea.querySelector('.text-gray-400');
        if (desc) desc.textContent = 'Set backendUrl in ton-config.js to enable swap.';
      }
    }

    // --- PVP: token stakes, countdown ---
    var PVP_DEFAULT_STAKE = 5;
    var PVP_GAME_DURATION_SEC = 30;
    var PVP_COUNTDOWN_SEC = 4;
    var PVP_CLICK_COOLDOWN_MS = 200;
    var PVP_PRESET_STAKES = [2, 5, 7, 10];

    function getPlayerName() {
      return (localStorage.getItem('tokenClicker_playerName') || '').trim().slice(0, 20) || null;
    }
    function setPlayerName(name) {
      name = (name || '').trim().slice(0, 20);
      if (name) {
        localStorage.setItem('tokenClicker_playerName', name);
        registerReferralIfNeeded(name);
        persistNameToLeaderboard();
      }
    }
    function registerReferralIfNeeded(invitedName) {
      var inviterCode = localStorage.getItem('tokenClicker_invitedBy');
      if (!inviterCode || !invitedName) return;
      var supabase = window.supabaseClient;
      if (!supabase) { localStorage.removeItem('tokenClicker_invitedBy'); return; }
      var wallet = getPvpPlayerId();
      if (wallet && wallet.indexOf('guest_') === 0) wallet = null;
      supabase.from('referrals').insert({ inviter_ref_code: inviterCode, invited_name: invitedName, invited_wallet: wallet }).then(function() {
        localStorage.removeItem('tokenClicker_invitedBy');
        if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      }).catch(function() { localStorage.removeItem('tokenClicker_invitedBy'); });
    }
    function getFriendTokenCache() {
      try {
        var raw = localStorage.getItem('tokenClicker_friendTokens');
        if (!raw) return { byWallet: {}, byRefCode: {} };
        var parsed = JSON.parse(raw);
        return { byWallet: parsed.byWallet || {}, byRefCode: parsed.byRefCode || {} };
      } catch (e) { return { byWallet: {}, byRefCode: {} }; }
    }
    function setFriendTokenCache(cache) {
      try { localStorage.setItem('tokenClicker_friendTokens', JSON.stringify(cache)); } catch (e) {}
    }
    function mergeFriendTokenCache(byWallet, byRefCode) {
      var c = getFriendTokenCache();
      if (byWallet) Object.keys(byWallet).forEach(function(k) { c.byWallet[k] = byWallet[k]; });
      if (byRefCode) Object.keys(byRefCode).forEach(function(k) { c.byRefCode[k.toUpperCase()] = byRefCode[k]; });
      setFriendTokenCache(c);
    }
    function removeFromFriendTokenCache(wallet, refCode) {
      var c = getFriendTokenCache();
      if (wallet) delete c.byWallet[wallet];
      if (refCode) delete c.byRefCode[(refCode || '').toUpperCase()];
      setFriendTokenCache(c);
    }
    var friendsLeaderboardChannel = null;
    function subscribeFriendsLeaderboardRealtime() {
      var supabase = window.supabaseClient;
      if (!supabase || friendsLeaderboardChannel) return;
      friendsLeaderboardChannel = supabase.channel('friends-leaderboard').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leaderboard' }, function(payload) {
        var row = payload.new;
        if (!row) return;
        var w = (row.wallet_address || '').trim();
        var r = (row.ref_code || '').trim().toUpperCase();
        var t = row.tokens != null ? row.tokens : 0;
        var cache = getFriendTokenCache();
        var changed = false;
        if (w && (w in cache.byWallet)) { mergeFriendTokenCache({ [w]: t }, null); changed = true; }
        if (r && (r in cache.byRefCode)) { mergeFriendTokenCache(null, { [r]: t }); changed = true; }
        if (changed && document.getElementById('page-friends') && document.getElementById('page-friends').classList.contains('active')) {
          if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
          if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
        }
      }).subscribe();
    }
    function unsubscribeFriendsLeaderboardRealtime() {
      if (window.supabaseClient && friendsLeaderboardChannel) {
        try { window.supabaseClient.removeChannel(friendsLeaderboardChannel); } catch (e) {}
        friendsLeaderboardChannel = null;
      }
    }
    var friendsPollInterval = null;
    function startFriendsTokenPolling() {
      if (friendsPollInterval) return;
      friendsPollInterval = setInterval(function() {
        if (document.getElementById('page-friends') && document.getElementById('page-friends').classList.contains('active')) {
          if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
          if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
        }
      }, 15000);
    }
    function stopFriendsTokenPolling() {
      if (friendsPollInterval) { clearInterval(friendsPollInterval); friendsPollInterval = null; }
    }
    function loadFriendsInvited() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('friends-invited-list');
      if (!list) return;
      if (!supabase) {
        list.innerHTML = '<li class="text-gray-500">Friends unavailable. Add Supabase in supabase-config.js.</li>';
        return;
      }
      var refCode = localStorage.getItem('tokenClicker_refCode') || '';
      if (!refCode) { list.innerHTML = '<li class="text-gray-500">Your code not set yet.</li>'; return; }
      supabase.from('referrals').select('invited_name, invited_wallet, created_at').eq('inviter_ref_code', refCode).order('created_at', { ascending: false }).limit(50)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No one has used your invite link yet.</li>' +
              '<li class="mt-2"><button type="button" id="friends-play-vs-computer-btn" class="py-2 px-3 border-2 border-neon-yellow text-neon-yellow rounded text-[9px] hover:bg-neon-yellow/10">Play vs Computer</button></li>';
            var btn = document.getElementById('friends-play-vs-computer-btn');
            if (btn) btn.addEventListener('click', function() {
              try { sessionStorage.setItem('tokenClicker_startVsComputer', '1'); } catch (e) {}
              window.location.hash = 'multiplayer';
              showPage('multiplayer');
              if (typeof window.startVsComputer === 'function') {
                try { sessionStorage.removeItem('tokenClicker_startVsComputer'); } catch (e) {}
                window.startVsComputer();
              }
            });
            return;
          }
          var wallets = r.data.map(function(e) { return (e.invited_wallet || '').trim(); }).filter(Boolean);
          var cache = getFriendTokenCache();
          var tokensByWallet = {};
          wallets.forEach(function(w) { tokensByWallet[w] = cache.byWallet[w] != null ? cache.byWallet[w] : null; });
          renderInvitedList(r.data, tokensByWallet);
          if (wallets.length > 0) {
            supabase.from('leaderboard').select('wallet_address, tokens').in('wallet_address', wallets).then(function(lr) {
              if (lr.data) {
                lr.data.forEach(function(row) { tokensByWallet[row.wallet_address] = row.tokens != null ? row.tokens : 0; });
                mergeFriendTokenCache(tokensByWallet, null);
              }
              renderInvitedList(r.data, tokensByWallet);
              subscribeFriendsLeaderboardRealtime();
            });
          }
          function renderInvitedList(data, tokensByWallet) {
            list.innerHTML = data.map(function(e, i) {
            var name = e.invited_name || 'Player';
            var wallet = (e.invited_wallet || '').trim();
            var walletShort = wallet ? (wallet.slice(0, 6) + '‚Ä¶') : '';
            var tokens = tokensByWallet[wallet] != null ? tokensByWallet[wallet] : null;
            var tokenStr = tokens != null ? '<span class="text-neon-yellow text-[10px] font-bold">' + tokens + ' tokens</span>' : '';
            var nameEsc = (name || '').replace(/"/g, '&quot;');
            var walletEsc = (wallet || '').replace(/"/g, '&quot;');
            return '<li class="flex flex-wrap items-center gap-2 py-1 border-b border-gray-700/50 last:border-0">' +
              '<span class="flex-1 min-w-0">' + (i + 1) + '. ' + name + (walletShort ? ' (' + walletShort + ')' : '') + (tokenStr ? '<span class="block mt-0.5">' + tokenStr + '</span>' : '') + '</span>' +
              '<span class="flex gap-1 shrink-0">' +
              '<button type="button" class="invited-duel-btn py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-name="' + nameEsc + '" data-wallet="' + walletEsc + '">DUEL</button>' +
              '<button type="button" class="invited-remove-btn py-1 px-2 border border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10" data-name="' + nameEsc + '" data-wallet="' + walletEsc + '">REMOVE</button>' +
              '</span></li>';
          }).join('');
            var refCode = localStorage.getItem('tokenClicker_refCode') || '';
            list.querySelectorAll('.invited-remove-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var name = btn.getAttribute('data-name') || 'this friend';
              if (!confirm('Do you want to remove ' + name + '?')) return;
              var wallet = btn.getAttribute('data-wallet') || '';
              var q = supabase.from('referrals').delete().eq('inviter_ref_code', refCode);
              if (wallet) q = q.eq('invited_wallet', wallet); else q = q.is('invited_wallet', null);
              q.then(function(res) {
                if (res.error) { console.error('Remove invited friend failed:', res.error); if (typeof loadFriendsInvited === 'function') loadFriendsInvited(); return; }
                if (typeof removeFromFriendTokenCache === 'function') removeFromFriendTokenCache(wallet, null);
                if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
              });
            });
          });
            list.querySelectorAll('.invited-duel-btn').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var name = btn.getAttribute('data-name') || 'Friend';
                startDuelWithFriend(name);
              });
            });
          }
        })
        .catch(function() { list.innerHTML = '<li class="text-gray-500">Could not load.</li>'; });
    }
    function startDuelWithFriend(friendName) {
      var supabase = window.supabaseClient;
      var name = getPlayerName();
      if (!name) { window.location.hash = 'wallet'; showPage('wallet'); return; }
      var stake = typeof getPvpCreateStake === 'function' ? getPvpCreateStake() : 5;
      if (typeof hasEnoughTokens === 'function' && !hasEnoughTokens(stake)) {
        window.location.hash = 'multiplayer'; showPage('multiplayer');
        var errEl = document.getElementById('pvp-error');
        if (errEl) { errEl.textContent = 'You need at least ' + stake + ' tokens. Earn tokens by tapping or in Wallet.'; errEl.classList.remove('hidden'); }
        return;
      }
      var me = getPvpPlayerId();
      if (!supabase || !me) { window.location.hash = 'multiplayer'; showPage('multiplayer'); return; }
      supabase.from('rooms').insert({ status: 'open', player1_wallet: me, player1_name: name, stake_amount: stake }).select('id').single()
        .then(function(r) {
          if (r.error) { window.location.hash = 'multiplayer'; showPage('multiplayer'); return; }
          var roomId = r.data.id;
          var url = (typeof getShareBaseUrl === 'function' ? getShareBaseUrl() : (window.location.origin + window.location.pathname)) + '/?room=' + roomId;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(function() {
              window.location.hash = 'multiplayer';
              showPage('multiplayer');
              if (typeof loadPvpRooms === 'function') loadPvpRooms();
              alert('Room created! Link copied. Send it to ' + friendName + ' so they can join the duel.');
            }).catch(function() { window.location.hash = 'multiplayer'; showPage('multiplayer'); if (typeof loadPvpRooms === 'function') loadPvpRooms(); });
          } else {
            window.location.hash = 'multiplayer';
            showPage('multiplayer');
            if (typeof loadPvpRooms === 'function') loadPvpRooms();
            alert('Room created! Share this link with ' + friendName + ': ' + url);
          }
        });
    }
    function loadFriendsAddedByCode() {
      var supabase = window.supabaseClient;
      var list = document.getElementById('friends-added-list');
      if (!list) return;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase) {
        list.innerHTML = '<li class="text-gray-500">Friends unavailable. Add Supabase in supabase-config.js.</li>';
        return;
      }
      if (!me) {
        list.innerHTML = '<li class="text-gray-500">Set your name in Wallet ‚Üí Settings to add friends by code.</li>';
        return;
      }
      list.innerHTML = '<li class="text-gray-500">Loading‚Ä¶</li>';
      supabase.from('friends_by_code').select('friend_ref_code, friend_name, created_at').eq('user_wallet', me).order('created_at', { ascending: false }).limit(50)
        .then(function(r) {
          if (r.error || !r.data || r.data.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No friends added by code yet. Enter a code above.</li>';
            return;
          }
          var codes = r.data.map(function(e) { return (e.friend_ref_code || '').trim(); }).filter(Boolean);
          var cache = getFriendTokenCache();
          var tokensByCode = {};
          codes.forEach(function(c) { var u = c.toUpperCase(); tokensByCode[u] = cache.byRefCode[u] != null ? cache.byRefCode[u] : null; });
          renderAddedList(r.data, tokensByCode);
          if (codes.length > 0) {
            supabase.from('leaderboard').select('ref_code, tokens').in('ref_code', codes).then(function(lr) {
              if (lr.data) {
                lr.data.forEach(function(row) { tokensByCode[(row.ref_code || '').toUpperCase()] = row.tokens != null ? row.tokens : 0; });
                var byRef = {};
                Object.keys(tokensByCode).forEach(function(k) { byRef[k] = tokensByCode[k]; });
                mergeFriendTokenCache(null, byRef);
              }
              renderAddedList(r.data, tokensByCode);
              subscribeFriendsLeaderboardRealtime();
            });
          }
          function renderAddedList(data, tokensByCode) {
            list.innerHTML = data.map(function(e, i) {
            var name = (e.friend_name || e.friend_ref_code || 'Friend').replace(/"/g, '&quot;');
            var code = (e.friend_ref_code || '').replace(/"/g, '&quot;');
            var codeUpper = (e.friend_ref_code || '').trim().toUpperCase();
            var tokens = tokensByCode[codeUpper] != null ? tokensByCode[codeUpper] : null;
            var tokenStr = tokens != null ? '<span class="text-neon-yellow text-[10px] font-bold">' + tokens + ' tokens</span>' : '';
            return '<li class="flex flex-wrap items-center gap-2 py-1 border-b border-gray-700/50 last:border-0">' +
              '<span class="flex-1 min-w-0">' + (i + 1) + '. ' + (e.friend_name || e.friend_ref_code || 'Friend') + (tokenStr ? '<span class="block mt-0.5">' + tokenStr + '</span>' : '') + '</span>' +
              '<span class="flex gap-1 shrink-0">' +
              '<button type="button" class="friend-duel-btn py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-name="' + name + '" data-ref="' + code + '">DUEL</button>' +
              '<button type="button" class="friend-remove-btn py-1 px-2 border border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10" data-name="' + name + '" data-ref="' + code + '">REMOVE</button>' +
              '</span></li>';
          }).join('');
          list.querySelectorAll('.friend-remove-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var name = btn.getAttribute('data-name') || 'this friend';
              if (!confirm('Do you want to remove ' + name + '?')) return;
              var ref = btn.getAttribute('data-ref') || '';
              if (!ref) return;
              supabase.from('friends_by_code').delete().eq('user_wallet', me).eq('friend_ref_code', ref).then(function(res) {
                if (res.error) { console.error('Remove friend failed:', res.error); if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode(); return; }
                if (typeof removeFromFriendTokenCache === 'function') removeFromFriendTokenCache(null, ref);
                if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
              });
            });
          });
          list.querySelectorAll('.friend-duel-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
              var name = btn.getAttribute('data-name') || 'Friend';
              startDuelWithFriend(name);
            });
          });
          }
        })
        .catch(function() { list.innerHTML = '<li class="text-gray-500">Could not load.</li>'; });
    }
    function addFriendByCode() {
      var input = document.getElementById('friend-code-input');
      var feedback = document.getElementById('friend-code-feedback');
      var code = (input && input.value ? input.value.trim() : '').toUpperCase();
      if (!code) {
        if (feedback) { feedback.textContent = 'Enter an invite code.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
        return;
      }
      var supabase = window.supabaseClient;
      var me = typeof getPvpPlayerId === 'function' ? getPvpPlayerId() : null;
      if (!supabase || !me) {
        if (feedback) { feedback.textContent = 'Set your name in Wallet ‚Üí Settings first.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
        return;
      }
      var myRef = localStorage.getItem('tokenClicker_refCode') || '';
      if (myRef && code === myRef.toUpperCase()) {
        if (feedback) { feedback.textContent = "You can't add yourself."; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
        return;
      }
      if (feedback) feedback.classList.add('hidden');
      var refCodePattern = code.replace(/\\/g, '\\\\').replace(/%/g, '\\%').replace(/_/g, '\\_');
      supabase.from('leaderboard').select('name').ilike('ref_code', refCodePattern).limit(1).maybeSingle().then(function(r) {
        if (r.error || !r.data || !r.data.name) {
          if (feedback) { feedback.textContent = 'Unknown invite code. Your friend should open the app, go to Wallet ‚Üí Settings, and SAVE their name so their code is synced.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-green'); feedback.classList.add('text-neon-yellow'); }
          return;
        }
        var friendName = (r.data.name || '').trim() || code;
        supabase.from('friends_by_code').insert({ user_wallet: me, friend_ref_code: code, friend_name: friendName }).then(function(ins) {
          if (ins.error) {
            if (feedback) { feedback.textContent = (ins.error.code === '23505' ? 'Already in your list.' : (ins.error.message || 'Could not add.')); feedback.classList.remove('hidden'); feedback.classList.add('text-neon-yellow'); }
            if (ins.error.code !== '23505' && typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
            return;
          }
          if (input) input.value = '';
          if (feedback) { feedback.textContent = 'Added ' + friendName + ' to your list.'; feedback.classList.remove('hidden'); feedback.classList.remove('text-neon-yellow'); feedback.classList.add('text-neon-green'); }
          if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
        });
      });
    }
    function persistNameToLeaderboard() {
      var name = getPlayerName();
      var wallet = getPvpPlayerId();
      if (!name || !wallet || wallet.indexOf('guest_') === 0) return;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('leaderboard').select('id').eq('wallet_address', wallet).maybeSingle().then(function(r) {
        var row = r.data;
        if (row) {
          supabase.from('leaderboard').update({ name: name, updated_at: new Date().toISOString(), ref_code: localStorage.getItem('tokenClicker_refCode') || null }).eq('id', row.id).then(function() {});
        } else {
          supabase.from('leaderboard').insert({ name: name, wallet_address: wallet, tokens: 0, ref_code: localStorage.getItem('tokenClicker_refCode') || null }).then(function() {});
        }
      });
    }
    function getInGameTokenBalance() {
      if (typeof tokens !== 'undefined') return Math.max(0, parseInt(tokens, 10));
      return Math.max(0, parseInt(localStorage.getItem('tokenClicker_tokens') || '0', 10));
    }
    function hasEnoughTokens(stake) {
      var s = parseInt(stake, 10);
      if (isNaN(s) || s < 1) return false;
      return getInGameTokenBalance() >= s;
    }
    function showPvpOnboarding(reason, roomId) {
      return;
    }
    function hidePvpOnboarding() {
      var modal = document.getElementById('pvp-onboarding-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }
      window._pvpOnboardingRoomId = null;
    }
    document.getElementById('pvp-onboarding-save') && document.getElementById('pvp-onboarding-save').addEventListener('click', function() {
      var nameInput = document.getElementById('pvp-onboarding-name');
      var name = nameInput && nameInput.value.trim().slice(0, 20);
      if (name) setPlayerName(name);
      var roomId = window._pvpOnboardingRoomId || window._pvpInvitedRoomId || (new URLSearchParams(window.location.search).get('room'));
      hidePvpOnboarding();
      window.location.hash = 'multiplayer';
      showPage('multiplayer');
      if (roomId && typeof joinPvpRoom === 'function') {
        joinPvpRoom(roomId);
      } else if (typeof window.loadPvpRooms === 'function') {
        window.loadPvpRooms();
      }
    });
    document.getElementById('pvp-onboarding-skip') && document.getElementById('pvp-onboarding-skip').addEventListener('click', function() {
      hidePvpOnboarding();
      if (window._pvpOnboardingRoomId && typeof window.loadPvpRooms === 'function') window.loadPvpRooms();
    });
    function hideWelcomeNameModal() {
      var m = document.getElementById('welcome-name-modal');
      if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    function hideProfileNameModal() {
      var m = document.getElementById('profile-name-modal');
      if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
    document.getElementById('welcome-name-save') && document.getElementById('welcome-name-save').addEventListener('click', function() {
      var input = document.getElementById('welcome-name-input');
      var name = input && input.value.trim().slice(0, 20);
      if (name) { setPlayerName(name); hideWelcomeNameModal(); updateUI(); }
    });
    document.getElementById('wallet-settings-open-btn') && document.getElementById('wallet-settings-open-btn').addEventListener('click', function() {
      if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
      var modal = document.getElementById('wallet-settings-modal');
      if (modal) { modal.classList.remove('hidden'); modal.style.display = 'flex'; }
    });
    document.getElementById('wallet-settings-modal-close') && document.getElementById('wallet-settings-modal-close').addEventListener('click', function() {
      var modal = document.getElementById('wallet-settings-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
    });
    document.getElementById('wallet-settings-replay-intro') && document.getElementById('wallet-settings-replay-intro').addEventListener('click', function() {
      var modal = document.getElementById('wallet-settings-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
      try { localStorage.removeItem('tokenClicker_onboardingCompleted'); } catch (e) {}
      var overlay = document.getElementById('onboarding-overlay');
      if (overlay) { overlay.classList.remove('hidden'); overlay.style.display = 'flex'; }
      if (app) app.classList.add('hidden');
      showOnboardingStep(0);
    });
    document.getElementById('wallet-settings-btn') && document.getElementById('wallet-settings-btn').addEventListener('click', function() {
      var modal = document.getElementById('profile-name-modal');
      var input = document.getElementById('profile-name-input');
      if (input) input.value = getPlayerName() || '';
      if (modal) { modal.classList.remove('hidden'); modal.style.display = 'flex'; }
    });
    document.getElementById('profile-name-save') && document.getElementById('profile-name-save').addEventListener('click', function() {
      var input = document.getElementById('profile-name-input');
      var name = input && input.value.trim().slice(0, 20);
      if (name) { setPlayerName(name); hideProfileNameModal(); updateProfileDisplayName(); updateUI(); }
    });
    document.getElementById('profile-name-cancel') && document.getElementById('profile-name-cancel').addEventListener('click', hideProfileNameModal);
    function updateProfileDisplayName() {
      var el = document.getElementById('profile-display-name');
      if (el) el.textContent = getPlayerName() || '‚Äî';
      var walletName = document.getElementById('wallet-settings-name');
      if (walletName) walletName.textContent = getPlayerName() || '‚Äî';
    }
    var featherCb = document.getElementById('wallet-setting-feather-effects');
    var featherLabel = document.getElementById('wallet-setting-feather-label');
    if (featherCb) {
      featherCb.checked = localStorage.getItem('tokenClicker_featherEffects') !== '0';
      if (featherLabel) featherLabel.textContent = featherCb.checked ? 'On' : 'Off';
      featherCb.addEventListener('change', function() {
        localStorage.setItem('tokenClicker_featherEffects', featherCb.checked ? '1' : '0');
        if (featherLabel) featherLabel.textContent = featherCb.checked ? 'On' : 'Off';
      });
    }
    // PVP full list modal removed; TOP 5 only on Friends page.

    // --- Notifications ---
    var NOTIFICATIONS_MAX = 50;
    function pushNotification(msg) {
      try {
        var list = JSON.parse(localStorage.getItem('tokenClicker_notifications') || '[]');
        list.unshift({ t: Date.now(), msg: msg });
        if (list.length > NOTIFICATIONS_MAX) list.length = NOTIFICATIONS_MAX;
        localStorage.setItem('tokenClicker_notifications', JSON.stringify(list));
      } catch (e) {}
    }
    function renderNotificationsList() {
      var el = document.getElementById('notifications-list');
      if (!el) return;
      try {
        var list = JSON.parse(localStorage.getItem('tokenClicker_notifications') || '[]');
        if (list.length === 0) { el.innerHTML = '<li class="text-gray-500">No activity yet. Claim bounties and tap to see updates here.</li>'; return; }
        el.innerHTML = list.slice(0, 20).map(function (n) {
          var d = new Date(n.t);
          var when = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          return '<li class="border-b border-gray-700 pb-1">' + (n.msg || '') + ' <span class="text-gray-500">' + when + '</span></li>';
        }).join('');
      } catch (e) { el.innerHTML = '<li class="text-gray-500">No activity yet.</li>'; }
    }
    function updateNotificationsPermissionLabel() {
      var el = document.getElementById('notifications-permission');
      var btn = document.getElementById('notifications-request-btn');
      if (!el) return;
      if (typeof Notification === 'undefined') { el.textContent = 'not supported'; if (btn) btn.disabled = true; return; }
      var p = Notification.permission;
      el.textContent = p === 'granted' ? 'enabled' : p === 'denied' ? 'denied' : 'ask';
      if (btn) { btn.style.display = (p === 'granted' ? 'none' : 'inline-block'); btn.disabled = (p === 'denied'); }
    }
    document.getElementById('notifications-btn') && document.getElementById('notifications-btn').addEventListener('click', function () {
      var modal = document.getElementById('notifications-modal');
      if (!modal) return;
      updateNotificationsPermissionLabel();
      renderNotificationsList();
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    });
    document.getElementById('notifications-close') && document.getElementById('notifications-close').addEventListener('click', function () {
      var modal = document.getElementById('notifications-modal');
      if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
    });
    document.getElementById('notifications-request-btn') && document.getElementById('notifications-request-btn').addEventListener('click', function () {
      if (typeof Notification === 'undefined') return;
      Notification.requestPermission().then(function () { updateNotificationsPermissionLabel(); });
    });
    updateNotificationsPermissionLabel();

    // --- PVP: rooms from Supabase ---
    function getPvpPlayerId() {
      if (window.TonWallet && typeof window.TonWallet.getAddress === 'function') {
        var addr = window.TonWallet.getAddress();
        if (addr) return addr;
      }
      var guest = localStorage.getItem('tokenClicker_pvp_guest_id');
      if (!guest) {
        guest = 'guest_' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('tokenClicker_pvp_guest_id', guest);
      }
      return guest;
    }
    function loadPvpRooms() {
      var list = document.getElementById('pvp-rooms-list');
      var status = document.getElementById('pvp-status');
      var errEl = document.getElementById('pvp-error');
      if (!list) return;
      if (errEl) errEl.classList.add('hidden');
      var supabase = window.supabaseClient;
      if (!supabase) {
        if (status) status.textContent = 'Rooms unavailable.';
        list.innerHTML = '<p class="text-gray-500 text-[10px] p-3">Leaderboard &amp; rooms need Supabase. Add URL and anon key in supabase-config.js and run migrations.</p>';
        return;
      }
      if (status) status.textContent = 'Loading rooms‚Ä¶';
      var nowIso = new Date().toISOString();
      var fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      supabase.from('rooms').update({ status: 'finished', updated_at: nowIso }).eq('status', 'open').lt('created_at', fiveMinAgo).then(function() {});
      supabase.from('rooms').update({ status: 'finished', updated_at: nowIso }).eq('status', 'in_progress').lt('game_ends_at', nowIso).then(function() {});
      supabase.from('rooms').select('id, status, player1_wallet, player2_wallet, player1_name, player2_name, player1_clicks, player2_clicks, game_started_at, game_ends_at, winner_wallet, stake_amount, rematch_until, created_at').order('created_at', { ascending: false }).limit(50)
        .then(function(r) {
          if (status) status.textContent = '';
          if (r.error) {
            if (status) status.textContent = 'Could not load rooms.';
            if (errEl) { errEl.textContent = r.error.message || 'Error'; errEl.classList.remove('hidden'); }
            list.innerHTML = '';
            return;
          }
          var rooms = (r.data || []).filter(function(room) {
            if (room.status === 'open' || room.status === 'in_progress') return true;
            if (room.status === 'finished' && room.rematch_until && new Date(room.rematch_until).getTime() > Date.now()) return true;
            return false;
          });
          var order = { open: 0, in_progress: 1, finished: 2 };
          rooms.sort(function(a, b) {
            var oa = order[a.status] !== undefined ? order[a.status] : 3;
            var ob = order[b.status] !== undefined ? order[b.status] : 3;
            if (oa !== ob) return oa - ob;
            return new Date(b.created_at) - new Date(a.created_at);
          });
          var me = getPvpPlayerId();
          list.innerHTML = rooms.map(function(room) {
            var p1 = room.player1_wallet || '‚Äî';
            var p2 = room.player2_wallet || '‚Äî';
            var count = (p1 && p1 !== '‚Äî' ? 1 : 0) + (p2 && p2 !== '‚Äî' ? 1 : 0);
            var isOpen = room.status === 'open' && count < 2;
            var isMine = p1 === me || p2 === me;
            var shortId = room.id.slice(0, 8);
            var joinBtn = isOpen && p1 !== me ? '<button type="button" class="pvp-join-btn mt-2 py-1 px-2 border border-neon-cyan text-neon-cyan rounded text-[9px] hover:bg-neon-cyan/10" data-room-id="' + room.id + '">JOIN</button>' : '';
            var enterDuelBtn = room.status === 'in_progress' && isMine ? '<button type="button" class="pvp-enter-duel-btn mt-2 py-1 px-2 border border-neon-green text-neon-green rounded text-[9px] hover:bg-neon-green/10" data-room-id="' + room.id + '">ENTER DUEL</button>' : '';
            var closeBtn = room.status === 'open' && p1 === me ? '<button type="button" class="pvp-close-room-btn mt-2 py-1 px-2 border border-neon-pink text-neon-pink rounded text-[9px] hover:bg-neon-pink/10" data-room-id="' + room.id + '">CLOSE ROOM</button>' : '';
            var base = (window.TON_CONFIG && window.TON_CONFIG.gameBaseUrl ? window.TON_CONFIG.gameBaseUrl : (window.location.origin + window.location.pathname)).replace(/\/?$/, '');
            var shareLink = base + '/?room=' + room.id;
            var stake = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 5;
            if (isNaN(stake) || stake < 1) stake = 5;
            var cardAction = isOpen && p1 !== me ? 'join' : (room.status === 'in_progress' && isMine ? 'enter-duel' : '');
            return '<div class="pvp-room-card bg-pixel-panel border-2 border-gray-700 p-3 rounded text-left cursor-pointer hover:border-gray-500" data-room-id="' + room.id + '" data-room-action="' + cardAction + '" data-room-stake="' + stake + '">' +
              '<div class="text-[10px] text-neon-pink">Room ' + shortId + (isMine ? ' (you)' : '') + ' ¬∑ ' + stake + ' tokens</div>' +
              '<div class="text-gray-500 text-[9px] mt-1">' + count + '/2 ¬∑ ' + room.status + '</div>' +
              '<div class="mt-2 flex flex-wrap gap-2 items-center">' + joinBtn + enterDuelBtn + closeBtn +
              '<button type="button" class="pvp-copy-link-btn py-1 px-2 border border-gray-500 text-gray-400 rounded text-[9px] hover:bg-gray-700" data-room-id="' + room.id + '" data-room-url="' + shareLink + '">COPY LINK</button>' +
              '</div></div>';
          }).join('');
          if (rooms.length === 0) list.innerHTML = '<p class="text-gray-500 text-[10px] p-3">No rooms yet. Create one above.</p>';
          // Use one delegated click on the list so all buttons and card clicks work
          list.onclick = function(ev) {
            var target = ev.target;
            var roomId = target.getAttribute && target.getAttribute('data-room-id');
            if (!roomId) {
              var card = target.closest && target.closest('.pvp-room-card');
              if (card) {
                roomId = card.getAttribute('data-room-id');
                var action = card.getAttribute('data-room-action');
                if (action === 'join') { ev.preventDefault(); joinPvpRoom(roomId); return; }
                if (action === 'enter-duel') { ev.preventDefault(); enterDuel(roomId); return; }
              }
              return;
            }
            if (target.classList && target.classList.contains('pvp-join-btn')) { ev.preventDefault(); joinPvpRoom(roomId); return; }
            if (target.classList && target.classList.contains('pvp-enter-duel-btn')) { ev.preventDefault(); enterDuel(roomId); return; }
            if (target.classList && target.classList.contains('pvp-close-room-btn')) { ev.preventDefault(); closePvpRoom(roomId); return; }
            if (target.classList && target.classList.contains('pvp-copy-link-btn')) {
              ev.preventDefault();
              var url = target.getAttribute('data-room-url');
              if (url && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(function() {
                  var statusEl = document.getElementById('pvp-status');
                  if (statusEl) { statusEl.textContent = 'Room link copied!'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
                });
              }
              return;
            }
            var card = target.closest && target.closest('.pvp-room-card');
            if (card) {
              var action = card.getAttribute('data-room-action');
              if (action === 'join') { ev.preventDefault(); joinPvpRoom(roomId); return; }
              if (action === 'enter-duel') { ev.preventDefault(); enterDuel(roomId); return; }
            }
          };
        })
        .catch(function(e) {
          if (status) status.textContent = '';
          if (errEl) { errEl.textContent = e.message || 'Network error'; errEl.classList.remove('hidden'); }
          list.innerHTML = '';
        });
    }
    function getPvpCreateStake() {
      var custom = document.getElementById('pvp-custom-stake');
      if (custom && custom.value.trim() !== '') {
        var n = parseInt(custom.value.trim(), 10);
        if (!isNaN(n) && n >= 1 && n <= 999) return n;
      }
      var sel = document.querySelector('.pvp-stake-btn.border-neon-green');
      if (sel && sel.getAttribute('data-stake')) return parseInt(sel.getAttribute('data-stake'), 10) || 5;
      return PVP_DEFAULT_STAKE;
    }
    function createPvpRoom() {
      var supabase = window.supabaseClient;
      var btn = document.getElementById('pvp-create-room-btn');
      var errEl = document.getElementById('pvp-error');
      if (!supabase) { if (errEl) { errEl.textContent = 'Supabase not configured.'; errEl.classList.remove('hidden'); } return; }
      var name = getPlayerName();
      if (!name) { showPvpOnboarding('name'); return; }
      var stake = getPvpCreateStake();
      if (!hasEnoughTokens(stake)) {
        if (errEl) { errEl.textContent = 'You need at least ' + stake + ' in-game tokens to create this room. Earn tokens by tapping or claiming bounties.'; errEl.classList.remove('hidden'); }
        return;
      }
      if (btn) btn.disabled = true;
      var me = getPvpPlayerId();
      supabase.from('rooms').insert({ status: 'open', player1_wallet: me, player1_name: name, stake_amount: stake }).select('id').single()
        .then(function(r) {
          if (btn) btn.disabled = false;
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Failed to create room'; errEl.classList.remove('hidden'); } return; }
          var status = document.getElementById('pvp-status');
          if (status) { status.textContent = 'Room created! Share the link. When someone joins, the duel starts.'; status.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { status.textContent = ''; status.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 4000); }
          loadPvpRooms();
          if (errEl) errEl.classList.add('hidden');
        })
        .catch(function(e) {
          if (btn) btn.disabled = false;
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function closePvpRoom(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var me = getPvpPlayerId();
      supabase.from('rooms').update({ status: 'finished', updated_at: new Date().toISOString() }).eq('id', roomId).eq('status', 'open').eq('player1_wallet', me)
        .then(function(r) {
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Could not close room'; errEl.classList.remove('hidden'); } return; }
          if (errEl) errEl.classList.add('hidden');
          loadPvpRooms();
          var statusEl = document.getElementById('pvp-status');
          if (statusEl) { statusEl.textContent = 'Room closed.'; statusEl.className = 'text-[9px] text-neon-green mb-2 min-h-[14px]'; setTimeout(function() { statusEl.textContent = ''; statusEl.className = 'text-[9px] text-gray-500 mb-2 min-h-[14px]'; }, 3000); }
        })
        .catch(function(e) {
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }
    function joinPvpRoom(roomId) {
      var supabase = window.supabaseClient;
      var errEl = document.getElementById('pvp-error');
      if (!supabase || !roomId) return;
      var name = getPlayerName();
      if (!name) { showPvpOnboarding('name', roomId); return; }
      var me = getPvpPlayerId();
      supabase.from('rooms').select('status, player1_wallet, player2_wallet, stake_amount').eq('id', roomId).single().then(function(check) {
        if (check.error || !check.data) { if (errEl) { errEl.textContent = 'Room not found.'; errEl.classList.remove('hidden'); } return; }
        var room = check.data;
        var stake = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 5;
        if (isNaN(stake) || stake < 1) stake = 5;
        if (!hasEnoughTokens(stake)) {
          if (errEl) { errEl.textContent = 'You need at least ' + stake + ' in-game tokens to join this wager. Your balance: ' + getInGameTokenBalance() + '.'; errEl.classList.remove('hidden'); }
          return;
        }
        if (room.status !== 'open') { if (errEl) { errEl.textContent = 'Room is full or game already started.'; errEl.classList.remove('hidden'); } return; }
        if (room.player2_wallet) { if (errEl) { errEl.textContent = 'Room is full. Only 2 players per game.'; errEl.classList.remove('hidden'); } return; }
        if (room.player1_wallet === me) { if (errEl) { errEl.textContent = 'You already created this room. Wait for opponent or close it.'; errEl.classList.remove('hidden'); } return; }
        doJoinPvpRoom(roomId, me, name, errEl);
      });
    }
    function doJoinPvpRoom(roomId, me, name, errEl) {
      var supabase = window.supabaseClient;
      var now = new Date();
      var totalSec = PVP_COUNTDOWN_SEC + PVP_GAME_DURATION_SEC;
      var endsAt = new Date(now.getTime() + totalSec * 1000);
      supabase.from('rooms').update({
        player2_wallet: me,
        player2_name: name,
        status: 'in_progress',
        game_started_at: now.toISOString(),
        game_ends_at: endsAt.toISOString(),
        updated_at: now.toISOString()
      }).eq('id', roomId).eq('status', 'open')
        .then(function(r) {
          if (r.error) { if (errEl) { errEl.textContent = r.error.message || 'Could not join'; errEl.classList.remove('hidden'); } return; }
          loadPvpRooms();
          if (errEl) errEl.classList.add('hidden');
          enterDuel(roomId);
        })
        .catch(function(e) {
          if (errEl) { errEl.textContent = e.message || 'Error'; errEl.classList.remove('hidden'); }
        });
    }

    // --- PVP: duel view, realtime clicks, timer, winner, rematch ---
    var pvpDuelRoomId = null;
    var pvpDuelMyRole = 0; // 1 or 2
    var pvpDuelTimerId = null;
    var pvpDuelRealtimeUnsub = null;
    var pvpDuelPollId = null;
    var pvpDuelLastClickAt = 0;
    var pvpRematchCountdownId = null;
    var pvpRematchChannelUnsub = null;
    // Play vs Computer (no Supabase)
    var pvpVsBotMode = false;
    var pvpBotClicks = 0;
    var pvpMyClicksVsBot = 0;
    var pvpBotIntervalId = null;
    var pvpLastWasVsBot = false;

    function showDuelLobby() {
      document.getElementById('pvp-duel-view').classList.add('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-create-card').classList.remove('hidden');
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = '';
      if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
      if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
      if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
      if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
      if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
      if (pvpBotIntervalId) { clearInterval(pvpBotIntervalId); pvpBotIntervalId = null; }
      pvpDuelRoomId = null;
      pvpDuelMyRole = 0;
      pvpVsBotMode = false;
    }
    function startVsComputer() {
      pvpVsBotMode = true;
      pvpDuelRoomId = null;
      pvpDuelMyRole = 1;
      pvpMyClicksVsBot = 0;
      pvpBotClicks = 0;
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = 'none';
      document.getElementById('pvp-duel-view').classList.remove('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-duel-waiting').classList.add('hidden');
      document.getElementById('pvp-duel-you-name').textContent = getPlayerName() || 'You';
      document.getElementById('pvp-duel-opp-name').textContent = 'Computer';
      document.getElementById('pvp-duel-you-clicks').textContent = '0';
      document.getElementById('pvp-duel-opp-clicks').textContent = '0';
      var endsAt = Date.now() + (PVP_COUNTDOWN_SEC + PVP_GAME_DURATION_SEC) * 1000;
      startDuelTimer(endsAt);
      if (pvpBotIntervalId) clearInterval(pvpBotIntervalId);
      if (window._pvpBotStartTimeout) clearTimeout(window._pvpBotStartTimeout);
      window._pvpBotStartTimeout = setTimeout(function() {
        window._pvpBotStartTimeout = null;
        if (!pvpVsBotMode) return;
        pvpBotIntervalId = setInterval(function() {
          if (!pvpVsBotMode) { clearInterval(pvpBotIntervalId); pvpBotIntervalId = null; return; }
          pvpBotClicks += 1;
          var el = document.getElementById('pvp-duel-opp-clicks');
          if (el) el.textContent = String(pvpBotClicks);
        }, 280 + Math.random() * 120);
      }, PVP_COUNTDOWN_SEC * 1000);
    }
    function endVsComputerGame() {
      if (!pvpVsBotMode) return;
      if (pvpBotIntervalId) { clearInterval(pvpBotIntervalId); pvpBotIntervalId = null; }
      pvpVsBotMode = false;
      var winner = pvpMyClicksVsBot > pvpBotClicks ? 'me' : (pvpBotClicks > pvpMyClicksVsBot ? 'bot' : null);
      document.getElementById('pvp-duel-view').classList.add('hidden');
      var resultEl = document.getElementById('pvp-duel-result');
      resultEl.classList.remove('hidden');
      pvpLastWasVsBot = true;
      if (winner === 'me') {
        document.getElementById('pvp-duel-result-title').textContent = 'YOU WIN!';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-green';
        document.getElementById('pvp-duel-result-detail').textContent = 'You beat the computer! Practice wins don\'t count on the leaderboard. Play vs a friend for real.';
      } else if (winner === 'bot') {
        document.getElementById('pvp-duel-result-title').textContent = 'COMPUTER WINS';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-pink';
        document.getElementById('pvp-duel-result-detail').textContent = 'The computer had more taps. Try again or invite a friend to duel!';
      } else {
        document.getElementById('pvp-duel-result-title').textContent = 'DRAW';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 text-gray-400';
        document.getElementById('pvp-duel-result-detail').textContent = 'Tie! No winner.';
      }
    }
    function enterDuel(roomId) {
      pvpDuelRoomId = roomId;
      pvpVsBotMode = false;
      var lobbyWrap = document.getElementById('pvp-lobby-wrap');
      if (lobbyWrap) lobbyWrap.style.display = 'none';
      document.getElementById('pvp-duel-view').classList.remove('hidden');
      document.getElementById('pvp-duel-result').classList.add('hidden');
      document.getElementById('pvp-duel-waiting').classList.add('hidden');
      var me = getPvpPlayerId();
      var supabase = window.supabaseClient;
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status === 'finished') { showDuelResult(room); document.getElementById('pvp-duel-view').classList.add('hidden'); document.getElementById('pvp-duel-result').classList.remove('hidden'); var lobbyWrap = document.getElementById('pvp-lobby-wrap'); if (lobbyWrap) lobbyWrap.style.display = 'none'; return; }
        pvpDuelMyRole = room.player1_wallet === me ? 1 : (room.player2_wallet === me ? 2 : 0);
        var youName = pvpDuelMyRole === 1 ? (room.player1_name || 'You') : (room.player2_name || 'You');
        var oppName = pvpDuelMyRole === 1 ? (room.player2_name || 'Opponent') : (room.player1_name || 'Opponent');
        document.getElementById('pvp-duel-you-name').textContent = youName;
        document.getElementById('pvp-duel-opp-name').textContent = oppName;
        document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
        document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
        var endsAt = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
        if (!endsAt && room.status === 'in_progress') {
          document.getElementById('pvp-duel-waiting').classList.remove('hidden');
        }
        startDuelTimer(endsAt);
        subscribeDuelRoom(roomId);
        if (pvpDuelPollId) clearInterval(pvpDuelPollId);
        pvpDuelPollId = setInterval(function() {
          if (!pvpDuelRoomId) { if (pvpDuelPollId) clearInterval(pvpDuelPollId); pvpDuelPollId = null; return; }
          supabase.from('rooms').select('player1_clicks, player2_clicks, status, game_ends_at').eq('id', roomId).single().then(function(r) {
            if (r.error || !r.data) return;
            var room = r.data;
            document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
            document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
            if (room.status === 'finished') { if (pvpDuelPollId) clearInterval(pvpDuelPollId); pvpDuelPollId = null; if (pvpDuelTimerId) clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; endDuelGame(); }
          });
        }, 250);
      });
    }
    function startDuelTimer(endsAtMs) {
      if (pvpDuelTimerId) clearInterval(pvpDuelTimerId);
      var countdownEndMs = endsAtMs - PVP_GAME_DURATION_SEC * 1000;
      var clickBtn = document.getElementById('pvp-duel-click-btn');
      if (clickBtn) clickBtn.disabled = true;
      function tick() {
        var now = Date.now();
        if (endsAtMs <= 0) return;
        if (now < countdownEndMs) {
          var countdownLeft = Math.ceil((countdownEndMs - now) / 1000);
          var el = document.getElementById('pvp-duel-timer');
          if (el) {
            if (countdownLeft >= 4) el.textContent = '3';
            else if (countdownLeft === 3) el.textContent = '2';
            else if (countdownLeft === 2) el.textContent = '1';
            else if (countdownLeft === 1) el.textContent = 'GO!';
            else el.textContent = 'GO!';
          }
          return;
        }
        if (clickBtn && clickBtn.disabled) clickBtn.disabled = false;
        var left = Math.max(0, Math.ceil((endsAtMs - now) / 1000));
        var el = document.getElementById('pvp-duel-timer');
        if (el) el.textContent = '0:' + (left < 10 ? '0' : '') + left;
        if (left <= 0) {
          clearInterval(pvpDuelTimerId);
          pvpDuelTimerId = null;
          if (pvpVsBotMode) endVsComputerGame(); else endDuelGame();
        }
      }
      tick();
      pvpDuelTimerId = setInterval(tick, 200);
    }
    function subscribeDuelRoom(roomId) {
      var supabase = window.supabaseClient;
      if (!supabase) return;
      if (pvpDuelRealtimeUnsub) pvpDuelRealtimeUnsub();
      var me = getPvpPlayerId();
      var channel = supabase.channel('room-' + roomId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, function(payload) {
        var room = payload.new;
        if (!room || room.id !== roomId) return;
        document.getElementById('pvp-duel-you-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player1_clicks : room.player2_clicks);
        document.getElementById('pvp-duel-opp-clicks').textContent = String(pvpDuelMyRole === 1 ? room.player2_clicks : room.player1_clicks);
        var endsAt = room.game_ends_at ? new Date(room.game_ends_at).getTime() : 0;
        if (endsAt && !pvpDuelTimerId) startDuelTimer(endsAt);
        if (room.status === 'finished') {
          if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
          showDuelResult(room);
        }
      }).subscribe();
      pvpDuelRealtimeUnsub = function() { supabase.removeChannel(channel); };
    }
    function endDuelGame() {
      if (pvpVsBotMode) { endVsComputerGame(); return; }
      if (!pvpDuelRoomId) return;
      var supabase = window.supabaseClient;
      supabase.from('rooms').select('*').eq('id', pvpDuelRoomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status === 'finished') { showDuelResult(room); return; }
        var c1 = room.player1_clicks || 0, c2 = room.player2_clicks || 0;
        var winner = c1 > c2 ? room.player1_wallet : (c2 > c1 ? room.player2_wallet : null);
        var rematchUntil = new Date(Date.now() + 60 * 1000).toISOString();
        supabase.from('rooms').update({ status: 'finished', winner_wallet: winner, updated_at: new Date().toISOString(), rematch_until: rematchUntil }).eq('id', pvpDuelRoomId).then(function() {
          room.status = 'finished';
          room.winner_wallet = winner;
          room.rematch_until = rematchUntil;
          showDuelResult(room);
          if (winner) upsertLeaderboardWin(winner, room.player1_wallet === winner ? room.player1_name : room.player2_name);
        });
      });
    }
    function endDuelEarly() {
      if (pvpVsBotMode) { endVsComputerGame(); return; }
      if (!pvpDuelRoomId) return;
      if (pvpDuelTimerId) { clearInterval(pvpDuelTimerId); pvpDuelTimerId = null; }
      if (pvpDuelPollId) { clearInterval(pvpDuelPollId); pvpDuelPollId = null; }
      endDuelGame();
    }
    function showDuelResult(room) {
      pvpLastWasVsBot = false;
      if (pvpDuelRealtimeUnsub) { pvpDuelRealtimeUnsub(); pvpDuelRealtimeUnsub = null; }
      if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
      if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
      document.getElementById('pvp-duel-view').classList.add('hidden');
      var resultEl = document.getElementById('pvp-duel-result');
      resultEl.classList.remove('hidden');
      var me = getPvpPlayerId();
      var winnerWallet = room.winner_wallet;
      var winName = room.player1_wallet === winnerWallet ? room.player1_name : (room.player2_name || 'Winner');
      var stake = room.stake_amount != null ? parseInt(room.stake_amount, 10) : 5;
      if (isNaN(stake) || stake < 1) stake = 5;
      if (winnerWallet === me) {
        if (typeof addTokens === 'function') addTokens(stake);
        try { localStorage.setItem('tokenClicker_firstPvpWin', '1'); } catch (e) {}
        if (typeof updateBadges === 'function') updateBadges();
        document.getElementById('pvp-duel-result-title').textContent = 'YOU WIN!';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-green';
        document.getElementById('pvp-duel-result-detail').textContent = 'You won ' + stake + ' tokens. You\'re on the leaderboard.';
      } else if (winnerWallet) {
        if (typeof tokens !== 'undefined') {
          tokens = Math.max(0, (tokens || 0) - stake);
          if (typeof save === 'function') save();
          if (typeof updateUI === 'function') updateUI();
        }
        document.getElementById('pvp-duel-result-title').textContent = 'YOU LOSE';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 neon-text-pink';
        document.getElementById('pvp-duel-result-detail').textContent = winName + ' won. You lost ' + stake + ' tokens.';
      } else {
        document.getElementById('pvp-duel-result-title').textContent = 'DRAW';
        document.getElementById('pvp-duel-result-title').className = 'text-lg font-bold mb-2 text-gray-400';
        document.getElementById('pvp-duel-result-detail').textContent = 'Tie! No token transfer.';
      }
      var rematchCountEl = document.getElementById('pvp-duel-rematch-countdown');
      var rematchBtn = document.getElementById('pvp-duel-rematch-btn');
      var roomId = pvpDuelRoomId;
      var rematchUntil = room.rematch_until ? new Date(room.rematch_until).getTime() : 0;
      if (roomId && rematchUntil > Date.now() && window.supabaseClient) {
        rematchCountEl.classList.remove('hidden');
        function updateRematchCountdown() {
          var left = Math.max(0, Math.ceil((rematchUntil - Date.now()) / 1000));
          rematchCountEl.textContent = left > 0 ? 'Rematch ‚Äî ' + left + 's (same stake, no extra cost)' : 'Room closed. No rematch in time.';
          if (left <= 0) {
            if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
            if (rematchBtn) rematchBtn.disabled = true;
            if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
          }
        }
        updateRematchCountdown();
        pvpRematchCountdownId = setInterval(updateRematchCountdown, 1000);
        var channel = window.supabaseClient.channel('rematch-' + roomId).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: 'id=eq.' + roomId }, function(payload) {
          var r = payload.new;
          if (r && r.status === 'in_progress' && r.game_ends_at && new Date(r.game_ends_at).getTime() > Date.now()) {
            if (pvpRematchCountdownId) { clearInterval(pvpRematchCountdownId); pvpRematchCountdownId = null; }
            if (pvpRematchChannelUnsub) { pvpRematchChannelUnsub(); pvpRematchChannelUnsub = null; }
            enterDuel(roomId);
          }
        }).subscribe();
        pvpRematchChannelUnsub = function() { window.supabaseClient.removeChannel(channel); };
      } else {
        rematchCountEl.classList.add('hidden');
      }
    }
    function upsertLeaderboardWin(wallet, name) {
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('leaderboard').select('id, pvp_wins, name').eq('wallet_address', wallet).maybeSingle().then(function(r) {
        var row = r.data;
        var wins = (row && (row.pvp_wins || 0)) || 0;
        if (row) {
          supabase.from('leaderboard').update({ pvp_wins: wins + 1, name: name || row.name, updated_at: new Date().toISOString() }).eq('id', row.id).then(function() { if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp(); });
        } else {
          supabase.from('leaderboard').insert({ name: name || 'Player', wallet_address: wallet, tokens: 0, pvp_wins: 1, ref_code: localStorage.getItem('tokenClicker_refCode') || null }).then(function() { if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp(); });
        }
      });
    }
    document.getElementById('pvp-duel-click-btn') && document.getElementById('pvp-duel-click-btn').addEventListener('click', function(e) {
      var clickBtn = document.getElementById('pvp-duel-click-btn');
      if (clickBtn) {
        clickBtn.classList.remove('pvp-duel-tap-pulse');
        clickBtn.offsetHeight;
        clickBtn.classList.add('pvp-duel-tap-pulse');
        setTimeout(function() { if (clickBtn) clickBtn.classList.remove('pvp-duel-tap-pulse'); }, 120);
        if (localStorage.getItem('tokenClicker_featherEffects') !== '0') {
          var rect = clickBtn.getBoundingClientRect();
          spawnFeathersAt(rect.left + rect.width / 2, rect.top + rect.height / 2);
        }
      }
      if (pvpVsBotMode) {
        var now = Date.now();
        if (now - pvpDuelLastClickAt < PVP_CLICK_COOLDOWN_MS) return;
        pvpDuelLastClickAt = now;
        pvpMyClicksVsBot += 1;
        var el = document.getElementById('pvp-duel-you-clicks');
        if (el) el.textContent = String(pvpMyClicksVsBot);
        return;
      }
      if (!pvpDuelRoomId || !pvpDuelMyRole) return;
      var now = Date.now();
      if (now - pvpDuelLastClickAt < PVP_CLICK_COOLDOWN_MS) return;
      pvpDuelLastClickAt = now;
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.rpc('increment_pvp_clicks', { room_id: pvpDuelRoomId, player_num: pvpDuelMyRole }).then(function(r) {
        if (r.data && r.data.clicks != null) document.getElementById('pvp-duel-you-clicks').textContent = String(r.data.clicks);
      });
    });
    document.getElementById('pvp-duel-end-game-btn') && document.getElementById('pvp-duel-end-game-btn').addEventListener('click', function() {
      endDuelEarly();
    });
    document.getElementById('pvp-duel-rematch-btn') && document.getElementById('pvp-duel-rematch-btn').addEventListener('click', function() {
      if (pvpLastWasVsBot) {
        showDuelLobby();
        startVsComputer();
        return;
      }
      if (!pvpDuelRoomId || !pvpDuelMyRole) { showDuelLobby(); if (typeof loadPvpRooms === 'function') loadPvpRooms(); return; }
      var supabase = window.supabaseClient;
      if (!supabase) { showDuelLobby(); if (typeof loadPvpRooms === 'function') loadPvpRooms(); return; }
      var me = getPvpPlayerId();
      var col = pvpDuelMyRole === 1 ? 'player1_wants_rematch' : 'player2_wants_rematch';
      supabase.from('rooms').update({ [col]: true, updated_at: new Date().toISOString() }).eq('id', pvpDuelRoomId).then(function() {
        supabase.from('rooms').select('player1_wants_rematch, player2_wants_rematch, rematch_until').eq('id', pvpDuelRoomId).single().then(function(r) {
          if (r.error || !r.data) return;
          var room = r.data;
          var until = room.rematch_until ? new Date(room.rematch_until).getTime() : 0;
          if (until <= Date.now()) return;
          if (room.player1_wants_rematch && room.player2_wants_rematch) {
            var now = new Date();
            var totalSec = (typeof PVP_COUNTDOWN_SEC !== 'undefined' ? PVP_COUNTDOWN_SEC : 3) + (typeof PVP_GAME_DURATION_SEC !== 'undefined' ? PVP_GAME_DURATION_SEC : 30);
            var endsAt = new Date(now.getTime() + totalSec * 1000);
            supabase.from('rooms').update({
              status: 'in_progress',
              winner_wallet: null,
              player1_clicks: 0,
              player2_clicks: 0,
              game_started_at: now.toISOString(),
              game_ends_at: endsAt.toISOString(),
              player1_wants_rematch: false,
              player2_wants_rematch: false,
              rematch_until: null,
              updated_at: now.toISOString()
            }).eq('id', pvpDuelRoomId).then(function() {
              enterDuel(pvpDuelRoomId);
            });
          }
        });
      });
    });
    document.getElementById('pvp-duel-lobby-btn') && document.getElementById('pvp-duel-lobby-btn').addEventListener('click', function() {
      showDuelLobby();
      if (typeof loadPvpRooms === 'function') loadPvpRooms();
    });

    // Creator: when player2 joins, start game (set game_ends_at) and enter duel
    function checkMyRoomStarted(roomId) {
      var me = getPvpPlayerId();
      var supabase = window.supabaseClient;
      if (!supabase) return;
      supabase.from('rooms').select('*').eq('id', roomId).single().then(function(r) {
        if (r.error || !r.data) return;
        var room = r.data;
        if (room.status !== 'in_progress' || room.player1_wallet !== me) return;
        if (!room.game_ends_at) {
          var now = new Date();
          var totalSec = PVP_COUNTDOWN_SEC + PVP_GAME_DURATION_SEC;
          var endsAt = new Date(now.getTime() + totalSec * 1000);
          supabase.from('rooms').update({ game_started_at: now.toISOString(), game_ends_at: endsAt.toISOString(), updated_at: now.toISOString() }).eq('id', roomId).then(function() { enterDuel(roomId); });
        } else {
          enterDuel(roomId);
        }
      });
    }
    window.enterDuel = enterDuel;
    window.checkMyRoomStarted = checkMyRoomStarted;
    window.startVsComputer = startVsComputer;
    var pvpCreateBtn = document.getElementById('pvp-create-room-btn');
    var pvpRefreshBtn = document.getElementById('pvp-refresh-btn');
    if (pvpCreateBtn) pvpCreateBtn.addEventListener('click', createPvpRoom);
    if (pvpRefreshBtn) pvpRefreshBtn.addEventListener('click', function() { loadPvpRooms(); });
    document.querySelectorAll('.pvp-stake-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.pvp-stake-btn').forEach(function(b) {
          b.classList.remove('border-neon-green', 'text-neon-green', 'bg-neon-green/10');
          b.classList.add('border-gray-600', 'text-gray-400');
        });
        this.classList.add('border-neon-green', 'text-neon-green', 'bg-neon-green/10');
        this.classList.remove('border-gray-600', 'text-gray-400');
        var custom = document.getElementById('pvp-custom-stake');
        if (custom) custom.value = '';
      });
    });
    document.getElementById('pvp-vs-computer-btn') && document.getElementById('pvp-vs-computer-btn').addEventListener('click', function() {
      var name = getPlayerName();
      if (!name) {
        var n = prompt('Enter your name to play vs computer (practice):', 'Player');
        if (n && n.trim()) setPlayerName(n.trim().slice(0, 20));
      }
      startVsComputer();
    });
    document.getElementById('pvp-invited-join-btn') && document.getElementById('pvp-invited-join-btn').addEventListener('click', function() {
      var roomId = window._pvpInvitedRoomId || new URLSearchParams(window.location.search).get('room');
      if (roomId) joinPvpRoom(roomId);
    });
    window.loadPvpRooms = loadPvpRooms;

    document.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });
    setInterval(updateClicksPerSecond, 200);

    // Routing
    function getPageFromHash() {
      const hash = (window.location.hash || '#home').slice(1).toLowerCase();
      return hash === '' ? 'home' : hash;
    }
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById('page-' + pageId);
      if (el) el.classList.add('active');
      if (pageId === 'home' && typeof updateUI === 'function') updateUI();
      if (pageId === 'friends') {
        startFriendsTokenPolling();
        if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
        if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
      } else {
        stopFriendsTokenPolling();
      }
      document.querySelectorAll('.nav-link').forEach(a => {
        a.classList.toggle('text-neon-cyan', a.getAttribute('data-page') === pageId);
        a.classList.toggle('text-gray-400', a.getAttribute('data-page') !== pageId);
      });
      if (pageId === 'friends') {
        if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
        if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
      }
      if (pageId === 'wallet') {
        if (typeof updateProfileDisplayName === 'function') updateProfileDisplayName();
        if (typeof fetchTonPrice === 'function') fetchTonPrice();
      }
      if (pageId === 'multiplayer') {
        if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
        if (typeof window.loadPvpRooms === 'function') window.loadPvpRooms();
        var invitedCard = document.getElementById('pvp-invited-card');
        if (invitedCard) invitedCard.classList.add('hidden');
        try {
          if (sessionStorage.getItem('tokenClicker_startVsComputer') === '1') {
            sessionStorage.removeItem('tokenClicker_startVsComputer');
            setTimeout(function() { if (typeof window.startVsComputer === 'function') window.startVsComputer(); }, 100);
          }
        } catch (e) {}
      }
    }
    window.addEventListener('hashchange', () => showPage(getPageFromHash()));

    // Onboarding: multi-step intro for new users
    const app = document.getElementById('app');
    const ONBOARDING_STEPS = [
      { icon: 'üê¶', title: 'WELCOME TO 1N TOKEN CLICKER', desc: 'Tap the Cardinal to earn tokens. Every 10 taps = 1 token. Build the community one tap at a time!' },
      { icon: '‚ö°', title: 'BOOSTS', desc: 'Spend tokens on Power (2x), Autoclicker, and faster cooldown. Earn more tokens faster!' },
      { icon: 'üéØ', title: 'BOUNTIES', desc: 'Claim daily rewards, weekly challenges, and tap milestones. Free tokens for completing goals!' },
      { icon: 'üèÜ', title: 'PVP DUELS', desc: 'Challenge friends in 30-second click races. Stake tokens ‚Äî winner takes all!' },
      { icon: 'üëõ', title: 'WALLET', desc: 'Connect Tonkeeper to swap $CARD for tokens or withdraw tokens to on-chain $CARD.' }
    ];
    let onboardingStep = 0;
    function showOnboardingStep(step) {
      onboardingStep = step;
      var container = document.getElementById('onboarding-step');
      var backBtn = document.getElementById('onboarding-back');
      var nextBtn = document.getElementById('onboarding-next');
      if (!container || !backBtn || !nextBtn) return;
      var s = ONBOARDING_STEPS[step];
      container.innerHTML = '<div class="text-4xl mb-4">' + s.icon + '</div><p class="text-neon-cyan text-[10px] font-bold mb-2">' + s.title + '</p><p class="text-gray-300 text-[9px] leading-relaxed">' + s.desc + '</p>';
      backBtn.classList.toggle('hidden', step === 0);
      nextBtn.textContent = step === 4 ? "LET'S PLAY!" : 'NEXT';
      document.querySelectorAll('.onboarding-dot').forEach(function(dot, i) {
        dot.classList.toggle('bg-neon-cyan', i === step);
        dot.classList.toggle('bg-gray-600', i !== step);
      });
    }
    function finishOnboarding() {
      try { localStorage.setItem('tokenClicker_onboardingCompleted', '1'); } catch (e) {}
      var overlay = document.getElementById('onboarding-overlay');
      if (overlay) { overlay.classList.add('hidden'); overlay.style.display = 'none'; }
      if (app) app.classList.remove('hidden');
      updateBountyProgress();
      save();
      showPage(getPageFromHash());
      updateUI();
      var playerName = typeof getPlayerName === 'function' ? getPlayerName() : null;
      if (!playerName) {
        var welcomeModal = document.getElementById('welcome-name-modal');
        var welcomeText = welcomeModal && welcomeModal.querySelector('.text-gray-300');
        var invitedBy = localStorage.getItem('tokenClicker_invitedBy');
        if (welcomeText) welcomeText.textContent = invitedBy ? 'You were invited! Enter your display name to accept and join. You can change it later in Wallet ‚Üí Settings.' : 'Enter your display name once. You can change it later in Wallet ‚Üí Settings.';
        if (welcomeModal) { welcomeModal.classList.remove('hidden'); welcomeModal.style.display = 'flex'; }
      } else if (localStorage.getItem('tokenClicker_invitedBy') && typeof registerReferralIfNeeded === 'function') {
        registerReferralIfNeeded(playerName);
      }
    }
    document.getElementById('onboarding-next') && document.getElementById('onboarding-next').addEventListener('click', function() {
      if (onboardingStep >= 4) finishOnboarding();
      else { showOnboardingStep(onboardingStep + 1); }
    });
    document.getElementById('onboarding-back') && document.getElementById('onboarding-back').addEventListener('click', function() {
      if (onboardingStep > 0) showOnboardingStep(onboardingStep - 1);
    });
    document.getElementById('onboarding-skip') && document.getElementById('onboarding-skip').addEventListener('click', finishOnboarding);

    function createStars() {
      const layer = document.getElementById('stars-layer');
      if (!layer) return;
      for (let i = 0; i < 45; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDuration = (4 + Math.random() * 6) + 's';
        star.style.animationDelay = Math.random() * 8 + 's';
        layer.appendChild(star);
      }
    }

    window.addEventListener('load', () => {
      createStars();
      checkDeath();
      updateBountyProgress();
      save();
      var params = new URLSearchParams(window.location.search);
      var refParam = params.get('ref') || (window.location.hash ? new URLSearchParams(window.location.hash.slice(1)).get('ref') : null);
      if (refParam) localStorage.setItem('tokenClicker_invitedBy', refParam);
      if (params.get('room')) {
        window._pvpInvitedRoomId = params.get('room');
      }
      showPage(getPageFromHash());
      updateUI();
      if (typeof loadFriendsInvited === 'function') loadFriendsInvited();
      if (typeof loadFriendsAddedByCode === 'function') loadFriendsAddedByCode();
      if (typeof loadLeaderboardPvp === 'function') loadLeaderboardPvp();
      var invitedBy = localStorage.getItem('tokenClicker_invitedBy');
      var playerName = typeof getPlayerName === 'function' ? getPlayerName() : null;
      var onboardingDone = localStorage.getItem('tokenClicker_onboardingCompleted') === '1';
      if (onboardingDone) {
        if (invitedBy && playerName) {
          if (typeof registerReferralIfNeeded === 'function') registerReferralIfNeeded(playerName);
        } else if (invitedBy && !playerName) {
          var welcomeModal = document.getElementById('welcome-name-modal');
          var welcomeText = welcomeModal && welcomeModal.querySelector('.text-gray-300');
          if (welcomeText) welcomeText.textContent = 'You were invited! Enter your display name to accept and join. You can change it later in Wallet ‚Üí Settings.';
          if (welcomeModal) { welcomeModal.classList.remove('hidden'); welcomeModal.style.display = 'flex'; }
        }
      } else {
        var overlay = document.getElementById('onboarding-overlay');
        if (overlay) {
          overlay.classList.remove('hidden');
          overlay.style.display = 'flex';
          if (app) app.classList.add('hidden');
          showOnboardingStep(0);
        }
      }
    });
  </script>
</body>
</html>
